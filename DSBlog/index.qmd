---
title: "Educational Data Science"
listing:
  contents: posts
  sort: "date desc"
  type: table
  categories: true
  sort-ui: true
  filter-ui: true
page-layout: full
title-block-banner: true
---

บทความนี้มีเนื้อหาเกี่ยวกับการวิเคราะห์ภาวะการถดถอยการเรียนรู้ของนักเรียนไทย ขอบเขตการศึกษาเป็นนักเรียนระดับชั้นประถมศึกษาปีที่ 6 ที่เรียนอยู่ในโรงเรียนสังกัดคณะกรรมการการศึกษาขั้นพื้นฐาน โดยข้อมูลที่ใช้จะเป็นข้อมูลระดับโรงเรียน ในช่วงปีการศึกษา 2561 - 2564 มีชุดข้อมูลที่เกี่ยวข้องดังนี้

1.  ฐานข้อมูลผลการสอบ O-NET
2.  ฐานข้อมูลภูมิหลังผู้สอบ O-NET --- รายได้ครอบครัว สถานะครอบครัว
3.  ฐานข้อมูลพื้นฐานโรงเรียน สพฐ. --- จำนวนครู จำนวนห้องเรียน จำนวนนักเรียน ขนาดโรงเรียน ในเขตนอกเขตเทศบาล
4.  ฐานข้อมูลประกันคุณภาพโรงเรียนภายนอก โดย สมศ. รอบ 3 และ 4

# Literature Review

อ้างอิง : <https://jazznbass.github.io/scan-Book/ch_create_display_and_store_scdfs.html>

## Piecewise Regression Analysis

การวิเคราะห์การถดถอยแบบ Piecewise (หนังสือบางเล่มอาจเรียกว่า segmentd regression) เป็นการวิเคราะห์ความสัมพันธ์ระหว่างตัวแปรตามกับตัวแปรอิสระ โดยที่ความสัมพันธ์ดังกล่าวมีการเปลี่ยนแปลง ณ จุดเปลี่ยน (breakpoint) ทำให้การคำนวณสัมประสิทธิ์การถดถอยภายในชุดข้อมูลมีการเปลี่ยนแปลง วิธีการวิเคราะห์นี้เหมาะสำหรับการวิเคราะห์ single case study ที่ต้องการวิเคราะห์แนวโน้มการเปลี่ยนแปลงของหน่วยข้อมูลตามเวลา

A general model for single-case data based on the piecewise regression approach has been proposed by Huitema and McKean Huitema & Mckean ([2000](https://jazznbass.github.io/scan-Book/references.html#ref-huitema_design_2000)). They refer to two-phase single-case designs with a pre-intervention phase containing some measurements before the start of the intervention (A-phase) and an intervention phase containing measurements starting at the beginning of the intervention and continuing throughout intervention (B-phase).

ภายใต้โมเดลประกอบด้วยพารามิเตอร์ 4 ตัว ได้แก่

-   intercept ใช้แทนคะแนนของตัวแปรตามเมื่อเริ่มศึกษา

-   trend effect หรือแนวโน้มโดยรวมของตัวแปรตาม

-   level effect เป็น intervention effect ที่ทำให้เกิดการเปลี่ยนแปลงอย่างฉับพลันต่อ intercept ระหว่างช่วง A กับ B

-   slope effect เป็น intervention effect ที่ทำให้เกิดการเปลี่ยนแปลงอย่างฉับพลันต่อ slope ระหว่างช่วง A กับ B

![](posts/2023-04-09-learningloss/Screenshot%202566-04-09%20at%2023.42.49.png){width="60%"}

```{r}
dat %>% filter(Days %in% c(0,9)) %>%
  select(-D, -lag.D) %>%
  spread(key = Days, value = Reaction) %>%
  rename("day0" = "0", "day9" = "9") %>%
  ggplot(aes(x=day0, y=day9))+
  geom_point()
  
```

```{r}
data("sleepstudy")
dat <- sleepstudy

ggplot(data=dat,aes(x = Days, y = Reaction, group = Subject)) +
  geom_line(aes(group=Subject))+
  geom_text(data = dat%>%filter(Days ==9 , Reaction < 300), 
            aes(x = Days, y = Reaction,label = Subject))
head(dat)
dat<-dat %>% 
  mutate(D = ifelse(Days>5,1,0),
         lag.D = Days-5)
dat2<-dat%>%filter(Subject=="310")
fit<-lm(Reaction ~ Days + lag.D*D - lag.D-D, dat2)
summary(fit)
pred<-predict(fit)


fit<-lmer(Reaction ~ Days + lag.D*D - lag.D-D + (1+ Days+lag.D*D - lag.D-D|Subject), dat)
summary(fit)

coef(fit)
coef<-coef(fit)$Subject
head(coef)

coef %>%
  rename("b0"="(Intercept)", "effect2" = "lag.D:D") %>%
  mutate(b1_pos = Days + effect2,
         y_pos = dat[dat$Days==9,"Reaction"]) %>%
  ggplot()+
  geom_point(aes(x=Days, y=b0))+
  geom_point(aes(x=b1_pos, y=y_pos, col="red"))+
  geom_segment(aes(x=Days, y=b0,
                   xend=b1_pos, yend=y_pos),
               arrow=arrow(length=unit(5,"pt"),
                           type="closed"), alpha=0.2
               )+
  xlab("อัตราการเปลี่ยนแปลงภายหลัง Covid")+
  ylab("คะแนน")+
  theme_light()+
  theme(text=element_text(family="ChulaCharasNew"),
        panel.grid=element_blank())
```

*scan* provides an implementation based on this piecewise-regression approach. Though the original model is extended by several factors:

-   multiple phase designs

-   additional (control) variables

-   autoregression modeling

-   logistic, binomial, and poisson distributed dependent variables and error terms

-   multivariate analyzes for analyzing the effect of an intervention on more than one outcome variable (see [Chapter 11](https://jazznbass.github.io/scan-Book/ch_multivariate_plm.html)).

-   multilevel analyzes for multiple cases (see [Chapter 10](https://jazznbass.github.io/scan-Book/ch_multilevel_plm.html)).

### The Basic `plm` function

ตัวอย่างต่อไปนี้จะแสดงการวิเคราะห์ piecewise regression ด้วยฟังก์ชัน `plm`

``` r
plm(data, dvar, pvar, mvar, AR = 0, model = c(“W”, “H-M”, “B&L-B”, “JW”), family = “gaussian”, trend = TRUE, level = TRUE, slope = TRUE, contrast = c(“first”, “preceding”), contrast_level = c(NA, “first”, “preceding”), contrast_slope = c(NA, “first”, “preceding”), formula = NULL, update = NULL, na.action = na.omit, r_squared = TRUE, var_trials = NULL, dvar_percentage = FALSE, …)
```

```{r}
library(ggplot2)
library(lme4)
library(dplyr)
library(scan)
data("sleepstudy")
dat <- sleepstudy

ggplot(data=dat,aes(x = Days, y = Reaction, group = Subject)) +
  geom_line(aes(group=Subject))+
  geom_text(data = dat%>%filter(Days ==9 , Reaction < 300), 
            aes(x = Days, y = Reaction,label = Subject))

single <- dat %>%filter(Subject == 332)
single 
scdf(single$Reaction, B_start = 8)->single
describe(single)
smd(single)
autocorr(single, lag_max = 4)
trend(single)
plm(single)
plot(single)

head(dat)
dat$phase<-rep(c(rep("A",6),rep("B",4)),18)
temp<-dat
head(temp)
temp<-temp %>% select(Subject, phase, Reaction, Days)
names(temp)<-c("case","phase","values","mt")
scdf(reaction = temp$values,
     dvar = "reaction",
     B_start = 7,
     names = temp$Subject)
```

onet %\>% filter(subject == "ภาษาไทย") %\>%

select(school_name, Med, year) %\>%

arrange(school_name)

```{r eval=F}
library(readxl)
onet<-read_excel("/Users/siwachoat/Library/CloudStorage/OneDrive-ChulalongkornUniversity/Documents/datakruroo/datakruroo.github.io/DSBlog/posts/2023-04-09-learningloss/SCORE_BY_SCHOOL_2560-2564.xlsx",
                 sheet=3)

glimpse(onet, width=50)

names(onet)[1]<-"year"
names(onet)[5]<-"school_name"
names(onet)[29]<-"Mean"
names(onet)[31]<-"Med"
names(onet)[25]<-"subject"
names(onet)[11]<-"area"
names(onet)[22]<-"location"
names(onet)[23]<-"size"
names(onet)[7]<-"area2"

sch<-names(table(onet$school_name))


onet %>% #filter(school_name %in% sch[sample(length(sch),1000)]) %>%
  filter(year %in% 2560:2564) %>%
  filter(subject == "คณิตศาสตร์") %>%
  mutate(Mean = as.numeric(Mean)) %>%
 # filter(area == "สำนักงานคณะกรรมการการศึกษาขั้นพื้นฐาน")%>%
  select(school_name, area2, year,Mean,Med, size, location) %>%
  ggplot(aes(x=year, y=Mean))+
  geom_line(data=.%>%filter(size=="S"),
    aes(group=school_name, col= size),alpha=0.1)+
  theme_minimal()+
  theme(panel.grid=element_blank())


onet %>% 
  filter(subject == "คณิตศาสตร์") %>%
 # filter(area == "สำนักงานคณะกรรมการการศึกษาขั้นพื้นฐาน")%>%
  select(school_name, area2, year,Mean,Med, size, location) %>%
  group_by(year) %>%
  summarise(mean=mean(Med),
            q1=quantile(Med,0.25),
            Min=min(Mean),
            Max=max(Mean))
```

```{r eval=F}
library(lme4)
data("sleepstudy")
dat <- sleepstudy
head(dat)

library(ggplot2)
dat %>% ggplot(aes(x = Days, y = Reaction)) +
  geom_line(aes(group=Subject))

dat %>% group_by(Days) %>%
  count()

library(lme4)
library(nlme)
# Fit a multilevel piecewise regression model with random intercepts
model <- lmer(Reaction ~ Days + (1|Subject), data = dat)
summary(model)

lme(Reaction ~ Days, random = ~1|Subject, data = dat) %>% summary()

library(piecewiseSEM)

# Fit a multilevel piecewise regression model with random intercepts and slopes
model <- psem(
        lme(Reaction ~ Days, random = ~1|Subject, data = dat),
        data = dat)
summary(model)
plot(model)
rsquared(model)
residuals(model)
coefs(model)

library(brms)

model <- brm(Reaction ~ Days + (1|Subject), data = dat)
summary(model)
```

```{r eval=F}
library(scan)
hplm(data = dat,
     dvar = "Reaction",
     )
```
