{
  "hash": "52faef9f6b1f469addd6a4c1e9d2f544",
  "result": {
    "markdown": "---\ntitle: \"Hierarchical Linear Modelling\"\nsubtitle: \"2756713 MSES RES 2023\"\nauthor: ผศ.ดร.สิวะโชติ ศรีสุทธิยากร </br> ผศ.ดร.กนิษฐ์ ศรีเคลือบ\nlogo: \"images/logo.png\"\nfooter: \"[DataKruROO MSEM](https://datakruroo.netlify.app/msem/_site)\"\nformat: \n  revealjs: \n    theme: slides.scss\n    multiplex: true\n    transition: slide\n    slide-number: true\n    navigation-mode: vertical\n    scrollable: true\n    chalkboard: true\n    menu: \n      numbers: true\n    slide-tone: true\neditor: visual\nexecute:\n  freeze: auto\n---\n\n\n\n\n## HSB Dataset {.smaller}\n\n![](images/image-1532658019.png){fig-align=\"left\" width=\"383\"}\n\nHSB = HighSchool & Beyond Survey (Raudenbush & Bryk, 2002)\n\n-   `mathach` = ผลสัมฤทธิ์ทางการเรียนคณิตศาสตร์ของนักเรียน\n\n-   `ses` = เศรษฐานะของนักเรียน\n\n-   `sector` = ประเภทของโรงเรียน (1 = Catholic, 0 = Public)\n\n-   `schid` = รหัสโรงเรียนของนักเรียน\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'dplyr'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n```\n:::\n\n```{.r .cell-code}\nlibrary(haven)\nlibrary(descriptr)\ndat <- read_spss(\"datasets/HSB.SAV\")\nglimpse(dat)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 7,185\nColumns: 4\n$ schid   <chr> \"1224\", \"1224\", \"1224\", \"1224\", \"1224\", \"1224\", \"1224\", \"1224\"…\n$ sector  <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…\n$ ses     <dbl> -1.528, -0.588, -0.528, -0.668, -0.158, 0.022, -0.618, -0.998,…\n$ mathach <dbl> 5.876, 19.708, 20.349, 8.781, 17.898, 4.583, -2.832, 0.523, 1.…\n```\n:::\n:::\n\n\n# Six Submodels\n\n## Hierarchical General Linear models {.small}\n\n-   One-way ANOVA with random effect model\n\n-   Means as outcomes regression model (random intercept model)\n\n-   One-way ANCOVA with random effect model\n\n-   Non-randomly varying slopes\n\n-   Random-coefficient regression model\n\n-   Intercept-and-slope as outcome model\n\n# One-way ANOVA </br> with random effect model {.small}\n\nผลสัมฤทธิ์ทางการเรียนคณิตศาสตร์ของแต่ละโรงเรียนแตกต่างกันหรือไม่\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(lme4)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: Matrix\n```\n:::\n\n```{.r .cell-code}\nlibrary(lmerTest)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'lmerTest'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following object is masked from 'package:lme4':\n\n    lmer\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following object is masked from 'package:stats':\n\n    step\n```\n:::\n\n```{.r .cell-code}\nfit_nullmodel <- lmer(mathach ~ 1 + (1|schid), data = dat)\nbeta0j <- coef(fit_nullmodel)\nleft_join(dat, data.frame(schid = rownames(beta0j$schid),\n                          group_mean = beta0j$schid),\n          by = \"schid\") %>%\n  rename(group_mean = X.Intercept.)%>%\n # filter(schid %in% subset) %>%\n  ggplot()+\n  geom_density(aes(x=mathach, y = after_stat(scaled)),alpha=0.3,\n               show.legend = F, fill = \"grey\", adjust =1.5)+\n  geom_density(aes(x = mathach, y = after_stat(density)*5,fill = schid),\n               show.legend = F, alpha = 0.3, adjust = 1.2)+\n  scale_x_continuous(limits = c(-5,30))+\n  theme_light()+\n  theme(panel.grid = element_blank())+\n  ylab(\"density\")\n```\n\n::: {.cell-output-display}\n![](07HLMs_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n## กิจกรรม (5 นาที) {.small}\n\n1.  คำนวณค่าเฉลี่ยของ `mathach` ระดับโรงเรียน จะมีค่าเฉลี่ยกี่ค่า?\n\n2.  ค่าเฉลี่ย `mathach` ของโรงเรียนมีความแตกต่างกันอย่างไร?\n\n## Modelling {.small}\n\n::: columns\n::: {.column width=\"30%\"}\n**student-level model**\n\n$math_{ij} = \\beta_{0j} + \\epsilon_{ij}$\n\n**school-level model**\n\n$\\beta_{0j} = \\gamma_{00} + u_{0j}$\n\n**combined model**\n\n$math_{ij} = \\gamma_{00} + u_{0j} + \\epsilon_{ij}$\n:::\n\n::: {.column .small width=\"50%\"}\n![](images/image-2097443701.png){width=\"433\"}\n:::\n:::\n\n**มีข้อตกลงเบื้องต้นคือ**\n\n1.  $\\epsilon_{ij} \\sim N(0, \\sigma^2)$\n2.  $u_{0j} \\sim N(0, \\tau_{00})$\n\nเรียก $\\sigma^2$ = level-1 variance และ $\\tau_{00}$ = level-2 variance\n\nโมเดลข้างต้นมีพารามิเตอร์กี่ตัว อะไรบ้าง และพารามิเตอร์แต่ละตัวมีความหมาย/ให้สารสนเทศอะไร\n\n## Modelling: parameter estimation {.small}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(lme4)\nlibrary(lmerTest)\nfit_nullmodel <- lmer(mathach ~ 1 + (1|schid), data = dat)\nsummary(fit_nullmodel)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nLinear mixed model fit by REML. t-tests use Satterthwaite's method [\nlmerModLmerTest]\nFormula: mathach ~ 1 + (1 | schid)\n   Data: dat\n\nREML criterion at convergence: 47116.8\n\nScaled residuals: \n    Min      1Q  Median      3Q     Max \n-3.0631 -0.7539  0.0267  0.7606  2.7426 \n\nRandom effects:\n Groups   Name        Variance Std.Dev.\n schid    (Intercept)  8.614   2.935   \n Residual             39.148   6.257   \nNumber of obs: 7185, groups:  schid, 160\n\nFixed effects:\n            Estimate Std. Error       df t value Pr(>|t|)    \n(Intercept)  12.6370     0.2444 156.6473   51.71   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\n## Modelling: พารามิเตอร์สำคัญ {.small}\n\nOne-way ANOVA with random effect มักใช้เป็นโมเดลเพื่อตรวจสอบโครงสร้างระดับลดหลั่นของข้อมูล สารสนเทศสำคัญ ได้แก่ point estimate และ interval estimate ของ\n\n-   $\\gamma_{00}$\n\n-   $\\sigma^2$\n\n-   $\\tau_{00}$\n\n-   Intraclass correlation = $\\rho = \\frac{\\tau_{00}}{\\tau_{00} + \\sigma^2}$\n\nมีฟังก์ชันที่สำคัญสองตัวได้แก่\n\n-   `confint(fit_nullmodel)` ซึ่งจะให้ช่วงความเชื่อมั่นของค่าประมาณพารามิเตอร์ของโมเดล\n\n-   `ranova(fit_nullmodel)` จะให้ผลการทดสอบอัตราส่วนภาวะความน่าจะเป็น (likelihood ratio test) ของ random effect term ในโมเดล\n\n## Modelling: ช่วงความเชื่อมั่น {.small}\n\nผลการวิเคราะห์นี้ให้สารสนเทศอะไร ใช้ประโยชน์อะไรได้บ้าง?\n\n\n::: {.cell}\n\n```{.r .cell-code}\nconfint(fit_nullmodel, level = 0.95)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nComputing profile confidence intervals ...\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n                2.5 %    97.5 %\n.sig01       2.594729  3.315880\n.sigma       6.154803  6.361786\n(Intercept) 12.156289 13.117121\n```\n:::\n:::\n\n\n## Modelling: Test for Random-Effects {.small}\n\n$H_0: \\tau_{00} =0$ vs $H_1: \\tau_{00}>0$\n\n\n::: {.cell}\n\n```{.r .cell-code}\nranova(fit_nullmodel)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nANOVA-like table for random-effects: Single term deletions\n\nModel:\nmathach ~ (1 | schid)\n            npar logLik   AIC    LRT Df Pr(>Chisq)    \n<none>         3 -23558 47123                         \n(1 | schid)    2 -24052 48107 986.12  1  < 2.2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\n-   In certain cases tests of non-nested models may be generated. An example is when `(0 + poly(x, 2) | gr)` is reduced (the default) to `(1 | gr)`. To our best knowledge non-nested model comparisons are only generated in cases which are statistical nonsense anyway (such as in this example where the random intercept is suppressed).\n\n-   Note that `anova` can be used to compare two models and will often be able to produce the same tests as `ranova`. This is, however, not always the case as illustrated in the examples.\n\n## ICC {.small}\n\n$$\n\\rho = \\frac{\\tau_{00}}{\\tau_{00} + \\sigma^2}\n$$\n\n-   The ICC can be interpreted as \"the proportion of the variance explained by the grouping structure in the population\"\n\n-   ICC indexes how strongly measurements in the same group resemble each other\n\n-   the ICC - sometimes conceptualized as the measurement repeatability - \"can also be interpreted as the expected correlation between two randomly drawn units that are in the same group\" *(Hox 2010: 15)*\n\nNote: This definition might not apply to mixed models with more complex random effects structures\n\n## ICC {.small}\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#install.packages(\"performance\")\nlibrary(performance)\n#insight::get_variance(fit_nullmodel)\nicc(fit_nullmodel)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# Intraclass Correlation Coefficient\n\n    Adjusted ICC: 0.180\n  Unadjusted ICC: 0.180\n```\n:::\n:::\n\n\n-   `icc()` calculates an adjusted and an unadjusted ICC, which both take all sources of uncertainty (i.e. of *all random effects*) into account. While the *adjusted ICC* only relates to the random effects, the *unadjusted ICC* also takes the fixed effects variances into account\n\n-   The fixed effects variance is added to the denominator of the formula to calculate the ICC\n\n## R2\n\n-   The coefficient of determination R2 quantifies the proportion of variance explained by a statistical model. More precisely, R2 is the proportion of the explained variance (of the full model)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nr2(fit_nullmodel)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# R2 for Mixed Models\n\n  Conditional R2: 0.180\n     Marginal R2: 0.000\n```\n:::\n:::\n\n\n-   R2 กับ ICC แตกต่างกันหรือไม่ อย่างไร?\n\n## Estimated value of $\\beta_{0j}$ {.small}\n\nNull model จะให้ค่าประมาณของค่าเฉลี่ยระดับกลุ่ม (ในที่นี้คือค่าเฉลี่ยผลสัมฤทธิ์ทางการเรียนคณิตศาสตร์) ซึ่งสามารถคำนวณได้ดังนี้\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbeta0j <- coef(fit_nullmodel)\nbeta0j$schid %>% summary()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  (Intercept)    \n Min.   : 5.234  \n 1st Qu.:10.731  \n Median :12.871  \n Mean   :12.637  \n 3rd Qu.:14.463  \n Max.   :19.115  \n```\n:::\n:::\n\n\n## Writting Report\n\n![ที่มา : Randenbush & Bryk (2002)](images/image-606181746.png)\n\n# Means as outcomes </br> regression model {.small}\n\nโรงเรียน Catholic กับ Public มีผลสัมฤทธิ์ทางการเรียนคณิตศาสตร์แตกต่างกันอย่างไร\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat %>% \n  mutate(sector = factor(sector, labels=c(\"Catholic\",\"Public\"))) %>%\n  group_by(sector, schid) %>%\n  summarise(mean_mathach = mean(mathach)) %>%\nggplot(aes(x = mean_mathach, y=\"\", fill = sector))+\n  geom_boxplot()+\n  theme_light()+\n  xlab(\"mean_mathach (school means)\")+\n  ylab(\"\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`summarise()` has grouped output by 'sector'. You can override using the\n`.groups` argument.\n```\n:::\n\n::: {.cell-output-display}\n![](07HLMs_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n## กิจกรรม (2 นาที) {.small}\n\nค่าเฉลี่ยผลสัมฤทธิ์ทางการเรียนคณิตศาสตร์ระดับโรงเรียนมีความแตกต่างกันระหว่างสังกัดของโรงเรียนอย่างไร?\n\n## Modelling {.small}\n\n::: {.column width=\"30%\"}\n**student-level model**\n\n$math_{ij} = \\beta_{0j} + \\epsilon_{ij}$\n\n**school-level model**\n\n$\\beta_{0j} = \\gamma_{00} +\\gamma_{01}W_j+u_{0j}$\n\n**combined model**\n\n$math_{ij} = \\gamma_{00} + \\gamma_{01}W_j +u_{0j} + \\epsilon_{ij}$\n:::\n\n::: {.column width=\"50%\"}\n![](images/image-1611863435.png){fig-align=\"center\" width=\"387\"}\n:::\n\n**มีข้อตกลงเบื้องต้นคือ**\n\n1.  $\\epsilon_{ij} \\sim N(0, \\sigma^2)$\n2.  $u_{0j} \\sim N(0, \\tau_{00})$\n\n-   โมเดลนี้มีพารามิเตอร์อะไรบ้าง และมีความหมายอย่างไร\n\n-   พารามิเตอร์เดิมที่อยู่ภายในโมเดลมีความหมายเหมือนหรือแตกต่างไปจาก null model อย่างไร\n\n## Modelling: parameter estimation {.small}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_randIntercept <- lmer(mathach ~ 1 + sector + (1|schid), data = dat)\nsummary(fit_randIntercept)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nLinear mixed model fit by REML. t-tests use Satterthwaite's method [\nlmerModLmerTest]\nFormula: mathach ~ 1 + sector + (1 | schid)\n   Data: dat\n\nREML criterion at convergence: 47080.1\n\nScaled residuals: \n    Min      1Q  Median      3Q     Max \n-3.0130 -0.7523  0.0253  0.7602  2.7472 \n\nRandom effects:\n Groups   Name        Variance Std.Dev.\n schid    (Intercept)  6.677   2.584   \n Residual             39.151   6.257   \nNumber of obs: 7185, groups:  schid, 160\n\nFixed effects:\n            Estimate Std. Error       df t value Pr(>|t|)    \n(Intercept)  11.3930     0.2928 158.5371  38.907  < 2e-16 ***\nsector        2.8049     0.4391 153.5006   6.388  1.9e-09 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nCorrelation of Fixed Effects:\n       (Intr)\nsector -0.667\n```\n:::\n:::\n\n\n## Modelling: Confidence Interval {.small}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nconfint(fit_randIntercept)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nComputing profile confidence intervals ...\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n                2.5 %    97.5 %\n.sig01       2.265614  2.918854\n.sigma       6.155051  6.362058\n(Intercept) 10.819305 11.966760\nsector       1.944660  3.665259\n```\n:::\n:::\n\n\n## Modelling: Test for random effects {.small}\n\nผลการวิเคราะห์ด้านล่างเป็นการทดสอบอะไร?\n\n\n::: {.cell}\n\n```{.r .cell-code}\nranova(fit_randIntercept)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nANOVA-like table for random-effects: Single term deletions\n\nModel:\nmathach ~ sector + (1 | schid)\n            npar logLik   AIC    LRT Df Pr(>Chisq)    \n<none>         4 -23540 47088                         \n(1 | schid)    3 -23900 47805 719.29  1  < 2.2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\n## Modelling: ICC {.small}\n\nadjusted กับ unadjusted ICC มีความหมายแตกต่างกันอย่างไร\n\n\n::: {.cell}\n\n```{.r .cell-code}\nicc(fit_randIntercept)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# Intraclass Correlation Coefficient\n\n    Adjusted ICC: 0.146\n  Unadjusted ICC: 0.140\n```\n:::\n\n```{.r .cell-code}\ninsight::get_variance(fit_randIntercept)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n$var.fixed\n[1] 1.966748\n\n$var.random\n[1] 6.676957\n\n$var.residual\n[1] 39.1514\n\n$var.distribution\n[1] 39.1514\n\n$var.dispersion\n[1] 0\n\n$var.intercept\n   schid \n6.676957 \n```\n:::\n:::\n\n\n## Modelling: Variance Explained {.small}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nr2(fit_randIntercept)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# R2 for Mixed Models\n\n  Conditional R2: 0.181\n     Marginal R2: 0.041\n```\n:::\n:::\n\n\n## Multiparameter tests (Deviance Test) {.small}\n\nนอกจากการทดสอบสมมุติฐานเพื่อตรวจสอบนัยสำคัญของพารามิเตอร์ภายในโมเดลเป็นรายตัวแล้ว เราสามารถทำการตรวจสอบนัยสำคัญของพารามิเตอร์หลายตัวพร้อมกันได้ด้วย ซึ่งมีประโยชน์ในเชิงของการเปรียบเทียบโมเดลคู่แข่งขัน (nested model) วิธีการหนึ่งที่สามารถนำมาใช้ได้เรียกว่า likelihood ratio test\n\nสมมุติต้องการเปรียบเทียบระหว่าง null model กับ โมเดลในกิจกรรมที่ผ่านมา (M2 model) สามารถดำเนินการได้ดังนี้\n\n$$\nH_0: M_{null} = M_2\n\\\\\nH_1: M_{null} \\neq M_2\n$$\n\n1.  คำนวณ $D_0 = -2log(L_{null})$ เรียกค่านี้ว่า deviance ของ null model\n2.  คำนวณ $D_2 = -2log(L_{M2})$ เรียกค่านี้ว่า deviance ของ M2 model\n3.  ภายใต้ $H_0$ เป็นจริง $\\chi^2 = D_0 - D_2 \\sim \\chi^2_{df}$ เมื่อ $df$ คือผลต่างของจำนวนพารามิเตอร์ระหว่างโมเดลคู่แข่งขันทั้งสอง\n\n## Multiparameter tests {.small}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanova(fit_nullmodel, fit_randIntercept)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nrefitting model(s) with ML (instead of REML)\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nData: dat\nModels:\nfit_nullmodel: mathach ~ 1 + (1 | schid)\nfit_randIntercept: mathach ~ 1 + sector + (1 | schid)\n                  npar   AIC   BIC logLik deviance  Chisq Df Pr(>Chisq)    \nfit_nullmodel        3 47122 47142 -23558    47116                         \nfit_randIntercept    4 47087 47115 -23540    47079 36.705  1  1.374e-09 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\n## กิจกรรม (5-6 นาที) {.small}\n\nวิเคราะห์และแปลผลโมเดลต่อไปนี้\n\n::: {width=\"30%\"}\n**student-level model**\n\n$math_{ij} = \\beta_{0j} + \\epsilon_{ij}$\n\n**school-level model**\n\n$\\beta_{0j} = \\gamma_{00} +\\gamma_{01}Sector_j+ \\gamma_{02}MeanSES + u_{0j}$\n\n**combined model**\n\n$math_{ij} = \\gamma_{00} +\\gamma_{01}Sector_j+ \\gamma_{02}MeanSES +u_{0j} + \\epsilon_{ij}$\n:::\n\n## Writting Report\n\n![ที่มา : Raudenbush & Bryk (2002)](images/image-1297874962.png)\n\n## Random Intercept model {.small}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(gridExtra)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'gridExtra'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following object is masked from 'package:dplyr':\n\n    combine\n```\n:::\n\n```{.r .cell-code}\ntemp<-dat%>%\n  group_by(schid) %>%\n  summarise(meanses = mean(ses)) %>%\n  left_join(dat,., by=\"schid\")\nfit<- lmer(mathach ~ 1 + meanses + (1|schid), data = temp)\ncoef<-coef(fit)\ncoef <- data.frame(coef$schid, schid = rownames(coef$schid)) %>%\n  rename(group_intercept = X.Intercept.,\n         meanses_slope = meanses)\nset.seed(123)\nsubset <- sample(temp$schid,10)\np1<-coef %>% filter(schid %in% subset) %>%\n  ggplot()+\n  geom_point(data = temp %>%\n               filter(schid %in% subset), \n             aes(x=ses, y=mathach, col = schid),\n             alpha=0.5,\n             show.legend = F)+\n  geom_abline(aes(intercept = group_intercept,\n                  slope = meanses_slope, col = schid),\n              show.legend = F)+\n  scale_x_continuous(limits = c(-2,3))+\n  theme_light()+\n  ggtitle(\"random intercept model (10 schools)\")\n\np2<-coef %>%\n  ggplot()+\n  geom_point(data = temp,\n             aes(x=ses, y=mathach),\n             alpha=0.3,\n             show.legend = F)+\n  geom_abline(aes(intercept = group_intercept,\n                  slope = meanses_slope), alpha = 0.3,\n              show.legend = F)+\n  theme_light()+\n  scale_x_continuous(limits = c(-2,3))+\n  ggtitle(\"random intercept model (all schools)\")\ngrid.arrange(p1,p2, ncol=2)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Removed 1 rows containing missing values (`geom_point()`).\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Removed 41 rows containing missing values (`geom_point()`).\n```\n:::\n\n::: {.cell-output-display}\n![](07HLMs_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n:::\n\n\n# Random Coefficients model {.small}\n\nอิทธิพลของ SES ที่มีต่อผลสัมฤทธิ์ทางการเรียนคณิตศาสตร์ของนักเรียน มีความแตกต่างกันระหว่างโรงเรียนหรือไม่\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat %>%\n  ggplot(aes(x=ses, y=mathach))+\n  geom_point(show.legend = F, alpha=0.1, col = \"black\")+\n  geom_smooth(method = \"lm\", se = F, show.legend = F, aes(col = schid))+\n  scale_color_manual(values = rep(scales::alpha(\"steelblue\", 0.5),160))+\n  theme_light()\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](07HLMs_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\n## กิจกรรม (5 นาที)\n\nความสัมพันธ์ระหว่าง mathach กับ ses ของนักเรียนมีความเหมือนหรือแตกต่างกันระหว่างโรงเรียนอย่างไร\n\n## Modelling {.small}\n\n::: {.column width=\"30%\"}\n**student-level model**\n\n$math_{ij} = \\beta_{0j} + \\beta_{1j} SES_{ij} + \\epsilon_{ij}$\n\n**school-level model**\n\n$\\beta_{0j} = \\gamma_{00} +u_{0j}$\n\n$\\beta_{1j} = \\gamma_{10}+u_{1j}$\n\n**combined model (เขียนเอง กิจกรรม 1 นาที)**\n:::\n\n::: {.column width=\"50%\"}\n![](images/image-232996304.png){fig-align=\"center\" width=\"387\"}\n:::\n\n**มีข้อตกลงเบื้องต้นคือ**\n\n1.  $\\epsilon_{ij} \\sim N(0, \\sigma^2)$\n2.  $\\bf{u} \\sim N(0, T)$ โดยที่ $\\bf{u} = (u_{0j}, u_{1j})^T$ และ $T = \\begin{pmatrix} \\tau_{00} & \\tau_{01} \\\\ \\tau_{10} & \\tau_{11}\\end{pmatrix}$\n\n-   โมเดลนี้มีพารามิเตอร์อะไรบ้าง และมีความหมายอย่างไร\n\n## Modelling: Parameter Estimation {.small}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_randCoeff <- lmer(mathach ~ 1 + ses + (1 + ses|schid), data = dat)\nsummary(fit_randCoeff)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nLinear mixed model fit by REML. t-tests use Satterthwaite's method [\nlmerModLmerTest]\nFormula: mathach ~ 1 + ses + (1 + ses | schid)\n   Data: dat\n\nREML criterion at convergence: 46640.4\n\nScaled residuals: \n     Min       1Q   Median       3Q      Max \n-3.12272 -0.73046  0.02144  0.75610  2.94356 \n\nRandom effects:\n Groups   Name        Variance Std.Dev. Corr \n schid    (Intercept)  4.8287  2.1974        \n          ses          0.4129  0.6426   -0.11\n Residual             36.8301  6.0688        \nNumber of obs: 7185, groups:  schid, 160\n\nFixed effects:\n            Estimate Std. Error       df t value Pr(>|t|)    \n(Intercept)  12.6650     0.1898 145.5479   66.71   <2e-16 ***\nses           2.3938     0.1181 157.5299   20.27   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nCorrelation of Fixed Effects:\n    (Intr)\nses -0.045\n```\n:::\n:::\n\n\n## Modelling: Confidence Interval {.small}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nconfint(fit_randCoeff)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nComputing profile confidence intervals ...\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in FUN(X[[i]], ...): non-monotonic profile for .sig02\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in confint.thpr(pp, level = level, zeta = zeta): bad spline fit for\n.sig02: falling back to linear interpolation\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n                  2.5 %     97.5 %\n.sig01       1.91159331  2.5112989\n.sig02      -1.00000000  0.3078580\n.sig03       0.08487641  0.9666694\n.sigma       5.96867353  6.1719565\n(Intercept) 12.28852890 13.0406703\nses          2.15925014  2.6317003\n```\n:::\n:::\n\n\n## Modelling: Level-1 Intercepts and Slopes {.small}\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncoef<-coef(fit_randCoeff)\ncoef <- data.frame(coef$schid, schid = rownames(coef$schid))\nhead(coef)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n     X.Intercept.      ses schid\n1224    11.060022 2.504083  1224\n1288    13.073615 2.477930  1288\n1296     9.197291 2.352981  1296\n1308    14.384652 2.309294  1308\n1317    12.449142 2.237431  1317\n1358    11.520351 2.753447  1358\n```\n:::\n:::\n\n\n## Writting Report {.small}\n\n![](images/image-1902336918.png)\n\n## Modelling: Level-1 Intercepts and Slopes {.small}\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1<-dat %>% group_by(schid) %>%\n  summarise(sector = mean(sector),\n            meanSES = mean(ses))%>%\n  left_join(., coef, by = \"schid\") %>%\n  rename(Intercept = X.Intercept.,\n         Slope_ses = ses) %>%\n  ggplot(aes(x = Slope_ses,\n             y = Intercept))+\n  geom_point(aes(col = factor(sector, labels = c(\"Catholic\",\"Public\"))))+\n  labs(col = \"Sector\")\n\np2<-dat %>% group_by(schid) %>%\n  summarise(sector = mean(sector),\n            meanSES = mean(ses))%>%\n  left_join(., coef, by = \"schid\") %>%\n  rename(Intercept = X.Intercept.,\n         Slope_ses = ses) %>%\n  ggplot(aes(x = Slope_ses,\n             y = Intercept))+\n  geom_point(aes(col = meanSES))\n\ngrid.arrange(p1,p2, ncol=2)\n```\n\n::: {.cell-output-display}\n![](07HLMs_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "07HLMs_files/figure-html"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}