{
  "hash": "1c5349c630d231ea527a3830001f7da9",
  "result": {
    "markdown": "---\ntitle: \"Hierarchical Linear Modelling\"\nsubtitle: \"2756713 MSES RES 2023\"\nauthor: ผศ.ดร.สิวะโชติ ศรีสุทธิยากร </br> ผศ.ดร.กนิษฐ์ ศรีเคลือบ\nlogo: \"images/logo.png\"\nformat: \n  revealjs: \n    theme: slides.scss\n    multiplex: true\n    transition: fade\n    slide-number: true\n    navigation-mode: vertical\n\neditor: visual\nexecute:\n  freeze: auto\n---\n\n\n\n\n## HSB Dataset {.smaller}\n\n![](images/image-1532658019.png){fig-align=\"left\" width=\"383\"}\n\nHSB = HighSchool & Beyond Survey (Raudenbush & Bryk, 2002)\n\n-   `mathach` = ผลสัมฤทธิ์ทางการเรียนคณิตศาสตร์ของนักเรียน\n\n-   `ses` = เศรษฐานะของนักเรียน\n\n-   `sector` = ประเภทของโรงเรียน (1 = Catholic, 0 = Public)\n\n-   `schid` = รหัสโรงเรียนของนักเรียน\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr)\nlibrary(haven)\nlibrary(descriptr)\ndat <- read_spss(\"datasets/HSB.SAV\")\nglimpse(dat)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 7,185\nColumns: 4\n$ schid   <chr> \"1224\", \"1224\", \"1224\", \"1224\", \"1224\", \"1224\", \"1224\", \"1224\"…\n$ sector  <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…\n$ ses     <dbl> -1.528, -0.588, -0.528, -0.668, -0.158, 0.022, -0.618, -0.998,…\n$ mathach <dbl> 5.876, 19.708, 20.349, 8.781, 17.898, 4.583, -2.832, 0.523, 1.…\n```\n:::\n:::\n\n\n# Six Submodels\n\n## Hierarchical General Linear models {.small}\n\n-   One-way ANOVA with random effect model\n\n-   Means as outcomes regression model (random intercept model)\n\n-   One-way ANCOVA with random effect model\n\n-   Non-randomly varying slopes\n\n-   Random-coefficient regression model\n\n-   Intercept-and-slope as outcome model\n\n# One-way ANOVA </br> with random effect model {.small}\n\nผลสัมฤทธิ์ทางการเรียนคณิตศาสตร์ของแต่ละโรงเรียนแตกต่างกันหรือไม่\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](07HLMs_files/figure-revealjs/unnamed-chunk-3-1.png){width=960}\n:::\n:::\n\n\n## กิจกรรม (5 นาที) {.small}\n\n1.  คำนวณค่าเฉลี่ยของ `mathach` ระดับโรงเรียน จะมีค่าเฉลี่ยกี่ค่า?\n\n2.  ค่าเฉลี่ย `mathach` ของโรงเรียนมีความแตกต่างกันอย่างไร?\n\n## Modelling {.small}\n\n::: columns\n::: {.column width=\"30%\"}\n**student-level model**\n\n$math_{ij} = \\beta_{0j} + \\epsilon_{ij}$\n\n**school-level model**\n\n$\\beta_{0j} = \\gamma_{00} + u_{0j}$\n\n**combined model**\n\n$math_{ij} = \\gamma_{00} + u_{0j} + \\epsilon_{ij}$\n:::\n\n::: {.column .small width=\"50%\"}\n![](images/image-2097443701.png){width=\"433\"}\n:::\n:::\n\n**มีข้อตกลงเบื้องต้นคือ**\n\n1.  $\\epsilon_{ij} \\sim N(0, \\sigma^2)$\n2.  $u_{0j} \\sim N(0, \\tau_{00})$\n\nเรียก $\\sigma^2$ = level-1 variance และ $\\tau_{00}$ = level-2 variance\n\nโมเดลข้างต้นมีพารามิเตอร์กี่ตัว อะไรบ้าง และพารามิเตอร์แต่ละตัวมีความหมาย/ให้สารสนเทศอะไร\n\n## Modelling: parameter estimation {.small}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(lme4)\nlibrary(lmerTest)\nfit_nullmodel <- lmer(mathach ~ 1 + (1|schid), data = dat)\nsummary(fit_nullmodel)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nLinear mixed model fit by REML. t-tests use Satterthwaite's method [\nlmerModLmerTest]\nFormula: mathach ~ 1 + (1 | schid)\n   Data: dat\n\nREML criterion at convergence: 47116.8\n\nScaled residuals: \n    Min      1Q  Median      3Q     Max \n-3.0631 -0.7539  0.0267  0.7606  2.7426 \n\nRandom effects:\n Groups   Name        Variance Std.Dev.\n schid    (Intercept)  8.614   2.935   \n Residual             39.148   6.257   \nNumber of obs: 7185, groups:  schid, 160\n\nFixed effects:\n            Estimate Std. Error       df t value Pr(>|t|)    \n(Intercept)  12.6370     0.2444 156.6473   51.71   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\n## Interpret the results {.small}\n\nOne-way ANOVA with random effect มักใช้เป็นโมเดลเพื่อตรวจสอบโครงสร้างระดับลดหลั่นของข้อมูล สารสนเทศสำคัญ ได้แก่ point estimate และ interval estimate ของ\n\n-   $\\gamma_{00}$\n\n-   $\\sigma^2$\n\n-   $\\tau_{00}$\n\n-   Intraclass correlation = $\\rho = \\frac{\\tau_{00}}{\\tau_{00} + \\sigma^2}$\n\nมีฟังก์ชันที่สำคัญสองตัวได้แก่\n\n-   `confint(fit_nullmodel)` ซึ่งจะให้ช่วงความเชื่อมั่นของค่าประมาณพารามิเตอร์ของโมเดล\n\n-   `ranova(fit_nullmodel)` จะให้ผลการทดสอบอัตราส่วนภาวะความน่าจะเป็น (likelihood ratio test) ของ random effect term ในโมเดล\n\n## ICC  {.small}\n\n-   The ICC can be interpreted as \"the proportion of the variance explained by the grouping structure in the population\"\n\n-   ICC indexes how strongly measurements in the same group resemble each other\n\n-   the ICC - sometimes conceptualized as the measurement repeatability - \"can also be interpreted as the expected correlation between two randomly drawn units that are in the same group\" *(Hox 2010: 15)*\n\nNote: This definition might not apply to mixed models with more complex random effects structures\n\n## ICC  {.small}\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#install.packages(\"performance\")\nlibrary(performance)\n#insight::get_variance(fit_nullmodel)\nicc(fit_nullmodel)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# Intraclass Correlation Coefficient\n\n    Adjusted ICC: 0.180\n  Unadjusted ICC: 0.180\n```\n:::\n:::\n\n\n## R2\n\n-   The coefficient of determination R2 quantifies the proportion of variance explained by a statistical model. More precisely, R2 is the proportion of the explained variance (of the full model)\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n```\n# R2 for Mixed Models\n\n  Conditional R2: 0.180\n     Marginal R2: 0.000\n```\n:::\n:::\n\n\n## Group Means  {.small}\n\nNull model จะให้ค่าประมาณของค่าเฉลี่ยระดับกลุ่ม (ในที่นี้คือค่าเฉลี่ยผลสัมฤทธิ์ทางการเรียนคณิตศาสตร์) ซึ่งสามารถคำนวณได้ดังนี้\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbeta0j <- coef(fit_nullmodel)\nbeta0j$schid %>% summary()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  (Intercept)    \n Min.   : 5.234  \n 1st Qu.:10.731  \n Median :12.871  \n Mean   :12.637  \n 3rd Qu.:14.463  \n Max.   :19.115  \n```\n:::\n:::\n\n\n## Writting Report\n\n![ที่มา : Randenbush & Bryk (2002)](images/image-606181746.png)\n\n# Means as outcomes </br> regression model {.small}\n\nโรงเรียน Catholic กับ Public มีผลสัมฤทธิ์ทางการเรียนคณิตศาสตร์แตกต่างกันอย่างไร\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](07HLMs_files/figure-revealjs/unnamed-chunk-8-1.png){width=960}\n:::\n:::\n\n\n## กิจกรรม (2 นาที) {.small}\n\nค่าเฉลี่ยผลสัมฤทธิ์ทางการเรียนคณิตศาสตร์ระดับโรงเรียนมีความแตกต่างกันระหว่างสังกัดของโรงเรียนอย่างไร?\n\n## Modelling {.small}\n\n::: {.column width=\"30%\"}\n**student-level model**\n\n$math_{ij} = \\beta_{0j} + \\epsilon_{ij}$\n\n**school-level model**\n\n$\\beta_{0j} = \\gamma_{00} +\\gamma_{01}W_j+u_{0j}$\n\n**combined model**\n\n$math_{ij} = \\gamma_{00} + \\gamma_{01}W_j +u_{0j} + \\epsilon_{ij}$\n:::\n\n::: {.column width=\"50%\"}\n![](images/image-1611863435.png){fig-align=\"center\" width=\"387\"}\n:::\n\n**มีข้อตกลงเบื้องต้นคือ**\n\n1.  $\\epsilon_{ij} \\sim N(0, \\sigma^2)$\n2.  $u_{0j} \\sim N(0, \\tau_{00})$\n\n-   โมเดลนี้มีพารามิเตอร์อะไรบ้าง และมีความหมายอย่างไร\n\n-   พารามิเตอร์เดิมที่อยู่ภายในโมเดลมีความหมายเหมือนหรือแตกต่างไปจาก null model อย่างไร\n\n## Modelling: parameter estimation {.small}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_randIntercept <- lmer(mathach ~ 1 + sector + (1|schid), data = dat)\nsummary(fit_randIntercept)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nLinear mixed model fit by REML. t-tests use Satterthwaite's method [\nlmerModLmerTest]\nFormula: mathach ~ 1 + sector + (1 | schid)\n   Data: dat\n\nREML criterion at convergence: 47080.1\n\nScaled residuals: \n    Min      1Q  Median      3Q     Max \n-3.0130 -0.7523  0.0253  0.7602  2.7472 \n\nRandom effects:\n Groups   Name        Variance Std.Dev.\n schid    (Intercept)  6.677   2.584   \n Residual             39.151   6.257   \nNumber of obs: 7185, groups:  schid, 160\n\nFixed effects:\n            Estimate Std. Error       df t value Pr(>|t|)    \n(Intercept)  11.3930     0.2928 158.5371  38.907  < 2e-16 ***\nsector        2.8049     0.4391 153.5006   6.388  1.9e-09 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nCorrelation of Fixed Effects:\n       (Intr)\nsector -0.667\n```\n:::\n:::\n\n\n## Modelling: parameter estimation {.small}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nconfint(fit_randIntercept)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                2.5 %    97.5 %\n.sig01       2.265614  2.918854\n.sigma       6.155051  6.362058\n(Intercept) 10.819305 11.966760\nsector       1.944660  3.665259\n```\n:::\n:::\n\n\n## Modelling: random effect test {.small}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nranova(fit_randIntercept)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nANOVA-like table for random-effects: Single term deletions\n\nModel:\nmathach ~ sector + (1 | schid)\n            npar logLik   AIC    LRT Df Pr(>Chisq)    \n<none>         4 -23540 47088                         \n(1 | schid)    3 -23900 47805 719.29  1  < 2.2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\n## Modelling: Variance Explained {.small}\n\nสัดส่วนความแปรปรวนในค่าเฉลี่ย mathach ของโรงเรียนที่อธิบายได้ด้วย Sector\n\n$$\nvariance\\ explained = \\frac{\\tau_{00}(null \\ model)-\\tau_{00}(Sector)}{\\tau_{00}(null \\ model)}\n$$\n\n## Modelling: Conditional Intraclass correlation {.small}\n\n1.  ทดลองคำนวณ intraclass correlation และ R2 ของโมเดล random intercept ใหม่\n2.  ค่าของ intraclass correlation ที่ได้เป็นอย่างไรเมื่อเทียบกับของ null model และค่าที่เปลี่ยนแปลงไปนี้หมายความว่าอย่างไร\n\n## กิจกรรม (5-6 นาที) {.small}\n\nวิเคราะห์และแปลผลโมเดลต่อไปนี้\n\n::: {width=\"30%\"}\n**student-level model**\n\n$math_{ij} = \\beta_{0j} + \\epsilon_{ij}$\n\n**school-level model**\n\n$\\beta_{0j} = \\gamma_{00} +\\gamma_{01}Sector_j+ \\gamma_{02}MeanSES + u_{0j}$\n\n**combined model**\n\n$math_{ij} = \\gamma_{00} +\\gamma_{01}Sector_j+ \\gamma_{02}MeanSES +u_{0j} + \\epsilon_{ij}$\n:::\n\n## Multiparameter tests  {.small}\n\nนอกจากการทดสอบสมมุติฐานเพื่อตรวจสอบนัยสำคัญของพารามิเตอร์ภายในโมเดลเป็นรายตัวแล้ว เราสามารถทำการตรวจสอบนัยสำคัญของพารามิเตอร์หลายตัวพร้อมกันได้ด้วย ซึ่งมีประโยชน์ในเชิงของการเปรียบเทียบโมเดลคู่แข่งขัน (nested model) วิธีการหนึ่งที่สามารถนำมาใช้ได้เรียกว่า likelihood ratio test\n\nสมมุติต้องการเปรียบเทียบระหว่าง null model กับ โมเดลในกิจกรรมที่ผ่านมา (M2 model) สามารถดำเนินการได้ดังนี้\n\n$$\nH_0: M_{null} = M_2\n\\\\\nH_1: M_{null} \\neq M_2\n$$\n\n1.  คำนวณ $D_0 = -2log(L_{null})$ เรียกค่านี้ว่า deviance ของ null model\n2.  คำนวณ $D_2 = -2log(L_{M2})$ เรียกค่านี้ว่า deviance ของ M2 model\n3.  ภายใต้ $H_0$ เป็นจริง $\\chi^2 = D_0 - D_2 \\sim \\chi^2_{df}$ เมื่อ $df$ คือผลต่างของจำนวนพารามิเตอร์ระหว่างโมเดลคู่แข่งขันทั้งสอง\n\n## Multiparameter tests  {.small}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanova(fit_nullmodel, fit_randIntercept)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nData: dat\nModels:\nfit_nullmodel: mathach ~ 1 + (1 | schid)\nfit_randIntercept: mathach ~ 1 + sector + (1 | schid)\n                  npar   AIC   BIC logLik deviance  Chisq Df Pr(>Chisq)    \nfit_nullmodel        3 47122 47142 -23558    47116                         \nfit_randIntercept    4 47087 47115 -23540    47079 36.705  1  1.374e-09 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\n## Writting Report\n\n![ที่มา : Raudenbush & Bryk (2002)](images/image-1297874962.png)\n\n## Random Intercept model  {.small}\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](07HLMs_files/figure-revealjs/unnamed-chunk-13-1.png){width=960}\n:::\n:::\n\n\n# Random Coefficients model  {.small}\n\nอิทธิพลของ SES ที่มีต่อผลสัมฤทธิ์ทางการเรียนคณิตศาสตร์ของนักเรียน มีความแตกต่างกันระหว่างโรงเรียนหรือไม่\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](07HLMs_files/figure-revealjs/unnamed-chunk-14-1.png){width=960}\n:::\n:::\n",
    "supporting": [
      "07HLMs_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}