{"title":"Hierarchical Linear Modelling","markdown":{"yaml":{"title":"Hierarchical Linear Modelling","subtitle":"2756713 MSES RES 2023","author":"ผศ.ดร.สิวะโชติ ศรีสุทธิยากร </br> ผศ.ดร.กนิษฐ์ ศรีเคลือบ","logo":"images/logo.png","footer":"[DataKruROO MSEM](https://datakruroo.netlify.app/msem/_site)","format":{"revealjs":{"theme":"slides.scss","multiplex":true,"transition":"slide","slide-number":true,"navigation-mode":"vertical","scrollable":true,"chalkboard":true,"menu":{"numbers":true},"slide-tone":true}},"editor":"visual","execute":{"freeze":"auto"}},"headingText":"| include: false","containsRefs":false,"markdown":"\n\n```{r}\nlibrary(ggplot2)\n```\n\n## HSB Dataset {.smaller}\n\n![](images/image-1532658019.png){fig-align=\"left\" width=\"383\"}\n\nHSB = HighSchool & Beyond Survey (Raudenbush & Bryk, 2002)\n\n-   `mathach` = ผลสัมฤทธิ์ทางการเรียนคณิตศาสตร์ของนักเรียน\n\n-   `ses` = เศรษฐานะของนักเรียน\n\n-   `sector` = ประเภทของโรงเรียน (1 = Catholic, 0 = Public)\n\n-   `schid` = รหัสโรงเรียนของนักเรียน\n\n```{r echo=T}\nlibrary(dplyr)\nlibrary(haven)\nlibrary(descriptr)\ndat <- read_spss(\"datasets/HSB.SAV\")\nglimpse(dat)\n```\n\n# Six Submodels\n\n## Hierarchical General Linear models {.small}\n\n-   One-way ANOVA with random effect model\n\n-   Means as outcomes regression model (random intercept model)\n\n-   One-way ANCOVA with random effect model\n\n-   Non-randomly varying slopes\n\n-   Random-coefficient regression model\n\n-   Intercept-and-slope as outcome model\n\n# One-way ANOVA </br> with random effect model {.small}\n\nผลสัมฤทธิ์ทางการเรียนคณิตศาสตร์ของแต่ละโรงเรียนแตกต่างกันหรือไม่\n\n```{r}\nlibrary(lme4)\nlibrary(lmerTest)\nfit_nullmodel <- lmer(mathach ~ 1 + (1|schid), data = dat)\nbeta0j <- coef(fit_nullmodel)\nleft_join(dat, data.frame(schid = rownames(beta0j$schid),\n                          group_mean = beta0j$schid),\n          by = \"schid\") %>%\n  rename(group_mean = X.Intercept.)%>%\n # filter(schid %in% subset) %>%\n  ggplot()+\n  geom_density(aes(x=mathach, y = after_stat(scaled)),alpha=0.3,\n               show.legend = F, fill = \"grey\", adjust =1.5)+\n  geom_density(aes(x = mathach, y = after_stat(density)*5,fill = schid),\n               show.legend = F, alpha = 0.3, adjust = 1.2)+\n  scale_x_continuous(limits = c(-5,30))+\n  theme_light()+\n  theme(panel.grid = element_blank())+\n  ylab(\"density\")\n  \n```\n\n## กิจกรรม (5 นาที) {.small}\n\n1.  คำนวณค่าเฉลี่ยของ `mathach` ระดับโรงเรียน จะมีค่าเฉลี่ยกี่ค่า?\n\n2.  ค่าเฉลี่ย `mathach` ของโรงเรียนมีความแตกต่างกันอย่างไร?\n\n## Modelling {.small}\n\n::: columns\n::: {.column width=\"30%\"}\n**student-level model**\n\n$math_{ij} = \\beta_{0j} + \\epsilon_{ij}$\n\n**school-level model**\n\n$\\beta_{0j} = \\gamma_{00} + u_{0j}$\n\n**combined model**\n\n$math_{ij} = \\gamma_{00} + u_{0j} + \\epsilon_{ij}$\n:::\n\n::: {.column .small width=\"50%\"}\n![](images/image-2097443701.png){width=\"433\"}\n:::\n:::\n\n**มีข้อตกลงเบื้องต้นคือ**\n\n1.  $\\epsilon_{ij} \\sim N(0, \\sigma^2)$\n2.  $u_{0j} \\sim N(0, \\tau_{00})$\n\nเรียก $\\sigma^2$ = level-1 variance และ $\\tau_{00}$ = level-2 variance\n\nโมเดลข้างต้นมีพารามิเตอร์กี่ตัว อะไรบ้าง และพารามิเตอร์แต่ละตัวมีความหมาย/ให้สารสนเทศอะไร\n\n## Modelling: parameter estimation {.small}\n\n```{r echo=T}\nlibrary(lme4)\nlibrary(lmerTest)\nfit_nullmodel <- lmer(mathach ~ 1 + (1|schid), data = dat)\nsummary(fit_nullmodel)\n```\n\n## Modelling: พารามิเตอร์สำคัญ {.small}\n\nOne-way ANOVA with random effect มักใช้เป็นโมเดลเพื่อตรวจสอบโครงสร้างระดับลดหลั่นของข้อมูล สารสนเทศสำคัญ ได้แก่ point estimate และ interval estimate ของ\n\n-   $\\gamma_{00}$\n\n-   $\\sigma^2$\n\n-   $\\tau_{00}$\n\n-   Intraclass correlation = $\\rho = \\frac{\\tau_{00}}{\\tau_{00} + \\sigma^2}$\n\nมีฟังก์ชันที่สำคัญสองตัวได้แก่\n\n-   `confint(fit_nullmodel)` ซึ่งจะให้ช่วงความเชื่อมั่นของค่าประมาณพารามิเตอร์ของโมเดล\n\n-   `ranova(fit_nullmodel)` จะให้ผลการทดสอบอัตราส่วนภาวะความน่าจะเป็น (likelihood ratio test) ของ random effect term ในโมเดล\n\n## Modelling: ช่วงความเชื่อมั่น {.small}\n\nผลการวิเคราะห์นี้ให้สารสนเทศอะไร ใช้ประโยชน์อะไรได้บ้าง?\n\n```{r echo=TRUE}\nconfint(fit_nullmodel, level = 0.95)\n```\n\n## Modelling: Test for Random-Effects {.small}\n\n$H_0: \\tau_{00} =0$ vs $H_1: \\tau_{00}>0$\n\n```{r echo=T}\nranova(fit_nullmodel)\n```\n\n-   In certain cases tests of non-nested models may be generated. An example is when `(0 + poly(x, 2) | gr)` is reduced (the default) to `(1 | gr)`. To our best knowledge non-nested model comparisons are only generated in cases which are statistical nonsense anyway (such as in this example where the random intercept is suppressed).\n\n-   Note that `anova` can be used to compare two models and will often be able to produce the same tests as `ranova`. This is, however, not always the case as illustrated in the examples.\n\n## ICC {.small}\n\n$$\n\\rho = \\frac{\\tau_{00}}{\\tau_{00} + \\sigma^2}\n$$\n\n-   The ICC can be interpreted as \"the proportion of the variance explained by the grouping structure in the population\"\n\n-   ICC indexes how strongly measurements in the same group resemble each other\n\n-   the ICC - sometimes conceptualized as the measurement repeatability - \"can also be interpreted as the expected correlation between two randomly drawn units that are in the same group\" *(Hox 2010: 15)*\n\nNote: This definition might not apply to mixed models with more complex random effects structures\n\n## ICC {.small}\n\n```{r echo=T}\n#install.packages(\"performance\")\nlibrary(performance)\n#insight::get_variance(fit_nullmodel)\nicc(fit_nullmodel)\n```\n\n-   `icc()` calculates an adjusted and an unadjusted ICC, which both take all sources of uncertainty (i.e. of *all random effects*) into account. While the *adjusted ICC* only relates to the random effects, the *unadjusted ICC* also takes the fixed effects variances into account\n\n-   The fixed effects variance is added to the denominator of the formula to calculate the ICC\n\n## R2\n\n-   The coefficient of determination R2 quantifies the proportion of variance explained by a statistical model. More precisely, R2 is the proportion of the explained variance (of the full model)\n\n```{r}\nr2(fit_nullmodel)\n```\n\n-   R2 กับ ICC แตกต่างกันหรือไม่ อย่างไร?\n\n## Estimated value of $\\beta_{0j}$ {.small}\n\nNull model จะให้ค่าประมาณของค่าเฉลี่ยระดับกลุ่ม (ในที่นี้คือค่าเฉลี่ยผลสัมฤทธิ์ทางการเรียนคณิตศาสตร์) ซึ่งสามารถคำนวณได้ดังนี้\n\n```{r echo=T}\nbeta0j <- coef(fit_nullmodel)\nbeta0j$schid %>% summary()\n```\n\n## Writting Report\n\n![ที่มา : Randenbush & Bryk (2002)](images/image-606181746.png)\n\n# Means as outcomes </br> regression model {.small}\n\nโรงเรียน Catholic กับ Public มีผลสัมฤทธิ์ทางการเรียนคณิตศาสตร์แตกต่างกันอย่างไร\n\n```{r}\ndat %>% \n  mutate(sector = factor(sector, labels=c(\"Catholic\",\"Public\"))) %>%\n  group_by(sector, schid) %>%\n  summarise(mean_mathach = mean(mathach)) %>%\nggplot(aes(x = mean_mathach, y=\"\", fill = sector))+\n  geom_boxplot()+\n  theme_light()+\n  xlab(\"mean_mathach (school means)\")+\n  ylab(\"\")\n```\n\n## กิจกรรม (2 นาที) {.small}\n\nค่าเฉลี่ยผลสัมฤทธิ์ทางการเรียนคณิตศาสตร์ระดับโรงเรียนมีความแตกต่างกันระหว่างสังกัดของโรงเรียนอย่างไร?\n\n## Modelling {.small}\n\n::: {.column width=\"30%\"}\n**student-level model**\n\n$math_{ij} = \\beta_{0j} + \\epsilon_{ij}$\n\n**school-level model**\n\n$\\beta_{0j} = \\gamma_{00} +\\gamma_{01}W_j+u_{0j}$\n\n**combined model**\n\n$math_{ij} = \\gamma_{00} + \\gamma_{01}W_j +u_{0j} + \\epsilon_{ij}$\n:::\n\n::: {.column width=\"50%\"}\n![](images/image-1611863435.png){fig-align=\"center\" width=\"387\"}\n:::\n\n**มีข้อตกลงเบื้องต้นคือ**\n\n1.  $\\epsilon_{ij} \\sim N(0, \\sigma^2)$\n2.  $u_{0j} \\sim N(0, \\tau_{00})$\n\n-   โมเดลนี้มีพารามิเตอร์อะไรบ้าง และมีความหมายอย่างไร\n\n-   พารามิเตอร์เดิมที่อยู่ภายในโมเดลมีความหมายเหมือนหรือแตกต่างไปจาก null model อย่างไร\n\n## Modelling: parameter estimation {.small}\n\n```{r echo=T}\nfit_randIntercept <- lmer(mathach ~ 1 + sector + (1|schid), data = dat)\nsummary(fit_randIntercept)\n```\n\n## Modelling: Confidence Interval {.small}\n\n```{r echo=T}\nconfint(fit_randIntercept)\n```\n\n## Modelling: Test for random effects {.small}\n\nผลการวิเคราะห์ด้านล่างเป็นการทดสอบอะไร?\n\n```{r echo=T}\nranova(fit_randIntercept)\n```\n\n## Modelling: ICC {.small}\n\nadjusted กับ unadjusted ICC มีความหมายแตกต่างกันอย่างไร\n\n```{r echo=T}\nicc(fit_randIntercept)\ninsight::get_variance(fit_randIntercept)\n```\n\n## Modelling: Variance Explained {.small}\n\n```{r echo=T}\nr2(fit_randIntercept)\n```\n\n## Multiparameter tests (Deviance Test) {.small}\n\nนอกจากการทดสอบสมมุติฐานเพื่อตรวจสอบนัยสำคัญของพารามิเตอร์ภายในโมเดลเป็นรายตัวแล้ว เราสามารถทำการตรวจสอบนัยสำคัญของพารามิเตอร์หลายตัวพร้อมกันได้ด้วย ซึ่งมีประโยชน์ในเชิงของการเปรียบเทียบโมเดลคู่แข่งขัน (nested model) วิธีการหนึ่งที่สามารถนำมาใช้ได้เรียกว่า likelihood ratio test\n\nสมมุติต้องการเปรียบเทียบระหว่าง null model กับ โมเดลในกิจกรรมที่ผ่านมา (M2 model) สามารถดำเนินการได้ดังนี้\n\n$$\nH_0: M_{null} = M_2\n\\\\\nH_1: M_{null} \\neq M_2\n$$\n\n1.  คำนวณ $D_0 = -2log(L_{null})$ เรียกค่านี้ว่า deviance ของ null model\n2.  คำนวณ $D_2 = -2log(L_{M2})$ เรียกค่านี้ว่า deviance ของ M2 model\n3.  ภายใต้ $H_0$ เป็นจริง $\\chi^2 = D_0 - D_2 \\sim \\chi^2_{df}$ เมื่อ $df$ คือผลต่างของจำนวนพารามิเตอร์ระหว่างโมเดลคู่แข่งขันทั้งสอง\n\n## Multiparameter tests {.small}\n\n```{r echo=T}\nanova(fit_nullmodel, fit_randIntercept)\n```\n\n## กิจกรรม (5-6 นาที) {.small}\n\nวิเคราะห์และแปลผลโมเดลต่อไปนี้\n\n::: {width=\"30%\"}\n**student-level model**\n\n$math_{ij} = \\beta_{0j} + \\epsilon_{ij}$\n\n**school-level model**\n\n$\\beta_{0j} = \\gamma_{00} +\\gamma_{01}Sector_j+ \\gamma_{02}MeanSES + u_{0j}$\n\n**combined model**\n\n$math_{ij} = \\gamma_{00} +\\gamma_{01}Sector_j+ \\gamma_{02}MeanSES +u_{0j} + \\epsilon_{ij}$\n:::\n\n## Writting Report\n\n![ที่มา : Raudenbush & Bryk (2002)](images/image-1297874962.png)\n\n## Random Intercept model {.small}\n\n```{r}\nlibrary(gridExtra)\ntemp<-dat%>%\n  group_by(schid) %>%\n  summarise(meanses = mean(ses)) %>%\n  left_join(dat,., by=\"schid\")\nfit<- lmer(mathach ~ 1 + meanses + (1|schid), data = temp)\ncoef<-coef(fit)\ncoef <- data.frame(coef$schid, schid = rownames(coef$schid)) %>%\n  rename(group_intercept = X.Intercept.,\n         meanses_slope = meanses)\nset.seed(123)\nsubset <- sample(temp$schid,10)\np1<-coef %>% filter(schid %in% subset) %>%\n  ggplot()+\n  geom_point(data = temp %>%\n               filter(schid %in% subset), \n             aes(x=ses, y=mathach, col = schid),\n             alpha=0.5,\n             show.legend = F)+\n  geom_abline(aes(intercept = group_intercept,\n                  slope = meanses_slope, col = schid),\n              show.legend = F)+\n  scale_x_continuous(limits = c(-2,3))+\n  theme_light()+\n  ggtitle(\"random intercept model (10 schools)\")\n\np2<-coef %>%\n  ggplot()+\n  geom_point(data = temp,\n             aes(x=ses, y=mathach),\n             alpha=0.3,\n             show.legend = F)+\n  geom_abline(aes(intercept = group_intercept,\n                  slope = meanses_slope), alpha = 0.3,\n              show.legend = F)+\n  theme_light()+\n  scale_x_continuous(limits = c(-2,3))+\n  ggtitle(\"random intercept model (all schools)\")\ngrid.arrange(p1,p2, ncol=2)\n```\n\n# Random Coefficients model {.small}\n\nอิทธิพลของ SES ที่มีต่อผลสัมฤทธิ์ทางการเรียนคณิตศาสตร์ของนักเรียน มีความแตกต่างกันระหว่างโรงเรียนหรือไม่\n\n```{r}\ndat %>%\n  ggplot(aes(x=ses, y=mathach))+\n  geom_point(show.legend = F, alpha=0.1, col = \"black\")+\n  geom_smooth(method = \"lm\", se = F, show.legend = F, aes(col = schid))+\n  scale_color_manual(values = rep(scales::alpha(\"steelblue\", 0.5),160))+\n  theme_light()\n```\n\n## กิจกรรม (5 นาที)\n\nความสัมพันธ์ระหว่าง mathach กับ ses ของนักเรียนมีความเหมือนหรือแตกต่างกันระหว่างโรงเรียนอย่างไร\n\n## Modelling {.small}\n\n::: {.column width=\"30%\"}\n**student-level model**\n\n$math_{ij} = \\beta_{0j} + \\beta_{1j} SES_{ij} + \\epsilon_{ij}$\n\n**school-level model**\n\n$\\beta_{0j} = \\gamma_{00} +u_{0j}$\n\n$\\beta_{1j} = \\gamma_{10}+u_{1j}$\n\n**combined model (เขียนเอง กิจกรรม 1 นาที)**\n:::\n\n::: {.column width=\"50%\"}\n![](images/image-232996304.png){fig-align=\"center\" width=\"387\"}\n:::\n\n**มีข้อตกลงเบื้องต้นคือ**\n\n1.  $\\epsilon_{ij} \\sim N(0, \\sigma^2)$\n2.  $\\bf{u} \\sim N(0, T)$ โดยที่ $\\bf{u} = (u_{0j}, u_{1j})^T$ และ $T = \\begin{pmatrix} \\tau_{00} & \\tau_{01} \\\\ \\tau_{10} & \\tau_{11}\\end{pmatrix}$\n\n-   โมเดลนี้มีพารามิเตอร์อะไรบ้าง และมีความหมายอย่างไร\n\n## Modelling: Parameter Estimation {.small}\n\n```{r}\nfit_randCoeff <- lmer(mathach ~ 1 + ses + (1 + ses|schid), data = dat)\nsummary(fit_randCoeff)\n```\n\n## Modelling: Confidence Interval {.small}\n\n```{r}\nconfint(fit_randCoeff)\n```\n\n## Modelling: Level-1 Intercepts and Slopes {.small}\n\n```{r echo=T}\ncoef<-coef(fit_randCoeff)\ncoef <- data.frame(coef$schid, schid = rownames(coef$schid))\nhead(coef)\n```\n\n## Writting Report  {.small}\n\n![](images/image-1902336918.png)\n\n## Modelling: Level-1 Intercepts and Slopes {.small}\n\n```{r}\np1<-dat %>% group_by(schid) %>%\n  summarise(sector = mean(sector),\n            meanSES = mean(ses))%>%\n  left_join(., coef, by = \"schid\") %>%\n  rename(Intercept = X.Intercept.,\n         Slope_ses = ses) %>%\n  ggplot(aes(x = Slope_ses,\n             y = Intercept))+\n  geom_point(aes(col = factor(sector, labels = c(\"Catholic\",\"Public\"))))+\n  labs(col = \"Sector\")\n\np2<-dat %>% group_by(schid) %>%\n  summarise(sector = mean(sector),\n            meanSES = mean(ses))%>%\n  left_join(., coef, by = \"schid\") %>%\n  rename(Intercept = X.Intercept.,\n         Slope_ses = ses) %>%\n  ggplot(aes(x = Slope_ses,\n             y = Intercept))+\n  geom_point(aes(col = meanSES))\n\ngrid.arrange(p1,p2, ncol=2)\n```\n"},"formats":{"revealjs":{"execute":{"fig-width":10,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":"auto","echo":false,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":true,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","html-math-method":{"method":"mathjax","url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML-full"},"slide-level":2,"to":"revealjs","output-file":"07HLMs.html"},"language":{},"metadata":{"lang":"en","fig-responsive":false,"quarto-version":"1.2.269","auto-stretch":true,"editor":"visual","urlcolor":"steelblue","linkcolor":"steelblue","title":"Hierarchical Linear Modelling","subtitle":"2756713 MSES RES 2023","author":"ผศ.ดร.สิวะโชติ ศรีสุทธิยากร </br> ผศ.ดร.กนิษฐ์ ศรีเคลือบ","logo":"images/logo.png","footer":"[DataKruROO MSEM](https://datakruroo.netlify.app/msem/_site)","theme":"slides.scss","multiplex":true,"transition":"slide","slideNumber":true,"navigationMode":"default","scrollable":true,"chalkboard":true,"menu":{"numbers":true},"slide-tone":true}}}}