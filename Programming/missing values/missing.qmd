---
title: "Missing value analysis"
format: html
toc: true
toc-depth: 4
toc-expand: true
number-sections: true
warning: false
message: false
editor: visual
bibliography: reference.bib 
---

ข้อมูลสูญหาย (missing values) เป็นปัญหาที่พบได้ทั่วไปทั้งในการวิจัย หลายกรณีที่ค่าสูญหายส่งผลกระทบเชิงลบต่อผลการวิเคราะห์ ทำให้ผลการวิเคราะห์ที่ได้เช่น ผลการประมาณค่าพารามิเตอร์ การทดสอบสมมุติฐาน ช่วงความเชื่อมั่น หรือค่าทำนายมีแนวโน้มคลาดเคลื่อนไปจากความเป็นจริง ดังนั้นการจัดการกับข้อมูลสูญหายอย่างเหมาะสมจึงเป็นสิ่งจำเป็นในการวิเคราะห์ข้อมูล ทั้งนี้เพื่อรับประกันว่าผลการวิเคราะห์ที่ได้จะปราศจากหรือมีความลำเอียงน้อยที่สุด

สาเหตุการสูญหายของข้อมูลเป็นไปได้อย่างหลากหลาย ทั้งการจงใจหรือลืมที่จะให้ข้อมูลของกลุ่มเป้าหมาย ความผิดพลาดในการบันทึกข้อมูล อุปสรรคอื่น ๆ ในการให้ข้อมูล ไปจนถึงการออกแบบการเก็บรวบรวมและจัดกระทำข้อมูล อย่างไรก็ตามไม่ว่าสาเหตุจะเป็นอะไรอาจจัดกลุ่มสาเหตุดังกล่าวได้เป็น 3 ด้านคือ สาเหตุด้านผู้ให้ข้อมูล ด้านเครื่องมือที่ใช้วัดค่าสังเกตหรือเก็บรวบรวมข้อมูล และด้านการเก็บรวบรวมและการจัดกระทำข้อมูลของผู้วิจัย/ผู้วิเคราะห์

## สาเหตุของการสูญหายของข้อมูล

การสูญหายของข้อมูลเป็นไปได้จากสาเหตุที่หลากหลาย ขึ้นอยู่กับบริบทและวิธีการเก็บรวบรวมข้อมูลที่ผู้วิจัยใช้ด้วย โดยรวมอาจจำแนกสาเหตุการสูญหายของข้อมูลได้เป็นดังนี้

**1. สาเหตุจากผู้ให้ข้อมูลหรือวิธีการวัดค่าสังเกต** ซึ่งเป็นไปได้หลากหลายลักษณะ เช่น ในการวิจัยเชิงสำรวจที่มีการเก็บรวบรวมข้อมูลด้วยแบบสอบถามหรือแบบวัด มีความเป็นไปได้ที่ผู้ตอบอาจลืมตอบคำถามในบางข้อ หรือเลือกที่จะไม่ตอบเพราะไม่มีความรู้ หรือไม่สนใจที่จะให้ข้อมูล หรืออาจมีความสะดวกในการตอบคำถาม ปัจจัยดังกล่าวล้วนเป็นสาเหตุที่ทำให้เกิดค่าสูญหายทั้งสิ้น

อีกลักษณะหนึ่งคือการขาดหายไปจากการที่หน่วยข้อมูลบางหน่วยไม่ได้เข้าร่วมกิจกรรมที่กำหนดไว้สำหรับการเก็บรวบรวมข้อมูล เช่น การออกแบบการเก็บรวบรวมข้อมูลในชั้นเรียน หรือเป็นการบ้านให้กับนักเรียน แต่อาจมีนักเรียนบางคนที่ไม่ได้เข้าเรียนในวันดังกล่าว หรือไม่ส่งการบ้าน สถานการณ์ดังกล่าวทำให้เกิดค่าสูญหายได้เช่นเดียวกัน

ความผิดพลาดของอุปกรณ์วัดก็เป็นปัจจัยในด้านนี้ด้วย เช่น ผู้วิจัยอาจเลือกใช้ smart watch เป็นเครื่องมือในการวัดชีพจร และตัวชี้วัดทางกายภาพของผู้เรียนระหว่างการจัดการเรียนรู้ อาจมีความเป็นไปได้ที่ผู้เรียนบางคนไม่ได้ใส่อุปกรณ์อย่างถูกต้อง หรืออุปกรณ์ทำงานผิดพลาดจากสาเหตุอื่น ๆ ทำให้ไม่สามารถเก็บรวบรวมข้อมูลได้อย่างครบถ้วน

การสูญหายที่เกี่ยวข้องในประเด็นนี้อาจเกิดจากอุปสรรคในการเข้าถึงสื่อหรือเครื่องมือที่การเก็บรวบรวมข้อมูลด้วย เช่น ผู้วิเคราะห์อาจออกแบบการเก็บรวบรวมข้อมูลโดยใช้การตอบแบบสอบถามบน google form หรือ application อื่นที่ต้องใช้อุปกรณ์คอมพิวเตอร์หรือ smart device ในการเข้าถึง แต่หากช่วงเวลาที่ดำเนินการเก็บรวบรวมข้อมูล หน่วยข้อมูลไม่มีอุปกรณ์หรือ internet หรือมีอุปสรรคที่ไม่สามารถเข้าถึงแบบสอบถามดังกล่าวได้ ก็อาจเป็นสาเหตุที่ทำให้เกิดค่าสูญหายได้เช่นเดียวกัน

**2. สาเหตุจากการยุบรวมข้อมูลจากแหล่งข้อมูลที่หลากหลาย** การวิเคราะห์ข้อมูลโดยเฉพาะในโครงการที่ใช้ฐานข้อมูลทุติยภูมิในปัจจุบัน มักจะต้องมีการเชื่อมโยงหรือรวมข้อมูลระหว่างฐาน ทั้งการเชื่อมโยงตามแนวคอลัมน์เพื่อให้ได้ข้อมูลคุณลักษณะหรือตัวแปรของหน่วยข้อมูลที่มีความสมบูรณ์ หรือการเชื่อมโยงตามแนวแถวเพื่อให้ได้หน่วยข้อมูลที่ครอบคลุมหรือเป็นตัวแทนของกลุ่มเป้าหมาย อย่างไรก็ตามการเชื่อมโยงข้อมูลจากหลายฐานข้อมูลมีโอกาสที่จะเกิดค่าสูญหายอันเนื่องมาจากรูปแบบหรือระบบบันทึกเก็บข้อมูลระหว่างฐานที่แตกต่างกัน เช่น

ความแตกต่างในรูปแบบของรหัสที่จะใช้เชื่อมโยง กล่าวคือในฐานข้อมูลหนึ่งอาจะใช้รูปแบบรหัสบ่งชี้หน่วยข้อมูลเป็นรูปแบบหนึ่ง แต่อีกฐานข้อมูลหนึ่งใช้อีกรูปแบบหนึ่ง ลักษณะนี้ทำให้การเชื่อมโยงข้อมูลจากฐานข้อมูลทั้งสองไม่สามารถทำได้จากรหัสบ่งชี้หน่วยข้อมูล แต่จะต้องเลี่ยงไปใช้ข้อมูลของตัวแปรอื่น ๆ เข้ามาช่วย ซึ่งอาจทำให้ไม่สามารถเชื่อมโยงข้อมูลทั้งสองฐานได้อย่างสมบูรณ์

รูปแบบการจัดเก็บข้อมูลที่แตกต่างกัน เช่น ฐานข้อมูลหนึ่งบันทึกวันที่ในรูปแบบ DD/MM/YYYY แต่อีกฐานหนึ่งอาจบันทึกในรูปแบบ MM/DD/YYYY หากมีการใช้ข้อมูลวันที่เป็นตัวแปรหนึ่งที่เชื่อมโยงฐานข้อมูลเข้ากัน จะทำให้ผลลัพธ์ที่ได้เป็นค่าสูญหาย เพราะไม่สามารถเชื่อมโยงฐานทั้งสองเข้าด้วยกันได้

ความไม่สอดคล้องของข้อมูลในตัวแปรเดียวกัน เช่น ฐานข้อมูลด้านการศึกษาหนึ่งอาจบันทึกสถานะของนักเรียนเป็น “จบการศึกษา” หรือ “ยังศึกษาอยู่” ขณะที่อีกฐานข้อมูลอาจใช้คำว่า “สำเร็จการศึกษา” หรือ “ลงทะเบียนเรียน” ความแตกต่างในคำอธิบายเหล่านี้อาจทำให้เกิดความสับสนหรือข้อมูลสูญหายเมื่อต้องเชื่อมโยงกัน ซึ่งอาจทำให้ผลลัพธ์ที่ได้มีการตัดค่าที่เป็นปัญหานี้ออกไปเกิดเป็นค่าสูญหาย

การขาดข้อมูลในฐานข้อมูลบางส่วน อาจเกิดขึ้นโดยเฉพาะในการรวมข้อมูลตามแถว กล่าวคือ ฐานข้อมูลหนึ่งอาจมีข้อมูลของโรงเรียนที่สังกัดเขตพื้นที่หนึ่งในด้านต่าง ๆ อย่างครบถ้วน แต่เมื่อเชื่อมโยงฐานข้อมูลนี้กับเขตพื้นที่อื่นที่อาจมีข้อมูลไม่สมบูรณ์ในบางตัวแปร ผลลัพธ์ที่ได้จะได้ชุดข้อมูลที่มีค่าสูญหายในตัวแปรดังกล่าว

**3. การเก็บรวบรวมข้อมูลระยะยาว** การเก็บรวบรวมข้อมูลระยะยาวที่ต้องเก็บข้อมูลจากหน่วยข้อมูลเดียวกันหลาย ๆ ครั้ง หากระหว่างทางมีหน่วยข้อมูลออกจากระบบ เช่น ผู้ตอบแบบสอบถามหรือผู้เข้าร่วมการศึกษาไม่สามารถเข้าร่วมการเก็บข้อมูลในช่วงใดช่วงหนึ่งได้ อาจเป็นเพราะย้ายถิ่นฐาน, เปลี่ยนสถานะ, หรือเลิกเข้าร่วมการศึกษา สิ่งนี้จะทำให้เกิดการสูญหายของข้อมูลในช่วงเวลานั้นได้ ข้อมูลขาดหายตามเวลา (attrition) เป็นปัญหาสำคัญในงานวิจัยระยะยาว เพราะอาจทำให้ความต่อเนื่องของข้อมูลไม่สมบูรณ์ และทำให้ผลลัพธ์ที่ได้จากการวิเคราะห์ไม่สะท้อนความเป็นจริงทั้งหมดของหน่วยข้อมูลที่ตั้งใจศึกษา

นอกจากนี้หากการออกกลางคันของผู้ให้ข้อมูลนี้เกิดขึ้นอย่างเป็นระบบ เช่น ผู้เข้าร่วมจากกลุ่มใดกลุ่มหนึ่งออกจากระบบมากกว่ากลุ่มอื่น อาจทำให้เกิดอคติในผลการวิเคราะห์ (attrition bias) ซึ่งจำเป็นที่จะต้องได้รับการจัดการก่อนเพื่อปรับปรุงผลการวิเคราะห์ให้มีความแม่นยำ และน่าเชื่อถือมากขึ้น

## ประเภทของค่าสูญหาย

การจำแนกประเภทของค่าสูญหายสามารถจำแนกได้หลายลักษณะ ขึ้นกับบริบทที่ทำการวิเคราะห์ค่าสูญหาย หรือเกณฑ์ที่ใช้ในการพิจารณา โดยทั่วไปอาจจำแนกค่าสูญหายออกเป็น 3 ประเภท ได้แก่ (1) ข้อมูลสูญหายจากการเก็บข้อมูลหรือการจัดกระทำข้อมูลไม่เหมาะสม (2) ข้อมูลสูญหายจากปรากฏการณ์สุ่ม และ (3) ข้อมูลสูญหายจากสาเหตุเฉพาะ รายละเอียดมีดังนี้

### ข้อมูลสูญหายจากการเก็บข้อมูลหรือการจัดกระทำข้อมูลไม่เหมาะสม

การวิเคราะห์การเรียนรู้ของนักเรียน ผู้วิเคราะห์อาจมีการออกแบบการเก็บรวบรวมข้อมูล**การมาเรียนของนักเรียน** โดยมีการบันทึกข้อมูลไว้ 2 ลักษณะ ได้แก่ มาเรียนตรงเวลา (`ontime`) และมาเรียนสาย (`late`) แต่เมื่อเก็บรวบรวมข้อมูลเสร็จพบว่ามีนักเรียนบางคนไม่มีข้อมูลในตัวแปรนี้ซึ่งทำให้กลายเป็นค่าสูญหาย อย่างไรก็ตามเมื่อพิจารณาเพิ่มเติมพบว่า นักเรียนกลุ่มที่ไม่มีข้อมูลนี้เป็นนักเรียนที่ไม่ได้มาเรียนในวันที่เก็บรวบรวมข้อมูล ทำให้ไม่สามารถระบุได้ว่ามาตรงเวลาหรือมาสาย สภาพดังกล่าวสะท้อนว่าตัวแปรการมาเรียนของนักเรียนที่มีค่าสังเกตเพียง 2 ค่าดังกล่าวไม่เพียงพอ การแก้ปัญหาดังกล่าวสามารถทำได้ด้วยการจัดการข้อมูลใหม่ โดยปรับโครงการของตัวแปรใหม่ ให้มีค่าที่เป็นไปได้ 3 ค่า อีกค่าหนึ่งที่เพิ่มขึ้นมาคือ นักเรียนที่ไม่ได้มาเรียน (`absent`) จะทำให้ตัวแปรนี้มีข้อมูลที่สมบูรณ์

การวิเคราะห์ข้อมูลโดยเฉพาะในโครงการที่ใช้ฐานข้อมูลทุติยภูมิในปัจจุบัน มักจะต้องมีการเชื่อมโยงหรือรวมข้อมูลระหว่างฐาน ทั้งการเชื่อมโยงตามแนวคอลัมน์เพื่อให้ได้ข้อมูลคุณลักษณะหรือตัวแปรของหน่วยข้อมูลที่มีความสมบูรณ์ หรือการเชื่อมโยงตามแนวแถวเพื่อให้ได้หน่วยข้อมูลที่ครอบคลุมหรือเป็นตัวแทนของกลุ่มเป้าหมาย อย่างไรก็ตามการเชื่อมโยงข้อมูลจากหลายฐานข้อมูลมีโอกาสที่จะเกิดค่าสูญหายอันเนื่องมาจากรูปแบบหรือระบบบันทึกเก็บข้อมูลระหว่างฐานที่แตกต่างกัน เช่น

-   ความแตกต่างในรูปแบบของรหัสที่จะใช้เชื่อมโยง กล่าวคือในฐานข้อมูลหนึ่งอาจะใช้รูปแบบรหัสบ่งชี้หน่วยข้อมูลเป็นรูปแบบหนึ่ง แต่อีกฐานข้อมูลหนึ่งใช้อีกรูปแบบหนึ่ง ลักษณะนี้ทำให้การเชื่อมโยงข้อมูลจากฐานข้อมูลทั้งสองไม่สามารถทำได้จากรหัสบ่งชี้หน่วยข้อมูล แต่จะต้องเลี่ยงไปใช้ข้อมูลของตัวแปรอื่น ๆ เข้ามาช่วย ซึ่งอาจทำให้ไม่สามารถเชื่อมโยงข้อมูลทั้งสองฐานได้อย่างสมบูรณ์

-   รูปแบบการจัดเก็บข้อมูลที่แตกต่างกัน เช่น ฐานข้อมูลหนึ่งบันทึกวันที่ในรูปแบบ DD/MM/YYYY แต่อีกฐานหนึ่งอาจบันทึกในรูปแบบ MM/DD/YYYY หากมีการใช้ข้อมูลวันที่เป็นตัวแปรหนึ่งที่เชื่อมโยงฐานข้อมูลเข้ากัน จะทำให้ผลลัพธ์ที่ได้เป็นค่าสูญหาย เพราะไม่สามารถเชื่อมโยงฐานทั้งสองเข้าด้วยกันได้

-   ความไม่สอดคล้องของข้อมูลในตัวแปรเดียวกัน เช่น ฐานข้อมูลด้านการศึกษาหนึ่งอาจบันทึกสถานะของนักเรียนเป็น “จบการศึกษา” หรือ “ยังศึกษาอยู่” ขณะที่อีกฐานข้อมูลอาจใช้คำว่า “สำเร็จการศึกษา” หรือ “ลงทะเบียนเรียน” ความแตกต่างในคำอธิบายเหล่านี้อาจทำให้เกิดความสับสนหรือข้อมูลสูญหายเมื่อต้องเชื่อมโยงกัน ซึ่งอาจทำให้ผลลัพธ์ที่ได้มีการตัดค่าที่เป็นปัญหานี้ออกไปเกิดเป็นค่าสูญหาย

-   การขาดข้อมูลในฐานข้อมูลบางส่วน อาจเกิดขึ้นโดยเฉพาะในการรวมข้อมูลตามแถว กล่าวคือ ฐานข้อมูลหนึ่งอาจมีข้อมูลของโรงเรียนที่สังกัดเขตพื้นที่หนึ่งในด้านต่าง ๆ อย่างครบถ้วน แต่เมื่อเชื่อมโยงฐานข้อมูลนี้กับเขตพื้นที่อื่นที่อาจมีข้อมูลไม่สมบูรณ์ในบางตัวแปร ผลลัพธ์ที่ได้จะได้ชุดข้อมูลที่มีค่าสูญหายในตัวแปรดังกล่าว

### ข้อมูลสูญหายจากปรากฏการณ์สุ่ม

การสูญหายในลักษณะที่สองคือการสูญหายจากปรากฏการณ์สุ่ม เรียกได้ว่าเป็นการสูญหายในเชิงสถิติ [@little2014statistical] โดยสามารถจำแนกได้เป็น 2 ประเภทได้แก่ การสูญหายแบบสุ่มสมบูรณ์ และการสูญหายแบบสุ่ม รายละเอียดมีดังนี้

#### การสูญหายแบบสุ่มสมบูรณ์ (missing completely at random: MCAR)

ข้อมูลสูญหายในตัวแปร $y$ จะเป็นการสูญหายแบบสุ่มสมบูรณ์เมื่อการสูญหายดังกล่าวไม่เกี่ยวข้องหรือไม่สัมพันธ์กับตัวแปรใด ๆ ทั้งที่สังเกตค่าได้และไม่สามารถสังเกตค่าได้ เราสามารถเขียนสมการทางคณิตศาสตร์เพื่ออธิบายการสูญหายแบบ MCAR ได้ดังนี้

กำหนดให้ $m_{ij}$ เป็นตัวแปร dummy แสดงการสูญหายของหน่วยข้อมูลที่ i ในตัวแปรที่ j ถ้ามีค่าเท่ากับ 1 คือเป็นค่าสูญหาย และ $x_{obs}$ คือข้อมูลที่ผู้วิเคราะห์สามารถสังเกตได้ในชุดข้อมูล ส่วน $x_{mis}$ คือข้อมูลที่สูญหาย กลไกลการสูญหายแบบ MCAR คือความน่าจะเป็นในการสูญหายของหน่วยข้อมูลที่ $i$ ในตัวแปรที่ $j$ เป็นค่าคงที่ ที่ไม่สัมพันธ์หรือขึ้นกับข้อมูลที่สังเกตได้และข้อมูลสูญหาย ดังนี้

$$
p(m_{ij} = 1 | x_{obs}, x_{mis}) = p
$$

ข้อมูลที่ได้จากการ simulation ด้านล่างแสดงกลไกการเกิดค่าสูญหายแบบ MCAR ได้อย่างชัดเจน

```{r}
library(tidyverse)
## ชุดข้อมูลสมบูรณ์
data <- read_csv("/Users/choat/Downloads/exam.csv")
glimpse(data)
```

สมมุติว่ามีการสูญหายแบบ MCAR ขึ้นบนตัวแปร `learning_performance` ร้อยละ 20 สถานการณ์นี้เทียบเท่ากับการสุ่มตัวอย่างแบบ SRS ออกจาก vector ของ `ach` ในสัดส่วน 0.2 ดังนี้

```{r fig.width = 9, fig.height=3}
library(patchwork)
set.seed(123)
## สร้างค่าสูญหายแบบ MCAR
data <- data %>% 
  mutate(learning_performance_mcar = 
        ifelse(runif(387,0,1)<0.2,NA, 
        learning_performance)) 

## นับจำนวนค่าสูญหายในแต่ละตัวแปร
data |> is.na() |> colSums()
p1<-data %>% 
  pivot_longer(cols=starts_with("learning")) %>% 
  ggplot(aes(x=value))+
  geom_histogram(aes(fill = name))+
  theme(legend.position = "top")+
  labs(fill = "")

p2<-data %>% 
  pivot_longer(cols=starts_with("learning")) %>% 
  ggplot(aes(x = value, y=name))+
  geom_boxplot(aes(fill = name))+
  theme(legend.position = "none")+
  ylab("")


p1+p2

```

```{r}
data %>% 
  ggplot(aes(x=learning_performance))+
  geom_point(aes(y=ach),alpha=0.1)+
  geom_point(data = data %>% filter(is.na(learning_performance_mcar)==T), 
             aes(y=ach), col="maroon", shape = 2)+
  theme_light()+
  theme(panel.grid = element_blank())
```

จากรูปข้างต้นจะเห็นว่าชุดข้อมูลที่มีข้อมูลสมบูรณ์และข้อมูลสูญหายแบบ MCAR มีลักษณะการแจกแจงที่คล้ายคลึงกัน ทั้งนี้เป็นเพราะการสูญหายแบบ MCAR ไม่ได้มีความสัมพันธ์กับตัวแปรใด ดังนั้นการสูญหายแบบ MCAR ไม่ได้ทำให้เกิด bias ในการวิเคราะห์ แต่อาจมีผลกับ precision ของการวิเคราะห์ ลองพิจารณาการเปรียบเทียบผลการวิเคราะห์สถิติบรรยาย และสหสัมพันธ์ระหว่างตัวแปรในชุดข้อมูล ระหว่างสถานการณ์ที่มีข้อมูลสมบูรณ์และมีข้อมูลสูญหาย

```{r}
data %>% 
  dplyr::select(learning_performance, ach, learning_performance_mcar) %>% 
  pivot_longer(cols = c(learning_performance, 
                        learning_performance_mcar)) %>% 
  group_by(name) %>% 
  summarise(n= sum(!is.na(value)),
            mean = mean(value, na.rm = T),
            sd = sd(value,na.rm = T),
            se = sd/sqrt(n),
            median = median(value,na.rm = T),
            cor = cor(ach, value, use = "complete.obs"),
            r2 = cor^2)
```

ผลการวิเคราะห์ข้างต้นจะเห็นว่าข้อมูลทั้งสองชุดให้ผลการวิเคราะห์ที่สอดคล้องกันสะท้อนว่าไม่ได้มีปัญหาความลำเอียงในการประมาณค่าพารามิเตอร์ อย่างไรก็ตามหากพิจารณาที่ค่าคลาดเคลื่อนมาตรฐานจะพบว่าข้อมูลที่มีการสูญหายแบบ MCAR มีแนวโน้มจะมีค่าคลาดเคลื่อนมาตรฐานของค่าเฉลี่ยสูงกว่าข้อมูลสมบูรณ์ ซึ่งบ่งชี้ผลกระทบของการขาดหายไปของข้อมูลที่มีต่อความน่าเชื่อถือ

เพื่อยืนยันข้อสรุปข้างต้นเราสามารถทำซ้ำกระบวนการข้างต้นเพื่อวิเคราะห์แนวโน้มความแม่นยำและความน่าเชื่อถือของการประมาณค่าพารามิเตอร์สถิติบรรยายและสหสัมพันธ์ระหว่างตัวแปรในสถานการณ์ที่มีการสูญหายแบบ MCAR ได้ดังนี้

```{r echo = F}
library(tidyverse)
library(purrr)

# จำนวนรอบการจำลอง
n_simulations <- 1000

# ฟังก์ชันสำหรับสร้างชุดข้อมูลที่มีค่าสูญหายแบบ MCAR
create_mcar <- function(data) {
  data %>% 
    mutate(learning_performance_mcar = 
             ifelse(runif(n(), 0, 1) < 0.2, NA, learning_performance))
}

# ทำการจำลอง 1000 รอบและเก็บผลลัพธ์
simulated_datasets <- map(1:n_simulations, ~create_mcar(data))

# ฟังก์ชันคำนวณสถิติเชิงบรรยาย
calc_summary_stats <- function(sim_data) {
  sim_data %>%
    dplyr::select(learning_performance, ach, learning_performance_mcar) %>%
    pivot_longer(cols = c(learning_performance, learning_performance_mcar)) %>%
    group_by(name) %>%
    summarise(
      n = sum(!is.na(value)),
      mean = mean(value, na.rm = TRUE),
      sd = sd(value, na.rm = TRUE),
      se = sd / sqrt(n),
      median = median(value, na.rm = TRUE),
      cor = cor(ach, value, use = "complete.obs"),
      r2 = cor^2
    )
}

# คำนวณสถิติเชิงบรรยายสำหรับแต่ละชุดข้อมูลจำลอง
summary_stats <- map_dfr(simulated_datasets, ~calc_summary_stats(.x), .id = "simulation")

summary_stats |> 
    filter(name == "learning_performance_mcar") |> 
    pivot_longer(cols = 4:9, names_to = "stat", values_to = "value") |> 
    ggplot(aes(x = value))+
    geom_histogram(fill = "steelblue")+
    geom_boxplot(aes(y = 0),width = 20,fill = "white", 
    outlier.size = 0.9)+
    geom_vline(data = summary_stats |> 
    filter(name == "learning_performance") |> 
    pivot_longer(cols = 4:9, names_to = "stat", values_to = "value"), 
    aes(xintercept = value), linetype=2)+
    facet_wrap(~stat, scales = "free_x")+
    theme_light()+
    theme(strip.text = element_text(color = "black"))
```

ผลการวิเคราะห์ข้างต้นจะเห็นว่า การประมาณค่าพารามิเตอร์ที่ทั้งส่วนที่เป็นการบรรยายสภาพของตัวแปร และความสัมพันธ์ระหว่างตัวแปรสามารถประมาณได้โดยไม่ลำเอียง แต่เมื่อพิจารณาค่าคลาดเคลื่อนมาตรฐาน เช่น ค่าคลาดเคลื่อนมาตรฐานของค่าเฉลี่ย (se) มีแนวโน้มที่จะประมาณค่าได้สูงขึ้น เนื่องจากขนาดตัวอย่างที่ลดลง

#### การสูญหายแบบสุ่ม (missing at random: MAR)

ข้อมูลสูญหายในตัวแปร $y$ จะเป็นการสูญหายแบบสุ่มเมื่อการสูญหายดังกล่าวมีความสัมพันธ์กับตัวแปรที่สังเกตค่าได้ เราสามารถเขียนสมการทางคณิตศาสตร์เพื่ออธิบายการสูญหายแบบ MAR ได้ดังนี้

$$
p(m_{ij} = 1 | x_{obs}, x_{mis}) = f(x_{obs})
$$

กล่าวคือ ถ้าการมีอยู่ของข้อมูลที่ขาดหายไปในตัวแปรหนึ่ง ๆ มีความสัมพันธ์กับตัวแปรอื่น ๆ ที่ผู้วิเคราะห์มีข้อมูลสามารถสังเกตค่าได้ โดยไม่เกี่ยวข้องกับข้อมูลที่สูญหายไปของตัวแปรนั้น ข้อมูลนั้นจะถือว่าขาดหายไปแบบ MAR กลไกการสูญหายแบบ MAR สามารถอธิบายในเชิงคณิตศาสตร์ได้ดังนี้

ข้อมูลที่ได้จากการ simulation ด้านล่างแสดงลักษณะการสูญหายแบบ MAR

```{r fig.width = 8, fig.height=3}
set.seed(123)
data <- data %>% 
  ## สร้างตัวแปรใหม่ที่สูญหายแบบ MAR โดยมีความสัมพันธ์กับ ach และ engage
  mutate(learning_performance_mar = case_when(
     ach < 40 | engage == "moderate engage"  ~ ifelse(runif(387,0,1)<0.8,NA, learning_performance) ,
    .default = learning_performance
  )
  )
p1<-data %>% 
  pivot_longer(cols=starts_with("learning")) %>% 
  ggplot(aes(x=value))+
  geom_histogram(aes(fill = name))+
  labs(fill = "")+
  theme(legend.position = "none",
        legend.direction = "horizontal")


p2<-data %>% 
  pivot_longer(cols=starts_with("learning")) %>% 
  ggplot(aes(x = value, y=name))+
  geom_boxplot(aes(fill = name))+
  ylab("")+
    theme(legend.position = "none")


p1+p2
```

```{r}
p1<-data %>% 
  ggplot(aes(x = learning_performance)) +
  geom_point(aes(y = ach), alpha = 0.1) +
  geom_point(data = data %>% filter(is.na(learning_performance_mar) == T), 
             aes(y = ach), col = "maroon", shape = 2) +
  geom_smooth(method = "lm", aes(x = learning_performance_mcar, y = ach, color = "MCAR"),
              se = F) +
  geom_smooth(method = "lm", aes(x = learning_performance_mar, y = ach, color = "MAR"),
              se = F) +
  theme_light() +
  scale_color_manual(values = c("MCAR" = "grey", "MAR" = "maroon")) +
  theme(panel.grid = element_blank()) +
  labs(color = "Missing Data Type")

p1

data %>% 
  dplyr::select(learning_performance,learning_performance_mcar, 
         learning_performance_mar, ach) %>% 
  pivot_longer(cols = c(learning_performance,
                        learning_performance_mcar, 
                        learning_performance_mar)) %>%
  group_by(name) %>% 
  summarise(mean = mean(value, na.rm = T),
            sd = sd(value,na.rm = T),
            median = median(value,na.rm = T),
            cor = cor(ach, value, use = "complete.obs"),
            r2 = cor^2)
```

ในทำนองเดียวกัน เราลอง simulate ข้อมูลสูญหายแบบ MAR จำนวน 1000 ชุด จากนั้นประมาณค่าพารามิเตอร์ต่าง ๆ โดยเปรียบเทียบกับ MCAR ที่ได้ทำไว้ก่อนหน้า ผลการวิเคราะห์จะเห็นว่าเมื่อเกิดค่าสูญหายแบบ MAR การประมาณค่าพารามิเตอร์ต่าง ๆ มีแนวโน้มจะลำเอียงและขาดความน่าเชื่อถือ

```{r echo = F}
library(tidyverse)
library(purrr)

# จำนวนรอบการจำลอง
n_simulations <- 1000

# ฟังก์ชันสำหรับสร้างชุดข้อมูลที่มีค่าสูญหายแบบ MAR
create_mar <- function(data){
  data %>% 
  ## สร้างตัวแปรใหม่ที่สูญหายแบบ MAR โดยมีความสัมพันธ์กับ ach และ engage
  mutate(learning_performance_mar = case_when(
     ach < 40 | engage == "moderate engage"  ~ ifelse(runif(387,0,1)<0.8,NA, learning_performance) ,
    .default = learning_performance
  )
  )
}

calc_summary_stats <- function(sim_data) {
  sim_data %>%
    dplyr::select(learning_performance, ach, learning_performance_mar) %>%
    pivot_longer(cols = c(learning_performance, learning_performance_mar)) %>%
    group_by(name) %>%
    summarise(
      n = sum(!is.na(value)),
      mean = mean(value, na.rm = TRUE),
      sd = sd(value, na.rm = TRUE),
      se = sd / sqrt(n),
      median = median(value, na.rm = TRUE),
      cor = cor(ach, value, use = "complete.obs"),
      r2 = cor^2
    )
}


# ทำการจำลอง 1000 รอบและเก็บผลลัพธ์
simulated_datasets_mar <- map(1:n_simulations, ~create_mar(data))

# คำนวณสถิติเชิงบรรยายสำหรับแต่ละชุดข้อมูลจำลอง
summary_stats_mar <- map_dfr(simulated_datasets_mar, ~calc_summary_stats(.x), .id = "simulation")

summary_stats_mar |> 
    filter(name == "learning_performance_mar") |> 
    pivot_longer(cols = 4:9, names_to = "stat", values_to = "value") |> 
    ggplot(aes(x = value))+
    geom_histogram(fill = "steelblue")+
    geom_boxplot(aes(y = 0),width = 20,fill = "white", 
    outlier.size = 0.9)+
    geom_vline(data = summary_stats |> 
    filter(name == "learning_performance") |> 
    pivot_longer(cols = 4:9, names_to = "stat", values_to = "value"), 
    aes(xintercept = value), linetype=2)+
    facet_wrap(~stat, scales = "free_x")+
    theme_light()+
    theme(strip.text = element_text(color = "black"))
```

### ข้อมูลสูญหายจากสาเหตุเฉพาะ

สาเหตุเฉพาะหรือ Missing Not at Random (MNAR) คือ การสูญหายที่มีความสัมพันธ์กับค่าของตัวแปรที่สูญหายไป นอกจากนี้การสูญหายแบบ MNAR ยังอาจมีความสัมพันธ์ร่วมกับตัวแปรที่สังเกตค่าได้อีกด้วย เราสามารถเขียนสมการทางคณิตศาสตร์เพื่ออธิบายการสูญหายแบบ MNAR ได้ดังนี้

$$
p(m_{ij} = 1 | x_{obs}, x_{mis}) = f(x_{obs}, x_{mis})
$$

กล่าวง่าย ๆ ว่า MNAR เป็นการสูญหายที่เกิดขึ้นโดยสัมพันธ์กับค่าที่สูญหาย การสูญหายแบบนี้ไม่สามารถอธิบายได้ด้วยข้อมูลที่มี เช่น

-   ผู้ตอบไม่ตอบคำถามเกี่ยวกับรายได้เพราะรายได้ของตนเองสูงเกินไป

-   นักเรียนที่มีคะแนนต่ำมากไม่ตอบคำถาม ไม่เข้าเรียน หรือไม่ส่งงานทำให้ครูไม่สามารถประเมินคะแนนให้นักเรียนได้

-   ผู้เรียนที่เรียนไม่เก่ง drop out ออกไปจากชั้นเรียนระหว่างการเรียนรู้ทำให้ไม่สามารถประเมินผลการเรียนรู้หรือตัวแปรที่เกี่ยวข้องได้

ผลลัพธ์ด้านล่างแสดงผลการเปรียบเทียบการวิเคราะห์ในสถานการณ์ที่ข้อมูลสูญหายแบบ MNAR เปรียบเทียบกับการสูญหายแบบอื่น โดยใช้ข้อมูลจำลอง

```{r fig.width = 8, fig.height=3, warning = F}
set.seed(123)
data <- data %>% 
  mutate(learning_performance_mnar = case_when(
    learning_performance < 30  ~ ifelse(runif(387,0,1)<0.8,NA, learning_performance) ,
    .default = learning_performance
  )
  )
p1<-data %>% 
  pivot_longer(cols=starts_with("learning")) %>% 
  ggplot(aes(x=value))+
  geom_histogram(aes(fill = name))+
  theme(legend.position = "none")

p2<-data %>% 
  pivot_longer(cols=starts_with("learning")) %>% 
  ggplot(aes(x = value, y=name))+
  geom_boxplot(aes(fill = name))

p1+p2
```

```{r}
data %>% 
  ggplot(aes(x=learning_performance))+
  geom_point(aes(y=ach),alpha=0.1)+
  geom_point(data = data %>% filter(is.na(learning_performance_mnar)==T), 
             aes(y=ach), col="maroon", shape = 2)+
  theme_light()+
  theme(panel.grid = element_blank())

data %>% 
  dplyr::select(learning_performance, learning_performance_mcar, 
         learning_performance_mar, learning_performance_mnar, ach) %>% 
  pivot_longer(cols = starts_with("learning")) %>% 
  group_by(name) %>% 
  summarise(mean = mean(value, na.rm = T),
            sd = sd(value,na.rm = T),
            median = median(value,na.rm = T),
            cor = cor(ach, value, use = "complete.obs"),
            r2 = cor^2)
```

การตรวจสอบ MNAR ค่อนข้างลำบากเมื่อเปรียบเทียบกับการวิเคราะห์กลไกการสูญหายแบบอื่น ตัวอย่างด้านล่างแสดงให้เห็นว่าเมื่อมีการสูญหายแบบ MAR ผลการวิเคราะห์ความสัมพันธ์ระหว่างการสูญหายกับตัวแปรในชุดข้อมูลมีลักษณะที่เหมือนกับผลการวิเคราะห์ที่ได้จาก MAR กล่าวคือการแยกกลไกการสูญหายแบบ MAR และ MNAR ออกจากกันด้วยข้อมูลเชิงปริมาณแต่เพียงอย่างเดียวทำได้ยากหรืออาจทำไม่ได้เลย

```{r fig.width = 10}
library(naniar)
p1<-data |> 
  bind_shadow() |>  ## สร้าง shadow matrix
  ggplot(aes(x = learning_performance_mcar_NA, y=ach))+
  geom_boxplot()+
  ggtitle("MCAR Mechanism")

p2<-data |> 
  bind_shadow() |>  ## สร้าง shadow matrix
  ggplot(aes(x = learning_performance_mar_NA, y=ach))+
  geom_boxplot()+
  ggtitle("MAR Mechanism")

p3<-data |> 
  bind_shadow() |>  ## สร้าง shadow matrix
  ggplot(aes(x = learning_performance_mnar_NA, y=ach))+
  geom_boxplot()+
  ggtitle("MNAR Mechanism")

p1+p2+p3
```

จากลักษณะการสูญหายแบบ MNAR ที่มีกลไกที่แฝงอยู่เบื้องหลังค่าที่สูญหายอีกทีหนึ่งนี้ การตรวจสอบจึงค่อนข้างยากลำบาก แต่ก็สามารถดำเนินการได้ โดยวิธีการตรวจสอบที่เป็นไปได้ เช่น

การเปรียบเทียบกับทฤษฎีหรือความรู้หรือข้อมูลอื่นที่มีอยู่เกี่ยวกับบริบทที่ทำการวิเคราะห์ ยกตัวอย่างเช่น การเก็บรวบรวมข้อมูลรายได้ผู้ปกครองของนักเรียนซึ่งพบว่ามีค่าสูญหาย เมื่อทำการวิเคราะห์ข้อมูลรายได้ที่เก็บรวบรวมได้ดังกล่าวอาจพบว่าค่าเฉลี่ย และขอบเขตของรายได้ผู้ปกครองนักเรียนในโรงเรียนนี้มีแนวโน้มที่ต่ำกว่าปกติ โดยอาจสังเกตว่าต่ำกว่าผลการสำรวจในอดีต หรือต่ำกว่าที่ควรจะเป็นจากการพิจารณาบริบทแวดล้อมของโรงเรียน กรณีเช่นนี้อาจตั้งสมมุติฐานได้ว่าการสูญหายดังกล่าวเป็นการสูญหายในกลุ่มของนักเรียนที่ครอบครัวมีฐานะร่ำรวย จากตัวอย่างนี้จะเห็นว่าการตรวจสอบการสูญหายแบบ MNAR ต้องอาศัยความรู้ในส่วนอื่นนอกเหนือจากข้อมูลเชิงปริมาณที่เก็บรวบรวมมาแต่เพียงอย่างเดียว

อีกวิธีการหนึ่งคือการใช้โมเดลการวิเคราะห์ความลำเอียงในการเลือกตัวอย่าง (sample dplyr::selection bias) หรือ Heckman dplyr::selection Model หรือ Heckman Correction [@Galimard2018]

กลไกของการสูญหายของข้อมูลมีผลต่อประสิทธิภาพของวิธีการจัดการกับข้อมูลที่สูญหาย [@baraldi2010introduction]

-   วิธีการลบข้อมูล (เช่น การลบแบบ listwise หรือ pairwise) จะทำงานได้ดีเมื่อข้อมูลสูญหายเป็นแบบ MCAR (Missing Completely at Random) ถ้าว่ากันตามตรงใช้วิธีอะไรกับ MCAR ก็ได้ที่ไม่บิดเบือด distribution ของข้อมูลก็ใช้กับ MCAR ได้หมด MCAR เป็นการสูญหายในอุดมคติที่แก้ได้ง่ายมาก แต่มักไม่เกิดขึ้นจริง

-   Multiple Imputation หรือ Full Information Maximum Likelihood (FIML)สามารถทำงานได้ดีกว่าและให้ค่าประมาณพารามิเตอร์ที่ไม่ลำเอียง (unbiased parameter estimates) เมื่อข้อมูลสูญหายเป็นแบบ MCAR หรือ MAR (Missing at Random)

-   อย่างไรก็ตาม สิ่งสำคัญที่ต้องสังเกตคือ วิธีการที่ใช้จัดการกับข้อมูลสูญหายหลายวิธี (เช่น การลบข้อมูล, การใช้ multiple imputation หรือ FIML) ไม่ได้ทำงานดีเมื่อข้อมูลสูญหายเป็นแบบ MNAR (Missing Not at Random)

-   ในความเป็นจริงชุดข้อมูลหนึ่ง ๆ สามารถการค่าสูญหายหลาย ๆ กลไกได้พร้อมกัน แม้กระทั่งตัวแปรเดียวก็อาจมีการสูญหายทั้ง MAR และ MNAR ผสมกันอยู่ ...

## การวิเคราะห์ข้อมูลที่มีค่าสูญหาย

การวิเคราะห์ข้อมูลเมื่อมีค่าสูญหายนั้นมีแนวทางหรือวิธีดำเนินงานที่หลากหลายขึ้นอยู่กับว่าเราอ้างอิงสำนักไหน นักสถิติหรือนักวิทยาการข้อมูลคนไหน กลุ่มไหน อย่างไรก็ตามแนวทางโดยทั่วไปที่เหมือนกันประกอบด้วย

1.  การระบุ สำรวจและวิเคราะห์กลไกการสูญหาย

2.  การแก้ปัญหาค่าสูญหาย

รายละเอียดในแต่ละขั้นตอนมีดังนี้

### การระบุ สำรวจและวิเคราะห์กลไกการสูญหาย

ดังที่ได้กล่าวไว้ข้างต้น ค่าสูญหายมีหลายลักษณะ และหลายกรณีการที่สามารถระบุค่าสูญหายว่าเป็นหน่วยข้อมูลใด หรือหน่วยข้อมูลในกลุ่มใด อาจนำไปสู่การแก้ปัญหาได้ในทันทีหากการสูญหายดังกล่าวเป็นการสูญหายที่เกิดจาการเก็บหรือจัดกระทำข้อมูลที่ไม่เหมาะสม

โดยปกติการใช้ทัศนภาพข้อมูลร่วมกับค่าสถิติเช่น จำนวน หรือร้อยละ เป็นวิธีการพื้นฐานในการระบุค่าผิดปกติที่เกิดขึ้นในชุดข้อมูล อย่างไรก็ตามในการทำงานกับข้อมูลขนาดใหญ่ การสำรวจค่าสูญหายด้วยวิธีการดังกล่าวอาจทำได้ยากและใช้เวลานาน กรณีเช่นนี้การนำอัลกอริทึมการเรียนรู้ของเครื่องมาประยุกต์ใช้อาจให้ประสิทธิภาพที่มากกว่า

#### Tabulating Missing data

ตารางวิเคราะห์ค่าสูญหายอาจจำแนกเป็นสองประเภท คือตารางวิเคราะห์ค่าสูญหายตามคอลัมน์ และตามแถว ดังนี้

```{r}
library(naniar)
onlinelearning_data <- read_csv("/Users/choat/Downloads/onlinelearning_miss.csv")
## ภาพรวม
miss_prop_summary(onlinelearning_data)
```

```{r}
miss_var_summary(onlinelearning_data)
miss_var_table(onlinelearning_data)
```

```{r}
miss_case_summary(onlinelearning_data)
miss_case_table(onlinelearning_data)
```

#### Visualization for Missing data

เทคนิคทั้งหมดในหัวข้อนี้เหมาะสำหรับใช้กับชุดข้อมูลที่มีขนาดไม่ใหญ่มาก

-   heatmap

-   missing data pattern plot

-   co-occurence plot

-   scatter plot

ตัวอย่างมีดังนี้

##### Heatmap

การสร้าง heatmap สามารถทำได้หลายวิธีการ ตั้งแต่การสร้างแบบ manual (ซึ่งทำบ่อย ๆ ก็เหนื่อย) ไปจนถึงมีฟังก์ชันสำเร็จรูปจากหลาย library ตั้งแต่การใช้ ggplot2 ธรรมดาไปจนถึง library เฉพาะ

```{r}
p1<-vis_miss(onlinelearning_data, cluster = TRUE)+
  theme(text = element_text(family = "ChulaCharasNew"))
p1
```

```{r}
p2<-vis_miss(onlinelearning_data, cluster = TRUE, facet = `ประเภทสถานศึกษา`)+
  theme(text = element_text(family = "ChulaCharasNew"))
p2
```

ตัวอย่างข้างต้นจะเห็นว่า heatmap ดูค่อนข้างยากหากข้อมูลมีขนาดใหญ่ โดยเฉพาะข้อมูลที่มีตัวแปรจำนวนมาก ข้อจำกัดหนึ่งของการใช้ฟังก์ชันสำเร็จรูปคือ เราปรับแต่งการนำเสนอได้จำกัด ทำให้การวิเคราะห์มุมมองต่าง ๆ ของ missing value ทำไม่ค่อยได้ตามที่ต้องการ

อีกวิธีการหนึ่งคือการสร้าง heatmap หรือแผนภาพข้อมูลสูญหายเอง โดยใช้ ggplot2 หรือ library ที่เกี่ยวข้องผ่าน shadow matrix ของ naniar ตัวอย่างมีดังนี้

จากชุดข้อมูล data

```{r}
data |> 
  dplyr::select(-learning_performance) |> 
  ### สร้าง shadow matrix
  bind_shadow() |> glimpse()
```

ลองนำ shadow matrix ที่สร้างขึ้นมาใช้ประโยชน์

```{r fig.width = 15, fig.height=8}
p1 <- data |> 
  dplyr::select(-learning_performance) |> 
  ### สร้าง shadow matrix
  bind_shadow() |>
  mutate(student_id = 1:387) |> 
  pivot_longer(cols = ends_with("NA")) |> 
  ggplot(aes(x = name, y= student_id))+
    geom_tile(aes(fill = value))+
    scale_fill_grey()

p2 <- data |> 
  dplyr::select(-learning_performance) |> 
  ### สร้าง shadow matrix
  bind_shadow() |>
  mutate(student_id = 1:387) |> 
  pivot_longer(cols = ends_with("NA")) |> 
  ggplot(aes(x = name, y= reorder(student_id, ach)))+
    geom_tile(aes(fill = value))+
    scale_fill_grey()

p1/p2
```

เมื่อจัดเรียงข้อมูลตาม ach จากน้อยไปมาก จะพบว่าในช่อง MAR มีรูปแบบการสูญหายในกลุ่ม ach น้อยมากกว่ากลุ่ม ach มาก ลักษณะนี้สะท้อนความสัมพันธ์ระหว่างการสูญหายกับตัวแปร ach กล่าวคือกลไกการสูญหายในตัวแปรดังกล่าวมีแนวโน้มเป็น MAR

##### co-occurence plot

co-occurence plot ช่วยแสดงสภาพการสูญหายที่ลึกกว่า heatmap เพราะมีทั้งมิติความถี่ของการสูญหายเป็นรายตัวแปรซึ่งจำแนกเป็นการสูญหายในตัวแปรเดียว และการสูญหายร่วมกัน

```{r}
gg_miss_upset(onlinelearning_data, nset = 10)
```

แผนภาพข้างต้นแสดงให้เห็นว่า ....

##### Scatter plot

บางสำนักเรียกว่า margin plot เป็นแผนภาพที่มีประโยชน์ในการสร้างทัศนภาพข้อมูลในเชิงความสัมพันธ์ระหว่างค่าสูญหายกับตัวแปรที่มีข้อมูลในชุดข้อมูล ซึ่งสามารถใช้สำรวจหรือระบุกลไกการสูญหายของข้อมูลได้

```{r fig.width=10}

p1<-data %>% 
  bind_shadow() %>% 
  ggplot(aes(x = learning_performance_mcar))+
  geom_point(aes(y=ach))+
  geom_rug(aes(y=ach))+
  geom_rug(aes(y=ach ,
               col = learning_performance_mcar_NA))+
  scale_color_manual(values = c("!NA" = NULL, "NA" = "maroon"),
                     labels=c(NULL, "missing in LP"))+
  theme_light()+
  theme(legend.position = "none")+
  ggtitle("MAR Mechanism")



p2<-data %>% 
  bind_shadow() %>% 
  ggplot(aes(x = learning_performance_mar))+
  geom_point(aes(y=ach))+
  geom_rug(aes(y=ach))+
  geom_rug(aes(y=ach ,
               col = learning_performance_mar_NA))+
  scale_color_manual(values = c("!NA" = NULL, "NA" = "maroon"),
                     labels=c(NULL, "missing in LP"))+
  theme_light()+
  theme(legend.position = "top")+
  ggtitle("MAR Mechanism")

p3<-data %>% 
  bind_shadow() %>% 
  ggplot(aes(x = learning_performance_mnar))+
  geom_point(aes(y=ach))+
  geom_rug(aes(y=ach))+
  geom_rug(aes(y=ach ,
               col = learning_performance_mnar_NA))+
  scale_color_manual(values = c("!NA" = NULL, "NA" = "maroon"),
                     labels=c(NULL, "missing in LP"))+
  theme_light()+
  theme(legend.position = "none")+
  ggtitle("MNAR Mechanism")

p1+p2+p3
```

ในทางปฏิบัติหากชุดข้อมูลมีขนาดใหญ่ การที่จะระบุตัวแปรมาสร้างเป็นแผนภาพ scatter ข้างต้นก็ยากเหมือนกัน ...

### การสำรวจค่าสูญหายสำหรับข้อมูลขนาดใหญ่

จากข้อจำกัดของการใช้สถิติบรรยายและทัศนภาพข้อมูลพื้นฐานเพื่อสำรวจค่าสูญหาย ทำให้ผู้วิเคราะห์ต้องการตัวช่วยในการสำรวจดังกล่าวสำหรับชุดข้อมูลขนาดใหญ่ เราอาจจำแนกตัวช่วยออกเป็นสองกลุ่ม ได้แก่

-   การวิเคราะห์ลักษณะของค่าสูญหายในชุดข้อมูล เช่่น การวิเคราะห์องค์ประกอบหลักของค่าสูญหาย หรือการวิเคราะห์จัดกลุ่ม

-   การวิเคราะห์กลไกการสูญหายในชุดข้อมูล เช่น การทดสอบ LittleMCAR การวิเคราะห์การถดถอยแบบ logistic หรือการทำ decision tree หรืออัลกอริทึมการเรียนรู้ของเครื่องแบบอื่น ๆ

#### การวิเคราะห์องค์ประกอบหลักของค่าสูญหาย

การวิเคราะห์องค์ประกอบหลัก (Principal Component Analysis หรือ PCA) สำหรับข้อมูลสูญหายเป็นเทคนิคที่ใช้เพื่อลดมิติของข้อมูลและระบุรูปแบบหรือโครงสร้างที่ซ่อนอยู่ในชุดข้อมูล โดยเฉพาะเมื่อข้อมูลมีค่าสูญหายเป็นจำนวนมาก การใช้ PCA ช่วยให้ผู้วิเคราะห์สามารถเข้าใจการสูญหายของข้อมูลในเชิงโครงสร้างว่ามีการกระจายหรือสัมพันธ์กันอย่างไรในตัวแปรต่างๆ

จุดเด่นของ PCA สามารถใช้ในการ**ระบุรูปแบบการสูญหายที่เกิดขึ้นร่วมกัน (co-occurring missingness)** การตรวจสอบลักษณะการสูญหายเช่นนี้จะช่วยให้คุณเห็นความสัมพันธ์ระหว่างการสูญหายของข้อมูลและปัจจัยพื้นฐานที่อาจไม่ได้สังเกตเห็นจากการวิเคราะห์แบบพื้นฐาน ซึ่งนอกจากจะช่วยให้เข้าใจรูปแบบการสูญหายได้ง่ายขึ้นและนำไปสู่การวิเคราะห์ขั้นต่อไปที่แม่นยำขึน

การใช้ PCA ในบริบทนี้สามารถดำเนินการได้ดังนี้

1.  แปลงข้อมูลของตัวแปรที่มีค่าสูญหายเป็น dummy variable โดยใช้ 1 แทนค่าสูญหาย และ 0 แทนค่าที่ไม่สูญหาย (สามารถสร้างได้จาก shadow matrix)

2.  ใช้ PCA เพื่อสกัดองค์ประกอบหลักจาก matrix ของ dummy ดังกล่าว

3.  ลักษณะการทำงานของ PCA คือจะสร้างองค์ประกอบหลักที่สามารถอธิบายความแปรปรวนของตัวแปรต้นฉบับเดิมให้ได้มากที่สุด ดังนั้นเมื่อตัวแปรนำเข้าเป็นแบบ binary 0,1 องค์ประกอบหลักที่ได้จึงจะสะท้อนความแปรปรวนหรือรูปแบบการสูญหายของข้อมูล

```{r}
## list ตัวแปรที่มี missing ในชุดข้อมูล
miss_var <- onlinelearning_data %>% 
              dplyr::select(where(~ any(is.na(.)))) |> names()

### เตรียมชุดข้อมูลค่าสูญหาย ผลลัพธ์ในขั้นตอนนี้จะได้ dummy matrix
missing_mat <- onlinelearning_data %>% 
  ## คัดเลือกเฉพาะตัวแปรที่มี missing value เท่านั้น
  dplyr::select(all_of(miss_var)) %>% 
  ## สร้าง shadow matrix ด้วย naniar
  bind_shadow() %>% 
  dplyr::select(30:58) %>% 
  mutate_all(as.numeric) %>% 
  mutate_all(~.-1)

### นำไปวิเคราะห์ PCA
pca_res <- princomp(missing_mat)  
pca_res$sdev ## standard deviation ของ PC
### Scree plot
data.frame(PC = 1:29, eigen = pca_res$sdev^2) %>% 
  ggplot(aes(x=PC, y=eigen))+
  geom_col()+
  ggtitle("Scree plot of PC")
```

Scree plot ด้านบนแปลความหมายว่าอย่างไร

Component หรือ Factor Loading คือสหสัมพันธ์ระหว่างตัวแปรต้นฉบับกับองค์ประกอบหลักแต่ละตัว ใช้ตีความหมายขององค์ประกอบหลักใน PCA

```{r}
## component loading
pca_res$loadings[1:29,] %>% 
  data.frame() %>% 
  rownames_to_column("var") %>% 
  dplyr::select(1:7) %>% 
  pivot_longer(cols = 2:7) %>% 
  ggplot(aes(x=value, y=var))+
  geom_col()+
  facet_wrap(~name)+
  theme(text = element_text(family = "ChulaCharasNew"))

```

#### Correlation of Missing Value

จากผลการวิเคราะห์ข้างต้นจะเห็นว่า component score ที่ได้จาก PCA สามารถสะท้อนสภาพการสูญหายโดยเฉพาะะ co-occurence missing value ผู้วิเคราะห์สามารถนำคะแนน component ดังกล่าวไปดำเนินการวิเคราะห์เพื่อระบุกลไกการสูญหายของข้อมูลในมิติต่าง ๆ ที่เกิดขึ้นในชุดข้อมูล ยกตัวอย่างเช่น

```{r fig.width = 8}
## ดึง component score แรกมาลองวิเคราะห์
missing_pca1<- pca_res$scores[,1]
missing_pca2<- pca_res$scores[,2]
par(mfrow=c(1,2))
hist(missing_pca1 |> abs())
hist(missing_pca2 |> abs())

p1 <- onlinelearning_data |> 
  dplyr::select_if(is.numeric) |> 
  dplyr::select(-1,-2) |> 
  bind_cols(missing_pca1 = missing_pca1) |> 
  mutate(missing_pca1 = abs(missing_pca1)) |> 
  pivot_longer(cols = -missing_pca1) |> 
  group_by(name) |> 
  summarise(cor = cor(missing_pca1, value, use = "complete.obs")) |> 
  mutate(r2 = cor^2) |> 
  ggplot(aes(x = r2, y= reorder(name, abs(cor))))+
  geom_col(fill = "steelblue")+
  ylab("")+
  theme_light()+
  theme(text = element_text(family = "ChulaCharasNew"))+
  xlim(0,0.2)

missing_pca2<- pca_res$scores[,2]
p2 <- onlinelearning_data |> 
  dplyr::select_if(is.numeric) |> 
  dplyr::select(-1,-2) |> 
  bind_cols(missing_pca2 = missing_pca2) |> 
  mutate(missing_pca2 = abs(missing_pca2)) |> 
  pivot_longer(cols = -missing_pca2) |> 
  group_by(name) |> 
  summarise(cor = cor(missing_pca2, value, use = "complete.obs")) |> 
  mutate(r2 = cor^2) |> 
  ggplot(aes(x = r2, y= reorder(name, abs(cor))))+
  geom_col(fill = "steelblue")+
  ylab("")+
  theme_light()+
  theme(text = element_text(family = "ChulaCharasNew"))+
  xlim(0,0.2)

p1+p2
```

ผลการวิเคราะห์ข้างต้นแปลความได้อย่างไร

#### Regression of Missing Values

นอกจากการใช้ correlation แล้วเรายังสามารถใช้ regression analysis หรือ logistic regression analysis เพื่อวิเคราะห์

##### Using Linear Regression

```{r}
 onlinelearning_data |> 
  dplyr::select(-1,-2) |> 
  bind_cols(missing_pca1 = missing_pca1) |> 
  mutate(missing_pca1 = abs(missing_pca1)) %>%
  lm(missing_pca1 ~ ., data = .) |> 
  summary()
```

อย่างไรก็ตามจะเห็นว่าผลการวิเคราะห์ข้างต้นมีปัญหา singularity เนื่องจากข้อมูลมีขนาดใหญ่ ตัวแปรมีจำนวนมาก การใส่ตัวแปรทั้งหมดลงไปวิเคราะห์มีแนวโน้มที่จะทำให้เกิดปัญหา multicollinearity การแก้ปัญหาดังกล่าวสามารถทำได้ด้วยการเลือก ML ตัวอื่น ๆ ที่แก้ปัญหาได้โดยตรง เช่น regularized regression หรืออื่น ๆ (ไปเรียนใน ML ดีกว่าครับ)

หากเราทำ ML ยังไม่ได้แล้วจะต้องทำ regression ข้างต้น เราจะลองแก้ปัญหายังไงได้บ้าง ??

##### Using Logistic Regression

นอกจากการทำ linear regression แล้วเรายังสามารถทำ logistic regression ของค่าสูญหายได้ด้วย ในกรณีนี้ขอใช้ตัวอย่างเล็ก ๆ ก่อนเพื่อให้ focus ส่วนเนื้อหา logistic regression ไปพร้อมกับการวิเคราะห์ค่าสูญหายได้ด้วย

เราจะใช้ข้อมูล `data` เพื่อวิเคราะห์กลไกการสูญหายในตัวแปร `learning_performance_mar` ดังนั้นขั้นแรกเราจะจัดกระทำข้อมูลให้มีเฉพาะตัวแปรที่ต้องการใช้งานก่อน

เมื่อตัวแปรตามเป็นตัวแปรแบบ binary ที่มีสองค่าได้แก่ 0,1 จะทำให้ค่าทำนายที่ได้จากสมการถดถอยมีความหมายเป็นสัดส่วนของการเกิดเหตุการณ์ที่สนใจ (เพราะอะไร?) ดังนั้นจึงมีความเป็นไปได้ที่จะใช้สมการถดถอยเชิงเส้นสำหรับอธิบายความสัมพันธ์ระหว่างสัดส่วนหรือความน่าจะเป็นของการเกิดเหตุการณ์ที่สนใจกับตัวแปรอิสระ


จากรูปด้านล่าง (ซ้าย) แสดงการใช้สมการเส้นตรง fit กับความสัมพันธ์ระหว่างตัวแปรตามแบบ binary คือการสูญหายใน learning performance กับผลสัมฤทธิ์ทางการเรียน (ach) เมื่อพิจารณาในส่วน scatter plot จะเห็นว่าความสัมพันธ์ระหว่างการสูญหายใน learning performance กับ ach มีแนวโน้มสัมพันธ์ในทิศทางลบ กล่าวคือการสูญหายมีแนวโน้มพบมากกว่าในกลุ่มนักเรียนที่มี ach ต่ำ ค่าทำนายของสัดส่วนหรือโอกาสการเกิดค่าสูญหาย (พิจารณาจากเส้นตรง) จึงมีแนวโน้มสูงในกลุ่ม ach ต่ำ และมีแนวโน้มลดต่ำลงเมื่อ ach มีแนวโน้มเพิ่มสูงขึ้น ในทางสถิติเรียกโมเดลการวิเคราะห์นี้ว่า โมเดลความน่าจะเป็นเชิงเส้น (linear probability model) อย่างไรก็ตามการใช้โมเดลดังกล่าวเพื่อทำนายความน่าจะเป็นของเหตุการณ์ที่สนใจไม่เหมาะสมนัก ทั้งนี้เป็นเพราะสมการทำนายดังกล่าวสามารถให้ค่าความน่าจะเป็นที่ต่ำกว่า 0 และมากกว่า 1 ได้โดยเฉพาะบริเวณส่วนปลายของการแจกแจง ach ซึ่งไม่สอดคล้องกับสัจพจน์ (axoim) ของความน่าจะเป็น


การแก้ปัญหาดังกล่าวสามารถทำได้ด้วยการปรับเปลี่ยนฟังก์ชันการตอบสนอง (response function) หรือ functional form ของสมการถดถอยให้เป็นแบบ non-linear สมการที่เหมาะสมคือ logistic function หรือที่เรียกว่า Sigmoid curve ทั้งนี้เป็นเพราะฟังก์ชันดังกล่าวมีลักษณะเป็นเส้นโค้งที่สามารถกำกับค่าความน่าจะเป็นให้อยู่ในช่วง [0,1]



```{r echo = F, fig.width = 10}
## linear probability model
p1 <- data |> 
  dplyr::select(ach, learning_performance_mar, engage, ontime_class, practice) |> 
  mutate(missing_in_LP = ifelse(is.na(learning_performance_mar),1,0)) %>% 
  ggplot(aes(x=ach, y=missing_in_LP))+
  geom_jitter(height = 0.01, alpha = 0.5) + 
  geom_smooth(method = "lm")+
  theme_light()+
  labs(title = "Linear Probability Model")+
  scale_y_continuous(breaks = seq(0,1,0.25))


logistic_model <- data |> 
  dplyr::select(ach, learning_performance_mar, engage, ontime_class, practice) |> 
  mutate(missing_in_LP = ifelse(is.na(learning_performance_mar),1,0)) |> 
  with(glm(missing_in_LP ~ ach, family = binomial))

x_seq <- seq(min(data$ach), max(data$ach), length.out = 100)
predicted_probs <- predict(logistic_model, newdata = data.frame(ach = x_seq), type = "response")

p2<-ggplot() +
  geom_jitter(data = data |> 
  dplyr::select(ach, learning_performance_mar, engage, ontime_class, practice) |> 
  mutate(missing_in_LP = ifelse(is.na(learning_performance_mar),1,0)), 
  aes(x = ach, y = missing_in_LP), height = 0.01, alpha = 0.5) + 
  geom_line(aes(x = x_seq, y = predicted_probs), color = "steelblue") +  
  labs(x = "ach", y = "Probability", title = "Sigmoid Curve for Logistic Regression") +
  theme_light()+
  scale_y_continuous(breaks = seq(0,1,0.25))

p1+p2
```

เพื่อแก้ปัญหาดังกล่าวจึงมีการพัฒนาสมการถดถอยที่แบบไม่ใช่เชิงเส้น (non-linear regression) โดยมีวัตถุประสงค์เพื่ออธิบายความสัมพันธ์ระหว่างโอกาสของการเกิดเหตุการณ์กับตัวแปรอิสระในโมเดล สมการดังกล่าวควรมีลักษณะเป็นเส้นโค้งที่มีเส้นกำกับทางอยู่บนช่วง \[0,1\] เพื่อให้สอดคล้องกับความน่าจะเป็นที่เป็นค่าทำนาย

โมเดล logistic regression สามารถเขียนได้หลายรูปแบบ สมการด้านล่างเรียกว่า logistic regression แสดงความสัมพันธ์ระหว่างความน่าจะเป็นของการสูญหายกับตัวแปรอื่น ๆ ที่สังเกตค่าได้ในชุดข้อมูล

$$
p = P(missing = 1) = \frac{1}{1 + e^{-(\beta_0 + \beta_1 x_1 + \beta_2 x_2 + \ldots + \beta_k x_k)}}
$$

อีกรูปแบบหนึ่งของ logistic regression เรียกว่า logit model สมการดังกล่าวสร้างจากการหาอัตราส่วนระหว่างความน่าจะเป็นที่จะเกิดเหตุการณ์ต่อความน่าจะเป็นที่ไม่เกิดเหตุการณ์ เชิงเทคนิคเรียกอัตราส่วนนี้ว่า อัตราส่วนของโอกาส หรือ อัตราต่อรอง (Odd) จะเห็นว่าสมการของ log ของอัตราส่วนดังกล่าวสามารถเขียนได้เป็นความสัมพันธ์เชิงเส้นตรงกับตัวแปรอิสระในโมเดล

$$
\log \left( \frac{p}{1-p} \right) = \beta_0 + \beta_1 x_1 + \beta_2 x_2 + \ldots + \beta_k x_k
$$

การใช้ประโยชน์จาก logistic regression นี้สามารถทำได้สองลักษณะ ลักษณะแรกคือการทำนายโอกาสของการเกิดเหตุการณ์ด้วยข้อมูลของตัวแปรอิสระ อีกลักษณะหนึ่งคือการอธิบายความสัมพันธ์ระหว่างโอกาสของการเกิดเหตุการณ์ที่สนใจกับตัวแปรอิิสระ ในบทเรียนนี้เราจะกล่าวถึงวัตถุประสงค์ข้อที่ 2 ก่อน

จาก logit model ข้างต้นจะเห็นว่าสัมประสิทธิ์การถดถอยในโมเดลสามารถบ่งชี้ความสัมพันธ์ระหว่างโอกาสกับตัวแปรอิสระต่าง ๆ ทั้งเชิงขนาดและทิศทาง โดยถ้าเครื่องหมายเป็นบวกแสดงว่าปัจจัยหรือตัวแปรอิสระนั้นมีความสัมพันธ์เชิงบวกกับโอกาสที่สนใจ หากสัมประสิทธิ์ดังกล่าวมีค่าเข้าใกล้ 0 แสดงว่าปัจจัยดังกล่าวไม่ได้มีความสัมพันธ์เชิงเส้นกับโอกาส

อย่างไรก็ตามการประเมินขนาดของค่าสัมประสิทธิ์จากสมการ logit ยังทำได้ยาก เพราะหน่วยการประเมินเป็น log ของอัตราต่อรอง เพื่อให้สามารถอธิบายความสัมพันธ์ดังกล่าวได้อย่างมีความหมายเราจำเป็นจะต้องสร้างดัชนีที่แปลผลได้ในการรับรู้ของมนุษย์

สมมุติว่า $x_1$ เป็นตัวแปรที่สนใจที่จะวิเคราะห์ขนาดอิทธิพล เราจะกำหนดให้ตัวแปรอิสระอื่น ๆ คงที่ และจะพิจารณาอิทธิพล/ความสัมพันธ์ของ $x_1$ จากการหาตัวเปรียบเทียบ Odd ระหว่างสถานการณ์ที่ $x_1 = x$ และ $x_1 = x+1$

$$
log(Odd|x_1=x) = \beta_0 + \beta_1 (x) + ...
$$

$$
log(Odd|x_1=x+1) = \beta_0 + \beta_1 (x+1) + ...  = \beta_0 + \beta_1 x + \beta_1 + ...
$$

นำสองสมการมาลบกันเพื่อเปรียบเทียบการเปลี่ยนแปลงของ odd ระหว่างสองสถานการณ์ข้างต้น

\begin{flushleft}

$$
log(Odd|x_1=x+1) - log(Odd|x_1=x) = \beta_1
$$

$$
log(\frac{Odd_{x+1}}{Odd_x}) = \beta_1
$$

$$
\frac{Odd_{x+1}}{Odd_x} = \exp{\{\beta_1\}}
$$

\end{flushleft}

ดังนั้นจะเห็นว่า exponential ของสัมประสิทธิ์การถดถอยจะมีความหมายเป็นอัตราส่วนของ Odd เรียกว่า Odd Ratio สามารถแปลความหมายได้ว่า ...

```{r}
data |> 
  dplyr::select(ach, learning_performance_mar, engage, ontime_class, practice) |> 
  mutate(missing_in_LP = ifelse(is.na(learning_performance_mar),1,0)) %>% 
  with(glm(missing_in_LP ~ ach + engage + practice + ontime_class, 
          data = ., family = "binomial")) |> 
  summary()
```

การประเมินประสิทธิภาพของ classification model เช่น logistic regression มีตัวชี้วัดที่แตกต่างจาก linear regression แบบปกติ เครื่องมือหลักที่ใช้ในการสร้างดัชนีประเมินประสิทธิภาพเรียกว่า confusion matrix

```{r}
library(yardstick)
missing_model <- data |> 
  dplyr::select(ach, learning_performance_mar, engage, ontime_class, practice) |> 
  mutate(missing_in_LP = ifelse(is.na(learning_performance_mar),1,0)) %>% 
  with(glm(missing_in_LP ~ ach + engage + practice + ontime_class, 
          data = ., family = "binomial"))

prob_missing <- predict(missing_model)
pred_missing <- ifelse(prob_missing>0.5,1,0)
```

Confusion Matrix คือเครื่องมือที่ใช้ในการวัดประสิทธิภาพของโมเดลการจำแนก (classification) โดยเป็นตารางที่แสดงผลลัพธ์การทำนายของโมเดลเทียบกับผลลัพธ์ที่แท้จริง ตารางนี้ถูกเรียกว่า “confusion” เนื่องจากมันช่วยแสดงให้เห็นว่าโมเดลสับสนอย่างไรในการจำแนกประเภทต่างๆ ในตารางมีส่วนประกอบได้แก่

-   true positive (TP)

-   true negative (TN)

-   false positive (FP)

-   false negative (FN)

```{r}
## confusion matrix
data |>
  mutate(missing_truth = ifelse(is.na(learning_performance_mar),1,0)) |> 
  mutate(missing_truth = factor(missing_truth)) |> 
  bind_cols(pred_missing = pred_missing) |>
  mutate(pred_missing = factor(pred_missing)) |> 
  conf_mat(truth = missing_truth, estimate = pred_missing)
```

จากตารางดังกล่าวสามารถนำไปใช้สร้างดัชนีอีกหลายตัว เช่น

-   accuracy = (TP + TN)/(Total)

-   sensitivity หรือ recall = TP/(TP + FP)

-   specificity = TN/(TN + FN)

-   precision = TP/(TP + FP)

```{r}
data |>
  mutate(missing_truth = ifelse(is.na(learning_performance_mar),1,0)) |> 
  mutate(missing_truth = factor(missing_truth)) |> 
  bind_cols(pred_missing = pred_missing) |>
  mutate(pred_missing = factor(pred_missing)) |> 
  accuracy(truth = missing_truth, estimate = pred_missing)
```

```{r}
data |>
  mutate(missing_truth = ifelse(is.na(learning_performance_mar),1,0)) |> 
  mutate(missing_truth = factor(missing_truth)) |> 
  bind_cols(pred_missing = pred_missing) |>
  mutate(pred_missing = factor(pred_missing)) |> 
  sens(truth = missing_truth, estimate = pred_missing)

data |>
  mutate(missing_truth = ifelse(is.na(learning_performance_mar),1,0)) |> 
  mutate(missing_truth = factor(missing_truth)) |> 
  bind_cols(pred_missing = pred_missing) |>
  mutate(pred_missing = factor(pred_missing)) |> 
  spec(truth = missing_truth, estimate = pred_missing)

data |>
  mutate(missing_truth = ifelse(is.na(learning_performance_mar),1,0)) |> 
  mutate(missing_truth = factor(missing_truth)) |> 
  bind_cols(pred_missing = pred_missing) |>
  mutate(pred_missing = factor(pred_missing)) |> 
  precision(truth = missing_truth, estimate = pred_missing)
```

ผลการวิเคราะห์ข้างต้นบ่งชี้ว่าการสูญหายใน learning_performance_mar มีแนวโน้มสูญหายแบบ MAR อย่างชัดเจน

### การแก้ปัญหาค่าสูญหาย

การแก้ปัญหาค่าสูญหายสามารถดำเนินการได้หลายลักษณะ ทั้งนี้ก็ขึ้นอยู่กับสาเหตุการสูญหายของข้อมูลด้วย กล่าวคือ หากสาเหตุการสูญหายเกิดขึ้นจากการเก็บรวบรวมข้อมูล จัดกระทำข้อมูล เชื่อมโยงข้อมูล การแก้ปัญหาอาจสามารถทำได้โดย เช่น ค้นหาข้อมูลที่ตกหล่นหายไประหว่างกระบวนการเก็บรวบรวม หรือจัดกระทำข้อมูลให้เหมาะสม ตรวจสอบและปรับวิธีการเชื่อมโยงฐานข้อมูล เพื่อให้ได้ข้อมูลกลับมามากขึ้น

หากการสูญหายเกิดจากปรากฏการณ์สุ่ม ได้แก่ MCAR หรือ MAR ผู้วิเคราะห์อาจแก้ไขได้สองลักษณะ ลักษณะแรกคือใช้การตัดข้อมูลที่สูญหายออกจาการวิเคราะห์ หรือเรียกอีกชื่อหนึ่งว่า complete case analysis การแก้ปัญหาแบบนี้ใช้งานได้ในสถานการณ์แบบ MCAR ลักษณะที่สองคือการทดแทนค่าสูญหาย (missing value imputation) ซึ่งสามารถใช้ได้กับทั้ง MAR และ MCAR การทดแทนค่าสูญหายมีหลายวิธีการ ตั้งแต่การทดแทนแบบง่าย ๆ โดยใช้ค่ากลาง เช่น ค่าเฉลี่ย มัธยฐาน การทดแทนด้วยสมการถดถอย และการทดแทนแบบหลายค่า

หากการสูญหายของข้อมูลเกิดจากสาเหตุเฉพาะที่เรียกว่า MNAR (Missing Not at Random) หรือเกิดจากการที่การสูญหายมีความเกี่ยวข้องกับค่าของตัวแปรที่สูญหายเอง การแก้ปัญหาจะซับซ้อนกว่า เนื่องจากไม่สามารถใช้วิธีการตัดข้อมูลที่สูญหายออกหรือการทดแทนข้อมูลแบบง่ายได้

ในกรณีที่การสูญหายเป็น MNAR ผู้วิเคราะห์อาจจำเป็นต้องใช้วิธีที่เฉพาะเจาะจงสำหรับการจัดการข้อมูลที่สูญหาย ซึ่งอาจรวมถึง:

-   การใช้โมเดลสถิติขั้นสูง: เช่น การใช้ dplyr::selection models หรือ Pattern-mixture models ที่ถูกออกแบบมาเพื่อตรวจสอบกลไกการสูญหายของข้อมูลแบบ MNAR โดยจะรวมตัวแปรที่เกี่ยวข้องกับการสูญหายมาในโมเดลด้วย เพื่อสร้างความเป็นไปได้ในการคาดการณ์ค่าที่สูญหาย

-   Multiple Imputation แบบปรับแต่ง: ในบางกรณีสามารถใช้การทดแทนหลายครั้ง (multiple imputation) แบบที่รวมถึงการสร้างโมเดลที่สามารถทำนายค่าสูญหายโดยใช้ตัวแปรอื่นๆ ที่สัมพันธ์กับการสูญหายของข้อมูล

ทั้งนี้วิธีการแก้ปัญหาขึ้นอยู่กับลักษณะและกลไกการสูญหายของข้อมูลที่เกิดขึ้นในแต่ละชุดข้อมูล

บทเรียนนี้จะกล่าวถึงการทดแทนการสูญหายสำหรับ MAR และ MCAR วิธีการทดแทนค่าสูญหายนี้อาจจำแนกได้เป็น 3 กลุ่ม

-   Simple imputation

-   Donor-based imputation

-   Model-based imputation

-   Multiple imputation

รายละเอียดมีดังนี้

#### Simple imputation

วิธีการนี้เป็นการใช้ค่าสถิติที่เป็นตัวแทนของข้อมูลเป็นค่าทดแทนค่าสูญหายเช่น การทดแทนด้วยค่าเฉลี่ย (mean imputation) หรือการทดแทนด้วยมัธยฐาน (median imputation) วิธีการในกลุ่มนี้สามารถใช้ได้กับการสูญหายแบบ MCAR และในกรณีที่มีข้อมูลสูญหายน้อยมาก ๆ เพราะหากมีข้อมูลสูญหายในปริมาณมากเกินไป การทดแทนลักษณะนี้สามารถบิดเบือนการแจกแจงของข้อมูล ซึ่งนำไปสู่ความลำเอียงของผลการวิเคราะห์ได้ และความลำเอียงนี้เกิดจากตัวผู้วิเคราะห์เองด้วย

```{r}
data |> 
  mutate(learning_performance_mean_imp =
          ifelse(is.na(learning_performance_mar)==T,
                mean(learning_performance_mar, na.rm = T),
                learning_performance_mar)) |> 
  dplyr::select(learning_performance, learning_performance_mean_imp) |> 
  pivot_longer(cols = everything()) |> 
ggplot(aes(x=value))+
geom_histogram(fill = "steelblue")+
facet_wrap(~name)+
theme_light()
```

```{r}
data |> 
  mutate(learning_performance_mean_imp =
          ifelse(is.na(learning_performance_mar)==T,
                mean(learning_performance_mar, na.rm = T),
                learning_performance_mar)) |> 
  ggplot()+
  geom_point(aes(x= learning_performance_mar,y= ach),col = "grey")+
  geom_point(data = . %>% filter(is.na(learning_performance_mar)==T),
            aes(x = learning_performance_mean_imp, y=ach), col = "maroon")+
  ggtitle("Mean Imputation")
```

เมื่อเปรียบเทียบกับการแจกแจงต้นฉบับ การทดแทนด้วยค่าเฉลี่ยเป็นอย่างไร

#### Donor-based imputation

วิธีการในกลุ่มนี้มีลักษณะสำคัญคือใช้ข้อมูลจากหน่วยข้อมูลที่คล้ายกัน (หรือที่เรียกว่า “donors”) เพื่อทดแทนค่าสูญหายในชุดข้อมูล วิธีนี้จะค้นหาหน่วยข้อมูลอื่นที่มีลักษณะคล้ายคลึงกันตามตัวแปรที่เกี่ยวข้อง จากนั้นใช้ข้อมูลจากหน่วยนั้นในการเติมค่าที่สูญหาย โดยวิธีการนี้แบ่งออกเป็นหลายเทคนิค เช่น:

-   Hot-Deck imputation

-   Cold-Deck imputation

-   KNN imputation

##### Hot-Deck imputation

เป็นวิธีการทดแทนค่าสูญหายที่ใช้ข้อมูลจากหน่วยข้อมูลที่คล้ายกันในชุดข้อมูลเพื่อเติมค่าให้กับหน่วยที่มีค่าสูญหาย โดยกระบวนการหลักจะเกี่ยวข้องกับการสุ่มหรือการจับคู่หน่วยข้อมูลที่มีค่าที่สมบูรณ์ (เรียกว่า “donors”) เพื่อทดแทนค่าที่หายไปในหน่วยข้อมูลที่สูญหาย (เรียกว่า “recipients”) วิธีนี้เป็นที่นิยมเนื่องจากมีความยืดหยุ่นและสามารถรักษาคุณลักษณะของข้อมูลจริงได้ดี อย่างไรก็ตามควรใช้วิธีการนี้กับการสูญหายแบบ MCAR

```{r}
# install.packages("VIM")
library(VIM)
dat_imp_mean <- hotdeck(data, variable = "learning_performance_mcar")
dat_imp_mean |> dplyr::select(learning_performance_mcar, learning_performance_mcar_imp) |> 
  arrange(learning_performance_mcar) |> head()
```

note: การทดแทนค่าสูญหายแบบ hot-deck อาจบิดเบือนการแจกแจงและความสัมพันธ์ระหว่างตัวแปรในชุดข้อมูลได้

##### KNN imputation

วิธีการนี้สามารถใช้ได้กับการสูญหายแบบ MAR ในบางสถานการณ์ วิธีการนี้จะใช้ข้อมูลจากหน่วยข้อมูลที่คล้ายคลึงกันมาเติมเต็มค่าสูญหาย โดยพิจารณาความคล้ายคลึงจากระยะทางระหว่างหน่วยข้อมูลดังกล่าว อัลกอริทึมนี้มี hyperparameter 1 ตัวได้แก่ k หรือจำนวนหน่วยข้อมูลคล้ายคลึงที่จะนำมาเฉลี่ยเพื่อสร้างค่าทดแทนของข้อมูลสูญหาย

```{r}
dat_imp_knn <- kNN(data, k = 15, variable = "learning_performance_mar")
```
