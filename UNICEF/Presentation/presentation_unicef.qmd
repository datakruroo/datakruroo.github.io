---
title: "Education data - Climate Change Risk Mapping Thailand"
author: "Assistant Prof. Dr. Siwachoat Srisuttiyakorn et al."
institute: "Department of Educational Research and Psychology <br> Faculty of Education Chulalongkorn University"
date: 2024-09-05
format:
  revealjs:
    auto-animate-easing: ease-in
    auto-animate-unmatched: false
    auto-animate-duration: 0.8
    slide-number: c/t
    footer: "Assistant Prof. Dr. Siwachoat Srisuttiyakorn et al. <br> Department of Educational Research and Psychology <br> Faculty of Education Chulalongkorn University"
    logo: https://github.com/ssiwacho/picture/blob/main/datakruroo.png?raw=true
    theme: theme.scss
    css: my_css.css
    scrollable: true
    transition: fade
    background-transition: fade
    highlight-style: github
    title-slide-attributes:
      data-background-image: img/70542874007-climatechangetopper.webp
      data-background-opacity: 15%
      data-background-size: full
    embed-resources: true
code-link: true
execute:
  echo: false
  freeze: auto
  progress: true
include-in-header:
  - text: |
      <style>
      #title-slide .title {
        font-size: 2em;
        color:  #C5705D;
      }
      </style>
---

```{r echo = F}
library(tidyverse)
library(gt)
load("/Users/choat/Documents/GitHub/unicef/effect_data.Rdata")
```

# 1. Outline {.smaller auto-animate="true" background-color="#BEC6A0" background-image="img/water.png" background-opacity="0.1"}

::: incremental
-   **Research Objectives**

    -   üéØ **Objective 1:** Explore and develop a methodological note to **identify relevant education metrics** to highlight the actual or potential, direct or indirect, adverse effects of climate change and environmental degradation on children‚Äôs education participation and learning.

    -   üéØ **Objective 2:** Identify characteristics of schools/provinces/areas and children\*\* where education is exposed to considerable risks of climate hazards inter alia by region, urban/rural, socio-economic status, disability, gender, age, school hardship location, etc.

-   **Research Design**

-   **Research Progress and Some Analysis Results**

-   **Q & A**
:::

# 2. Research Design {background-color="#BEC6A0" background-image="img/water2.png" background-opacity="0.1"}

-  Scope of the Research

-  Variables and Data Sources

-  Analysis Design

## 2.1 Scope of the Research {.smaller}

- The target population consists of students in Grade 6, Grade 9, and Grade 12 under the Office of the Basic Education Commission, Ministry of Education.

- The data used is divided into two parts: climate data, spanning the periods 1970-2005 and 2017-2021, with a unit of analysis as a grid of 25x25 square kilometers (details in section 2.2.1), and non-climate (education) data, covering the period 2017-2021, with a unit of analysis as the school (details in section 2.2.2).

## 2.2 Variables and Data Sources {.smaller auto-animate="true"}

The data used in the research are divided into two main categories:

<center>

```{mermaid}
flowchart TD
A[Data]--climate data-->B((" "))
A[Data]--non-climate data-->C((" "))
```

</center>

## 2.2.1 Climate Data {.smaller auto-animate="true"}

The data used in the research are divided into two main categories:

<center>


```{mermaid}
flowchart TD
A[Data]--climate data-->B((" "))
B((" "))-->C["Extreme Precipitation
             - intensity
             - duration
             - frequency"]
B((" "))-->D["Extreme Temperature
             - intensity
             - duration
             - frequency"]
A[Data]--non-climate data-->E((" "))

```

</center>

## 2.2.1 Climate Data {.smaller auto-animate="true"}

The data used in the research are divided into two main categories:

<center>

```{mermaid}
flowchart TD
A[Data]--climate data-->B((" "))
B((" "))-->C["Extreme Precipitation
             - intensity
             - duration
             - frequency"]
B((" "))-->D["Extreme Temperature
             - intensity
             - duration
             - frequency"]
A[Data]--non-climate data-->E((" "))
```

</center>


::: {style="font-size:90%;"}
:::

:::::::::::::: panel-tabset
## Extreme Climate Data

::::::: columns
:::::: {style="font-size:80%;"}
::: {.column width="40%"}
**Data (1970-2021)**

-   Extreme precipitation (7 indices)

-   Extreme temperature (11 indices)

    -   Intensity

    -   Frequency

    -   Duration
:::

::: {.column width="5%"}
:::

::: {.column width="50%"}
<br>

<p style="margin-top: 20px;">

Ramkhamhaeng University Center Of Regional climate change and Renewable Energy (RU-CORE)

-   Emsemble Models

-   RCP 4.5 & RCP 8.5 conditions

-   The data units are grids of 25x25 square kilometers, with a total of 2,073 grids.

</p>
:::
::::::
:::::::

<br>

## Detail

::: {style="font-size:80%;"}
The table below provides details of the extreme climate data.
:::

::::::: columns
:::: {.column width="50%"}
::: {style="font-size:75%;"}
**Precipitation**
:::

```{r echo = F}
data <- data.frame(
  Index = c("Rx1day", "Rx5day", "R95p", "R99p"),
  Definition = c("Maximum 1-day precipitation total", 
                 "Maximum 5-day precipitation total", 
                 "Annual sum of daily precipitation > 95th percentile", 
                 "Annual sum of daily precipitation > 99th percentile"),
  Unit = rep("mm", 4)
)
gt_table <- data %>%
  gt()
gt_table |> 
  tab_caption("Precipitation: Intensity")
```

```{r echo = F}
# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á
data <- tibble::tibble(
  Index = c("R10mm", "R20mm"),
  Definition = c("Annual number of days when precipitation ‚â• 10 mm", "Annual number of days when precipitation ‚â• 20 mm "),
  Unit = c("days", "days")
)
gt_table <- data %>%
  gt() %>%
  tab_caption("Precipitation: Frequency") %>%
  cols_width(
    Definition ~ px(10)  # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Definition ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° wrap
  ) %>%
  fmt_markdown(
    columns = c(Definition)  # ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Definition ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Markdown ‡πÄ‡∏ä‡πà‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ \n ‡∏´‡∏£‡∏∑‡∏≠ <br>
  )
# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ gt ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
gt_table 
```

```{r echo = F}
data <- data.frame(
  Index = c("CWD"),
  Definition = c("Maximum annual number of consecutive wet days <br> (i.e., when precipitation ‚â• 1 mm)"), 
  Unit = rep("days", 1)
)
gt_table <- data %>%
  gt() %>%
  tab_caption("Precipitation: Duration") %>%
  cols_width(
    Definition ~ px(10)  # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Definition ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° wrap
  ) %>%
  fmt_markdown(
    columns = c(Definition)  # ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Definition ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Markdown ‡πÄ‡∏ä‡πà‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ \n ‡∏´‡∏£‡∏∑‡∏≠ <br>
  )
gt_table
```
::::

:::: {.column width="50%"}

::: {style="font-size:75%;"}
**Temperature**
:::

```{r echo = F, fig.align="left"}
# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á
data <- tibble::tibble(
  Index = c("TXx", "TNx", "TXn", "TNn", "DTR"),
  Definition = c("Monthly Maximum value of daily max temperature",
                 "Monthly Maximum value of daily min temperature",
                 "Monthly Minimum value of daily max temperature",
                 "Monthly Minimum value of daily min temperature",
                 "Monthly mean difference between TX and TN"),
  Unit = rep("¬∞C", 5)
)

# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ gt
gt_table <- data %>%
  gt()
gt_table |> 
  tab_caption("Temperature: Intensity")
```

```{r echo = F}
data <- tibble::tibble(
  Index = c("TX10p", "TN10p", "TX90p", "TN90p"),
  Definition = c("Share of days when Tmax < 10th percentile",
                 "Share of days when Tmin < 10th percentile",
                 "Share of days when Tmax > 90th percentile",
                 "Share of days when Tmin > 90th percentile"),
  Unit = rep("% of days", 4)
)
# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ gt
gt_table <- data %>%
  gt()
gt_table |> 
  tab_caption("Temperature: Frequency")
```

```{r echo = F}
# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á
data <- tibble::tibble(
  Index = c("CSD", "WSD"),
  Definition = c("Annual number of days with at least <br> 6 consecutive days when Tmin < 10th percentile", "Annual number of days with at least <br> 6 consecutive days when Tmax > 90th percentile "),
  Unit = c("days", "days")
)
gt_table <- data %>%
  gt() %>%
  tab_caption("Temperature: Duration") %>%
  cols_width(
    Definition ~ px(10)  # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Definition ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° wrap
  ) %>%
  fmt_markdown(
    columns = c(Definition)  # ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Definition ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Markdown ‡πÄ‡∏ä‡πà‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ \n ‡∏´‡∏£‡∏∑‡∏≠ <br>
  )
# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ gt ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
gt_table 
```
::::
:::::::

## Grid Data

<center>![](img/climate_grid.jpg)</center>
::::::::::::::

## 2.2.2 Non-Climate Data {.smaller auto-animate="true"}

The data used in the research are divided into two main categories:


<center>

```{mermaid}
flowchart TD
A[Data]--climate data-->B((" "))
A[Data]--non-climate-->E((" "))
E((" "))-->F["Geographical and
              Spatial Barriers"]
E((" "))-->G["Infrastructure and
              Connectivity"]  
E((" "))-->H["School 
            Characteristic"]
E((" "))-->J["Student Achievement and 
              Socioeconomic Status"]          
```

</center>



## 2.2.2 Non-Climate Data {.smaller auto-animate="true"}

The data used in the research are divided into two main categories:

<center>


```{mermaid}
flowchart TD
A[Data]--climate data-->B((" "))

A[Data]--non-climate-->E((" "))
E((" "))-->F["Geographical and
              Spatial Barriers"]
E((" "))-->G["Infrastructure and
              Connectivity"]  
E((" "))-->H["School 
            Characteristic"]
E((" "))-->J["Student Achievement and 
              Socioeconomic Status"]              
```

</center>

<br>




#### **Geographical & Spatial Barriers**

<div style="font-size: 75%;">

  - Province, Amphor, School Coordinates

  - Distance from District (km.)

  - Hardship Location (type & level)

Source: (1) OBEC (DMC60/1, DMC65/1), and (2) Google Map API

</div>

<hr>

#### **Infrastructure and Connectivity**

<div style="font-size: 75%;">


  - Electrivity

  - Water

  - Internet

Source:  [Scraping from OBEC Asset Data (2566)](https://asset.bopp-obec.info/)

</div>


<hr>

#### **School Characteristics**

<div style="font-size: 75%;">


  - School Size

  - Student Level

  - Teacher Allocation

Source: OBEC (DMC60/1, DMC65/1)

</div>


<hr>


#### **Student Achievement and SES**

<div style="font-size: 75%;">


  - ONET Score (average by school)

  - Percent of Poor Student

Source: NIETS (2560-2564)

</div>

## 2.3 Analysis Design: Research Objective 1 {.smaller}

<br>

> üéØ **Research Objective 1:** Explore and develop a methodological note to **identify relevant education metrics** to highlight the actual or potential, direct or indirect, adverse effects of climate change and environmental degradation on children‚Äôs education participation and learning.

- To address the first research objective, the researcher developed an educational risk index using an extreme precipitation and temperature indices combined with student academic achievement.

<center>

```{mermaid}
flowchart LR

A("Extreme Climate Data
- Intensity
- Duration
- Frequency")-->C[PCA]
B("Non-Climate Data
O-NET Score")-->C[PCA]
C[PCA]-->D((("Risk Index")))
```

<div class="caption">Fig 2.1: Educational Risk Index Construction Framework</div>

</center>

- Principal Component Analysis (PCA) was employed to construct the index scale by integrating key variables related to climate extreams namely `intensity`, `duration` and `frequency` with educational achievement (`O-NET Score`)


- The PCA method enables the reduction of dimensionality while preserving the most significant variation within the data, thereby creating a composite index that reflects the combined correlations of these factors on educational performance. These correlations include both direct and indirect relationships between the climate factors and educational outcomes.


```{r echo = F, eval = F}
library(tidymodels)

p <- overall_precipitaion_data |> 
  group_by(student_level) |> 
  nest() |> 
  mutate(score = map(data, 
                  ~{
                   recipe(~ ach_score + intensity_rcp45 + frequency_rcp45 + duration_rcp45, data=.x)  |> 
                    step_naomit(all_predictors()) |> 
                    step_normalize(all_predictors()) |> 
                    prep() |> 
                    juice()
                  })) |> 
  unnest(score) |> 
  pivot_longer(cols = c("ach_score","intensity_rcp45","duration_rcp45", "frequency_rcp45")) |> 
  mutate(name = str_replace_all(name, pattern = "_rcp45", replace = "_anomaly")) %>% 
  mutate(student_level = factor(student_level, levels=c("p6","m3","m6"))) %>% 
  ggplot(aes(x=value))+
  geom_histogram(col = "white", fill = "steelblue")+
  facet_grid(student_level ~ name, scales = "free")

p
```

## 2.3 Analysis Design: Research Objective 1 {.smaller}

<br>

<div style="font-size: 85%;">


The following diagram illustrates the data preprocessing for Research Objective 1. The diagram divided into two major components: Preprocessing for Climate Data and Non-Climate Data.

1.	Climate Data: The data is tidied (reshaped, filtered, and aligned), normalized, and composite indices are calculated for intensity, duration, and frequency. The data is then split into two periods: the baseline (1970-2005) and the study period (2017-2021), which leads to the calculation of anomaly scores for each grid.

2.	Non-Climate Data: This involves tidying and aligning data from the DMC (school profile and address) and O-NET datasets (school profile and scores), followed by merging the two datasets. The school locations are mapped using Google Maps API, and the O-NET scores are normalized. A composite achievement index (Ach Score) is then calculated and merged with the school profile data, including latitude and longitude.

3.	Final Merging: The schools are mapped to climate grids using the Haversine distance, and the climate and non-climate data are merged. The final step involves using Principal Component Analysis (PCA) to create a risk index, ranging from 0 to 1.

This process integrates both climate and non-climate data to analyze educational risk in relation to climate factors.

</div>

<style>
  .mermaid {
    font-size: 12px;
    transform: scale(0.8);
    transform-origin: top left;
  }
</style>

```{mermaid}
stateDiagram-v2
    Objective1 --> NamedComposite1
    NamedComposite1: Climate Data (Precipitation & Temperature datasets) \n
    Objective1: Data Preprocessing for \n Research Objective 1
    state NamedComposite1 {
        [*] --> A
        A --> B
        B --> C
        C --> D
        D --> E
        D --> F
        E --> G
        F --> G
        A: Tidying data
        A: Reshaped, Filtered, & Aligned
        B: Normalized data
        C: Calculate composite indices
        C: Intensity \n Duration \n Frequency
        D: Split Data
        E: <center>Baseline \n (1970-2005)</center>
        F: <center>Study \n (2017-2021)</center>
        G: Anomaly Score dataset
        G: Anomaly Score \n Grid ID \n Grid Longitude \n Grid Latitude
    }
    Objective1 --> NamedComposite2
    NamedComposite2: Non-Climate Data (DMC & O-NET datasets)
    state NamedComposite2 {
        [*] --> DMC
        [*] --> ONET
        DMC --> step1A
        ONET --> step1B
        step1A --> step2
        step1B --> step2
        step2 --> step3
        step2 --> schlocation
        schlocation --> google
        google -->step5
        step3 --> step4
        step4 --> step5
        step5 --> step6
        step1A: Tidying data
        step1A: Reshaped, Filtered, & Aligned \n - School Profile \n - School Address
        step1B: Tidying data
        step1B: Reshaped, Filtered, & Aligned \n - School Profile \n - O-NET score
        step2: Merging
        step2: DMC and O-NET datasets
        schlocation: School Address
        schlocation: School name \n Address \n Tambon \n Amphor \n Province \n Postal Code
        google: Retriving School Coordinates
        google: Using School Address to retrieve \n school latitude and longitude data \n via Google Maps API.
        step3: Normalized O-NET Score
        step3: Math \n Science \n Thai \n Eng
        step4: Calculate composite index
        step4: Achievement Score (Ach Score)
        step5: Merging Data
        step5: Completed Achievement Dataset \n - School Profile \n - School Longitude \n - School Latitude \n - Ach Score
        step6: Mapping School into Climate Grid
        step6: 1. Calculate the distance \n between the school and grid coordinates \n using the Haversine distance. \n 2. Map each school to a grid cell based on \n the shortest distance criterion.
    }
    G --> final
    G --> subset
    subset --> step6
    step6 --> final
    final --> PCA
    PCA --> [*]
    subset: Grid Location
    subset: Grid ID \n Grid Longitude \n Grid Latitude
    final: Merging Climate \n and Non-Climate Data \n
    PCA: Principal Component Analysis
    PCA: Risk Index [0,1]
```

<br>

## 2.3 Analysis Design: Objective 2 {.smaller}

<br>

> üéØ **Objective 2:** Identify characteristics of schools/provinces/areas and children\*\* where education is exposed to considerable risks of climate hazards inter alia by region, urban/rural, socio-economic status, disability, gender, age, school hardship location, etc.

<center>

```{mermaid}
flowchart LR
A["Geographical
   & Spatial Barriers"]-->E((Risk Index))
B["School Infrastructure
  & Connectivity"]  -->E((Risk Index))
C["School Characteristic"]-->E((Risk Index))
D["Student SES"]-->E(((Risk Index)))
```

<div class="caption">Fig 2.2: Conceptual Framework</div>

</center>

<div style="font-size: 85%;">

- To address this research objective, the analyst employed a supervised learning model, a machine learning approach where the model is trained using labeled data‚Äîdata with known outcomes. This method helps the model understand patterns and relationships between various factors, allowing it to make predictions about unseen data. In this case, the model was used to assess how factors such as geographical barriers, infrastructure, school characteristics, and student socioeconomic status affect the educational risk index. Supervised learning helps the model ‚Äòlearn‚Äô from the known outcomes (i.e., the risk index values) and apply this knowledge to predict future risks or better understand the impact of each factor.

- The results of the analysis provide a comprehensive understanding of how various school characteristics, such as size, resources, and location, relate to educational risk. This deeper insight enables the identification of specific school-level factors that may exacerbate or mitigate the effects of climate change on student performance, contributing to targeted interventions and policy recommendations.

- The unit of analysis in this study is the school, and the researcher hypothesizes that the relationship between various factors and educational risk may vary across different regional areas or school affiliations. Therefore, this analysis focuses on assessing how these factors differ in the context of various regions to understand how geographical, school, and student factors influence educational risk. This approach aims to inform the development of policies that are tailored to the specific needs of each region effectively.

</div>

<br>


# 3. Research Results {background-color="#BEC6A0" background-image="img/mountain.png" background-opacity="0.1"}

-   Results of Research Objective 1

-   Results of Research Objective 2


## 3.1 Research Results: Objective 1 {.smaller}

<br>

The analysis results are divided into two parts: 

- Principal Component Analysis results

- Descriptive results of the Risk Index (Climate-Mapped Educational Risk Index)

## 3.1.1 Principal Component Analysis results {.smaller}

<div style="font-size: 75%;">

- The following analysis presents a bar chart displaying the component loadings of the extreme climate index (precipitation and temperature) and student academic performance (O-NET scores) for each of the four principal components. The loadings represent the weights or the strength of the relationship between each variable and the extracted components in the PCA analysis. High loadings indicate that the variable plays a significant role in explaining the variance of the corresponding component.

- The charts in Fig 3.1, and Fig 3.2 below displays the component loadings between precipitation indicators (like intensity, frequency, duration) and O-NET scores against all possible Principal Components (PC1 to PC4). The purpose of this chart is to show how each indicator relates to the different principal components, which represent underlying patterns in the data.

**Chart Key Elements:**

1. Y-Axis: Shows the indicators used for the analysis

2. X-Axis (Horizontal Axis): Shows the loading values for each indicator, which explain how strongly each variable contributes to each Principal Component (PC). Values closer to -1 or 1 indicate stronger correlations, while values close to 0 suggest weak or no correlation.

3. Each Block (PC1 - PC4): Represents the different Principal Components. For each component, reader can see how each variable is related to it. 

4. Color of the Bars: Represents the direction of the correlation, red color for negative correlation (values below 0), and blue color for positive correlation (value above 0). A positive value (blue) indicates that as the indicator increases, the Principal Component increases. A negative value (red) means that as the indicator increases, the Principal Component decreases.



</div>

::: panel-tabset
## Extreme Precipitation

<div style="font-size: 75%;">

- When considering Fig 3.1, particularly in PC3, we can observe an inverse relationship between Precipitation Duration and ach_score (O-NET score):

  - Precipitation Duration has a positive loading in PC3, meaning that as the duration of rainfall increases, it is positively associated with PC3. This suggests that longer extreme rainfall durations are linked to higher values in PC3, which in this context represents increased climate risk.

  - Conversely, ach_score has a negative loading in PC3, implying that higher O-NET scores are inversely related to the extreme climate risk. In other words, in areas where PC3 (educational risk) is high, ach_score tends to be lower, indicating greater risk of poorer academic performance.


- **Thus, PC3 serves as a measure of educational risk, where prolonged rainfall duration tends to increase risk, while better academic performance (higher O-NET scores) correlates with lower risk. Therefore, as rainfall duration extends, we can expect a higher educational risk (PC3), which, in turn, is associated with lower academic achievement. This relationship supports the use of PC3 as an index for the Climate-Map Education Risk Index (CMER).**

</div>

```{r}
library(tidymodels)
overall_precipitaion_data |> 
  group_by(student_level) |> 
  nest() |> 
  mutate(loadings = map(data, 
                  ~{
                   recipe(~ ach_score + intensity_rcp45 + frequency_rcp45 + duration_rcp45, data=.x)  |> 
                    step_naomit(all_predictors()) |> 
                    step_normalize(all_predictors()) |> 
                    step_pca(all_predictors(), num_comp = 4) |> 
                    prep() |> 
                    tidy(3)
                  })) |> 
  unnest(loadings) |> 
  mutate(student_level = factor(student_level, levels=c("p6","m3","m6"))) |> 
  mutate(terms = case_when(
    terms == "intensity_rcp45" ~ "Precipitation Intensity",
    terms == "frequency_rcp45" ~ "Precipitation Frequency",
    terms == "duration_rcp45" ~ "Precipitation Duration",
    .default = as.character(terms)
  )) |> 
  ggplot(aes(x=value, y=terms))+
  geom_col(aes(fill = value))+
  geom_vline(xintercept = c(-0.3,0.3), linetype = 2, col = "grey50")+
  geom_vline(xintercept = 0, linetype = 1, col = "grey")+
  facet_grid(student_level ~ component)+
  theme_light()+
  ylab("")+
  xlab("\n Loading value")+
  xlim(-1,1)+
  scale_x_continuous(breaks = seq(-1,1,0.2))+
  scale_fill_gradient2(low = "maroon",mid = "white", high = "steelblue")+
  theme(panel.grid = element_blank())+
  ggtitle("Precipitation: loadings between indicators and principal components")
```

<div class="caption">fig 3.1: Component loading of Extreme Precipitaion, and O-NET score</div>

<br>
<br>

## Extreme Temperature

<div style="font-size: 75%;">

- When considering Fig 3.2, no clear pattern of relationships was found between the variables to combine them into a risk scale. No components in the variance and covariance between extreme temperature factors and O-NET scores reflect educational risk.

</div>

```{r}
overall_temperature_data |> 
  group_by(student_level) |> 
  nest() |> 
  mutate(loadings = map(data, 
                  ~{
                   recipe(~ ach_score + intensity_rcp45 + frequency_rcp45 + duration_rcp45, data=.x)  |> 
                    step_naomit(all_predictors()) |> 
                    step_normalize(all_predictors()) |> 
                    step_pca(all_predictors(), num_comp = 4) |> 
                    prep() |> 
                    tidy(3)
                  })) |> 
  unnest(loadings) |> 
  mutate(student_level = factor(student_level, levels=c("p6","m3","m6"))) |> 
  mutate(terms = case_when(
    terms == "intensity_rcp45" ~ "Temperature Intensity",
    terms == "frequency_rcp45" ~ "Temperature Frequency",
    terms == "duration_rcp45" ~ "Temperature Duration",
    .default = as.character(terms)
  )) |> 
  ggplot(aes(x=value, y=terms))+
  geom_col(aes(fill = value))+
  geom_vline(xintercept = c(-0.3,0.3), linetype = 2, col = "grey50")+
  geom_vline(xintercept = 0, linetype = 1, col = "grey")+
  facet_grid(student_level ~ component)+
  ylab("")+
  xlab("\n Loading value")+
  xlim(-1,1)+
  scale_x_continuous(breaks = seq(-1,1,0.2))+
  scale_fill_gradient2(low = "maroon",mid = "white", high = "steelblue")+
  theme_light()+
  theme(panel.grid = element_blank())+
  ggtitle("Temperature: loadings between indicators and principal components")
```

<div class="caption">fig 3.2: Component loading of Extreme Temperature, and O-NET score</div>

<br>
<br>

:::


## 3.1.2 Climate-Mapped Educational Risk Index (CMER) {.smaller}

<div style="font-size: 75%;">

- The **Climate-Mapped Educational Risk Index (CMER)** scores derived from PC3 using PCA are standard scores with a possible range from -infinity to infinity, which may make it difficult to interpret the risk levels. To address this, the researcher transformed the risk index scores into a [0,1] range using a cumulative distribution function (CDF) based on the t-distribution, making the interpretation of risk levels more intuitive. The histogram below shows the distribution of the risk index scores, categorized by student grade level.

</div>

<center>

```{r fig.width = 16, fig.height = 4.5}
library(tidymodels)
library(rcartocolor)
library(patchwork)
precipitaion_risk_data <- overall_precipitaion_data |> drop_na() |> 
  group_by(student_level) |> 
  nest() |> 
  mutate(score = map(data, 
                  ~{
                   recipe(~ ach_score + intensity_rcp45 + frequency_rcp45 + duration_rcp45, data=.x)  |> 
                    step_naomit(all_predictors()) |> 
                    step_normalize(all_predictors()) |> 
                    step_pca(all_predictors(), num_comp = 4) |> 
                    prep() |> 
                    juice()
                  })) |> 
  unnest(c(data, score)) |> 
  select(-PC1, -PC4)

precipitaion_risk_data <- precipitaion_risk_data |> 
  mutate(risk_index = pt(PC3, df = 1))
         #robust_index = pt(-PC2, df = 1))

#write_excel_csv(precipitaion_risk_data %>% 
#                  filter(str_detect(province,
#                                    "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£|‡∏¢‡∏∞‡∏•‡∏≤|‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ|‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ|#‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå")),
#                file = "precipitaion_risk_data.csv")


p_hist <- precipitaion_risk_data %>% 
  group_by(student_level, school_name) %>% 
  summarise(risk_index = mean(risk_index),
            #robust_index = mean(robust_index),
            ach_score =mean(ach_score)) %>% 
  ungroup() %>% 
  mutate(student_level = fct_relevel(student_level, "p6","m3","m6")) %>% 
  ggplot(aes(x = risk_index))+
  xlim(0,1)+
  xlab("\n CMER Index")+
  geom_histogram(aes(y = after_stat(density)),bins = 20, fill = "#0C1844", col = "white")+
  geom_boxplot(y = 0, width = 0.1, outlier.alpha = 0)+
  facet_wrap(~student_level)+
  theme_minimal()+
  theme(text = element_text(family = "ChulaCharasNew", size = 20),
        panel.grid = element_blank(),
        strip.text = element_text(size = 20))
p_hist
```

<div class="caption">fig 3.3: Histogram of CMER Index categorized by student level</div>


</center>


## 3.1.2 Descriptive results of the CMER Index (1) {.smaller}

<div style="font-size: 75%;">

- The boxplot below shows the relationship between the Precipitation Duration Anomaly index and Achievement Score, categorized by five risk intervals: (0.0,0.2], (0.2,0.4], (0.4,0.6], (0.6,0.8], and (0.8,1.0], as well as by student grade levels. 

- The analysis results indicate that when the CMER risk index exceeds 0.6, the Precipitation Duration Anomaly in almost all areas tends to be above average, while the Achievement Scores of most schools tend to be below average. Furthermore, when the CMER index exceeds 0.8, the Achievement Scores of all schools show a clear decline and tend to be significantly lower than average. **This suggests that a cut-off risk value of 0.6 can be used as an indicator of moderate risk severity, while a value of 0.8 reflects a high level of risk severity, which has a pronounced impact on academic performance.**

</div>

<center>

```{r fig.width = 16, fig.height = 8}
library(rcartocolor)
library(ggplot2)

p1<-precipitaion_risk_data |> 
  group_by(student_level, school_name) %>%
  summarise(risk_index = mean(risk_index),
            ach_score = mean(ach_score),
            duration_anomaly = mean(duration_rcp45)) %>%
  mutate(risk_index = cut(risk_index, breaks = c(0,0.2,0.4,0.6,0.8,1.0))) |>
  ungroup() %>% 
  mutate(student_level = fct_relevel(student_level, "p6","m3","m6")) |> 
  ggplot(aes(x=risk_index, y=duration_anomaly))+
  geom_boxplot(outlier.alpha = 0,width = 0.5, aes(fill = risk_index), show.legend = F)+
  geom_hline(yintercept = 0, linetype = 2)+
  ylab("Duration Anomaly")+
  facet_wrap(~student_level, scale ="free_x")+
  theme_light()+
  theme(text = element_text(family = "ChulaCharasNew", size = 20))+
    xlab("\n CMER Index")+
  scale_fill_carto_d(type = "quantitative", palette =3)


p2<-precipitaion_risk_data |> 
  group_by(student_level, school_name) %>%
  summarise(risk_index = mean(risk_index),
            ach_score = mean(ach_score),
            duration_anomaly = mean(duration_rcp45)) %>%
  mutate(risk_index = cut(risk_index, breaks = c(0,0.2,0.4,0.6,0.8,1.0))) |>
  ungroup() %>% 
  mutate(student_level = fct_relevel(student_level, "p6","m3","m6")) |> 
  ggplot(aes(x=risk_index, y=ach_score))+
  geom_boxplot(outlier.alpha = 0,width = 0.5, aes(fill = risk_index), show.legend = F)+
  geom_hline(yintercept = 0, linetype = 2)+
  ylab("Achievement Score")+
  facet_wrap(~student_level, scale ="free_x")+
  theme_light()+
  theme(text = element_text(family = "ChulaCharasNew", size = 20))+
    xlab("\n CMER Index")+
  scale_fill_carto_d(type = "quantitative", palette =3)

p1/p2
```

</center>

<div class="caption">fig 3.4: Boxplot of Duration Anomaly Score and Achievement Score categorized by CMER Index level</div>

<br>
<br>


## 3.1.2 Descriptive results of the CMER Index (3) {.smaller}


<div style="font-size: 75%;">

- The following map shows schools with high CMER risk levels over the 22 river basins as defined by the Royal Decree on River Basin Designation, B.E. 2565, issued by [the Office of the National Water Resources](http://www.onwr.go.th/?page_id=9893).

- The contour in the map below illustrates the density of schools with high CMER risk in each of Thailand‚Äôs major river basins. The analysis revealed that the highest density of high-risk schools is found in the central and northeastern regions, particularly in the Northest Khong, Chi, Pasak, and Chao Phraya river basins. This is followed by the southern region, in the Peninsula Lower East Coast basin, and the northern region, in the Salawin, Ping, and North Khong river basins.

- When compared contour maps with the flood-prone area maps from the Department of Disaster Prevention and Mitigation (DDPM) during 2012-2018, and the repeated flood areas map of Thailand from 2000-2016, schools with high CMER Index scores tend to be located in the same areas as shown on both maps. **This analysis suggests that the CMER Index is correlates with natural disaster risks, especially flooding, and can serve as an effective indicator for assessing educational risks associated with climate change.**

</div>


:::: {.columns}

::: {.column width="40%"}

```{r fig.height = 9, fig.width = 6}
library(rnaturalearth)
library(sf)
library(ggrepel)

rivermap <- st_read("/Users/choat/Library/CloudStorage/OneDrive-ChulalongkornUniversity/Documents/‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢/unicef/data/‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà/MainBasin_ONWR_Law_WGS84/MainBasin_ONWR_Law_WGS84.shp", options = "ENCODING=UTF-8", quiet = TRUE) 


school_sf <- precipitaion_risk_data |> 
  group_by( student_level, school_lon, school_lat,school_size, location, type_of_hard, hard_to_reach,school_name) %>% 
  summarise(risk_index = mean(risk_index),
           # robust_index = mean(robust_index),
            ach_score =mean(ach_score)) %>% 
  ungroup() %>% 
  select(student_level, school_lon, school_lat, type_of_hard, hard_to_reach,school_size, ach_score, risk_index) |> drop_na() |> 
  mutate(student_level = fct_relevel(student_level, "p6","m3","m6")) %>% 
  mutate(student_level = fct_relevel(student_level, "p6","m3","m6")) %>% 
  mutate(type_of_hard = factor(type_of_hard, labels=c("None","Highland in Remote Area","Island"))) |> 
 mutate(hard_to_reach = factor(hard_to_reach, labels=c("None","Hard","Harder","Hardest"))) |> 
  filter(risk_index>=0.80) %>% 
  st_as_sf(coords = c("school_lon", "school_lat"), crs = 4326)

river_contour_p <- rivermap |> 
  ggplot() +
  stat_density_2d(data = school_sf, aes(x = st_coordinates(geometry)[,1], 
                                        y = st_coordinates(geometry)[,2], 
                                        fill = after_stat(level)),  # ‡πÉ‡∏ä‡πâ after_stat(level) ‡πÅ‡∏ó‡∏ô ..level..
                  geom = "polygon", alpha = 0.08, color = "white", fill = "maroon",
                  bins = 8, contour_var = "ndensity") +
  geom_sf(alpha = 0.3) +
  geom_sf_text(aes(label = MBASIN_E), check_overlap = TRUE,
              size = 2, color = "grey30", alpha = 0.8) +
  theme_minimal() +
  xlab("")+
  ylab("")+
  theme(text = element_text(family = "ChulaCharasNew"),
        axis.text = element_blank(),
        panel.grid = element_blank(),
        legend.position = "right") +  # ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á legend
  ggtitle("Contour Map for \n High Risk School (CMER Index)",
          subtitle = "22 river basins map") +
  guides(color = guide_legend(override.aes = list(size = 4)),
         shape = guide_legend(override.aes = list(size = 4))) +
  labs(shape = "Geographic \n characteristics",
       col = "Difficulty level \n in accessing the school")

river_contour_p
```


<div class="caption">fig 3.6: Schools with high CMER levels over the 22 river basins map.</div>

:::

::: {.column width="30%"}

<center>

![](img/4.5.jpg)

</center>

:::

::: {.column width="30%"}

<center>

![](img/4.4.jpg)

</center>

:::


::::



```{r create_map, echo = F}
library(rnaturalearth)
library(sf)
library(ggrepel)
thailand_map <- ne_states(country = "Thailand", returnclass = "sf")

school_sf <- precipitaion_risk_data |> 
  group_by(student_level, school_lon, school_lat,school_size, type_of_hard, hard_to_reach, location, school_name) %>% 
  summarise(risk_index = mean(risk_index),
            #robust_index = mean(robust_index),
            ach_score =mean(ach_score)) %>% 
  ungroup() %>% 
  select(student_level, school_lon, school_lat, type_of_hard, hard_to_reach, school_size, ach_score, risk_index) |> drop_na() |> 
  mutate(student_level = fct_relevel(student_level, "p6","m3","m6")) %>% 
  mutate(type_of_hard = factor(type_of_hard, labels=c("None","Highland in Remote Area","Island"))) |> 
  mutate(hard_to_reach = factor(hard_to_reach, labels=c("None","Hard","Harder","Hardest"))) |> 
  filter(risk_index>=0.6 & risk_index<0.8) %>% 
  st_as_sf(coords = c("school_lon", "school_lat"), crs = 4326)
```

```{r megeing_data_for_map, echo = F}
precipitaion_risk_data_cleaned_aggregated <- precipitaion_risk_data_cleaned |> 
    group_by(student_level,
             grid_id, grid_lon, grid_lat,
             school_lon, school_lat, distance,
             area_code, affiliation,
             school_code1, school_code2, school_code3, school_code,
             school_name, school_size, school_type, 
             location, amphor, tambon, province,
             #ach_score,
             #ends_with("rcp45"), ends_with("rcp85"),
             #starts_with("risk"),
             distance_from_district,
             type_of_hard, hard_to_reach,
             electric, electric_corrected, electric_type_use,
             water_type, internet_type
             ) |> 
    summarise(ach_score = mean(ach_score, na.rm = T),
              risk_index_df1 = mean(risk_index_df1, na.rm = T),
              risk_index_df5 = mean(risk_index_df5, na.rm = T),
              duration = mean(duration_rcp45, na.rm = T)) |> 
    ungroup()

precipitaion_risk_data_cleaned_aggregated <- precipitaion_risk_data_cleaned_aggregated |> 
    select(-electric, -electric_corrected) |> 
    mutate(electric_score = case_when(
        electric_type_use == "‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏±‡∏ê" ~ 5,
        electric_type_use == "‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≥‡πÄ‡∏ô‡∏¥‡∏î‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß" ~ 3,
        electric_type_use == "‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤" ~ 0,
        electric_type_use == "Unknown" ~ NA
    )) |> 
    mutate(water_score = case_when(str_detect(water_type, "‡∏ô‡∏Ñ‡∏£‡∏´‡∏•‡∏ß‡∏á") ~ 5,
           str_detect(water_type, "‡∏≠‡∏õ‡∏ó.") ~ 4,
           str_detect(water_type, "‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô") ~ 2,
           str_detect(water_type, "Unknown") ~ NA)) |> 
    mutate(internet_score = case_when(
        str_detect(internet_type, "‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á") ~ 5,
        str_detect(internet_type, "‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î") ~ 2,
        str_detect(internet_type, "‡πÑ‡∏°‡πà‡∏°‡∏µ") ~ 0,
        str_detect(internet_type, "Unknown") ~ NA,

    )) |> 
 mutate(infra_readiness_score = (electric_score+water_score+internet_score)/15)

precipitaion_risk_data_cleaned_aggregated <- precipitaion_risk_data_cleaned_aggregated |> 
    mutate(risk_class = case_when(
                risk_index_df5>=0.6 ~ "risk",
                risk_index_df5<0.6 ~"not risk"
    )) |> 
    mutate(risk_class = fct_relevel(risk_class, "risk","not risk")) |> 
    mutate(student_level = fct_relevel(student_level, "p6","m3","m6"))

library(readxl)
temp <- read_excel("/Users/choat/Library/CloudStorage/OneDrive-ChulalongkornUniversity/Documents/‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢/learning loss/LearningLossProject/dataTotal 2559-2565.xlsx")

poor_data <- temp |> filter(`‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î` == "‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Ç‡∏±‡πâ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô") |> 
    group_by(schid, schNanme) |> 
    summarise(percent_poor = mean(pool)) |> 
    ungroup() |> 
    mutate(schid = as.numeric(schid))

precipitaion_risk_data_cleaned_aggregated <- precipitaion_risk_data_cleaned_aggregated |> 
    left_join(poor_data, by = join_by(school_code == schid))

precipitaion_risk_data_cleaned_aggregated <- precipitaion_risk_data_cleaned_aggregated |> 
    mutate(percent_poor = ifelse(percent_poor>0.6,"majority_poor","not_poor")) |> 
    mutate(percent_poor = fct_relevel(percent_poor, "not_poor", "majority_poor"))

area_name_new <- read_excel("/Users/choat/Documents/GitHub/unicef/area_code_new.xlsx")
precipitaion_risk_data_cleaned_aggregated <- precipitaion_risk_data_cleaned_aggregated |> 
    mutate(affiliation = case_when(
        str_detect(affiliation,"‡∏™‡∏û‡∏°.") ~ area_name_new$area_name[match(province, area_name_new$province)],
        TRUE ~ affiliation
    ))
```

```{r river_map_point, eval = F}

river_p <- rivermap |> ggplot()+
  geom_sf(aes(fill = MBASIN_E), alpha=0.3)+
  geom_sf_text(aes(label = MBASIN_E), size = 2, col = "grey30",alpha = 0.4)+
 geom_sf(data = school_sf, aes(geometry = geometry, shape = type_of_hard, col = hard_to_reach) ,
          alpha = 0.3,  size = 2) +
  theme_light()+
  theme(text = element_text(family = "ChulaCharasNew"),
        panel.grid = element_blank(),
        legend.position = "none")+
  scale_fill_grey()+
  scale_color_manual(values=c("orange","#D8A25E","#A04747","#821131"))+
  ggtitle("Risk Score >=0.8")+
  guides(color = guide_legend(override.aes = list(size = 4)),  # ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏™‡∏µ
         shape = guide_legend(override.aes = list(size = 4)))+  # ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î
  labs(shape = "Geographic \n characteristics",
        col = "Difficulty level \n in accessing the school")


 <-rivermap |> 
  ggplot() +
  stat_density_2d(data = school_sf, aes(x = st_coordinates(geometry)[,1], 
                                        y = st_coordinates(geometry)[,2], 
                                        fill = after_stat(level)),  # ‡πÉ‡∏ä‡πâ after_stat(level) ‡πÅ‡∏ó‡∏ô ..level..
                  geom = "polygon", alpha = 0.08, color = "white", fill = "maroon",
                  bins = 8, contour_var = "ndensity") +
  geom_sf(alpha = 0.3) +
  geom_sf_text(aes(label = MBASIN_E), check_overlap = TRUE,
              size = 2, color = "grey30", alpha = 0.8) +
  theme_minimal() +
  xlab("")+
  ylab("")+
  theme(text = element_text(family = "ChulaCharasNew"),
        axis.text = element_blank(),
        panel.grid = element_blank(),
        legend.position = "right") +  # ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á legend
  ggtitle("(a) Contour Map for \n High Risk School (CMER Index)",
          subtitle = "22 river basins map") +
  guides(color = guide_legend(override.aes = list(size = 4)),
         shape = guide_legend(override.aes = list(size = 4))) +
  labs(shape = "Geographic \n characteristics",
       col = "Difficulty level \n in accessing the school")

```


<br>

```{r message  = F, warning = F, echo = F, fig.height = 16, fig.width = 14}

school_sf <- precipitaion_risk_data |> 
  group_by(year, student_level, school_lon, school_lat,school_size, location, type_of_hard, hard_to_reach,school_name) %>% 
  summarise(risk_index = mean(risk_index),
           # robust_index = mean(robust_index),
            ach_score =mean(ach_score)) %>% 
  ungroup() %>% 
  select(year, student_level, school_lon, school_lat, type_of_hard, hard_to_reach,school_size, ach_score, risk_index) |> drop_na() |> 
  mutate(student_level = fct_relevel(student_level, "p6","m3","m6")) %>% 
  mutate(student_level = fct_relevel(student_level, "p6","m3","m6")) %>% 
  mutate(type_of_hard = factor(type_of_hard, labels=c("None","Highland in Remote Area","Island"))) |> 
 mutate(hard_to_reach = factor(hard_to_reach, labels=c("None","Hard","Harder","Hardest"))) |> 
  filter(risk_index>=0.80) %>% 
  st_as_sf(coords = c("school_lon", "school_lat"), crs = 4326)


river_contour_p <- rivermap |> 
  ggplot() +
  stat_density_2d(data = school_sf, aes(x = st_coordinates(geometry)[,1], 
                                        y = st_coordinates(geometry)[,2], 
                                        fill = after_stat(level)),  # ‡πÉ‡∏ä‡πâ after_stat(level) ‡πÅ‡∏ó‡∏ô ..level..
                  geom = "polygon", alpha = 0.08, color = "white", fill = "maroon",
                  bins = 8, contour_var = "ndensity") +
  geom_sf(alpha = 0.3) +
  geom_sf_text(aes(label = MBASIN_E), check_overlap = TRUE,
              size = 2, color = "grey30", alpha = 0.8) +
  theme_minimal() +
  xlab("")+
  ylab("")+
  theme(text = element_text(family = "ChulaCharasNew"),
        strip.text = element_text(size = 20),
        title = element_text(size = 22),
        axis.text = element_blank(),
        panel.grid = element_blank(),
        legend.position = "right") +  # ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á legend
  ggtitle("Contour Map for \n High Risk School (CMER Index)",
          subtitle = "22 river basins map") +
  guides(color = guide_legend(override.aes = list(size = 4)),
         shape = guide_legend(override.aes = list(size = 4))) +
  labs(shape = "Geographic \n characteristics",
       col = "Difficulty level \n in accessing the school")+
        facet_wrap(~year)

river_contour_p
```


<div class="caption">fig 3.7: Schools with high CMER levels over the 22 river basins map categorized by year.</div>



## 3.1.2 Descriptive results of the CMER Index (4) {.smaller}

<div style="font-size: 75%;">


- The two maps below show the CMER Index levels categorized by primary and secondary educational service areas. Educational service areas shaded in varying intensities of red indicate that the median CMER Index in those areas is higher than 0.6, corresponding to a moderate to high risk level. **From the map, it was found that schools under PESA tend to have a moderate to high level of risk more frequently than school SESA.**

</div>

<center>

```{r}
shapefile_data <- st_read("/Users/choat/Downloads/ocha-roap-d24bdc45-eb4c-4e3d-8b16-44db02667c27/tha_adm_rtsd_itos_20190221_SHP_PART_1/tha_admbnda_adm2_rtsd_20190221.shp",
quiet = TRUE) 

# ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• precipitation ‡πÅ‡∏•‡∏∞ Shapefile
school_sf <- precipitaion_risk_data_cleaned_aggregated |> 
  filter(str_detect(affiliation, "‡∏™‡∏û‡∏õ.")) |> 
  group_by(province, amphor, affiliation) %>% 
  summarise(risk_index = median(risk_index_df5, na.rm = TRUE)) |> 
  inner_join(shapefile_data, by = c("amphor" = "ADM2_TH"))  # ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô join_by ‡πÄ‡∏õ‡πá‡∏ô c()

school_sf_label <- school_sf |> 
  filter(risk_index > 0.6)
# ‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏ï‡∏≤‡∏° affiliation
affiliation_boundaries <- school_sf %>%
  group_by(affiliation) %>%
  summarise(geometry = st_union(geometry))  # ‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏ï‡∏≤‡∏° affiliation

# ‡∏û‡∏•‡πá‡∏≠‡∏ï‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
PESA_p <- ggplot(data = thailand_map) +
  geom_sf() +
  geom_sf(data = school_sf, aes(geometry = geometry, fill = risk_index),
          alpha = 1, size = 0.8, color = NA) +  
  geom_sf(data = affiliation_boundaries, aes(geometry = geometry), 
          color = "black", fill = NA, size = 1, show.legend = FALSE) +  # ‡∏ï‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏ï‡∏≤‡∏° affiliation
  geom_sf_text(data = school_sf_label, aes(geometry = geometry, label = affiliation), size = 2, color = "grey20", check_overlap = TRUE,
  family = "ChulaCharasNew")+
  theme_minimal() +
  labs(fill = "CMER Level")+
  xlab("") + ylab("") +
  theme(legend.position = "right",
        text = element_text(family = "ChulaCharasNew"),
        axis.text = element_blank(),
        panel.grid = element_blank()) +
  scale_fill_gradient2(low = "steelblue", mid = "white", high = "maroon", midpoint = 0.6) +
  ggtitle("(a) CMER Index",
          subtitle = "Categorized by PESA")


### - ‡∏™‡∏û‡∏°.
shapefile_data <- st_read("/Users/choat/Downloads/ocha-roap-d24bdc45-eb4c-4e3d-8b16-44db02667c27/tha_adm_rtsd_itos_20190221_SHP_PART_1/tha_admbnda_adm1_rtsd_20190221.shp",
quiet = TRUE) 

# ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• precipitation ‡πÅ‡∏•‡∏∞ Shapefile
school_sf <- precipitaion_risk_data_cleaned_aggregated |> 
  filter(str_detect(affiliation, "‡∏™‡∏û‡∏°.")) |> 
  group_by(province, amphor, affiliation) %>% 
  summarise(risk_index = median(risk_index_df5, na.rm = TRUE)) |> 
  inner_join(shapefile_data, by = c("province" = "ADM1_TH"))  # ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô join_by ‡πÄ‡∏õ‡πá‡∏ô c()

school_sf_label <- school_sf |> 
  filter(risk_index > 0.6)
# ‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏ï‡∏≤‡∏° affiliation
affiliation_boundaries <- school_sf %>%
  group_by(affiliation) %>%
  summarise(geometry = st_union(geometry))  # ‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏ï‡∏≤‡∏° affiliation

# ‡∏û‡∏•‡πá‡∏≠‡∏ï‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
sesa <- ggplot(data = thailand_map) +
  geom_sf() +
  geom_sf(data = school_sf, aes(geometry = geometry, fill = risk_index),
          alpha = 1, size = 0.8, color = NA) +  
  geom_sf(data = affiliation_boundaries, aes(geometry = geometry), 
          color = "black", fill = NA, size = 1, show.legend = FALSE) +  # ‡∏ï‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏ï‡∏≤‡∏° affiliation
  geom_sf_text(data = school_sf_label, aes(geometry = geometry, label = affiliation), size = 2, color = "grey20", check_overlap = TRUE,
  family = "ChulaCharasNew")+
  theme_minimal() +
  labs(fill = "CMER Level")+
  xlab("") + ylab("") +
  theme(legend.position = "right",
        text = element_text(family = "ChulaCharasNew"),
        axis.text = element_blank(),
        panel.grid = element_blank()) +
  scale_fill_gradient2(low = "steelblue", mid = "white", high = "maroon", midpoint = 0.6) +
  ggtitle("(b) CMER Index",
          subtitle = "Categorized by SESA")
```


</center>

<div style="font-size: 75%;">

- The bar chart below shows the Primary educational service areas where the median CMER Index is higher than 0.6 (moderate to high risk), revealing that there are 37 such areas.

</div>

```{r}
pesa_risk <- precipitaion_risk_data_cleaned_aggregated |> 
  filter(str_detect(affiliation, "‡∏™‡∏û‡∏õ.")) |> 
  group_by(affiliation) |> 
  summarise(median = median(risk_index_df5)) |> 
  filter(median > 0.6) |> 
  ggplot(aes(x = median, y=reorder(affiliation, median)))+
  geom_col(aes(fill = median))+
  xlab("CMER Index")+
  ylab("")+
  theme_light()+
  theme(text = element_text(family = "ChulaCharasNew"))+
  scale_fill_gradient(low = "orange",high = "maroon")+
  ggtitle("Primary education areas with \n moderate to high CMER levels.")

```



<center>

```{r fig.height = 10, fig.width = 14}
library(patchwork)
PESA_p + sesa
```

<div class="caption">fig 3.8: CMER Index on Educational Service Area Map</div>


```{r}
pesa_risk
```

<div class="caption">fig 3.9: Primary Educational Service Areas with Median CMER Index Above 0.6: Moderate to High Risk Levels </div>

</center>



```{r eval = F}
pesa_data_risk <- precipitaion_risk_data_cleaned_aggregated |> 
  filter(str_detect(affiliation, "‡∏™‡∏û‡∏õ."))
pesa_data_risk <- pesa_data_risk |> 
  group_by(affiliation) |> 
  summarise(n = n(),
            avg_risk = mean(risk_index_df5),
            median_risk = median(risk_index_df5),
            sd_risk = sd(risk_index_df5)) |> 
  ungroup() |> 
  mutate(risk_level = case_when(
    avg_risk <= 0.6 ~ "Low Risk",
    avg_risk > 0.6 & avg_risk <=0.8 ~ "Moderate Risk",
    avg_risk >0.8 ~ "High Risk"
  )) |> 
    select(affiliation, risk_level, avg_risk, median_risk, sd_risk) |> 
  rename("CMER Level" = 2 , "Avg. CMER"=  3 , "Median CMER" = 4, "SD CMER" = 5)
#pesa_data_risk <- as.list(pesa_data_risk)
#write_excel_csv(pesa_data_risk, file = "pesa_data_risk.csv")


sesa_data_risk <- precipitaion_risk_data_cleaned_aggregated |> 
  filter(str_detect(affiliation, "‡∏™‡∏û‡∏°."))
sesa_data_risk <- sesa_data_risk |> 
  group_by(affiliation) |> 
  summarise(n = n(),
            avg_risk = mean(risk_index_df5),
            median_risk = median(risk_index_df5),
            sd_risk = sd(risk_index_df5)) |> 
  ungroup() |> 
  mutate(risk_level = case_when(
    avg_risk <= 0.6 ~ "Low Risk",
    avg_risk > 0.6 & avg_risk <=0.8 ~ "Moderate Risk",
    avg_risk >0.8 ~ "High Risk"
  )) |> 
    select(affiliation, risk_level, avg_risk, median_risk, sd_risk) |> 
  rename("CMER Level" = 2 , "Avg. CMER"=  3 , "Median CMER" = 4, "SD CMER" = 5)
```


## 3.2 Research Results: Objective 2 {.smaller}

<br>


The analysis for this objective is divided into two parts. The first part examines the overall relationship between school, student, and area characteristics and the CMER risk. However, the researcher‚Äôs hypothesis is that these relationships likely vary across regions. Therefore, the second part of the analysis applies regularized regression to explore these relationships within each educational service area. The insights gained from this approach provide stakeholders with a deeper understanding of the regional variations, which can lead to the development of flexible, area-specific policies.


## 3.2.1 Overall Results {.smaller}

CMER Index categorized by

- Geographical & Spatial Barriers

- Infrastructure and Connectivity

- School Characteristics

- Student SES (avaliable p6 student or PESA school only)


## 3.2.1 Overall Results: Geographical & Spatial Barriers {.smaller}

<div style="font-size: 75%;">


- The analysis below presents a cumulative distribution function (CDF) plot that shows the distribution of the CMER Index. This plot can be used to compare risk levels across different groups.

- The plot can be interpreted based on the horizontal position of the curves: a curve positioned to the left indicates that the group has a lower risk, while a curve positioned to the right suggests that the group has a higher risk. Additionally, the slope of the curve reflects the distribution of risk within the group. A steeper slope indicates that a large number of schools have similar risk levels, whereas a more gradual slope suggests a wider distribution of risk levels within the group.

- The analysis found that schools that are harder to access tend to have higher risks. Additionally, the distance between the school and the district center may be another factor contributing to the increased risk for schools in hard-to-reach areas.‚Äã

</div>

```{r}
precipitaion_risk_data_cleaned_aggregated %>% 
  group_by(student_level, affiliation, hard_to_reach, distance_from_district, school_name) %>% 
  summarise(risk_index = mean(risk_index_df5)) %>% 
  ungroup() %>% 
  drop_na() %>% 
  mutate(hard_to_reach = factor(hard_to_reach, labels = c(
                      "Not Hard", "Hard", "Harder", "Hardest"))) %>% 
  ggplot(aes(x = risk_index, col = hard_to_reach)) +
  stat_ecdf(geom = "line", linewidth = 1) +
  xlab("CMER Index") +
  ylab("Cumulative Probability") +
  scale_x_continuous(breaks=c(0,0.6,0.8,1))+
  ggtitle("CMER Index categorized by \n Spatial Barriers") +
  scale_color_carto_d(type = "qualitative", palette = 2) +
  theme_light() +
  theme(text = element_text(family = "ChulaCharasNew", size = 16),
        panel.grid.minor = element_blank())
  #facet_wrap(~student_level)
```

```{r}
precipitaion_risk_data_cleaned_aggregated %>% 
  group_by(student_level, affiliation, hard_to_reach, distance_from_district, school_name) %>% 
  summarise(risk_index = mean(risk_index_df5)) %>% 
  ungroup() %>% 
  drop_na() %>% 
  mutate(hard_to_reach = factor(hard_to_reach, labels = c(
                      "Not Hard", "Hard", "Harder", "Hardest"))) %>% 
  ggplot(aes(x = risk_index, col = hard_to_reach)) +
  stat_ecdf(geom = "line", linewidth = 1) +
  xlab("CMER Index") +
  ylab("Cumulative Probability") +
  scale_x_continuous(breaks=c(0,0.6,0.8,1))+
  ggtitle("CMER Index categorized by \n Spatial Barriers and Distance") +
  scale_color_carto_d(type = "qualitative", palette = 2) +
  theme_light() +
  theme(text = element_text(family = "ChulaCharasNew", size = 16),
        panel.grid.minor = element_blank()) +
  facet_wrap(~ distance_from_district > 10,
             labeller = labeller(`distance_from_district > 10` = 
                                 c(`FALSE` = "Distance ‚â§ 10 km.", 
                                   `TRUE` = "Distance > 10 km.")))
```


<div class="caption">fig 3.10: ECDF plot of CMER Index categorized by Geographical & Spatial Barriers.</div>


## 3.2.1 Overall Results: School Infrastructure& Connectivity {.smaller}

<div style="font-size: 75%;">

- School Infrastructure& Connectivity is derived from data on the availability of electricity, water supply, and internet at the school. The `infra_readiness_score` in the plot categorized in to three level: Fully Ready, Partial, and Not Ready

- The analysis found that **schools lacking readiness in infrastructure and connectivity tend to have higher risks compared to schools that are fully or partially ready. This difference is particularly evident in schools located in remote areas.‚Äú‚Äã**

</div>

```{r}
precipitaion_risk_data_cleaned_aggregated  %>% 
   group_by(student_level,affiliation ,infra_readiness_score , school_name) %>% 
  summarise(risk_index = mean(risk_index_df5)) %>% 
  ungroup() %>% 
  drop_na() |> 
  mutate(infra_readiness_score = 
  case_when(
    infra_readiness_score > 0.9 ~ "Fully",
    infra_readiness_score >= 0.5 & infra_readiness_score<0.9 ~ "Partial",
    infra_readiness_score < 0.5 ~ "Not Ready"
  )) |> 
  mutate(infra_readiness_score =fct_relevel(infra_readiness_score, 
                  "Fully", "Partial", "Not Ready")) |> 
 ggplot(aes(x = risk_index, col = infra_readiness_score))+
  stat_ecdf(geom = "line", linewidth = 1)+
  #facet_wrap(~student_level)+
  xlab("CMER Index")+
  ylab("Cumulative Probability")+
  scale_x_continuous(breaks=c(0,0.6,0.8,1))+
  ggtitle("CMER Index categorized by \n Inflastructure & Connectivity Readiness")+
  scale_color_carto_d(type = "qualitative", palette = 2)+
  theme_light()+
  theme(text = element_text(family = "ChulaCharasNew", size = 16),
        panel.grid.minor = element_blank())
  #facet_wrap(~student_level)

```



```{r fig.width = 16}
precipitaion_risk_data_cleaned_aggregated  %>% 
   group_by(student_level,affiliation ,infra_readiness_score , distance_from_district, school_name) %>% 
  summarise(risk_index = mean(risk_index_df5)) %>% 
  ungroup() %>% 
  drop_na() |> 
  mutate(infra_readiness_score = 
  case_when(
    infra_readiness_score > 0.9 ~ "Fully",
    infra_readiness_score >= 0.5 & infra_readiness_score<0.9 ~ "Partial",
    infra_readiness_score < 0.5 ~ "Not Ready"
  )) |> 
  mutate(infra_readiness_score =fct_relevel(infra_readiness_score, 
                  "Fully", "Partial", "Not Ready")) |> 
 ggplot(aes(x = risk_index, col = infra_readiness_score))+
  stat_ecdf(geom = "line", linewidth = 1)+
  #facet_wrap(~student_level)+
  xlab("CMER Index")+
  ylab("Cumulative Probability")+
  scale_x_continuous(breaks=c(0,0.6,0.8,1))+
  ggtitle("CMER Index categorized by \n Inflastructure & Connectivity Readiness")+
  scale_color_carto_d(type = "qualitative", palette = 2)+
  theme_light()+
  theme(text = element_text(family = "ChulaCharasNew", size = 16),
        panel.grid.minor = element_blank())+
 facet_wrap(~ distance_from_district > 10,
             labeller = labeller(`distance_from_district > 10` = 
                                 c(`FALSE` = "Distance ‚â§ 10 km.", 
                                   `TRUE` = "Distance > 10 km.")))
```


<div class="caption">fig 3.11: ECDF plot of CMER Index categorized by School Infrastructure& Connectivity.</div>

<br>
<br>


## 3.2.1 Overall Results: School Characteristic {.smaller}

<div style="font-size: 75%;">

- The analysis found that small and medium-sized schools tend to have higher risks compared to large and extra-large schools. This trend is consistent across all student grade levels.

</div>

```{r}
p1 <- precipitaion_risk_data_cleaned_aggregated  %>% 
   group_by(student_level,affiliation ,school_size, school_name) %>% 
  summarise(risk_index = mean(risk_index_df5)) %>% 
  ungroup() %>% 
  mutate(student_level = fct_relevel(student_level, "p6","m3","m6")) %>% 
  mutate(school_size = fct_relevel(school_size, "XL","L","M","S")) |> 
  ggplot(aes(x = risk_index, col = school_size))+
  stat_ecdf(geom = "line", linewidth = 1)+
  #facet_wrap(~student_level)+
  scale_x_continuous(breaks=c(0,0.6,0.8,1))+
  xlab("CMER Index")+
  ylab("Cumulative Probability")+
  ggtitle("CMER Index categorized by School Size")+
  scale_color_carto_d(type = "qualitative", palette = 2)+
  theme_light()+
  theme(text = element_text(family = "ChulaCharasNew", size = 16),
        panel.grid.minor = element_blank())


p1

```


```{r fig.width = 16}

p2 <- precipitaion_risk_data_cleaned_aggregated  %>% 
   group_by(student_level,affiliation ,school_size, school_name) %>% 
  summarise(risk_index = mean(risk_index_df5)) %>% 
  ungroup() %>% 
  mutate(student_level = fct_relevel(student_level, "p6","m3","m6")) %>% 
  mutate(school_size = fct_relevel(school_size, "XL","L","M","S")) |> 
  ggplot(aes(x = risk_index, col = school_size))+
  stat_ecdf(geom = "line", linewidth = 1)+
  #facet_wrap(~student_level)+
  xlab("CMER Index")+
  ylab("Cumulative Probability")+
  scale_x_continuous(breaks=c(0,0.6,0.8,1))+
  ggtitle("CMER Index categorized by \n School Size and Student Level")+
  scale_color_carto_d(type = "qualitative", palette = 2)+
  theme_light()+
  theme(text = element_text(family = "ChulaCharasNew", size = 16),
        panel.grid.minor = element_blank())+
  facet_wrap(~student_level)

p2
```


<div class="caption">fig 3.12: ECDF plot of CMER Index categorized by School Characteristics.</div>

<br>
<br>

## 3.2.1 Overall Results: Student SES {.smaller}

<div style="font-size: 75%;">


- Overall, no significant difference in risk was found between schools with a majority of students from low-income families and those without. 

- However, when categorized by school size, a difference in risk was found between large and extra-large schools with a majority of low-income students and those without. Schools with a majority of low-income students tend to have higher risks.

</div>

```{r}
precipitaion_risk_data_cleaned_aggregated  %>% 
   group_by(student_level,affiliation ,percent_poor, school_name) %>% 
  summarise(risk_index = mean(risk_index_df5)) %>% 
  ungroup() %>% 
  drop_na() |> 
  ggplot(aes(x = risk_index, col = percent_poor))+
  stat_ecdf(geom = "line", linewidth = 1)+
  #facet_wrap(~student_level)+
  scale_x_continuous(breaks=c(0,0.6,0.8,1))+
  xlab("CMER Index")+
  ylab("Cumulative Probability")+
  ggtitle("CMER Index categorized by SES")+
  scale_color_carto_d(type = "qualitative", palette = 2)+
  theme_light()+
  theme(text = element_text(family = "ChulaCharasNew", size = 16),
        panel.grid.minor = element_blank())
```


```{r}
precipitaion_risk_data_cleaned_aggregated  %>% 
   group_by(student_level,affiliation ,school_size, percent_poor, school_name) %>% 
  summarise(risk_index = mean(risk_index_df5)) %>% 
  ungroup() %>% 
  mutate(school_size = fct_relevel(school_size, "S","M","L","XL")) |> 
  drop_na() |> 
  ggplot(aes(x = risk_index, col = percent_poor))+
  stat_ecdf(geom = "line", linewidth = 1)+
  scale_x_continuous(breaks=c(0,0.6,0.8,1))+
  xlab("CMER Index")+
  ylab("Cumulative Probability")+
  ggtitle("CMER Index categorized by SES")+
  scale_color_carto_d(type = "qualitative", palette = 2)+
  theme_light()+
  theme(text = element_text(family = "ChulaCharasNew", size = 16),
        panel.grid.minor = element_blank())+
  facet_wrap(~school_size)
```


<div class="caption">fig 3.13: ECDF plot of CMER Index categorized by Student SES.</div>

<br>
<br>

## 3.2.2 Insight Results: CMER Modelling {.smaller}


<div style="font-size: 75%;">

- In this analysis, the researchers employed regression analysis to examine the relationship between non-climate factors and the CMER Index. Based on the hypothesis that these relationships may vary across different regions due to diverse contexts, the predictive models were constructed separately for PESA and SESA educational service areas. This means that each educational service area has its own predictive model to explain the relationship between non-climate factors and the CMER Index.

The non-climate factors used to build the risk prediction model consist of six variables, categorized into four dimensions:

- **Geographical & Spatial Barriers (2 variables):**

  - School Distance: The distance from the school to the district center.
 
  - Hard to Reach: The level of difficulty in accessing the school.

- **School Infrastructure & Connectivity (1 variable):**

  - Infrastructure Readiness Score: This variable is derived from data on the availability of electricity, water supply, and internet at the school. The readiness score ranges from 0 to 1, where schools with higher infrastructure readiness have scores closer to 1.00.
  
- **School Characteristics (2 variables):**

  - School Size: Categorized into four sizes‚Äîsmall, medium, large, and extra-large. The size of a school is a significant factor that can reflect the resources and budget allocated for educational management.
  
  - Student Level: Based on the highest grade offered at the school, divided into three levels‚ÄîGrade 6 (Primary School), Grade 9 (Middle School), and Grade 12 (High School).

- **Student Socioeconomic Status (1 variable):**

  - Percentage of Low-Income Students: This factor is available only for schools under the PESA. Before analysis, the researchers converted this variable into a categorical variable with two levels: (1) Schools where the majority of students are from low-income families (percent of low-income student > 50%), and (2) Schools where low-income students are a minority. This conversion was made to ensure that the analysis results are clearly interpretable and communicable.‚Äã

Before processing, the researchers prepared the data for analysis by cleaning data, normalized all numeric variables into the same scale, and imputing missing values using the bagging trees algorithm.


</div>

<!--
## 3.2.2 Insight Results: R-Squared {.smaller}


<div style="font-size: 75%;">

- The initial analysis involves the R-squared values of the predictive models in each area, which helps analysts understand the overall relationship between non-climate factors and the CMER Index in each educational service area.

- The figure below show that the R-squared values in the group of SESA educational service areas tend to be higher than those in PESA. Most predictive models for SESA areas have R-squared values above 30%, with the highest being approximately 80%. In contrast, most PESA areas have R-squared values around 10%, and the highest R-squared value is about 68%

- The disparity in R-squared values between SESA and PESA highlights that the factors influencing educational risk differ by region. Non-climate factors have a stronger explanatory power in SESA areas compared to PESA areas.

- The results of this analysis are consistent with the hypothesis previously set by the researchers, showing that the relationship between non-climate factors and the CMER Index varies across different educational service areas. This indicates that policymakers and educators might need to consider different strategies when addressing educational risks in PESA and SESA areas. Since non-climate factors play a larger role in SESA, interventions targeting these factors could be more effective there.

</div>

<center>

```{r eval = T}
library(rcartocolor)
library(treemapify)

collapsed_data <- tidy_results |> 
  unnest(c(data)) |> 
  select(province, amphor,affiliation, term, vip,r_squared ) |> 
  mutate(percent_vip = vip*100/max(vip)) |> 
  mutate(term = ifelse(str_detect(term, "^school_size_"), "School Size", term)) |> 
  mutate(term = ifelse(str_detect(term, "^student_level_"), "Student Level", term)) %>%  # ‡∏¢‡∏∏‡∏ö‡∏ä‡∏∑‡πà‡∏≠ school_size_XXX ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô school_size
  mutate(term = ifelse(str_detect(term,"hard_to_reach"),
                       "Hard to Reach", term)) |> 
  mutate(term = ifelse(str_detect(term,"infra"),
                       "Infrastructure & Connectivity", term)) |> 
  mutate(term = ifelse(str_detect(term,"distance"),
                       "School Distance", term)) |> 
  mutate(term = ifelse(str_detect(term,"poor"),
                       "Poor Family", term)) |> 
  group_by(province, amphor, affiliation, term) %>%
  summarise(
    vip = sum(vip),  # ‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤ vip
    percent_vip = max(percent_vip),  # ‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤ percent_vip
    r_squared = max(r_squared)  # ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤ r_squared ‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
  ) %>%
  ungroup()
# write_excel_csv(collapsed_data, file = "Effect_collapsed_data.csv")
```

```{r}
collapsed_data |> 
  group_by(affiliation) |> 
  summarise(r_squared = mean(r_squared)) |> 
  ungroup() |> 
  mutate(area = ifelse(str_detect(affiliation,"‡∏™‡∏û‡∏õ."),"PESA", "SESA")) |> 
  ggplot(aes(x=r_squared, y=area,fill = area))+
  geom_violin()+
  geom_boxplot(outlier.alpha = 0, width = 0.2, fill = "white")+
  geom_jitter(height = 0.05, alpha = 0.4)+
  ylab("Educational Service Area\n")+
  xlab("\n R Squared")+
  theme_light()+
  ggtitle("R-squared for the models of each educational service area.‚Äù")+
  theme(text = element_text(family = "ChulaCharasNew", size = 15),
        legend.position = "none")
```

<div class="caption">fig 3.14: R-squared values of the predictive models in each educational service area</div>


</center>

-->

## 3.2.2 Insight Results: Importance Factors {.smaller}

<div style="font-size: 75%;">

- The bar chart below illustrates the non-climate factors most strongly associated with the CMER Index in each educational service area. This helps us identify trends regarding which factors are the primary contributors to risk in different regions. From the figure, the numbers in the bar chart represent the number of educational service areas where each factor is identified as the most important factor. Focusing on the PESA areas, we find that the top three significant factors are School Size, School Distance, and Student Level. Focusing on the PESA areas, most SESA areas identify School Size as the most significant factor.

</div>

<center>

```{r collapsed_data_creating}
collapsed_data <- tidy_results |> 
  unnest(c(data)) |> 
  select(province, amphor,affiliation, term, vip,r_squared ) |> 
  mutate(percent_vip = vip*100/max(vip)) |> 
  mutate(term = ifelse(str_detect(term, "^school_size_"), "School Size", term)) |> 
  mutate(term = ifelse(str_detect(term, "^student_level_"), "Student Level", term)) %>%  # ‡∏¢‡∏∏‡∏ö‡∏ä‡∏∑‡πà‡∏≠ school_size_XXX ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô school_size
  mutate(term = ifelse(str_detect(term,"hard_to_reach"),
                       "Hard to Reach", term)) |> 
  mutate(term = ifelse(str_detect(term,"infra"),
                       "Infrastructure & Connectivity", term)) |> 
  mutate(term = ifelse(str_detect(term,"distance"),
                       "School Distance", term)) |> 
  mutate(term = ifelse(str_detect(term,"poor"),
                       "Poor Family", term)) |> 
  group_by(province, amphor, affiliation, term) %>%
  summarise(
    vip = sum(vip),  # ‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤ vip
    percent_vip = max(percent_vip),  # ‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤ percent_vip
    r_squared = max(r_squared)  # ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤ r_squared ‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
  ) %>%
  ungroup()
```

```{r}
counts_PESA <- collapsed_data |> 
  mutate(area = ifelse(str_detect(affiliation, "‡∏™‡∏û‡∏õ."), "PESA","SESA")) |> 
  group_by(area, affiliation) |> 
  slice_max(percent_vip) |> 
  group_by(area,affiliation, term) |> 
  summarise(n = n_distinct(term)) |> 
  group_by(area,term) |> 
  count() |> 
  ungroup() |> 
  filter(area == "PESA") 

terms_ordered <- counts_PESA %>%
  arrange(n) %>%
  pull(term)

# ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏•‡πá‡∏≠‡∏ï‡∏Å‡∏£‡∏≤‡∏ü
plot_data <-  collapsed_data |> 
  mutate(area = ifelse(str_detect(affiliation, "‡∏™‡∏û‡∏õ."), "PESA","SESA")) |> 
  group_by(area, affiliation) |> 
  slice_max(percent_vip) |> 
  group_by(area,affiliation, term) |> 
  summarise(n = n_distinct(term)) |> 
  group_by(area,term) |> 
  count() |> 
  ungroup()

# ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ç‡∏≠‡∏á term ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á
plot_data$term <- factor(plot_data$term, levels = terms_ordered)

ggplot(plot_data, aes(x = term, y = n, fill = area)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c("steelblue", "maroon")) +
  xlab("\n Non-Climate Factor") +
  ylab("Number of Educational Service Area") +
  theme(
    legend.position = "right",
    text = element_text(family = "ChulaCharasNew")
  ) +
  labs(fill = "") +
  coord_flip() +
  ggtitle("The Most Important Variable Associated with CMER Index")
```


<div class="caption">fig 3.15: the non-climate factors most strongly associated with the CMER Index in each educational service area</div>

</center>



## 3.2.2 Insight Results: Importance Factors {.smaller}


<div style="font-size: 75%;">

The maps below show the most important non-climate factors for each area, divided into two images: the left image represents PESA areas, and the right image represents SESA areas.

</div>

<center>

```{r fig.height = 14, fig.width = 16}
library(sf)
library(rnaturalearth)

thailand_map <- ne_states(country = "Thailand", returnclass = "sf")

shapefile_data <- st_read("/Users/choat/Downloads/ocha-roap-d24bdc45-eb4c-4e3d-8b16-44db02667c27/tha_adm_rtsd_itos_20190221_SHP_PART_1/tha_admbnda_adm2_rtsd_20190221.shp",
quiet = TRUE) 
# ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• precipitation ‡πÅ‡∏•‡∏∞ Shapefile
school_sf <-  collapsed_data |> 
  filter(str_detect(affiliation, "‡∏™‡∏û‡∏õ.")) |> 
  group_by(affiliation) |> 
  slice_max(percent_vip) |> 
  inner_join(shapefile_data, by = c("amphor" = "ADM2_TH"))  # ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô join_by ‡πÄ‡∏õ‡πá‡∏ô c()
school_sf_label <- school_sf |> 
  filter(r_squared > 10) |> 
  group_by(province, affiliation) |> 
  slice(1) |> 
  ungroup()

# ‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏ï‡∏≤‡∏° affiliation
affiliation_boundaries <- school_sf %>%
  group_by(affiliation) %>%
  summarise(geometry = st_union(geometry))  # ‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏ï‡∏≤‡∏° affiliation
# ‡∏û‡∏•‡πá‡∏≠‡∏ï‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
PESA_p <- ggplot(data = thailand_map) +
  geom_sf(col = "white") +
  geom_sf(data = school_sf, aes(geometry = geometry, fill = term), alpha = 0.7,
          size = 0.8, color = NA) +  
  geom_sf(data = affiliation_boundaries, aes(geometry = geometry), 
          color = "black", fill = NA, size = 1, show.legend = FALSE) +  # ‡∏ï‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏ï‡∏≤‡∏° affiliation
  geom_sf_text(data = school_sf_label, aes(geometry = geometry, label = affiliation), size = 2, color = "grey20", check_overlap = TRUE,
  family = "ChulaCharasNew")+
  theme_minimal() +
  labs(fill = "Non-Climate Factor")+
  xlab("") + ylab("") +
  theme(legend.position = "right",
        text = element_text(family = "ChulaCharasNew"),
        axis.text = element_blank(),
        panel.grid = element_blank()) +
    scale_fill_manual(values = c(
    "Infrastructure & Connectivity" = "#1f78b4",
    "Poor Family" = "#33a02c",
    "School Distance" = "#e31a1c",
    "School Size" = "#ff7f00",
    "Student Level" = "#6a3d9a",
    "Hard to Reach" = "#b15928"
  ))+
  #scale_alpha_continuous(breaks=c(0,8,20), range=c(0.01,1),
  #                      guide = "none")+
  labs(alpha = "R-Squared level")+
  ggtitle("The most importance factor associated \n with the CMER Index of each PESA.")

### --- ‡∏™‡∏û‡∏°.

shapefile_data <- st_read("/Users/choat/Downloads/ocha-roap-d24bdc45-eb4c-4e3d-8b16-44db02667c27/tha_adm_rtsd_itos_20190221_SHP_PART_1/tha_admbnda_adm1_rtsd_20190221.shp",
quiet = TRUE) 

# ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• precipitation ‡πÅ‡∏•‡∏∞ Shapefile
school_sf <- collapsed_data |> 
  filter(str_detect(affiliation, "‡∏™‡∏û‡∏°.")) |> 
  group_by(province, affiliation) |> 
  slice_max(percent_vip) |> 
  inner_join(shapefile_data, by = c("province" = "ADM1_TH"))  # ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô join_by 



school_sf_label <- school_sf |> 
  filter(r_squared > 40) |> 
  group_by(province, affiliation) |> 
  slice(1) |> 
  ungroup()

# ‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏ï‡∏≤‡∏° affiliation
#affiliation_boundaries <- school_sf %>%
#  group_by(affiliation) %>%
#  summarise(geometry = st_union(geometry))  # ‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏ï‡∏≤‡∏° affiliation

# ‡∏û‡∏•‡πá‡∏≠‡∏ï‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
sesa_p <- ggplot(data = thailand_map) +
  #geom_sf(alpha = 0.5) +
  geom_sf(data = school_sf, aes(geometry = geometry, fill = term, alpha = r_squared), alpha = 0.7,
          size = 0.8, color = NA) +  
  geom_sf(data = affiliation_boundaries, aes(geometry = geometry), 
          color = "black", fill = NA, size = 1, show.legend = FALSE) +  # ‡∏ï‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏ï‡∏≤‡∏° affiliation
  geom_sf_text(data = school_sf_label, aes(geometry = geometry, label = affiliation), size = 2.5, color = "grey20", check_overlap = TRUE,
  family = "ChulaCharasNew")+
  theme_minimal() +
  labs(fill = "Non-Climate Factor")+
  xlab("") + ylab("") +
  theme(legend.position = "right",
        text = element_text(family = "ChulaCharasNew"),
        axis.text = element_blank(),
        panel.grid = element_blank()) +
   scale_fill_manual(values = c(
    "Infrastructure & Connectivity" = "#1f78b4",
    "Poor Family" = "#33a02c",
    "School Distance" = "#e31a1c",
    "School Size" = "#ff7f00",
    "Student Level" = "#6a3d9a",
    "Hard to Reach" = "#b15928"
  ))+
  ggtitle("The most importance factor associated \n with the CMER Index of each SESA.")

PESA_p + sesa_p
```


<div class="caption">fig 3.16: The most importance non-climate factors map.</div>


</center>

## Risk-Importance matrix

<div style="font-size: 75%;">


- The researcher developed the Risk-Importance Matrix (RIM) to assess climate-mapped educational risk and classify educational service areas into subgroups for more effective planning and policy-making. Specifically, the RIM helps identify priority areas for intervention by considering the CMER Index alongside the relative importance of contributing factors in each district.

</div>

<div style="font-size: 75%;">

**Matrix Key Elements and Interpretation:**

1. Y-axis: Displays the CMER Index, representing educational risk derived from academic achievement and extreme rainfall conditions. Higher values indicate greater risk levels that demand attention.

2. X-axis: Represents the Relative Importance of six factors affecting educational risk, calculated using variable importance (VIP). This axis shows how significantly each factor contributes to the overall risk in each district.

- Points higher on the Y-axis indicate districts with higher risk, requiring more urgent intervention.

- Points further to the right on the X-axis indicate factors that play a more significant role in driving risk.

</div>

<div style="font-size: 75%;">

**Key Groups in the Matrix:**

1.	Strategic Focus: Areas with high risk and high importance of contributing factors. These areas require immediate policy attention and intervention.

2.	Development Priority: Areas with high risk but lower factor importance, where development efforts can help mitigate risks.

3.	Monitoring: Areas with lower risk but higher factor importance, which should be monitored to ensure risks do not escalate.

4.	Low-risk Group: Areas with both low risk and low factor importance, which may require minimal intervention but regular monitoring.

</div>


## Risk-Importance matrix (RIM): PESA



```{r}
 data_for_performance <- collapsed_data |> 
  mutate(group = case_when(
    str_detect(affiliation, "‡∏™‡∏û‡∏õ.") ~ "PESA",
    str_detect(affiliation, "‡∏™‡∏û‡∏°.") ~ "SESA"
  )) |> 
  inner_join(
  precipitaion_risk_data_cleaned_aggregated |> 
    group_by(affiliation) |> 
    summarise(CMER = median(risk_index_df5)), by = "affiliation") |> 
  ungroup() |> 
  group_by(group, affiliation, term) |> 
  summarise(vip = mean(vip),
            CMER = mean(CMER),
            r_squared = mean(r_squared)) |> 
  ungroup() |> 
  group_by(group, term) |> 
  mutate(percent_vip = vip*100/max(vip))
```


```{r fig.width = 15, fig.height=10}
# ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏™‡πâ‡∏ô‡∏ú‡πà‡∏≤‡∏ô
x_points <- c(-1, 50, 105)
y_points <- c(max(data_for_performance$CMER), 0.6, 0.6)
spline_curve <- spline(x_points, y_points, n = 100)
spline_curve <- data.frame(x= spline_curve$x, y= spline_curve$y)

x_points2 <- c(0, 25, 50)
y_points2 <- c(0.2, 0.15, 0)
spline_curve2 <- spline(x_points2, y_points2, n = 100)
spline_curve2 <- data.frame(x= spline_curve2$x, y= spline_curve2$y)

# ‡∏™‡∏°‡∏°‡∏∏‡∏ï‡∏¥‡∏ß‡πà‡∏≤ data_for_performance ‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå x (percent_vip) ‡πÅ‡∏•‡∏∞ y (CMER)
data_for_performance2 <- data_for_performance %>%
  filter(str_detect(affiliation, "‡∏™‡∏û‡∏õ.")) |> 
  mutate(spline_y = approx(spline_curve$x, spline_curve$y, xout = percent_vip)$y) |> 
  mutate(y_segment = 0.4 - (0.2/100)*percent_vip) 


# ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà CMER ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏™‡πâ‡∏ô spline
data_above_spline <- data_for_performance2 %>%
  filter(CMER > spline_y)

data_for_performance |> 
  filter(str_detect(affiliation, "‡∏™‡∏û‡∏õ.")) |> 
  #filter(term == "Hard to Reach") |> 
  ggplot(aes(x = percent_vip, y = CMER))+
  geom_point(size = 3, shape = 16, alpha =0.3)+
  geom_line(data = spline_curve,
    aes(x = x, y = y), linetype = 3) +
  geom_line(data = spline_curve2,
    aes(x = x, y = y), linetype = 3) +
   geom_segment(aes(x = 0, y = 0.4, xend = 100, yend = 0.2), linetype = 3) +  
 # geom_hline(yintercept = 0.6, linetype = 3)+
 # geom_vline(xintercept = 50, linetype = 3)+
  geom_point(data = data_above_spline, aes(x = percent_vip, y = CMER), size = 3, col = "maroon", alpha = 0.7)+
  geom_text_repel(data = data_above_spline, aes(label = affiliation), 
  col = "maroon", family = "ChulaCharasNew", size = 2.5) +
geom_text_repel(data = data_for_performance2 %>%
    filter(CMER < y_segment), aes(label = affiliation), col = "grey20",
    family = "ChulaCharasNew", size = 2,
    min.segment.length = 10) +
geom_text_repel(data = data_for_performance2 %>%
    filter(CMER < spline_y & percent_vip >60), aes(label = affiliation), col = "grey20",
    family = "ChulaCharasNew", size = 2, nudge_y = -0.01,
    min.segment.length = 10)+
  geom_label(x=80, y=0.77, label = "Strategic Focus",
  family = "ChulaCharasNew", col = "maroon")+
  geom_label(x=80, y=0.28, label = "Development Priority",
  angle = -12,
  family = "ChulaCharasNew")+
  geom_label(x=60, y=0.15, label = "Monitoring",
  family = "ChulaCharasNew")+
  geom_label(x=12, y=0.05, label = "Low-risk",
  family = "ChulaCharasNew")+
    ylim(0,0.8)+
    xlim(0,100)+
    theme_light()+
    theme(panel.grid = element_blank(),
    strip.text = element_text(color = "grey20"))+
    facet_wrap(~term)

risk_matrix_data <- data_for_performance %>%
  filter(str_detect(affiliation, "‡∏™‡∏û‡∏õ.")) |> 
  mutate(spline_y = approx(spline_curve$x, spline_curve$y, xout = percent_vip)$y) |> 
  mutate(y_segment = 0.4 - (0.2/100)*percent_vip) |> 
  mutate(strategic_focus = CMER > spline_y) |> 
  arrange(desc(strategic_focus)) |> 
  select(affiliation, CMER,term,strategic_focus) |> 
  filter(strategic_focus == TRUE)
```


<div class="caption">fig 3.17: Risk-Importance matrix for PESA.</div>


## Risk-Importance matrix (RIM): SESA

```{r fig.width = 15, fig.height=10}

# ‡∏™‡∏°‡∏°‡∏∏‡∏ï‡∏¥‡∏ß‡πà‡∏≤ data_for_performance ‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå x (percent_vip) ‡πÅ‡∏•‡∏∞ y (CMER)
data_for_performance2 <- data_for_performance %>%
  filter(str_detect(affiliation, "‡∏™‡∏û‡∏°.")) |> 
  mutate(spline_y = approx(spline_curve$x, spline_curve$y, xout = percent_vip)$y) |> 
  mutate(y_segment = 0.4 - (0.2/100)*percent_vip) 


# ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà CMER ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏™‡πâ‡∏ô spline
data_above_spline <- data_for_performance2 %>%
  filter(CMER > spline_y)



data_for_performance |> 
  filter(str_detect(affiliation, "‡∏™‡∏û‡∏°.")) |> 
  #filter(term == "Hard to Reach") |> 
  ggplot(aes(x = percent_vip, y = CMER))+
  geom_point(size = 3, shape = 16, alpha =0.3)+
  geom_line(data = spline_curve,
    aes(x = x, y = y), linetype = 3) +
  geom_line(data = spline_curve2,
    aes(x = x, y = y), linetype = 3) +
   geom_segment(aes(x = 0, y = 0.4, xend = 100, yend = 0.2), linetype = 3) +  
 # geom_hline(yintercept = 0.6, linetype = 3)+
 # geom_vline(xintercept = 50, linetype = 3)+
  geom_point(data = data_above_spline, aes(x = percent_vip, y = CMER), size = 3, col = "maroon", alpha = 0.7)+
  geom_text_repel(data = data_above_spline, aes(label = affiliation), 
  col = "maroon", family = "ChulaCharasNew", size = 2.5) +
geom_text_repel(data = data_for_performance2 %>%
    filter(CMER < y_segment), aes(label = affiliation), col = "grey20",
    family = "ChulaCharasNew", size = 2,
    min.segment.length = 10) +
geom_text_repel(data = data_for_performance2 %>%
    filter(CMER < spline_y & percent_vip >60), aes(label = affiliation), col = "grey20",
    family = "ChulaCharasNew", size = 2, nudge_y = -0.01,
    min.segment.length = 10)+
  geom_label(x=80, y=0.77, label = "Strategic Focus",
  family = "ChulaCharasNew", col = "maroon")+
  geom_label(x=80, y=0.28, label = "Development Priority",
  angle = -12,
  family = "ChulaCharasNew")+
  geom_label(x=60, y=0.15, label = "Monitoring",
  family = "ChulaCharasNew")+
  geom_label(x=12, y=0.05, label = "Low-risk",
  family = "ChulaCharasNew")+
    ylim(0,0.8)+
    xlim(0,100)+
    theme_light()+
    theme(panel.grid = element_blank(),
    strip.text = element_text(color = "grey20"))+
    facet_wrap(~term)
```


<div class="caption">fig 3.18: Risk-Importance matrix for SESA.</div>


<!--

## 3.2.2 Insight Results: Importance Factors {.smaller}

<div style="font-size: 75%;">

- The figure below is called a VIP plot (Variable Importance in Projection plot). The scores on the x-axis represent the relative importance of non-climate factors to the CMER Index within each educational service area, expressed as percentages. A variable with a VIP value of 100% indicates that it is the most important factor or can best predict the risk in that area.

-  Readers can select and view the factors associated with the CMER Index for each educational service area. This demonstrates that the non-climate data used to predict risk varies across different areas, reflecting the unique context of each area. Consequently, policy planning and support methods for each area should be tailored to align with their specific needs.

</div>

```{ojs}
// Import necessary libraries
import { Inputs } from "@observablehq/inputs";
import { Plot } from "@observablehq/plot";

// Load data from file attachment with type parsing
collapsed_data = await d3.csv("https://raw.githubusercontent.com/datakruroo/unicef/main/Effect_collapsed_data.csv", d3.autoType);


// Create a dropdown for selecting 'affiliation'
viewof selected_affiliation = Inputs.select(
  Array.from(new Set(collapsed_data.map(d => d.affiliation))).sort(),
  {
    label: "Select an Affiliation",
    element: (input) => {
      // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏Ç‡∏≠‡∏á select ‡πÅ‡∏•‡∏∞ label
      input.querySelector("select").style.fontSize = "12px";
      input.querySelector("label").style.fontSize = "12px";
      return input;
    }
  }
);

// Filter data according to selected affiliation
filtered_data = collapsed_data.filter(d => d.affiliation === selected_affiliation);

// Plot the chart
chart = {
  if (filtered_data.length > 0) {

    // ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• filtered_data ‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢‡∏ï‡∏≤‡∏° percent_vip
    const sorted_data = filtered_data.slice().sort((a, b) => b.percent_vip - a.percent_vip);

    // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á term ‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô domain ‡πÉ‡∏ô‡πÅ‡∏Å‡∏ô y
    const sorted_terms = sorted_data.map(d => d.term);

    return Plot.plot({
      marginLeft: 200,
      color: { legend: true },
      marks: [
        Plot.barX(
          sorted_data,
          {
            y: "term",
            x: "percent_vip",
            fill: "term",
            title: d => `${d.term}: ${d.percent_vip.toFixed(2)}%`
          }
        )
      ],
      x: { label: "Percent VIP (%)" },
      y: { label: "Non-Climate Factor \n \n \n", domain: sorted_terms },  // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏Å‡∏ô y ‡∏ï‡∏≤‡∏° terms ‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß
      height: 400,
      width: 600,
      style: { background: "white" }
    });
  } else {
    return md`No data available for the selected affiliation.`;
  }
}
```

<br>

<div class="caption">fig 3.17: VIP plot for each educational service area.</div>

<br>
<br>




## 3.1.2 Descriptive results of the CMER Index (2) {.smaller .hidden}

<div style="font-size: 75%;">

The following figure presents a spatial risk map showing schools in Thailand with risk scores in the moderate range (0.6, 0.8] and high-risk levels (0.8, 1.0], categorized by student grade levels. Additionally, the researcher has included spatial barriers data, such as special geographic characteristics of schools (island, highland in remote areas) and the level of difficulty in accessing the school (no difficulty, hard, harder, hardest), plotted on the map as well.

</div>


```{r fig.width = 14, fig.height = 10, eval = F}
library(rnaturalearth)
library(sf)
library(ggrepel)
thailand_map <- ne_states(country = "Thailand", returnclass = "sf")

school_sf <- precipitaion_risk_data |> 
  group_by(student_level, school_lon, school_lat,school_size, type_of_hard, hard_to_reach, location, school_name) %>% 
  summarise(risk_index = mean(risk_index),
            #robust_index = mean(robust_index),
            ach_score =mean(ach_score)) %>% 
  ungroup() %>% 
  select(student_level, school_lon, school_lat, type_of_hard, hard_to_reach, school_size, ach_score, risk_index) |> drop_na() |> 
  mutate(student_level = fct_relevel(student_level, "p6","m3","m6")) %>% 
  mutate(type_of_hard = factor(type_of_hard, labels=c("None","Highland in Remote Area","Island"))) |> 
  mutate(hard_to_reach = factor(hard_to_reach, labels=c("None","Hard","Harder","Hardest"))) |> 
  filter(risk_index>=0.6 & risk_index<0.8) %>% 
  st_as_sf(coords = c("school_lon", "school_lat"), crs = 4326)

p1 <- ggplot(data = thailand_map)+
  geom_sf()+
  geom_sf(data = school_sf, aes(geometry = geometry, shape = type_of_hard, col = hard_to_reach),
          alpha = 0.3,  size = 0.8) +
  theme_minimal() +
  xlab("")+ylab("")+
  facet_wrap(~student_level)+
  theme(legend.position = "left",
        axis.text = element_blank(),
        panel.grid = element_blank(),
        text = element_text(family = "ChulaCharasNew", size = 16))+
  scale_color_manual(values=c("orange","#D8A25E","#A04747","#821131"))+
  ggtitle("Moderate Risk")+
  guides(color = guide_legend(override.aes = list(size = 4)),  # ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏™‡∏µ
         shape = guide_legend(override.aes = list(size = 4)))+  # ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î
  labs(shape = "Geographic \n characteristics",
        col = "Difficulty level \n in accessing the school")

school_sf <- precipitaion_risk_data |> 
  group_by(year, student_level, school_lon, school_lat,school_size, location, type_of_hard, hard_to_reach,school_name) %>% 
  summarise(risk_index = mean(risk_index),
           # robust_index = mean(robust_index),
            ach_score =mean(ach_score)) %>% 
  ungroup() %>% 
  select(student_level, school_lon, school_lat, type_of_hard, hard_to_reach,school_size, ach_score, risk_index) |> drop_na() |> 
  mutate(student_level = fct_relevel(student_level, "p6","m3","m6")) %>% 
  mutate(student_level = fct_relevel(student_level, "p6","m3","m6")) %>% 
  mutate(type_of_hard = factor(type_of_hard, labels=c("None","Highland in Remote Area","Island"))) |> 
 mutate(hard_to_reach = factor(hard_to_reach, labels=c("None","Hard","Harder","Hardest"))) |> 
  filter(risk_index>=0.80) %>% 
  st_as_sf(coords = c("school_lon", "school_lat"), crs = 4326)

p2 <- ggplot(data = thailand_map)+
  geom_sf()+
  geom_sf(data = school_sf, aes(geometry = geometry, shape = type_of_hard, col = hard_to_reach) ,
          alpha = 0.3,  size = 2) +
  geom_text_repel(aes(label = name, geometry = geometry), min.segment.length = 10,
                  stat = "sf_coordinates", size =1.5, col = "grey40")+
  theme_minimal() +
  xlab("")+ylab("")+
  facet_wrap(~student_level)+
  ggtitle("High Risk")+
  theme(legend.position = "left",
        axis.text = element_blank(),
        panel.grid = element_blank(),
        text = element_text(family = "ChulaCharasNew", size = 16))+
  scale_color_manual(values=c("orange","#D8A25E","#A04747","#821131"))+
  guides(color = guide_legend(override.aes = list(size = 4)),  # ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏™‡∏µ
         shape = guide_legend(override.aes = list(size = 4)))+  # ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î
  labs(shape = "Geographic \n characteristics",
        col = "Difficulty level \n in accessing the school")
```


::: {.panel-tabset}

## Moderate Risk School Map

<center>

```{r eval = F}
p1
```


</center>

<div class="caption">fig 3.5: Spatial Risk Map (Moderate Risk) categorized by Student Level</div>

<br>
<br>

## High Risk School Map

<center>

```{r eval = F}
p2
```

</center>

<div class="caption">fig 3.6: Spatial Risk Map (High Risk) categorized by Student Level</div>

<br>
<br>


:::
-->