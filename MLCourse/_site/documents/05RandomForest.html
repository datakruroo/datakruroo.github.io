<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="ผศ.ดร.สิวะโชติ ศรีสุทธิยากร">

<title>2758688 ML PRIN APPLN - Random Forest</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<meta property="og:title" content="2758688 ML PRIN APPLN - Random Forest">
<meta property="og:description" content="ถึงแม้ว่า Decision tree จะเป็นโมเดลที่สร้างง่าย ใช้งาน และแปลผลง่าย แต่โดยทั่วไปแล้ว ประสิทธิภาพการทำนายของ decision tree มักไม่ค่อยดี และสุ่มเสี่ยงที่จะเกิดปัญหา overfitting ได้ง่ายอีกด้วย">
<meta property="og:site-name" content="2758688 ML PRIN APPLN">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Random Forest</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-center sidebar-header">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../images/logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/ssiwacho/2758688_ML" title="GitHub ของรายวิชา" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
    <a href="https://cmgr.oit.duke.edu/containers" title="RStudio Containers" class="sidebar-tool px-1"><i class="bi bi-code-square"></i></a>
    <a href="" title="Sakai" id="sidebar-tool-dropdown-0" class="sidebar-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-person-fill"></i></a>
    <ul class="dropdown-menu" aria-labelledby="sidebar-tool-dropdown-0">
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://sakai.duke.edu/portal/site/779c3ebe-3b88-4bcc-bd01-1813e8396a23/tool/13b6446a-a6c6-4222-8cfb-c36d1f70802b">
          Discussion forum
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://sakai.duke.edu/portal/site/779c3ebe-3b88-4bcc-bd01-1813e8396a23/page/aec742dc-2972-4f02-a35b-1dd3315af889">
          Gradescope
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://sakai.duke.edu/portal/site/779c3ebe-3b88-4bcc-bd01-1813e8396a23/tool/69078433-67a6-4054-a2e7-9e6c202ecdc3/">
          Gradebook
          </a>
        </li>
    </ul>
</div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false">Course information</a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../course-overview.html" class="sidebar-item-text sidebar-link">Overview</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../syllabus-th-PDF-2758688.PDF" class="sidebar-item-text sidebar-link">Syllabus</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../course-team.qmd" class="sidebar-item-text sidebar-link">Teaching team</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">Schedule</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../course-links.qmd" class="sidebar-item-text sidebar-link">Useful links</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../course-faq.qmd" class="sidebar-item-text sidebar-link">FAQ</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">สารบัญ</h2>
   
  <ul>
  <li><a href="#บทท-7-random-forest-algorithm" id="toc-บทท-7-random-forest-algorithm" class="nav-link active" data-scroll-target="#บทท-7-random-forest-algorithm">บทที่ 7 : Random Forest Algorithm</a>
  <ul class="collapse">
  <li><a href="#basic-concepts" id="toc-basic-concepts" class="nav-link" data-scroll-target="#basic-concepts">7.1 Basic Concepts</a></li>
  <li><a href="#out-of-bag-oob" id="toc-out-of-bag-oob" class="nav-link" data-scroll-target="#out-of-bag-oob">7.2 Out-of-Bag (OOB)</a></li>
  <li><a href="#hyperparameters-ของ-random-forest" id="toc-hyperparameters-ของ-random-forest" class="nav-link" data-scroll-target="#hyperparameters-ของ-random-forest">7.3 Hyperparameters ของ Random Forest</a></li>
  <li><a href="#ตวอยางการวเคราะห-random-forest" id="toc-ตวอยางการวเคราะห-random-forest" class="nav-link" data-scroll-target="#ตวอยางการวเคราะห-random-forest">7.4 ตัวอย่างการวิเคราะห์ random forest</a></li>
  <li><a href="#fine-tune-hyperparameters" id="toc-fine-tune-hyperparameters" class="nav-link" data-scroll-target="#fine-tune-hyperparameters">7.5 fine-tune hyperparameters</a>
  <ul class="collapse">
  <li><a href="#ขนแรก-นำเขาขอมล-และจดการ-label-ของขอมล" id="toc-ขนแรก-นำเขาขอมล-และจดการ-label-ของขอมล" class="nav-link" data-scroll-target="#ขนแรก-นำเขาขอมล-และจดการ-label-ของขอมล">ขั้นแรก นำเข้าข้อมูล และจัดการ label ของข้อมูล</a></li>
  <li><a href="#ขนทสอง-แบงชดขอมล" id="toc-ขนทสอง-แบงชดขอมล" class="nav-link" data-scroll-target="#ขนทสอง-แบงชดขอมล">ขั้นที่สอง แบ่งชุดข้อมูล</a></li>
  <li><a href="#ขนทสาม-สราง-recipe-object-สำหรบจดการขอมล" id="toc-ขนทสาม-สราง-recipe-object-สำหรบจดการขอมล" class="nav-link" data-scroll-target="#ขนทสาม-สราง-recipe-object-สำหรบจดการขอมล">ขั้นที่สาม สร้าง recipe object สำหรับจัดการข้อมูล</a></li>
  <li><a href="#ขนท-4-กำหนดโมเดล-model-specification" id="toc-ขนท-4-กำหนดโมเดล-model-specification" class="nav-link" data-scroll-target="#ขนท-4-กำหนดโมเดล-model-specification">ขั้นที่ 4 กำหนดโมเดล (model specification)</a></li>
  <li><a href="#ขนท-5-สราง-workflow" id="toc-ขนท-5-สราง-workflow" class="nav-link" data-scroll-target="#ขนท-5-สราง-workflow">ขั้นที่ 5 สร้าง workflow</a></li>
  <li><a href="#ขนท-6-เตรยมทำ-cross-validation-และกำหนด-hyperparameter-grid" id="toc-ขนท-6-เตรยมทำ-cross-validation-และกำหนด-hyperparameter-grid" class="nav-link" data-scroll-target="#ขนท-6-เตรยมทำ-cross-validation-และกำหนด-hyperparameter-grid">ขั้นที่ 6 เตรียมทำ cross-validation และกำหนด hyperparameter grid</a></li>
  <li><a href="#ขนท-7-ทำ-cv-เพอนำขอมลมา-tune-hyperparameters" id="toc-ขนท-7-ทำ-cv-เพอนำขอมลมา-tune-hyperparameters" class="nav-link" data-scroll-target="#ขนท-7-ทำ-cv-เพอนำขอมลมา-tune-hyperparameters">ขั้นที่ 7 ทำ CV เพื่อนำข้อมูลมา tune hyperparameters</a></li>
  <li><a href="#วเคราะห-tuning-results" id="toc-วเคราะห-tuning-results" class="nav-link" data-scroll-target="#วเคราะห-tuning-results">วิเคราะห์ tuning results</a></li>
  <li><a href="#ขนท-8-finalized" id="toc-ขนท-8-finalized" class="nav-link" data-scroll-target="#ขนท-8-finalized">ขั้นที่ 8 Finalized</a></li>
  </ul></li>
  <li><a href="#grid-search-methods" id="toc-grid-search-methods" class="nav-link" data-scroll-target="#grid-search-methods">7.6 Grid Search methods</a></li>
  <li><a href="#regular-grid" id="toc-regular-grid" class="nav-link" data-scroll-target="#regular-grid">Regular grid</a></li>
  <li><a href="#irregular-grid" id="toc-irregular-grid" class="nav-link" data-scroll-target="#irregular-grid">Irregular grid</a></li>
  </ul></li>
  <li><a href="#บทท-8-workflow-set" id="toc-บทท-8-workflow-set" class="nav-link" data-scroll-target="#บทท-8-workflow-set">บทที่ 8: workflow set</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Random Forest</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>ผศ.ดร.สิวะโชติ ศรีสุทธิยากร </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<div class="cell">

</div>
<section id="บทท-7-random-forest-algorithm" class="level1">
<h1>บทที่ 7 : Random Forest Algorithm</h1>
<p>ถึงแม้ว่า Decision tree จะเป็นโมเดลที่สร้างง่าย ใช้งาน และแปลผลง่าย แต่โดยทั่วไปแล้ว ประสิทธิภาพการทำนายของ decision tree มักไม่ค่อยดี และสุ่มเสี่ยงที่จะเกิดปัญหา overfitting ได้ง่ายอีกด้วย</p>
<p><img src="images/image-1695152319.png" class="img-fluid"></p>
<section id="basic-concepts" class="level2">
<h2 class="anchored" data-anchor-id="basic-concepts">7.1 Basic Concepts</h2>
<p>จากข้อจำกัดของ decision tree (รวมทั้ง ML แบบ single learner ตัวอื่น ๆ ) จึงมีการพัฒนาวิธีการสร้างโมเดลทำนายโดยใช้การรวมผลทำนายจากชุดข้อมูล bootstrap เรียกว่า bootstrap aggregation (bagging) รูปด้านล่างแสดงแนวคิดพื้นฐานของ bagging method</p>
<p><img src="images/image-1237506128.png" class="img-fluid"></p>
<p>random forest ในยุคแรกใช้แนวคิดของ bagging ข้างต้นโดยตรง โดยมีขั้นตอนการดำเนินงานดังนี้</p>
<p>กำหนดให้ training dataset ของผู้วิเคราะห์มีขนาด n หน่วย</p>
<ol type="1">
<li><p>สร้าง bootstrap dataset โดยใช้การสุ่มตัวอย่างแบบใส่คืน ขนาด n หน่วย (sampling with replacement) จากชุดข้อมูล trainng data</p></li>
<li><p>นำชุดข้อมูลแต่ละชุดมาสร้าง decision tree</p></li>
<li><p>ทวนซ้ำขั้นตอนที่ 1 และ 2 จนครบ bootstrap dataset ทั้งหมด</p></li>
<li><p>นำผลทำนายจาก bootstrap dataset แต่ละชุดมาหา majority vote</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/image-275986106.png" class="img-fluid figure-img" alt="ตัวอย่าง bootstrap dataset"></p>
<p></p><figcaption class="figure-caption">ตัวอย่าง bootstrap dataset</figcaption><p></p>
</figure>
</div></li>
</ol>
<p>อย่างไรก็ตาม bagging tree ข้างต้นมีข้อจำกัดกล่าวคือในแต่ละรอบของการทวนซ้ำ อัลกอริทึมมักสร้าง decision tree ที่ซ้ำซ้อนกัน ซึ่งให้ประสิทธิภาพการทำนายไม่ได้ดีขึ้นเท่าที่ควร จากข้อจำกัดนี้จึงมีการพัฒนา random forest algorithm ขึ้น ซึ่งมีรายละเอียดดังนี้</p>
<pre><code>1. สร้าง training dataset
2. กำหนด hyperparameter ของโมเดล
3. สร้าง bootstrap dataset จาก traning dataset
4. สร้าง decision tree จาก bootstrap dataset ดังกล่าวภายใต้เงื่อนไขของ hyperparameter ที่กำหนด 
5. นำ decision tree ใน 4. ไปคำนวณ error ใน OOB แล้วเก็บค่าไว้
6. ทวนซ้ำ 3 - 5 ใหม่ จนได้จำนวน tree model ครบตามกำหนด นำ OOB error ของ model ทั้งหมดมาเฉลี่ยรวมกันจะได้ error ของ random forest 
7. ทวนซ้ำ 2. ถึง 6. ใหม่ด้วย cross-validation จนครบทั้ง hyperparameter grid นำ error ทั้งหมดมาวิเคราะห์เพื่อเลือก hyperparameter ชุดที่ดีที่สุด</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/image-2033240077.png" class="img-fluid figure-img" alt="สิวะโชติ ศรีสุทธิยากร (2564)"></p>
<p></p><figcaption class="figure-caption">สิวะโชติ ศรีสุทธิยากร (2564)</figcaption><p></p>
</figure>
</div>
</section>
<section id="out-of-bag-oob" class="level2">
<h2 class="anchored" data-anchor-id="out-of-bag-oob">7.2 Out-of-Bag (OOB)</h2>
<p>จากตัวอย่าง algorithm ของ random forest ข้างต้นจะเห็นว่ามี hyperparameter ที่จะต้อง fine-tune เนื่องจาก random forest สร้างขึ้นจาก bootstrap dataset การตรวจสอบประสิทธิภาพของโมเดลเพื่อ fine-tune hyperparameters จึงจะใช้การประเมินจาก out-of-bag error โดยที่ out-of-bag error จะคำนวณจากหน่วยข้อมูลที่ไม่ถูกเลือกให้อยู่ภายใต้ bootstrap dataset ในแต่ลละรอบ ซึ่งในทางทฤษฎีจะมีหน่วยข้อมูลแบบ OOB นี้คิดเป็นร้อยละประมาณ 37 ของ original dataset</p>
</section>
<section id="hyperparameters-ของ-random-forest" class="level2">
<h2 class="anchored" data-anchor-id="hyperparameters-ของ-random-forest">7.3 Hyperparameters ของ Random Forest</h2>
<p>hyperparameter ของ random forest เช่น</p>
<ol type="1">
<li><strong>n_trees</strong> — จำนวนต้นไม้ของแต่ละ random forest จำนวนต้นไม้มีผลโดยตรงต่อประสิทธิภาพในการทำนาย กล่าวคือหากกำหนดให้มีต้นไม้จำนวนมาก การประมาณประสิทธิภาพในการทำนายจะทำได้อย่างคงเส้นคงวา ส่งผลให้การ fine-tune hyperparameter ทำได้อย่างมีประสิทธิภาพตามไปด้วย อย่างไรก็ตามจำนวนต้นไม้ที่มากเกินไปก็จะใช้ทรัพยากรการประมวลผลที่มากตามไปด้วย</li>
<li><strong>mtry</strong> — จำนวนของ feature ที่จะสุ่มมาสร้าง tree model แต่ละ model ภายใต้ random forest</li>
<li><strong>cp</strong> — หรือ cost of complexity hyperparameter อธิบายโดยละเอียดไปแล้วใน decision tree</li>
<li><strong>minspit</strong> — จำนวนหน่วยข้อมูลขั้นต่ำที่ต้องมีภายในแต่ละ node (node size)</li>
<li><strong>minbucket</strong> — จำนวนหน่วยข้อมูลขั้นต่ำของ Terminal node</li>
<li><strong>maxdepth.</strong> — ความลึกสูงที่สุดของต้นไม้แต่ละต้น</li>
<li><strong>splitrule</strong></li>
</ol>
</section>
<section id="ตวอยางการวเคราะห-random-forest" class="level2">
<h2 class="anchored" data-anchor-id="ตวอยางการวเคราะห-random-forest">7.4 ตัวอย่างการวิเคราะห์ random forest</h2>
<p>ใน R มี package หลายตัวที่สามารถใช้วิเคราะห์ random forest ได้ package หนึ่งที่มีประสิทธิภาพคือ ranger ชุดคำสั่งต่อไปนี้เป็นการใช้ฟังก์ชัน <code>ranger</code> โดยตรงเพื่อวิเคราะห​ random forest</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rsample)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ranger)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vip)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'vip'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:utils':

    vi</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(yardstick)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># importing and preprocessing</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"https://raw.githubusercontent.com/ssiwacho/2758688_ML/main/week%201/TeacherSalaryData.csv"</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat[,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     rank            discipline        yrs.since.phd    yrs.service   
 Length:397         Length:397         Min.   : 1.00   Min.   : 0.00  
 Class :character   Class :character   1st Qu.:12.00   1st Qu.: 7.00  
 Mode  :character   Mode  :character   Median :21.00   Median :16.00  
                                       Mean   :22.31   Mean   :17.61  
                                       3rd Qu.:32.00   3rd Qu.:27.00  
                                       Max.   :56.00   Max.   :60.00  
     sex                salary      
 Length:397         Min.   : 57800  
 Class :character   1st Qu.: 91000  
 Mode  :character   Median :107300  
                    Mean   :113706  
                    3rd Qu.:134185  
                    Max.   :231545  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>dat1_preproc<span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">salary_class =</span> <span class="fu">ifelse</span>(salary<span class="sc">&gt;=</span><span class="dv">100000</span>,<span class="dv">1</span>,<span class="dv">0</span>),</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">salary_class =</span> <span class="fu">factor</span>(salary_class,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                               <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>),</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                               <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"low"</span>,<span class="st">"high"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>salary)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dat1_preproc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     rank            discipline        yrs.since.phd    yrs.service   
 Length:397         Length:397         Min.   : 1.00   Min.   : 0.00  
 Class :character   Class :character   1st Qu.:12.00   1st Qu.: 7.00  
 Mode  :character   Mode  :character   Median :21.00   Median :16.00  
                                       Mean   :22.31   Mean   :17.61  
                                       3rd Qu.:32.00   3rd Qu.:27.00  
                                       Max.   :56.00   Max.   :60.00  
     sex            salary_class
 Length:397         low :140    
 Class :character   high:257    
 Mode  :character               
                                
                                
                                </code></pre>
</div>
</div>
<p>ขั้นตอนถัดมาคือแบ่งชุดข้อมูลเป็น training และ test dataset</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(dat1_preproc, <span class="at">prop =</span> <span class="fl">0.8</span>, <span class="at">strata =</span> salary_class)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>train<span class="ot">&lt;-</span><span class="fu">training</span>(split)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>test<span class="ot">&lt;-</span><span class="fu">testing</span>(split)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(train<span class="sc">$</span>salary_class)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 low high 
 112  205 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(test<span class="sc">$</span>salary_class)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 low high 
  28   52 </code></pre>
</div>
</div>
<p>วิเคราะห์ random forest model ด้วยฟังก์ชัน <code>ranger()</code> ในตัวอย่างนี้จะกำหนดให้เป็นค่าเริ่มต้นทั้งหมดก่อน</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>fit_rf1 <span class="ot">&lt;-</span> <span class="fu">ranger</span>(salary_class <span class="sc">~</span> . ,</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> train,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">importance =</span> <span class="st">"impurity"</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>fit_rf1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Ranger result

Call:
 ranger(salary_class ~ ., data = train, importance = "impurity") 

Type:                             Classification 
Number of trees:                  500 
Sample size:                      317 
Number of independent variables:  5 
Mtry:                             2 
Target node size:                 1 
Variable importance mode:         impurity 
Splitrule:                        gini 
OOB prediction error:             15.14 % </code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">vip</span>(fit_rf1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="05RandomForest_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>คำนวณค่าทำนายและตรวจสอบความคลาดเคลื่อนของค่าทำนายบนชุดข้อมูล test data</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>pred_class <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_rf1, test, <span class="at">type=</span><span class="st">"response"</span>)<span class="sc">$</span>predictions</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(pred, test<span class="sc">$</span>salary_class)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="fine-tune-hyperparameters" class="level2">
<h2 class="anchored" data-anchor-id="fine-tune-hyperparameters">7.5 fine-tune hyperparameters</h2>
<p>หัวข้อนี้จะแสดงการ fine-tune hyperparameter ของ random forest ตาม algorithm ที่ในข้างต้น โดยใช้ tidymodel framwork รายละเอียดมีดังนี้</p>
<section id="ขนแรก-นำเขาขอมล-และจดการ-label-ของขอมล" class="level3">
<h3 class="anchored" data-anchor-id="ขนแรก-นำเขาขอมล-และจดการ-label-ของขอมล">ขั้นแรก นำเข้าข้อมูล และจัดการ label ของข้อมูล</h3>
<p>ตัวอย่างนี้จะแปลงข้อมูลตัวแปรตาม <code>salary</code> ให้เป็นตัวแปรแบบจัดประเภทที่มี 2 กลุ่ม คือกลุ่มที่เป็นอาจารย์รายได้สูง (&gt;= 100,000 บาท) และกลุ่มอาจารย์รายได้ต่ำ (&lt; 100,000 บาท)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parsnip)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(recipes)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co"># importing dataset</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"https://raw.githubusercontent.com/ssiwacho/2758688_ML/main/week%201/TeacherSalaryData.csv"</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(dat, <span class="at">width =</span> <span class="dv">80</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 397
Columns: 7
$ X             &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 1…
$ rank          &lt;chr&gt; "Prof", "Prof", "AsstProf", "Prof", "Prof", "AssocProf",…
$ discipline    &lt;chr&gt; "B", "B", "B", "B", "B", "B", "B", "B", "B", "B", "B", "…
$ yrs.since.phd &lt;int&gt; 19, 20, 4, 45, 40, 6, 30, 45, 21, 18, 12, 7, 1, 2, 20, 1…
$ yrs.service   &lt;int&gt; 18, 16, 3, 39, 41, 6, 23, 45, 20, 18, 8, 2, 1, 0, 18, 3,…
$ sex           &lt;chr&gt; "Male", "Male", "Male", "Male", "Male", "Male", "Male", …
$ salary        &lt;int&gt; 139750, 173200, 79750, 115000, 141500, 97000, 175000, 14…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">salary_class =</span> <span class="fu">ifelse</span>(salary<span class="sc">&gt;=</span><span class="dv">100000</span>,<span class="dv">1</span>,<span class="dv">0</span>),</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">salary_class =</span> <span class="fu">factor</span>(salary_class, <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"low"</span>,<span class="st">"high"</span>)))</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(dat, <span class="at">width =</span> <span class="dv">80</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 397
Columns: 8
$ X             &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 1…
$ rank          &lt;chr&gt; "Prof", "Prof", "AsstProf", "Prof", "Prof", "AssocProf",…
$ discipline    &lt;chr&gt; "B", "B", "B", "B", "B", "B", "B", "B", "B", "B", "B", "…
$ yrs.since.phd &lt;int&gt; 19, 20, 4, 45, 40, 6, 30, 45, 21, 18, 12, 7, 1, 2, 20, 1…
$ yrs.service   &lt;int&gt; 18, 16, 3, 39, 41, 6, 23, 45, 20, 18, 8, 2, 1, 0, 18, 3,…
$ sex           &lt;chr&gt; "Male", "Male", "Male", "Male", "Male", "Male", "Male", …
$ salary        &lt;int&gt; 139750, 173200, 79750, 115000, 141500, 97000, 175000, 14…
$ salary_class  &lt;fct&gt; high, high, low, high, high, low, high, high, high, high…</code></pre>
</div>
</div>
</section>
<section id="ขนทสอง-แบงชดขอมล" class="level3">
<h3 class="anchored" data-anchor-id="ขนทสอง-แบงชดขอมล">ขั้นที่สอง แบ่งชุดข้อมูล</h3>
<p>กำหนด seed number เท่ากับ 123 จากนั้นแบ่งชุดข้อมูลโดยใช้ rsample package ดังนี้</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(dat, <span class="at">prop =</span> <span class="fl">0.8</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>train<span class="ot">&lt;-</span><span class="fu">training</span>(split)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>test<span class="ot">&lt;-</span><span class="fu">testing</span>(split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="ขนทสาม-สราง-recipe-object-สำหรบจดการขอมล" class="level3">
<h3 class="anchored" data-anchor-id="ขนทสาม-สราง-recipe-object-สำหรบจดการขอมล">ขั้นที่สาม สร้าง recipe object สำหรับจัดการข้อมูล</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>preproc <span class="ot">&lt;-</span> <span class="fu">recipe</span>(salary_class <span class="sc">~</span> ., <span class="at">data =</span> train) <span class="sc">%&gt;%</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_select</span>(<span class="sc">-</span>X, <span class="sc">-</span>salary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="ขนท-4-กำหนดโมเดล-model-specification" class="level3">
<h3 class="anchored" data-anchor-id="ขนท-4-กำหนดโมเดล-model-specification">ขั้นที่ 4 กำหนดโมเดล (model specification)</h3>
<p>ตัวอย่างนี้จะใช้ random forest ใน parsnip สามารถ fit random forest model ได้ด้วย engine หลายตัว ในตัวอย่างนี้จะใช้ <code>ranger</code> ที่มี hyperparameter ให้กำหนดได้ 3 ตัวได้แก่ mtry, trees และ min_n</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>forest_mod <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>(<span class="at">mtry =</span> <span class="fu">tune</span>(),</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>                          <span class="at">trees =</span> <span class="dv">500</span>,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">min_n =</span> <span class="fu">tune</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"ranger"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="ขนท-5-สราง-workflow" class="level3">
<h3 class="anchored" data-anchor-id="ขนท-5-สราง-workflow">ขั้นที่ 5 สร้าง workflow</h3>
<p>ผู้วิเคราะห์ไม่จำเป็นต้องสร้าง workflow ก็สามารถใช้ <code>tune_grid()</code> เพื่อ fine-tune hyperparameter ได้ โดยใช้ parsnip object ที่สร้างขึ้นในขั้น 4 เป็น object ใน <code>tune_grid()</code> ได้เลย อย่างไรก็ตามในสถานการณ์ทั่วไปผู้วิเคราะห์จะเป็นต้อง preprocess ข้อมูลก่อนอยู่แล้ว การใช้ workflow จึงน่าจะสะดวกกว่าในกรณีทั่วไป</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>rf_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(preproc) <span class="sc">%&gt;%</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(forest_mod)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>rf_workflow</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow ════════════════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: rand_forest()

── Preprocessor ────────────────────────────────────────────────────────────────
1 Recipe Step

• step_select()

── Model ───────────────────────────────────────────────────────────────────────
Random Forest Model Specification (classification)

Main Arguments:
  mtry = tune()
  trees = 500
  min_n = tune()

Computational engine: ranger </code></pre>
</div>
</div>
</section>
<section id="ขนท-6-เตรยมทำ-cross-validation-และกำหนด-hyperparameter-grid" class="level3">
<h3 class="anchored" data-anchor-id="ขนท-6-เตรยมทำ-cross-validation-และกำหนด-hyperparameter-grid">ขั้นที่ 6 เตรียมทำ cross-validation และกำหนด hyperparameter grid</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create folds</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(train, <span class="at">repeats =</span><span class="dv">5</span>, <span class="at">strata =</span> <span class="st">"salary_class"</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co"># create random grid</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>my_hyparams <span class="ot">&lt;-</span> <span class="fu">parameters</span>(<span class="fu">mtry</span>(<span class="at">range=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">5</span>)),</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">min_n</span>(<span class="at">range=</span><span class="fu">c</span>(<span class="dv">10</span>,<span class="dv">40</span>)))</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>my_grid <span class="ot">&lt;-</span> <span class="fu">grid_random</span>(my_hyparams, <span class="at">size =</span> <span class="dv">20</span>)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>my_grid <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(mtry, min_n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="05RandomForest_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># crete evaluation metrics</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>eval_metric <span class="ot">&lt;-</span> <span class="fu">metric_set</span>(roc_auc, sens, spec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="ขนท-7-ทำ-cv-เพอนำขอมลมา-tune-hyperparameters" class="level3">
<h3 class="anchored" data-anchor-id="ขนท-7-ทำ-cv-เพอนำขอมลมา-tune-hyperparameters">ขั้นที่ 7 ทำ CV เพื่อนำข้อมูลมา tune hyperparameters</h3>
<p>ฟังก์ชันที่ใช้คือ <code>tune_grid()</code> มีอาร์กิวเมนท์ที่สำคัญได้แก่</p>
<ul>
<li><p><code>resamples</code> ใช้ระบุชุดข้อมูลที่สร้างขึ้นจากกระบวนการสุ่มซ้ำ เช่น k-folds CV หรือ boostraping dataset</p></li>
<li><p><code>grid</code> ใช้สำหรับระบุ grid ของ hyperparameter ของอัลกอริทึมการเรียนรู้ที่เลือกใช้</p></li>
<li><p><code>control</code> ใช้กำหนด option สำหรับควบคุมกระบวนการสุ่มซ้ำ (resample) และปรับแต่งค่า hyperparameter การกำหนดอาร์กิวเมนท์นี้จะต้องกำหนดผ่านฟังก์ชัน <code>control_resamples()</code> หรือ <code>control_grid()</code> อีกทีหนึ่ง รายละเอียดของฟังก์ชันทั้งสองสามารถศึกษาได้จากคู่มือการใช้งาน (พิมพ์ <code>?control_resamples</code> หรือ <code>?control_grid</code>)</p></li>
<li><p><code>metrics</code> ใช้กำหนด evalution metrics ที่ผู้วิเคราะห์จะใช้เพื่อประเมินประสิทธิภาพของโมเดลระหว่างการปรับแต่งค่าพารามิเตอร์ การกำหนดอาร์กิวเมนท์นี้ให้ทำผ่านฟังก์ชัน <code>metric_set()</code> ในกรณีที่ไม่ได้กำหนดโปรแกรมจะกำหนดให้ใช้ค่าเริ่มต้น ซึ่งจะเลือกให้เหมาะสมกับ mode ของโมเดล</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>tuning_results <span class="ot">&lt;-</span> rf_workflow <span class="sc">%&gt;%</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">tune_grid</span>(<span class="at">resamples =</span> folds,</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">grid =</span> my_grid,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>                            <span class="at">control =</span> <span class="fu">control_grid</span>(<span class="at">verbose =</span> <span class="cn">FALSE</span>,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">save_pred =</span> <span class="cn">TRUE</span>),</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>                            <span class="at">metrics =</span> eval_metric)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="วเคราะห-tuning-results" class="level3">
<h3 class="anchored" data-anchor-id="วเคราะห-tuning-results">วิเคราะห์ tuning results</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>tuning_results <span class="sc">%&gt;%</span> <span class="fu">autoplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="05RandomForest_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>tuning_results <span class="sc">%&gt;%</span> <span class="fu">collect_metrics</span>(<span class="at">summarize =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 57 × 8
    mtry min_n .metric .estimator  mean     n std_err .config              
   &lt;int&gt; &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;                
 1     5    18 roc_auc binary     0.859    50 0.0113  Preprocessor1_Model01
 2     5    18 sens    binary     0.688    50 0.0205  Preprocessor1_Model01
 3     5    18 spec    binary     0.955    50 0.00658 Preprocessor1_Model01
 4     1    21 roc_auc binary     0.877    50 0.0100  Preprocessor1_Model02
 5     1    21 sens    binary     0.669    50 0.0199  Preprocessor1_Model02
 6     1    21 spec    binary     0.964    50 0.00570 Preprocessor1_Model02
 7     4    14 roc_auc binary     0.856    50 0.0117  Preprocessor1_Model03
 8     4    14 sens    binary     0.708    50 0.0195  Preprocessor1_Model03
 9     4    14 spec    binary     0.950    50 0.00827 Preprocessor1_Model03
10     4    33 roc_auc binary     0.864    50 0.0110  Preprocessor1_Model04
# … with 47 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>tuning_results <span class="sc">%&gt;%</span> </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>(<span class="at">summarize =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">"sens"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 19 × 8
    mtry min_n .metric .estimator  mean     n std_err .config              
   &lt;int&gt; &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;                
 1     3    38 sens    binary     0.726    50  0.0189 Preprocessor1_Model14
 2     3    35 sens    binary     0.726    50  0.0189 Preprocessor1_Model19
 3     2    11 sens    binary     0.721    50  0.0195 Preprocessor1_Model18
 4     3    37 sens    binary     0.721    50  0.0187 Preprocessor1_Model07
 5     3    11 sens    binary     0.719    50  0.0191 Preprocessor1_Model08
 6     2    33 sens    binary     0.713    50  0.0205 Preprocessor1_Model16
 7     4    14 sens    binary     0.708    50  0.0195 Preprocessor1_Model03
 8     4    20 sens    binary     0.705    50  0.0195 Preprocessor1_Model12
 9     4    13 sens    binary     0.704    50  0.0196 Preprocessor1_Model06
10     4    36 sens    binary     0.704    50  0.0202 Preprocessor1_Model15
11     4    33 sens    binary     0.692    50  0.0208 Preprocessor1_Model04
12     5    10 sens    binary     0.690    50  0.0197 Preprocessor1_Model09
13     5    18 sens    binary     0.688    50  0.0205 Preprocessor1_Model01
14     5    28 sens    binary     0.672    50  0.0212 Preprocessor1_Model10
15     1    14 sens    binary     0.671    50  0.0198 Preprocessor1_Model17
16     1    21 sens    binary     0.669    50  0.0199 Preprocessor1_Model02
17     1    16 sens    binary     0.669    50  0.0199 Preprocessor1_Model13
18     1    25 sens    binary     0.661    50  0.0192 Preprocessor1_Model11
19     1    39 sens    binary     0.659    50  0.0197 Preprocessor1_Model05</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>tuning_results <span class="sc">%&gt;%</span> </span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>(<span class="at">summarize =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">"roc_auc"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 19 × 8
    mtry min_n .metric .estimator  mean     n std_err .config              
   &lt;int&gt; &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;                
 1     1    14 roc_auc binary     0.880    50 0.00963 Preprocessor1_Model17
 2     1    16 roc_auc binary     0.879    50 0.00997 Preprocessor1_Model13
 3     1    21 roc_auc binary     0.877    50 0.0100  Preprocessor1_Model02
 4     1    25 roc_auc binary     0.876    50 0.0101  Preprocessor1_Model11
 5     1    39 roc_auc binary     0.875    50 0.00991 Preprocessor1_Model05
 6     2    33 roc_auc binary     0.868    50 0.0107  Preprocessor1_Model16
 7     2    11 roc_auc binary     0.866    50 0.00979 Preprocessor1_Model18
 8     4    36 roc_auc binary     0.866    50 0.0109  Preprocessor1_Model15
 9     3    35 roc_auc binary     0.865    50 0.0108  Preprocessor1_Model19
10     3    37 roc_auc binary     0.865    50 0.0107  Preprocessor1_Model07
11     4    33 roc_auc binary     0.864    50 0.0110  Preprocessor1_Model04
12     3    38 roc_auc binary     0.864    50 0.0109  Preprocessor1_Model14
13     5    28 roc_auc binary     0.863    50 0.0110  Preprocessor1_Model10
14     4    20 roc_auc binary     0.861    50 0.0111  Preprocessor1_Model12
15     5    18 roc_auc binary     0.859    50 0.0113  Preprocessor1_Model01
16     3    11 roc_auc binary     0.858    50 0.0108  Preprocessor1_Model08
17     4    13 roc_auc binary     0.857    50 0.0115  Preprocessor1_Model06
18     4    14 roc_auc binary     0.856    50 0.0117  Preprocessor1_Model03
19     5    10 roc_auc binary     0.852    50 0.0116  Preprocessor1_Model09</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>tuning_results <span class="sc">%&gt;%</span> </span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>(<span class="at">summarize =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">"sens"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> std_err, <span class="at">y=</span> mean))<span class="sc">+</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="05RandomForest_files/figure-html/unnamed-chunk-13-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>best <span class="ot">&lt;-</span> <span class="fu">show_best</span>(tuning_results, <span class="at">n=</span><span class="dv">6</span>, <span class="at">metric =</span> <span class="st">"sens"</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>best[<span class="dv">1</span>,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 8
   mtry min_n .metric .estimator  mean     n std_err .config              
  &lt;int&gt; &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;                
1     3    38 sens    binary     0.726    50  0.0189 Preprocessor1_Model14</code></pre>
</div>
</div>
</section>
<section id="ขนท-8-finalized" class="level3">
<h3 class="anchored" data-anchor-id="ขนท-8-finalized">ขั้นที่ 8 Finalized</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>RF_final <span class="ot">&lt;-</span> rf_workflow <span class="sc">%&gt;%</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize_workflow</span>(best[<span class="dv">1</span>,]) <span class="sc">%&gt;%</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(split,</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">metrics =</span>eval_metric)</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>RF_final <span class="sc">%&gt;%</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_engine</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Ranger result

Call:
 ranger::ranger(x = maybe_data_frame(x), y = y, mtry = min_cols(~3L,      x), num.trees = ~500, min.node.size = min_rows(~38L, x),      num.threads = 1, verbose = FALSE, seed = sample.int(10^5,          1), probability = TRUE) 

Type:                             Probability estimation 
Number of trees:                  500 
Sample size:                      317 
Number of independent variables:  5 
Mtry:                             3 
Target node size:                 38 
Variable importance mode:         none 
Splitrule:                        gini 
OOB prediction error (Brier s.):  0.1078116 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>RF_final <span class="sc">%&gt;%</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 4
  .metric .estimator .estimate .config             
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               
1 sens    binary         0.706 Preprocessor1_Model1
2 spec    binary         0.891 Preprocessor1_Model1
3 roc_auc binary         0.850 Preprocessor1_Model1</code></pre>
</div>
</div>
</section>
</section>
<section id="grid-search-methods" class="level2">
<h2 class="anchored" data-anchor-id="grid-search-methods">7.6 Grid Search methods</h2>
<p>ปัจจัยสำคัญตัวหนึ่งที่มีผลโดยตรงต่อประสิทธิภาพการปรับแต่ง hyperparameter คือการกำหนด grid ของ hyperparameter ใน tidymodel สามารถจำแนกได้เป็น 2 ประเภท ได้แก่</p>
<ul>
<li><p>regular grid</p></li>
<li><p>nonregular grid</p></li>
</ul>
<p>รายละเอียดมีดังนี้</p>
</section>
<section id="regular-grid" class="level2">
<h2 class="anchored" data-anchor-id="regular-grid">Regular grid</h2>
<p>regular grid เป็น grid ของ hyperparameter ที่สร้างขึ้นจากส่วนผสม (combination) ของค่าที่เป็นไปได้ทั้งหมดของ hyperparameter ที่ต้องการวิเคราะห์ การสร้าง regular grid มี 2 ขั้นตอน ขั้นตอนแรกคือการกำหนดค่าที่เป็นไปได้ของ hyperparameter แต่ละตัว และขั้นที่สองคือการสร้าง grid ของค่าที่เป็นไปได้ดังกล่าว ผลลัพธ์ที่ได้คือ hyperparameter space ที่สมบูรณ์</p>
<p>การสร้าง regular grid ใน R สามารถทำได้หลายวิธีการ วิธีการแรกคือการใช้ฟังก์ชัน <code>expand.grid()</code> วิธีการที่สองคือการใช้ฟังก์ชัน <code>crossing()</code> ของ package tidyr และวิธีการที่สามคือการใช้ฟังก์ชัน <code>grid_regular()</code> ของ package dials</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>my_grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_n =</span> <span class="fu">seq</span>(<span class="dv">10</span>,<span class="dv">50</span>,<span class="dv">5</span>)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(my_grid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  mtry min_n
1    1    10
2    2    10
3    3    10
4    4    10
5    5    10
6    1    15</code></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(my_grid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   mtry min_n
40    5    45
41    1    50
42    2    50
43    3    50
44    4    50
45    5    50</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">crossing</span>(</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_n =</span> <span class="fu">seq</span>(<span class="dv">10</span>,<span class="dv">50</span>,<span class="dv">5</span>)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 45 × 2
    mtry min_n
   &lt;int&gt; &lt;dbl&gt;
 1     1    10
 2     1    15
 3     1    20
 4     1    25
 5     1    30
 6     1    35
 7     1    40
 8     1    45
 9     1    50
10     2    10
# … with 35 more rows</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>my_params <span class="ot">&lt;-</span> <span class="fu">extract_parameter_set_dials</span>(rf_workflow) <span class="sc">%&gt;%</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update</span>(<span class="at">mtry =</span> <span class="fu">mtry</span>(<span class="at">range=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">5</span>)),</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">min_n =</span> <span class="fu">min_n</span>(<span class="at">range=</span><span class="fu">c</span>(<span class="dv">20</span>,<span class="dv">60</span>)))</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>my_reggrid <span class="ot">&lt;-</span> <span class="fu">grid_regular</span>(my_params, <span class="at">levels =</span> <span class="dv">5</span>)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>my_reggrid <span class="sc">%&gt;%</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> mtry, <span class="at">y =</span> min_n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="05RandomForest_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>ข้อจำกัดของ regular grid คือใช้ทรัพยากรในการประมวลผลมาก โดยเฉพาะกับโมเดลที่มี hyperparameter จำนวนมาก และมีการทวนซ้ำหลายรอบ</p>
</section>
<section id="irregular-grid" class="level2">
<h2 class="anchored" data-anchor-id="irregular-grid">Irregular grid</h2>
<p>มีหลายวิธีที่จะช่วยลดการประมวลผลของ regular grid ลงได้ วิธีการแรกคือ random grid ที่ใช้วิธีการสุ่มตัวอย่าง เพื่อสุ่ม grid มาจากประชากรของ grid ที่เป็นไปได้</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>my_randomgrid <span class="ot">&lt;-</span> <span class="fu">grid_random</span>(my_params, <span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>my_randomgrid <span class="sc">%&gt;%</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> mtry, <span class="at">y =</span> min_n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="05RandomForest_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>my_randomgrid <span class="ot">&lt;-</span> <span class="fu">grid_random</span>(my_params, <span class="at">size =</span> <span class="dv">25</span>)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>my_randomgrid <span class="sc">%&gt;%</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> mtry, <span class="at">y =</span> min_n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="05RandomForest_files/figure-html/unnamed-chunk-18-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>my_randomgrid <span class="ot">&lt;-</span> <span class="fu">grid_random</span>(my_params, <span class="at">size =</span> <span class="dv">50</span>)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>my_randomgrid <span class="sc">%&gt;%</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> mtry, <span class="at">y =</span> min_n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="05RandomForest_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>ข้อจำกัดของ random grid คือ หาก generate grid ขนาดเล็ก มีโอกาสที่จะได้ grid ที่มีความใกล้เคียงหรือซ้อนทับกันมากเกินไป กล่าวคือ hyperparameter space ที่สร้างขึ้นอาจขาดคุณสมบัติความเป็นตัวแทน ผลการวิเคราะห์ที่ได้จึงอาจทำให้การปรับแต่ง hyperparameter มีความคลาดเคลื่อน</p>
<p>จากข้อจำกัดดังกล่าวการสร้าง grid ของ hyperparameter ที่มีประสิทธิภาพมากกว่า random grid คือการใช้วิธีในกลุ่ม space-filling design ที่มีอัลกอริทึมภายใต้วิธีการในกลุ่มนี้หลายตัว เช่น latin hypercubes, maximum entropy designs, maximum projection designs เป็นต้น</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>my_latingrid <span class="ot">&lt;-</span> <span class="fu">grid_latin_hypercube</span>(my_params, <span class="at">size =</span> <span class="dv">25</span>)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>my_latingrid <span class="sc">%&gt;%</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> mtry, <span class="at">y =</span> min_n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="05RandomForest_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>my_maxentrp <span class="ot">&lt;-</span> <span class="fu">grid_max_entropy</span>(my_params, <span class="at">size =</span> <span class="dv">25</span>)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>my_maxentrp  <span class="sc">%&gt;%</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> mtry, <span class="at">y =</span> min_n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="05RandomForest_files/figure-html/unnamed-chunk-20-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<p><img src="05RandomForest_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="864"></p>
</div>
</div>
</section>
</section>
<section id="บทท-8-workflow-set" class="level1">
<h1>บทที่ 8: workflow set</h1>
<p>ในทางปฏิบัติเรามักจะมีโมเดลคู่แข่งขันหลายตัวที่จะนำมาพัฒนาควบคู่กัน ภายใต้ tidymodel framework ผู้วิเคราะห์สามารถสร้าง workflow set เพื่อ fine tune hyperparameter และเปรียบเทียบโมเดลหลาย ๆ ตัวไปพร้อม ๆ กันในการประมวลผลรอบเดียวได้</p>
<p>ผู้วิเคราะห์ต้องการพัฒนาโมเดลจำแนก class โดยมีโมเดลคู่แข่งขันที่เลือกมาใช้งานได้แก่</p>
<ul>
<li><p>logistic regression with regulization</p></li>
<li><p>decision tree</p></li>
<li><p>random forest (เป็นการบ้าน)</p></li>
</ul>
<p>ชุดข้อมูลที่ใช้เป็นตัวอย่างคือชุดข้อมูล <code>parabolic</code> ซึ่งเป็นชุดข้อมูลตัวอย่างของ tidymodels ผลการสำรวจข้่อมูลด้านล่างจะเห็นว่า ชุดข้อมูลประกอบด้วยข้อมูลของหน่วยข้อมูลจำนวน 500 หน่วย มีตัวแปรตามแบบจัดประเภท <code>class</code> และตัวแปรอิสระเชิงปริมาณ 2 ตัวได้แก่ <code>x1</code> และ <code>x2</code> ตามลำดับ</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co">#importing data</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(parabolic)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(parabolic)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 500
Columns: 3
$ X1    &lt;dbl&gt; 3.291779227, 1.465839693, 1.660986913, 1.602301296, 2.165003287,…
$ X2    &lt;dbl&gt; 1.66108928, 0.41398566, 0.79147013, 0.27639110, 3.16557011, 3.82…
$ class &lt;fct&gt; Class1, Class2, Class2, Class2, Class1, Class1, Class2, Class1, …</code></pre>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># splitting data</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(<span class="at">data =</span> parabolic)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>train <span class="ot">&lt;-</span> <span class="fu">training</span>(split)</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> <span class="fu">testing</span>(split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>ผู้วิเคราะห์สำรวจความสัมพันธ์ระหว่างตัวแปรตามกับตัวแปรอิสระเบื้องต้น ได้ผลดังแผนภาพด้านล่าง</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co">#exploring</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>train <span class="sc">%&gt;%</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> X1, <span class="at">y =</span> X2, <span class="at">col=</span>class))<span class="sc">+</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha=</span><span class="fl">0.7</span>)<span class="sc">+</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>()<span class="sc">+</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"top"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="05RandomForest_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>การวิเคราะห์นี้มีการพัฒนา ML จำนวน 2 ตัวได้แก่ regularized logistic regression และ decision tree ที่มีการทำ preprocessing แตกต่างกัน การทำ workflow set ยอมให้ผู้วิเคราะห์กำหนด preprocessing ที่แตกต่างกันกับ model specification ที่กำหนดได้ ดังตัวอย่างต่อไปนี้</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co">#preprocessing</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>base_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(class <span class="sc">~</span> . ,<span class="at">data=</span> train)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>norm_recipe <span class="ot">&lt;-</span> base_recipe <span class="sc">%&gt;%</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>())</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a><span class="co"># model specification</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="do">## - 1 regularized logistic regression</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>regular_logit <span class="ot">&lt;-</span> <span class="fu">logistic_reg</span>(<span class="at">penalty=</span> <span class="fu">tune</span>(),</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>                              <span class="at">mixture =</span> <span class="fu">tune</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>)<span class="sc">%&gt;%</span></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a><span class="do">## - 2 decision tree </span></span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>tree_mod <span class="ot">&lt;-</span> <span class="fu">decision_tree</span>(<span class="at">cost_complexity =</span> <span class="fu">tune</span>(),</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>                          <span class="at">min_n =</span> <span class="fu">tune</span>())<span class="sc">%&gt;%</span></span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"rpart"</span>)<span class="sc">%&gt;%</span></span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a><span class="co"># creat workflowset</span></span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a>my_workflowset <span class="ot">&lt;-</span> <span class="fu">workflow_set</span>(</span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">preproc =</span> <span class="fu">list</span>(<span class="at">norm =</span> norm_recipe,</span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a>                 <span class="at">base =</span> base_recipe),</span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">models =</span> <span class="fu">list</span>(<span class="at">reg_logit =</span> regular_logit,</span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a>                <span class="at">cart =</span> tree_mod),</span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">cross =</span> <span class="cn">FALSE</span></span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a>my_workflowset</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A workflow set/tibble: 2 × 4
  wflow_id       info             option    result    
  &lt;chr&gt;          &lt;list&gt;           &lt;list&gt;    &lt;list&gt;    
1 norm_reg_logit &lt;tibble [1 × 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt;
2 base_cart      &lt;tibble [1 × 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt;</code></pre>
</div>
</div>
<p>นำ workflow set ที่สร้างมาผ่านกระบวนการ tune hyperapameter โดยฟังก์ชันที่จะใช้คือ <code>workflow_map()</code> แทน <code>tune_grid()</code></p>
<p>ตัวอย่างด้านล่างมีการระบุ <code>grid = 20</code> แปลว่าให้ฟังก์ชันสร้าง hyperparameter grid ให้โดยใช้ค่าเริ่มต้นจำนวน 25 จุด ทั้งนี้ค่าเริ่มต้นของ tidymodel จะใช้อัลกอริทึม maximum entropy ในการกำหนด grid</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Tuning Hypeparameter</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>eval_metrics <span class="ot">&lt;-</span> <span class="fu">metric_set</span>(accuracy,roc_auc, sens, spec)</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(<span class="at">data =</span> train, <span class="at">v =</span> <span class="dv">10</span>)</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>all_tune <span class="ot">&lt;-</span> my_workflowset <span class="sc">%&gt;%</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow_map</span>(<span class="at">resamples =</span> folds,</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">grid =</span> <span class="dv">20</span>,</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">verbose =</span> <span class="cn">TRUE</span>,</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">metrics =</span> eval_metrics)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>i 1 of 2 tuning:     norm_reg_logit</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ 1 of 2 tuning:     norm_reg_logit (54.6s)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i 2 of 2 tuning:     base_cart</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ 2 of 2 tuning:     base_cart (51.3s)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rank_results</span>(all_tune)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 160 × 9
   wflow_id  .config             .metric  mean std_err     n prepr…¹ model  rank
   &lt;chr&gt;     &lt;chr&gt;               &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;   &lt;chr&gt; &lt;int&gt;
 1 base_cart Preprocessor1_Mode… accura… 0.901  0.0142    10 recipe  deci…     1
 2 base_cart Preprocessor1_Mode… roc_auc 0.923  0.0203    10 recipe  deci…     1
 3 base_cart Preprocessor1_Mode… sens    0.891  0.0132    10 recipe  deci…     1
 4 base_cart Preprocessor1_Mode… spec    0.909  0.0215    10 recipe  deci…     1
 5 base_cart Preprocessor1_Mode… accura… 0.901  0.0142    10 recipe  deci…     2
 6 base_cart Preprocessor1_Mode… roc_auc 0.932  0.0184    10 recipe  deci…     2
 7 base_cart Preprocessor1_Mode… sens    0.896  0.0143    10 recipe  deci…     2
 8 base_cart Preprocessor1_Mode… spec    0.905  0.0243    10 recipe  deci…     2
 9 base_cart Preprocessor1_Mode… accura… 0.901  0.0142    10 recipe  deci…     3
10 base_cart Preprocessor1_Mode… roc_auc 0.932  0.0184    10 recipe  deci…     3
# … with 150 more rows, and abbreviated variable name ¹​preprocessor</code></pre>
</div>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>all_tune <span class="sc">%&gt;%</span> <span class="fu">autoplot</span>(<span class="at">metric =</span> <span class="st">"roc_auc"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="05RandomForest_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>จากผลการวิเคราะห์ข้างต้นแสดงให้เห็นว่า decision tree มีประสิทธิภาพสูงกว่า regularized logistic regression เราสามารถดึงข้อมูลของ regularized logistic regression ขึ้นมาได้โดยใช้คำสั่งต่อไปนี้</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>all_tune <span class="sc">%&gt;%</span> <span class="fu">autoplot</span>(<span class="at">metric =</span> <span class="st">"sens"</span>, <span class="at">id =</span> <span class="st">"base_cart"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="05RandomForest_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>ฟังก์ชัน <code>extract_workflow_set_result()</code> ใช้ดึงผลการ fine-tune hyperparameter ของแต่ละโมเดลภายใต้ workflow set ขึ้นมาวิเคราะห์ในเชิงลึกต่อได้อีก</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>simple_cart_results<span class="ot">&lt;-</span> all_tune <span class="sc">%&gt;%</span> </span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_workflow_set_result</span>(<span class="at">id =</span> <span class="st">"base_cart"</span>)</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>simple_cart_results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Tuning results
# 10-fold cross-validation 
# A tibble: 10 × 4
   splits           id     .metrics          .notes          
   &lt;list&gt;           &lt;chr&gt;  &lt;list&gt;            &lt;list&gt;          
 1 &lt;split [337/38]&gt; Fold01 &lt;tibble [80 × 6]&gt; &lt;tibble [0 × 3]&gt;
 2 &lt;split [337/38]&gt; Fold02 &lt;tibble [80 × 6]&gt; &lt;tibble [0 × 3]&gt;
 3 &lt;split [337/38]&gt; Fold03 &lt;tibble [80 × 6]&gt; &lt;tibble [0 × 3]&gt;
 4 &lt;split [337/38]&gt; Fold04 &lt;tibble [80 × 6]&gt; &lt;tibble [0 × 3]&gt;
 5 &lt;split [337/38]&gt; Fold05 &lt;tibble [80 × 6]&gt; &lt;tibble [0 × 3]&gt;
 6 &lt;split [338/37]&gt; Fold06 &lt;tibble [80 × 6]&gt; &lt;tibble [0 × 3]&gt;
 7 &lt;split [338/37]&gt; Fold07 &lt;tibble [80 × 6]&gt; &lt;tibble [0 × 3]&gt;
 8 &lt;split [338/37]&gt; Fold08 &lt;tibble [80 × 6]&gt; &lt;tibble [0 × 3]&gt;
 9 &lt;split [338/37]&gt; Fold09 &lt;tibble [80 × 6]&gt; &lt;tibble [0 × 3]&gt;
10 &lt;split [338/37]&gt; Fold10 &lt;tibble [80 × 6]&gt; &lt;tibble [0 × 3]&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>simple_cart_results <span class="sc">%&gt;%</span> <span class="fu">collect_metrics</span>(<span class="at">summarise =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 80 × 8
   cost_complexity min_n .metric  .estimator  mean     n std_err .config        
             &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;          
 1    0.00000300       9 accuracy binary     0.883    10  0.0126 Preprocessor1_…
 2    0.00000300       9 roc_auc  binary     0.908    10  0.0254 Preprocessor1_…
 3    0.00000300       9 sens     binary     0.876    10  0.0125 Preprocessor1_…
 4    0.00000300       9 spec     binary     0.887    10  0.0208 Preprocessor1_…
 5    0.0000000334    13 accuracy binary     0.893    10  0.0158 Preprocessor1_…
 6    0.0000000334    13 roc_auc  binary     0.914    10  0.0225 Preprocessor1_…
 7    0.0000000334    13 sens     binary     0.891    10  0.0132 Preprocessor1_…
 8    0.0000000334    13 spec     binary     0.894    10  0.0225 Preprocessor1_…
 9    0.000000211     28 accuracy binary     0.891    10  0.0159 Preprocessor1_…
10    0.000000211     28 roc_auc  binary     0.936    10  0.0188 Preprocessor1_…
# … with 70 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>simple_cart_results <span class="sc">%&gt;%</span> <span class="fu">autoplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="05RandomForest_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(simple_cart_results, <span class="at">n=</span><span class="dv">5</span>, <span class="at">metric =</span> <span class="st">"sens"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 8
  cost_complexity min_n .metric .estimator  mean     n std_err .config          
            &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;            
1        9.95e- 5    32 sens    binary     0.925    10  0.0195 Preprocessor1_Mo…
2        4.83e-10    34 sens    binary     0.925    10  0.0195 Preprocessor1_Mo…
3        1.02e- 8    38 sens    binary     0.920    10  0.0224 Preprocessor1_Mo…
4        3.87e- 3    17 sens    binary     0.896    10  0.0143 Preprocessor1_Mo…
5        2.00e-10    17 sens    binary     0.896    10  0.0143 Preprocessor1_Mo…</code></pre>
</div>
</div>
<p>ขั้นตอนสุดท้ายคือการ finalized model …</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">© Copyright 2023, DataKruRoo</div>   
    <div class="nav-footer-right">This page is built with ❤️ and <a href="https://quarto.org/">Quarto</a>.</div>
  </div>
</footer>



</body></html>