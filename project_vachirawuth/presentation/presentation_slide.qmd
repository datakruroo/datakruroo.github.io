---
title: "ผลการวิเคราะห์คุณลักษณะอันพึงประสงค์และปัจจัยที่ส่งผลต่อคุณลักษณะอันพึงประสงค์ของนักเรียนโรงเรียนวชิราวุธวิทยาลัย"
author: "Assistant Prof. Dr. Kanit Sriklaub et al."
institute: "Department of Educational Research and Psychology <br> Faculty of Education Chulalongkorn University"
date: 2024-09-05
format:
  revealjs:
    slide-number: c/t
    footer: "Assistant Prof. Dr. Kanit Sriklaub et al. <br> Department of Educational Research and Psychology <br> Faculty of Education Chulalongkorn University"
    logo: https://github.com/ssiwacho/picture/blob/main/datakruroo.png?raw=true
    theme: theme.scss
    css: my_css.css
    scrollable: true
    transition: fade
    background-transition: fade
    highlight-style: github
    embed-resources: true
code-link: true
execute:
  echo: false
  freeze: auto
  progress: true
include-in-header:
  - text: |
      <style>
      #title-slide .title {
        font-size: 1.5em;
        color: #C5705D;; 
      }
      
      </style>
---


```{r}
library(googlesheets4)
library(tidyverse)
source("data_pipeline.R")
```


## Research Objectives {}

<br>

<div style="font-size: 1em; color: white; background-color: #C5705D; padding: 1em;"

> เพื่อวิเคราะห์คุณลักษณะอันพึงประสงค์ตามพระราโชบายของรัชกาลที่ 6 และกระทรวงศึกษาธิการของนักเรียนโรงเรียนวชิราวุธวิทยาลัยที่เป็นจุดเด่น จุดที่ควรพัฒนาตามการรับรู้ของนักเรียน ครูและผู้กำกับคณะ

</div>

## คุณลักษณะอันพึงประสงค์ {.smaller}

<div style = "font-size:50%;">

| ด้าน                               | พระราโชบาย ร.6                                                                 | หลักสูตรแกนกลาง รับผิดชอบโดยฝ่ายวิชาการ                    | หลักสูตรแกนกลาง รับผิดชอบโดยฝ่ายกิจการ นร.                  |
|------------------------------------|---------------------------------------|--------------------------------|-----------------------------------|
| คุณธรรมและจริยธรรม                   | • ศีลธรรม<br>• ไม่เหยียดหยามผู้อื่น<br>• ไม่ทำตนเป็นคนถือยศศักดิ์                | • ซื่อสัตย์สุจริต<br>• มีจิตสาธารณะ                          | • เข้าใจและเห็นใจผู้อื่น<br>• มีจิตสาธารณะ เสียสละเพื่อส่วนรวม<br>• กริยามารยาทสุภาพเรียบร้อย |
| วินัยและการกำกับตนเอง                | • มีระเบียบ                  | • มีวินัย                 | • รักษาระเบียบวินัยโรงเรียน                                 |
| ภาวะผู้นำและความกล้าหาญ             | • เป็นผู้รับใช้และใช้คน <br>• เป็นผู้กล้าหาญ<br>• กล้าเสียสละเพื่อประโยชน์ส่วนรวม<br>• รู้จักรักษาหมู่รักษาคณะ |                                               | • ภาวะผู้นำ                                               |
| การใฝ่รู้และปัญญา                   | • มีสติปัญญาความรู้                                                                | • ใฝ่เรียนรู้                                            | • มีความคิดสร้างสรรค์                                      |
| ความรับผิดชอบในชีวิตและงาน          | • รู้จักตรากตรำ               | • มุ่งมั่นในการทำงาน          | • มีความรับผิดชอบ<br>• มีร่างกายและจิตใจเข้มแข็ง              |
| อัตลักษณ์และความเป็นไทย             | • รักเกียรติ และรักชื่อเสียงและวงศ์ตระกูล                | • รักความเป็นไทย<br>• รักชาติ ศาสน์ กษัตริย์               | • รักชาติ ศาสน์ กษัตริย์                                   |
| กรอบคิดด้านการดำเนินชีวิต            | • ไม่สำรวยหยิบโหย่ง                                                                | • อยู่อย่างพอเพียง                                      | • อยู่อย่างพอเพียง                                        |

</div>

## วิธีดำเนินการวิจัย

## จำนวนนักเรียนที่ให้ข้อมูลจำแนกตามคุณลักษณะอันพึงประสงค์ตามพระราโชบาย ร.6 {.smaller}

:::: {.columns}

::: {.column width="50%"}

ในแต่ละคุณลักษณะมีนักเรียนให้ข้อมูลโดยเฉลี่ย 628.50 คน (SD = 40.65) โดยด้านที่มีนักเรียนให้ข้อมูลมากที่สุดคือ มีสติปัญญาความรู้ (n = 682) และด้านที่มีนักเรียนให้ข้อมูลน้อยที่สุดคือไม่ทำตนเป็นคนถือยศศักดิ์ (n = 524) 

:::

::: {.column width="50%"}

```{r}
library(tidyverse)
library(gt)
source("05_report/score_data_merge.R")
score_longformat %>% 
  count(attribute) %>% 
  summarise(avg_n = mean(n),
            sd = sd(n),
            min = min(n),
            q1 = quantile(n, 0.25),
            median = median(n),
            q3 = quantile(n, 0.75),
            max = max(n)) %>% 
  gt() %>%
  cols_label(avg_n = "M",
             sd = "SD",
             min = "Min",
             q1 = "Q1",
             median = "Med",
             q3 = "Q3",
             max = "Max") %>% 
  fmt_number(columns = everything(),
             decimals = 2) %>%
  tab_options(table.font.size = 16,
              table.width = pct(100),
              column_labels.font.weight = "bold",
              column_labels.font.size = 18,
              table.border.top.style = "solid",
              table.border.bottom.style = "solid",
              table.border.top.color = "black",
              table.border.bottom.color = "black") 
  
```

```{r message=F, echo = F}
score_longformat %>% 
  count(attribute) %>% 
  ggplot(aes(x = n, y = reorder(attribute, n)))+
  geom_col(fill = "#4285f4")+
  geom_text(aes(label = n), hjust = -0.3,
            col = "grey20",
            size = 4.5,
            family = "ChulaCharasNew")+
  ylab("")+
  xlab("\n จำนวนนักเรียน")+
  theme_light()+
  theme(text = element_text(family = "ChulaCharasNew"),
        axis.text = element_text(size = 14),
        panel.grid = element_blank())+
  xlim(0,700)
```

:::

::::

## จำนวนนักเรียนที่ให้ข้อมูลจำแนกตามคุณลักษณะอันพึงประสงค์ของหลักสูตรแกนกลางรับผิดชอบโดยฝ่ายวิชาการ {.smaller}

:::: {.columns}

::: {.column width="50%"}

ในแต่ละคุณลักษณะมีนักเรียนให้ข้อมูลโดยเฉลี่ย 635.38 คน (SD = 28.31) โดยด้านที่มีนักเรียนให้ข้อมูลมากที่สุดคือ ใฝ่เรียนรู้ (n = 683) และด้านที่มีนักเรียนให้ข้อมูลน้อยที่สุดคือ รักความเป็นไทย (n = 592)

:::

::: {.column width="50%"}

```{r}
score_longformat_academic %>% 
  count(attribute) %>% 
  summarise(avg_n = mean(n),
            sd = sd(n),
            min = min(n),
            q1 = quantile(n, 0.25),
            median = median(n),
            q3 = quantile(n, 0.75),
            max = max(n)) %>% 
  gt() %>%
  cols_label(avg_n = "M",
             sd = "SD",
             min = "Min",
             q1 = "Q1",
             median = "Med",
             q3 = "Q3",
             max = "Max") %>% 
  fmt_number(columns = everything(),
             decimals = 2) %>%
  tab_options(table.font.size = 16,
              table.width = pct(100),
              column_labels.font.weight = "bold",
              column_labels.font.size = 18,
              table.border.top.style = "solid",
              table.border.bottom.style = "solid",
              table.border.top.color = "black",
              table.border.bottom.color = "black") 
```


```{r}
score_longformat_academic %>% 
  count(attribute) %>% 
  ggplot(aes(x = n, y = reorder(attribute, n)))+
  geom_col(fill = "#0f9d58")+
  geom_text(aes(label = n), hjust = -0.3,
            col = "grey20",
            size = 4.5,
            family = "ChulaCharasNew")+
  ylab("")+
  xlab("\n จำนวนนักเรียน")+
  theme_light()+
  theme(text = element_text(family = "ChulaCharasNew"),
        axis.text = element_text(size = 14),
        panel.grid = element_blank())+
  xlim(0,700)
```

:::

::::


## จำนวนนักเรียนที่ให้ข้อมูลจำแนกตามคุณลักษณะอันพึงประสงค์ของหลักสูตรแกนกลางรับผิดชอบโดยฝ่ายกิจการนักเรียน {.smaller}

:::: {.columns}

::: {.column width="50%"}


ในแต่ละคุณลักษณะมีนักเรียนให้ข้อมูลโดยเฉลี่ย 631.22 คน (SD = 43.17) โดยด้านที่มีนักเรียนให้ข้อมูลมากที่สุดคือ ใฝ่เรียนรู้ (n = 680) และด้านที่มีนักเรียนให้ข้อมูลน้อยที่สุดคือ รักความเป็นไทย (n = 524)

:::

::: {.column width="50%"}

```{r}
score_longformat_student %>% 
  count(attribute) %>% 
  summarise(avg_n = mean(n),
            sd = sd(n),
            min = min(n),
            q1 = quantile(n, 0.25),
            median = median(n),
            q3 = quantile(n, 0.75),
            max = max(n)) %>% 
  gt() %>%
  cols_label(avg_n = "M",
             sd = "SD",
             min = "Min",
             q1 = "Q1",
             median = "Med",
             q3 = "Q3",
             max = "Max") %>% 
  fmt_number(columns = everything(),
             decimals = 2) %>%
  tab_options(table.font.size = 16,
              table.width = pct(100),
              column_labels.font.weight = "bold",
              column_labels.font.size = 18,
              table.border.top.style = "solid",
              table.border.bottom.style = "solid",
              table.border.top.color = "black",
              table.border.bottom.color = "black") 
```


```{r fig.height}
score_longformat_student %>% 
  count(attribute) %>% 
  ggplot(aes(x = n, y = reorder(attribute, n)))+
  geom_col(fill = "#f4b400")+
  geom_text(aes(label = n), hjust = -0.3,
            col = "grey20",
            size = 4.5,
            family = "ChulaCharasNew")+
  ylab("")+
  xlab("\n จำนวนนักเรียน")+
  theme_light()+
  theme(text = element_text(family = "ChulaCharasNew"),
        axis.text = element_text(size = 14),
        panel.grid = element_blank())+
  xlim(0,700)
```

:::

::::


## การคำนวณคะแนนคุณลักษณะอันพึงประสงค์

$$
 Score_{attribute} = max(P_{สอดคล้อง}) - max(P_{ไม่สอดคล้อง})
$$

<center>

![](img/scale_score.png){width="60%"}

</center>


## คะแนนคุณลักษณะอันพึงประสงค์ตามพระราโชบายของ ร.6

```{r}
score_longformat |> 
 mutate(attribute = as.character(attribute)) %>% 
  mutate(attribute = ifelse(attribute == "รักชื่อเสียงวงศ์ตระกูล" ,
                            "รักเกียรติ และรักชื่อเสียงวงศ์ตระกูล",
                          attribute)) %>% 
  ggplot(aes(x = score_value))+
  geom_histogram(fill = "#4285f4") +
  theme_light()+
  theme(panel.grid = element_blank(),
        text = element_text(family = "ChulaCharasNew"),
        strip.background = element_rect(fill = "black"))+
  facet_wrap(~attribute)+
  xlab("\n คะแนนคุณลักษณะอันพึงประสงค์ตามพระราโชบายของ ร.6")+
  ylab("\n จำนวนนักเรียน \n")

```


## คะแนนคุณลักษณะอันพึงประสงค์ของหลักสูตรแกนกลางรับผิดชอบโดยฝ่ายวิชาการ

```{r}
score_longformat_academic |> 
  ggplot(aes(x = score_value))+
  geom_histogram(fill = "#4285f4") +
  theme_light()+
  theme(panel.grid = element_blank(),
        text = element_text(family = "ChulaCharasNew"),
        strip.background = element_rect(fill = "black"))+
  facet_wrap(~attribute)+
  xlab("\n คะแนนคุณลักษณะอันพึงประสงค์ของหลักสูตรแกนกลางรับผิดชอบโดยฝ่ายวิชาการ")+
  ylab("\n จำนวนนักเรียน \n")

```


## คะแนนคุณลักษณะอันพึงประสงค์ของหลักสูตรแกนกลางรับผิดชอบโดยฝ่ายกิจการนักเรียน

```{r}
score_longformat_student |> 
  ggplot(aes(x = score_value))+
  geom_histogram(fill = "#4285f4") +
  theme_light()+
  theme(panel.grid = element_blank(),
        text = element_text(family = "ChulaCharasNew"),
        strip.background = element_rect(fill = "black"))+
  facet_wrap(~attribute)+
  xlab("\n คะแนนคุณลักษณะอันพึงประสงค์ของหลักสูตรแกนกลางรับผิดชอบโดยฝ่ายกิจการนักเรียน")+
  ylab("\n จำนวนนักเรียน \n")

```



## การกำหนดจุดตัดของคะแนนคุณลักษณะอันพึงประสงค์ {.smaller}

เมื่อพิจารณาการแจกแจงของคะแนนคุณลักษณะอันพึงประสงค์ พบว่ามีการแจกแจงในลักษณะเดียวกัน ผู้วิจัยตึงนำคะแนนคุณลักษณะทุกด้านมาดำเนินการจัดกลุ่มด้วยอัลกอริทึม K-Means โดยแบ่งออกเป็น 3 กลุ่ม จากนั้นใช้ค่าต่ำสุดและสูงสุดของแต่ละกลุ่มมาเป็นคะแนนจุดตัด

```{r}
set.seed(123)
kmeans_result <- kmeans(score_longformat$score_value, centers = 3, nstart = 20)
score_category <- factor(kmeans_result$cluster, 
                         levels = c(1,3,2),
                         labels = c("สอดคล้อง",
                                     "ไม่ชัดเจน",
                                      "ไม่สอดคล้อง"))
score_longformat %>% 
  bind_cols(
score_category = score_category) %>% 
  group_by(score_category) %>% 
  summarise(
    n = n(),
    avg = mean(score_value, na.rm = TRUE),
    sd = sd(score_value, na.rm = TRUE),
    min = min(score_value, na.rm = TRUE),
    q1 = quantile(score_value, 0.25, na.rm = TRUE),
    median = median(score_value, na.rm = TRUE),
    q3 = quantile(score_value, 0.75, na.rm = TRUE),
    max = max(score_value, na.rm = TRUE)
  )
```

```{r}
score_longformat %>% 
  bind_cols(
score_category = score_category) %>% 
  ggplot(aes(x = score_value))+
  geom_histogram(aes(y = after_stat(count),
                     fill = score_category), 
                color = "white", binwidth = 0.05, alpha = 0.8) +
  scale_fill_manual(values = c(
    "ไม่สอดคล้อง" = "#e74c3c", 
    "ไม่ชัดเจน" = "#f39c12", 
    "สอดคล้อง" = "#27ae60"
  )) +
  geom_vline(xintercept = c(-0.36, 0.45), linetype = "dashed", color = "black") +
  annotate("text", x = -0.36, y = 0.4, label = "คะแนนจุดตัด -0.36", 
           vjust = -0.5, hjust = -0.6,
           size = 3.5, col = "grey20",
           family = "ChulaCharasNew", 
           fontface = "italic",
           angle = 90) +
annotate("text", x = 0.45, y = 0.4, label = "คะแนนจุดตัด 0.45", 
           vjust = -0.5, hjust = -0.6,
           size = 3.5, col = "grey20",
           family = "ChulaCharasNew", 
           fontface = "italic",
           angle = 90) +
  labs(x = "\nคะแนนคุณลักษณะอันพึงประสงค์", y = "\n ความหนาแน่น \n", fill = "ความสอดคล้องกับคุณลักษณะฯ") +
  theme_minimal(base_family = "ChulaCharasNew") +
  theme(
    panel.grid = element_blank(),
    axis.text = element_text(size = 14),
    axis.title = element_text(size = 14),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 13)
  )+
  scale_y_continuous(breaks = c(0, 300, 600, 900, 1200),
                     labels = c(0, 1, 2, 3, 4))
```


# 1. ผลการวิเคราะห์คุณลักษณะอันพึงประสงค์ตามพระราโชบายของรัชกาลที่ 6



## คะแนนคุณลักษณะอันพึงประสงค์ตามพระราโชบาย <br> ของรัชกาลที่ 6 (1) {.smaller}

เมื่อพิจารณาคุณลักษณะอันพึงประสงค์ตามพระราโชบายของรัชกาลที่ 6 จำนวน 13 ด้าน พบว่าทุกด้านมีค่ามัธยฐานสูงกว่าคะแนนจุดตัดที่ 0.45 คะแนนทั้งหมด บ่งชี้ว่าพฤติกรรมการแสดงออกของนักเรียนส่วนใหญ่มีแนวโน้มสอดคล้องกับคุณลักษณะอันพึงประสงค์ตามพระราโชบายของรัชกาลที่ 6

เมื่อพิจารณาจากมัธยฐานพบว่า ด้านที่นักเรียนแสดงออกอย่างสอดคล้องมากที่สุดได้แก่

- รู้จักตรากตรำ (Med = 0.89, QD = 0.05)

- ไม่สำรวยหยิบโหย่ง (Med = 0.86, QD = 0.08) และไม่ทำตนเป็นคนถือยศศักดิ์ (Med = 0.86, QD = 0.06) 

ด้านที่มีมัธยฐานต่ำที่สุดคือด้านศีลธรรม (Med = 0.64, QD = 0.79) นอกจากนี้ยังมีข้อสังเกตว่าคะแนนด้านศีลธรรมเป็นด้่านที่มีการกระจายสูงมากที่สุด บ่งชี้ว่ามีนักเรียนบางกลุ่มที่มีแนวโน้มแสดงออกไม่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านศีลธรรม

## คะแนนคุณลักษณะอันพึงประสงค์ตามพระราโชบายของรัชกาลที่ 6 (2) {.smaller}


```{r}
score_longformat %>% 
  mutate(attribute = as.character(attribute)) %>% 
  mutate(attribute = ifelse(attribute == "รักชื่อเสียงวงศ์ตระกูล" ,
                            "รักเกียรติ และรักชื่อเสียงวงศ์ตระกูล",
                          attribute)) %>% 
  group_by(attribute) %>% 
  summarise(
    n = n(),
    median = median(score_value, na.rm = TRUE),
    qd = IQR(score_value, na.rm = TRUE)/2,
    avg = mean(score_value, na.rm = TRUE),
    sd = sd(score_value, na.rm = TRUE),
    min = min(score_value, na.rm = TRUE),
    q1 = quantile(score_value, 0.25, na.rm = TRUE),
    q3 = quantile(score_value, 0.75, na.rm = TRUE),
    max = max(score_value, na.rm = TRUE)
  ) %>% 
  arrange(desc(median)) %>%
  gt() %>% 
  cols_label(attribute = "คุณลักษณะอันพึงประสงค์",
             median = "Med",
             qd = "QD",
             avg = "M",
             sd = "SD",
             min = "Min",
             q1 = "Q1",
             q3 = "Q3",
             max = "Max") %>% 
  cols_align(align = "left", columns = attribute) %>%
  fmt_number(columns = everything(),
             decimals = 2) %>%
  tab_options(table.font.size = 12,
              table.width = pct(100),
              column_labels.font.weight = "bold",
              column_labels.font.size = 18,
              table.border.top.style = "solid",
              table.border.bottom.style = "solid",
              table.border.top.color = "black",
              table.border.bottom.color = "black") %>% 
  tab_style(
    style = cell_text(font = "ChulaCharasNew"),
    locations = cells_column_labels()
  )
```


## คะแนนคุณลักษณะอันพึงประสงค์ตามพระราโชบายของรัชกาลที่ 6 (3) {.smaller}

```{r fig.height = 5}
score_longformat %>% 
  mutate(attribute = as.character(attribute)) %>% 
  mutate(attribute = ifelse(attribute == "รักชื่อเสียงวงศ์ตระกูล" ,
                            "รักเกียรติ และรักชื่อเสียงวงศ์ตระกูล",
                          attribute)) %>% 
  mutate(attribute = fct_reorder(attribute, score_value, .fun = mean, .na_rm = TRUE)) %>% 
  ggplot(aes(x = score_value, y = attribute)) +
  geom_boxplot(fill = "#4285f4", outlier.alpha = 0) +
  geom_jitter(height = 0.1, alpha = 0.1)+
  geom_vline(xintercept = c(-0.37, 0.45), linetype = 2, color = "grey50")+
  ylab("")+
  xlab("\n คะแนนคุณลักษณะอันพึงประสงค์") +
  theme_light()+
  theme(text = element_text(family = "ChulaCharasNew"),
        panel.grid = element_blank(),
        axis.text = element_text(size = 14),
        axis.title.x = element_text(size = 15))
```


## สัดส่วนนักเรียนจำแนกตามความสอดคล้องกับคุณลักษณะอันพึงประสงค์ตามพระราโชบายของรัชกาลที่ 6 {.smaller}

```{r fig.height = 5}
library(rcartocolor)
score_longformat %>% 
 mutate(attribute = as.character(attribute)) %>% 
  mutate(attribute = ifelse(attribute == "รักชื่อเสียงวงศ์ตระกูล" ,
                            "รักเกียรติ และรักชื่อเสียงวงศ์ตระกูล",
                          attribute)) %>% 
  mutate(class = case_when(
    score_value > 0.45 ~ "สอดคล้อง",
    score_value < -0.37 ~ "ไม่สอดคล้อง",
    TRUE ~ "ไม่ขัดเจน/หลากหลาย"
  )) %>% 
  mutate(class = fct_relevel(class, "สอดคล้อง", "ไม่ขัดเจน/หลากหลาย", "ไม่สอดคล้อง")) %>%
  
  # 1. คำนวณสัดส่วนแต่ละ class
  count(attribute, class) %>%
  group_by(attribute) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup() %>%
  
  # 2. หาค่าที่เป็น prop ของ "สอดคล้อง" เพื่อนำไปจัดลำดับ
  group_by(attribute) %>%
  mutate(prop_green = prop[class == "สอดคล้อง"]) %>%
  ungroup() %>%
  
  # 3. จัดลำดับ attribute ใหม่
  mutate(attribute = fct_reorder(attribute, prop_green)) %>%
  
  # 4. ใส่ label เฉพาะ "สอดคล้อง"
  mutate(label = ifelse(class == "สอดคล้อง", scales::percent(prop, accuracy = 1), NA)) %>%
  
  ggplot(aes(y = attribute, x = prop, fill = class)) +
  geom_col(position = "fill") +
  geom_text(
    aes(label = label),
    position = position_fill(vjust = 0.5),
    family = "ChulaCharasNew",
    fontface = "bold",
    size = 5,
    na.rm = TRUE,
    col = "white"
  ) +
  scale_fill_manual(values = c(
    "สอดคล้อง" = "#0f9d58", 
    "ไม่ขัดเจน/หลากหลาย" = "#f4b400", 
    "ไม่สอดคล้อง" = "#db4437"
  )) +
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(x = "\nสัดส่วนของนักเรียน", y = "", fill = "") +
  theme_light() +
  theme(
    panel.grid = element_blank(),
    text = element_text(family = "ChulaCharasNew", size = 14),
    axis.text = element_text(size = 14),
    axis.title.x = element_text(size = 15),
    legend.position = "top"
  ) +
  guides(fill = guide_legend(reverse = TRUE))
```



## 1.1 รู้จักตรากตรำ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

<div style = "font-size:80%;">

- ผู้วิจัยคัดกรองข้อความที่มีความสอดคล้อง/ไม่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านรู้จักตรากตรำ โดยใช้คะแนนจุดตัดเป็นเกณฑ์  จากนั้นใช้โมเดลภาษาขนาดใหญ่ช่วยระบุคุณลักษณะย่อยของพฤติกรรมที่แสดงออกในแต่ละข้อความ

</div>

:::: {.columns}

::: {.column width="40%"}

<div style = "font-size:80%;">

- จำแนกข้อความออกเป็นคุณลักษณะย่อย  6 ด้าน ประกอบด้วย ด้านที่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านรู้จักตรากตรำ 5 ด้าน และด้านที่ไม่สอดคล้อง 1 ด้าน

- **ด้านที่สอดคล้อง** ได้แก่
  
  - รับผิดชอบ (ร้อยละ 27.0)

  - บริหารเวลาอย่างมีประสิทธิภาพ (ร้อยละ 26.3)

  - ขอความช่วยเหลืออย่างเหมาะสม (ร้อยละ 15.2)

  - ตั้งใจทำหน้าที่ให้ลุล่วง (ร้อยละ 12.5)

  - ขอความช่วยเหลืออย่างเหมาะสม (ร้อยละ 11.1)

- **ด้านที่ไม่สอดคล้อง** ได้แก่ หลีกเลี่ยงความรับผิดชอบ (ร้อยละ 7.8)

</div>

:::


::: {.column width="60%"}

<br>


```{r results = F}
source("05_report/generate_report.R")
```


```{r message = F, warning = F, echo = F}
score_hardwork_phrase <- read_csv("01_data/score_data/score_item5.1_phrase.csv")
score_hardwork_phrase <- score_hardwork_phrase %>% 
  left_join(all_data %>% select(student_id, student_level) %>% 
  filter(is.na(student_id) == F),
  by = "student_id", keep = F) %>% 
  unique()

library(rcartocolor)
# กำหนดว่าแต่ละ category เป็นบวกหรือลบ
positive_cats <- score_hardwork_phrase %>% 
  count(category_use,category) %>% 
  slice(2:6) %>% 
  pull(category)
negative_cats <- score_hardwork_phrase %>% 
  count(category_use,category) %>% 
  slice(1) %>% 
  pull(category)

thai_labels <- c(
  "ตั้งใจทำหน้าที่ให้ลุล่วง",
  "รับผิดชอบ",
  "บริหารเวลาอย่างมีประสิทธิภาพ",
  "เข้มแข็งและอดทน",
  "ขอความช่วยเหลืออย่างเหมาะสม",
  "หลีกเลี่ยงความรับผิดชอบ"
)

score_hardwork_phrase %>% 
  count(category) %>% 
  mutate(prop = n / sum(n)) %>%
  mutate(category = factor(category, 
                      levels = c(positive_cats, negative_cats),
                      labels = thai_labels)) %>% 
  ggplot(aes(x = n, y = reorder(category, n), fill = category)) +
  geom_col()+
  geom_text(aes(x = n, label = scales::percent(prop, accuracy = 0.1)),
            hjust = -0.1, size = 5, family = "ChulaCharasNew") +
  scale_fill_manual(
    values = c(
      rep("#0f9d58",5),
      rep("#db4437",1)
    ))+
  theme_light()+
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.text = element_text(size = 16),
    text = element_text(family = "ChulaCharasNew", size = 18))+
  ylab("")+
  xlab("\n จำนวนข้อความ") +
  xlim(0,300)
```

:::

::::

## 1.1 รู้จักตรากตรำ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


เมื่อพิจารณาคุณลักษณะย่อยของพฤติกรรมด้านรู้จักตรากตรำผ่านข้อความ จำแนกตามระดับชั้นของนักเรียน  พบว่า

- นักเรียนทุกระดับชั้นมีสัดส่วนข้อความที่สะท้อนพฤติกรรมที่สอดคล้องกับคุณลักษณะรู้จักตรากตรำเป็นส่วนใหญ่ โดยมีร้อยละของข้อความดังกล่าวอยู่ในช่วง 89.2% ถึง 94.2% ของข้อความทั้งหมดในแต่ละระดับชั้น

- ระดับชั้นที่มีสัดส่วนของข้อความดังกล่าวมากที่สุดคือ มัธยมศึกษาปีที่ 6 (ร้อยละ 94.2) รองลงมาคือ มัธยมศึกษาปีที่ 4 (ร้อยละ 94.1) และ มัธยมศึกษาปีที่ 2 (ร้อยละ 93.4)

- ในทางกลับกันระดับชั้นที่มีสัดส่วนข้อความที่ไม่สอดคล้องกับพฤติกรรมตามคุณลักษณะรู้จักตรากตรำมากที่สุด ได้แก่ ประถมศึกษาปีที่ 5 (ร้อยละ 10.7) มัธยมศึกษาปีที่ 1 (ร้อยละ 10.6) และ มัธยมศึกษาปีที่ 3 (ร้อยละ 10.4)

## 1.1 รู้จักตรากตรำ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

คุณลักษณะย่อยของพฤติกรรมด้านรู้จักตรากตรำผ่านข้อความ จำแนกตามระดับชั้นของนักเรียน 

```{r distribution_plot, fig.width = 10, fig.height = 6, echo = F}


thai_labels <- c(
  "ตั้งใจทำหน้าที่ให้ลุล่วง",
  "รับผิดชอบ",
  "บริหารเวลาอย่างมีประสิทธิภาพ",
  "เข้มแข็งและอดทน",
  "ขอความช่วยเหลืออย่างเหมาะสม",
  "หลีกเลี่ยงความรับผิดชอบ"
)

plot_pyramid_chart(score_hardwork_phrase %>% select(-student_level), 
                   all_data,
                   legend_row = 2,
                   positive_cats = positive_cats,
                   negative_cats = negative_cats,
                   thai_labels = thai_labels)
  
```



## 1.1 คุณลักษณะย่อยด้านรู้จักตรากตรำ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r results = F}
source("05_report/generate_report.R")
source("05_report/word_cloud.R")
```


```{r message = F, warning = F, echo = F}
score_hardwork_phrase <- read_csv("01_data/score_data/score_item5.1_phrase.csv")
score_hardwork_phrase <- score_hardwork_phrase %>% 
  left_join(all_data %>% select(student_id, student_level) %>% 
  filter(is.na(student_id) == F),
  by = "student_id", keep = F) %>% 
  unique()
```


```{r fig.width = 8, echo = F}
library(rcartocolor)
# กำหนดว่าแต่ละ category เป็นบวกหรือลบ
positive_cats <- score_hardwork_phrase %>% 
  count(category_use,category) %>% 
  slice(2:6) %>% 
  pull(category)
negative_cats <- score_hardwork_phrase %>% 
  count(category_use,category) %>% 
  slice(1) %>% 
  pull(category)
```

```{r data_preprocessing_respect, echo = F, eval = F, fig.width=8, fig.height=6}

positive_phrase <- score_hardwork_phrase %>% 
  mutate(score = .pred_positive_behav_rf - .pred_negative_behav_rf) %>% 
  filter(score > 0.7) %>% 
  mutate(main_idea = purrr::map_chr(phrase, summarize_main_idea_openai)) 
write_excel_csv(positive_phrase, file = "01_data/score_data/hardwork_positive_phrase.csv")

negative_phrase <- score_hardwork_phrase %>% 
  mutate(score = .pred_negative_behav_rf - .pred_positive_behav_rf) %>% 
  filter(score > 0.6) %>% 
  mutate(main_idea = purrr::map_chr(phrase, summarize_main_idea_openai))
write_excel_csv(negative_phrase, file = "01_data/score_data/hardwork_negative_phrase.csv")
```


```{r}
library(thaitextrecipe)
library(tidytext)
positive_phrase <- read_csv("01_data/score_data/hardwork_positive_phrase.csv")


p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% 
      slice(2:6) %>%  pull(category),
    category_labels = thai_labels[1:5],
    selected_categories = thai_labels[2],
  max_words = 150,
  color_palette = "Set2",
  reverse_colors = TRUE
)

```



## 1.1 คุณลักษณะย่อยด้านรู้จักตรากตรำ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% 
      slice(2:6) %>%  pull(category),
    category_labels = thai_labels[1:5],
    selected_categories = thai_labels[3],
  max_words = 150,
  color_palette = "Set2",
  reverse_colors = TRUE
)
```



## 1.1 คุณลักษณะย่อยด้านรู้จักตรากตรำ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% 
      slice(2:6) %>%  pull(category),
    category_labels = thai_labels[1:5],
    selected_categories = thai_labels[5],
  max_words = 150,
  color_palette = "Set2",
  reverse_colors = TRUE
)
```



## 1.1 คุณลักษณะย่อยด้านรู้จักตรากตรำ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% 
      slice(2:6) %>%  pull(category),
    category_labels = thai_labels[1:5],
    selected_categories = thai_labels[1],
  max_words = 150,
  color_palette = "Set2",
  reverse_colors = TRUE
)
```


## 1.1 คุณลักษณะย่อยด้านรู้จักตรากตรำ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% 
      slice(2:6) %>%  pull(category),
    category_labels = thai_labels[1:5],
    selected_categories = thai_labels[4],
  max_words = 150,
  color_palette = "Set2",
  reverse_colors = TRUE
)
```

## 1.1 คุณลักษณะย่อยด้านรู้จักตรากตรำ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
negative_phrase <- read_csv("01_data/score_data/hardwork_negative_phrase.csv")

p<-plot_category_wordclouds(
    phrase_data = negative_phrase,
    categories_filter = negative_phrase |> count(category) |> pull(1),
    category_labels = thai_labels[6],
    selected_categories = thai_labels[6],
  max_words = 150,
  color_palette = "Set1",
  reverse_colors = TRUE
)
```




## 1.4 ไม่ทำตนเป็นคนถือยศศักดิ์ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

<div style = "font-size:75%;">

- ผู้วิจัยคัดกรองข้อความที่มีความสอดคล้อง/ไม่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านรู้จักตรากตรำ โดยใช้คะแนนจุดตัดเป็นเกณฑ์  จากนั้นใช้โมเดลภาษาขนาดใหญ่ช่วยระบุคุณลักษณะย่อยของพฤติกรรมที่แสดงออกในแต่ละข้อความ

</div>

:::: {.columns}

::: {.column width="40%"}

<div style = "font-size:75%;">

- จำแนกข้อความออกเป็นคุณลักษณะย่อย  6 ด้าน ประกอบด้วย ด้านที่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านไม่เป็นตนถือยศศักดิ์จำนวน 3 ด้าน และด้านที่ไม่สอดคล้อง 3 ด้าน

- **ด้านที่สอดคล้อง** ได้แก่
  
  - แสดงออก/พูดจาสุภาพ (ร้อยละ 65.8)

  - ให้เกียรติผู้อื่น (ร้อยละ 17.4)

  - รู้จักกาลเทศะ (ร้อยละ 6.7)


- **ด้านที่ไม่สอดคล้อง** ได้แก่ 

  - พูดจาหยาบคาย (ร้อยละ 7.2)

  - แสดงพฤติกรรมก้าวร้าว (ร้อยละ 2.9)
  
  - ใช้อำนาจข่มคนอื่น (ร้อยละ 0.1)

</div>

:::


::: {.column width="60%"}

<br>


```{r results = F}
source("05_report/generate_report.R")
```


```{r message = F, warning = F, echo = F}
score_phrase <- read_csv("01_data/score_data/score_item1.3_phrase.csv")
score_phrase <- score_phrase %>% 
  left_join(all_data %>% select(student_id, student_level) %>% 
  filter(is.na(student_id) == F),
  by = "student_id", keep = F) %>% 
  unique() %>% 
  filter(!category == "Status_Abuse") %>% 
  filter(!category == "Respectful_Equality") # ลบ category ที่ไม่ต้องการออก

library(rcartocolor)
# กำหนดว่าแต่ละ category เป็นบวกหรือลบ
positive_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(4:6) %>% 
  pull(category)
negative_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(1:3) %>% 
  pull(category)


thai_labels <- c(
  "รู้จักกาลเทศะ",
  "แทรกแซงอย่างสุภาพ",
  "ให้เกียรติผู้อื่น",
  "แสดงพฤติกรรมก่้าวร้าว",
  "พูดจาหยาบคาย"
)



score_phrase %>% 
  count(category) %>% 
  mutate(prop = n / sum(n)) %>%
  mutate(category = factor(category, 
                      levels = c(positive_cats, negative_cats),
                      labels = thai_labels)) %>% 
  ggplot(aes(x = n, y = reorder(category, n), fill = category)) +
  geom_col()+
  geom_text(aes(x = n, label = scales::percent(prop, accuracy = 0.1)),
            hjust = -0.1, size = 5, family = "ChulaCharasNew") +
  scale_fill_manual(
    values = c(
      rep("#0f9d58",3),
      rep("#db4437",3)
    ))+
  theme_light()+
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.text = element_text(size = 16),
    text = element_text(family = "ChulaCharasNew", size = 18))+
  ylab("")+
  xlab("\n จำนวนข้อความ") +
  xlim(0,500)
```

:::

::::

## 1.2 ไม่ทำตนเป็นคนถือยศศักดิ์ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


คุณลักษณะย่อยของพฤติกรรมที่นักเรียนแสดงออกในด้านไม่เป็นตนถือยศศักดิ์ จำแนกตามระดับชั้นของนักเรียน

```{r fig.width = 10, fig.height = 6, echo = F}

plot_pyramid_chart(score_phrase %>% select(-student_level), 
                   all_data,
                   legend_row = 2,
                   color_direction = 1,
                   positive_cats = positive_cats,
                   negative_cats = negative_cats,
                   thai_labels = thai_labels)
  
```




## 1.2 คุณลักษณะย่อยด้านไม่ทำตนเป็นคนถือยศศักดิ์ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r echo = F, eval = F, fig.width=8, fig.height=6}

positive_phrase <- score_phrase %>% 
  mutate(score = .pred_positive_behav_rf - .pred_negative_behav_rf) %>% 
  filter(score > 0.7) %>% 
  mutate(main_idea = purrr::map_chr(phrase, summarize_main_idea_openai)) 
write_excel_csv(positive_phrase, file = "01_data/score_data/dignity_positive_phrase.csv")

negative_phrase <- score_phrase %>% 
  mutate(score = .pred_negative_behav_rf - .pred_positive_behav_rf) %>% 
  filter(score > 0.7) %>% 
  mutate(main_idea = purrr::map_chr(phrase, summarize_main_idea_openai))
write_excel_csv(negative_phrase, file = "01_data/score_data/dignity_negative_phrase.csv")
```


```{r}
library(thaitextrecipe)
library(tidytext)
positive_phrase <- read_csv("01_data/score_data/dignity_positive_phrase.csv")
negative_phrase <- read_csv("01_data/score_data/dignity_negative_phrase.csv")

positive_phrase  <- positive_phrase %>% 
  filter(!category == "Respectful_Equality")

p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:3],
    selected_categories = thai_labels[2],
  max_words = 150,
  color_palette = "Set2",
  reverse_colors = TRUE
)

```

## 1.2 คุณลักษณะย่อยด้านไม่ทำตนเป็นคนถือยศศักดิ์ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r}
p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:3],
    selected_categories = thai_labels[3],
  max_words = 150,
  color_palette = "Set2",
  reverse_colors = TRUE
)
```



## 1.2 คุณลักษณะย่อยด้านไม่ทำตนเป็นคนถือยศศักดิ์ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r}
p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
     categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:3],
    selected_categories = thai_labels[1],
  max_words = 150,
  color_palette = "Set2",
  reverse_colors = TRUE
)
```



## 1.2 คุณลักษณะย่อยด้านไม่ทำตนเป็นคนถือยศศักดิ์ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r}
p<-plot_category_wordclouds(
    phrase_data = negative_phrase,
    categories_filter = negative_phrase %>% 
      count(category) %>% 
      slice(1:2) %>%  pull(category),
    category_labels = thai_labels[4:5],
    selected_categories = thai_labels[5],
  max_words = 150,
  color_palette = "Set1",
  reverse_colors = TRUE
)
```




## 1.2 คุณลักษณะย่อยด้านไม่ทำตนเป็นคนถือยศศักดิ์ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r}
p<-plot_category_wordclouds(
    phrase_data = negative_phrase %>% 
      filter(!phrase == "บอกครู") %>% 
      filter(!phrase == "เบาๆ หน่อย"),
    categories_filter = negative_phrase %>% 
      count(category) %>% 
      slice(1:2) %>%  pull(category),
    category_labels = thai_labels[4:5],
    selected_categories = thai_labels[4],
  max_words = 150,
  color_palette = "Set1",
  reverse_colors = TRUE
)
```

## 1.3 ไม่สำรวยหยิบโหย่ง : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

<div style = "font-size:75%;">

- ผู้วิจัยคัดกรองข้อความที่มีความสอดคล้อง/ไม่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านรู้จักตรากตรำ โดยใช้คะแนนจุดตัดเป็นเกณฑ์  จากนั้นใช้โมเดลภาษาขนาดใหญ่ช่วยระบุคุณลักษณะย่อยของพฤติกรรมที่แสดงออกในแต่ละข้อความ

</div>

:::: {.columns}

::: {.column width="40%"}

<div style = "font-size:75%;">

- จำแนกข้อความออกเป็นคุณลักษณะย่อย  7 ด้าน ประกอบด้วย ด้านที่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านไม่เป็นตนถือยศศักดิ์จำนวน 4 ด้าน และด้านที่ไม่สอดคล้อง 3 ด้าน

- **ด้านที่สอดคล้อง** ได้แก่
  
  - แสดงออก/พูดจาสุภาพ (ร้อยละ 65.8)

  - ให้เกียรติผู้อื่น (ร้อยละ 17.4)

  - รู้จักกาลเทศะ (ร้อยละ 6.7)


- **ด้านที่ไม่สอดคล้อง** ได้แก่ 

  - พูดจาหยาบคาย (ร้อยละ 7.2)

  - แสดงพฤติกรรมก้าวร้าว (ร้อยละ 2.9)
  
  - ใช้อำนาจข่มคนอื่น (ร้อยละ 0.1)

</div>

:::


::: {.column width="60%"}

<br>


```{r results = F}
source("05_report/generate_report.R")
```


```{r message = F, warning = F, echo = F}
score_phrase <- read_csv("01_data/score_data/score_item8.1_phrase.csv")
score_phrase <- score_phrase %>% 
  left_join(all_data %>% select(student_id, student_level) %>% 
  filter(is.na(student_id) == F),
  by = "student_id", keep = F) %>% 
  unique() %>% 
  filter(!category == "Peer_Dependent")

library(rcartocolor)
# กำหนดว่าแต่ละ category เป็นบวกหรือลบ
positive_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(3:6) %>% 
  pull(category)
negative_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(1:2) %>% 
  pull(category)


thai_labels <- c("ตั้งเป้าหมายและมุ่งมั่น",
  "พยายามอย่างต่อเนื่องโดยไม่หักโหม",
  "มีแรงจูงใจจากภายใน",
  "มีวินัยในตนเอง",
  "มุ่งแสวงหาความสบาย",
  "ขาดแรงจูงใจ")



score_phrase %>% 
  count(category) %>% 
  mutate(prop = n / sum(n)) %>%
  mutate(category = factor(category, 
                      levels = c(positive_cats, negative_cats),
                      labels = thai_labels)) %>% 
  ggplot(aes(x = n, y = reorder(category, n), fill = category)) +
  geom_col()+
  geom_text(aes(x = n, label = scales::percent(prop, accuracy = 0.1)),
            hjust = -0.1, size = 5, family = "ChulaCharasNew") +
  scale_fill_manual(
    values = c(
      rep("#0f9d58",4),
      rep("#db4437",3)
    ))+
  theme_light()+
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.text = element_text(size = 16),
    text = element_text(family = "ChulaCharasNew", size = 18))+
  ylab("")+
  xlab("\n จำนวนข้อความ") +
  xlim(0,500)
```

:::

::::

## 1.3 ไม่สำรวยหยิบโหย่ง : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}



คุณลักษณะย่อยของพฤติกรรมที่นักเรียนแสดงออกในด้านไม่สำรวยหยิบโหย่ง จำแนกตามระดับชั้นของนักเรียน

```{r fig.width = 10, fig.height = 6, echo = F}

plot_pyramid_chart(score_phrase %>% select(-student_level), 
                   all_data,
                   legend_row = 2,
                   color_direction = 1,
                   positive_cats = positive_cats,
                   negative_cats = negative_cats,
                   thai_labels = thai_labels)
  
```





## 1.3 คุณลักษณะย่อยด้านไม่สำรวยหยิบโหย่ง : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r echo = F, eval = F, fig.width=8, fig.height=6}
positive_phrase <- score_phrase %>% 
  mutate(score = .pred_positive_behav_rf - .pred_negative_behav_rf) %>% 
  filter(score > 0.8) %>% 
  mutate(main_idea = purrr::map2_chr(phrase, category, summarize_main_idea_openai2)) 
write_excel_csv(positive_phrase, file = "01_data/score_data/resilient_positive_phrase.csv")

negative_phrase <- score_phrase %>% 
  mutate(score = .pred_negative_behav_rf - .pred_positive_behav_rf) %>% 
  filter(score > 0.7) %>% 
  mutate(main_idea = purrr::map_chr(phrase, summarize_main_idea_openai))
write_excel_csv(negative_phrase, file = "01_data/score_data/resilient_negative_phrase.csv")
```


```{r}
library(thaitextrecipe)
library(tidytext)
positive_phrase <- read_csv("01_data/score_data/resilient_positive_phrase.csv")
negative_phrase <- read_csv("01_data/score_data/resilient_negative_phrase.csv")




p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:4],
    selected_categories = thai_labels[1],
  max_words = 150,
  color_palette = "Set2",
  reverse_colors = TRUE
)

```




## 1.3 คุณลักษณะย่อยด้านไม่สำรวยหยิบโหย่ง : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r}
library(thaitextrecipe)
library(tidytext)


p<-plot_category_wordclouds(
    phrase_data = positive_phrase %>% 
      mutate(main_idea = ifelse(
        main_idea == "พักบ้างเถอะ", "พักวันนี้เพื่อให้วันหน้ามีแรงเต็มที่", main_idea)) %>% 
      mutate(main_idea = ifelse(
        main_idea == "พักผ่อนบ้าง" ,"แบ่งวันพักให้ร่างกาย", main_idea
      )) %>% 
      mutate(main_idea = ifelse(
        main_idea == "พักบ้าง" ,"ปรับตารางวิ่งให้มีวันพัก", main_idea
      )),
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:4],
    selected_categories = thai_labels[2],
  max_words = 150,
  color_palette = "Set2",
  reverse_colors = TRUE
)
```


## 1.3 คุณลักษณะย่อยด้านไม่สำรวยหยิบโหย่ง : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}

p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:4],
    selected_categories = thai_labels[3],
  max_words = 150,
  color_palette = "Set2",
  reverse_colors = TRUE
)
```



## 1.3 คุณลักษณะย่อยด้านไม่สำรวยหยิบโหย่ง : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}

p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:4],
    selected_categories = thai_labels[4],
  max_words = 150,
  color_palette = "Set2",
  reverse_colors = TRUE
)
```




## 1.3 คุณลักษณะย่อยด้านไม่สำรวยหยิบโหย่ง : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}

p<-plot_category_wordclouds(
    phrase_data = negative_phrase,
    categories_filter = negative_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[5:7],
    selected_categories = thai_labels[5],
  max_words = 150,
  color_palette = "Set3",
  reverse_colors = TRUE
)
```



## 1.3 คุณลักษณะย่อยด้านไม่สำรวยหยิบโหย่ง : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}

p<-plot_category_wordclouds(
    phrase_data = negative_phrase %>% 
      filter(!main_idea == "เลิกอ้าง") %>% 
      filter(!main_idea == "เริ่มใหม่"),
    categories_filter = negative_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[5:7],
    selected_categories = thai_labels[6],
  max_words = 150,
  color_palette = "Set1",
  reverse_colors = TRUE
)
```


## 1.4 เป็นผู้กล้าหาญ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


<div style = "font-size:75%;">

- ผู้วิจัยคัดกรองข้อความที่มีความสอดคล้อง/ไม่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านรู้จักตรากตรำ โดยใช้คะแนนจุดตัดเป็นเกณฑ์  จากนั้นใช้โมเดลภาษาขนาดใหญ่ช่วยระบุคุณลักษณะย่อยของพฤติกรรมที่แสดงออกในแต่ละข้อความ

</div>

:::: {.columns}

::: {.column width="40%"}

<div style = "font-size:75%;">

- จำแนกข้อความออกเป็นคุณลักษณะย่อย  7 ด้าน ประกอบด้วย ด้านที่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านไม่เป็นตนถือยศศักดิ์จำนวน 4 ด้าน และด้านที่ไม่สอดคล้อง 3 ด้าน

- **ด้านที่สอดคล้อง** ได้แก่
  
  - แสดงออก/พูดจาสุภาพ (ร้อยละ 65.8)

  - ให้เกียรติผู้อื่น (ร้อยละ 17.4)

  - รู้จักกาลเทศะ (ร้อยละ 6.7)


- **ด้านที่ไม่สอดคล้อง** ได้แก่ 

  - พูดจาหยาบคาย (ร้อยละ 7.2)

  - แสดงพฤติกรรมก้าวร้าว (ร้อยละ 2.9)
  
  - ใช้อำนาจข่มคนอื่น (ร้อยละ 0.1)

</div>

:::


::: {.column width="60%"}

<br>


```{r results = F}
source("05_report/generate_report.R")
```


```{r message = F, warning = F, echo = F}
score_phrase <- read_csv("01_data/score_data/score_item3.2_phrase.csv")
score_phrase <- score_phrase %>% 
  left_join(all_data %>% select(student_id, student_level) %>% 
  filter(is.na(student_id) == F),
  by = "student_id", keep = F) %>% 
  unique()  %>% 
  mutate(category = ifelse(category == "Calm_Intervention", "Assertive_Correction", category)) %>% 
  filter(!category == "Moral_Stand") %>% 
  filter(!category == "Responsible_Leadership") %>% 
  filter(!category == "Over_Relaxing")

library(rcartocolor)
# กำหนดว่าแต่ละ category เป็นบวกหรือลบ
positive_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(3:4) %>% 
  pull(category)


negative_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(1:2) %>% 
  pull(category)


thai_labels <- c(
  "ตักเตือนอย่างเหมาะสม",           # Assertive_Correction
  "ใช้ระเบียบ/ชี้ให้เห็นผลที่จะตามมา",                # Consequential_Accountability
"ตอบโต้ด้วยความก้าวร้าว",      # Aggressive_Reaction
  "หลีกเลี่ยงสถานการณ์"        # Avoidant_Behavior
  )




score_phrase %>% 
  count(category) %>% 
  mutate(prop = n / sum(n)) %>%
  mutate(category = factor(category, 
                      levels = c(positive_cats, negative_cats),
                      labels = thai_labels)) %>% 
  ggplot(aes(x = n, y = reorder(category, n), fill = category)) +
  geom_col()+
  geom_text(aes(x = n, label = scales::percent(prop, accuracy = 0.1)),
            hjust = -0.1, size = 5, family = "ChulaCharasNew") +
  scale_fill_manual(
    values = c(
      rep("#0f9d58",2),
      rep("#db4437",2)
    ))+
  theme_light()+
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.text = element_text(size = 16),
    text = element_text(family = "ChulaCharasNew", size = 18))+
  ylab("")+
  xlab("\n จำนวนข้อความ") +
  xlim(0,650)
```


:::

::::


## 1.4 เป็นผู้กล้าหาญ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}



คุณลักษณะย่อยของพฤติกรรมที่นักเรียนแสดงออกในด้านไม่สำรวยหยิบโหย่ง จำแนกตามระดับชั้นของนักเรียน

```{r fig.width = 10, fig.height = 6, echo = F}

plot_pyramid_chart(score_phrase %>% select(-student_level), 
                   all_data,
                   legend_row = 2,
                   color_direction = 1,
                   positive_cats = positive_cats,
                   negative_cats = negative_cats,
                   thai_labels = thai_labels)
  
```

## 1.4 คุณลักษณะย่อยด้านเป็นผู้กล้าหาญ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r echo = F, eval = F, fig.width=8, fig.height=6}
positive_phrase <- score_phrase %>% 
  mutate(score = .pred_positive_behav_rf - .pred_negative_behav_rf) %>% 
  filter(score > 0.8) %>% 
  mutate(main_idea = purrr::map2_chr(phrase, category, summarize_main_idea_openai2)) 
write_excel_csv(positive_phrase, file = "01_data/score_data/brave_positive_phrase.csv")

negative_phrase <- score_phrase %>% 
  mutate(score = .pred_negative_behav_rf - .pred_positive_behav_rf) %>% 
  filter(score > 0.7) %>% 
  mutate(main_idea = purrr::map2_chr(phrase,category, summarize_main_idea_openai2))
write_excel_csv(negative_phrase, file = "01_data/score_data/brave_negative_phrase.csv")
```


```{r}
positive_phrase <- read_csv("01_data/score_data/brave_positive_phrase.csv")
negative_phrase <- read_csv("01_data/score_data/brave_negative_phrase.csv")

p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:4],
    selected_categories = thai_labels[1],
  max_words = 350,
  color_palette = "Set2",
  reverse_colors = TRUE
)
```


## 1.4 คุณลักษณะย่อยด้านเป็นผู้กล้าหาญ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:4],
    selected_categories = thai_labels[2],
  max_words = 350,
  color_palette = "Set2",
  reverse_colors = TRUE
)

```


## 1.4 คุณลักษณะย่อยด้านเป็นผู้กล้าหาญ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r}
p<-plot_category_wordclouds(
    phrase_data = negative_phrase,
    categories_filter = negative_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[3:5],
    selected_categories = thai_labels[3],
  max_words = 350,
  color_palette = "Set1",
  reverse_colors = TRUE
)

```

## 1.4 คุณลักษณะย่อยด้านเป็นผู้กล้าหาญ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r}
p<-plot_category_wordclouds(
    phrase_data = negative_phrase %>% 
      filter(!main_idea == "รอทำข้อหนึ่ง") %>% 
      filter(!main_idea == "สงสารคนเงียบ") %>% 
      filter(!main_idea == "เตือนผิด"),
    categories_filter = negative_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[3:5],
    selected_categories = thai_labels[4],
  max_words = 30,
  color_palette = "Set1",
  reverse_colors = TRUE
)

```


## 1.5 มีสติปัญญาความรู้ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


<div style = "font-size:75%;">

- ผู้วิจัยคัดกรองข้อความที่มีความสอดคล้อง/ไม่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านรู้จักตรากตรำ โดยใช้คะแนนจุดตัดเป็นเกณฑ์  จากนั้นใช้โมเดลภาษาขนาดใหญ่ช่วยระบุคุณลักษณะย่อยของพฤติกรรมที่แสดงออกในแต่ละข้อความ

</div>

:::: {.columns}

::: {.column width="40%"}

<div style = "font-size:75%;">

- จำแนกข้อความออกเป็นคุณลักษณะย่อย  7 ด้าน ประกอบด้วย ด้านที่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านไม่เป็นตนถือยศศักดิ์จำนวน 4 ด้าน และด้านที่ไม่สอดคล้อง 3 ด้าน

- **ด้านที่สอดคล้อง** ได้แก่
  
  - แสดงออก/พูดจาสุภาพ (ร้อยละ 65.8)

  - ให้เกียรติผู้อื่น (ร้อยละ 17.4)

  - รู้จักกาลเทศะ (ร้อยละ 6.7)


- **ด้านที่ไม่สอดคล้อง** ได้แก่ 

  - พูดจาหยาบคาย (ร้อยละ 7.2)

  - แสดงพฤติกรรมก้าวร้าว (ร้อยละ 2.9)
  
  - ใช้อำนาจข่มคนอื่น (ร้อยละ 0.1)

</div>

:::


::: {.column width="60%"}

<br>


```{r results = F}
source("05_report/generate_report.R")
```

```{r message = F, warning = F, echo = F}
score_phrase <- read_csv("01_data/score_data/score_item4.1_phrase.csv")
score_phrase <- score_phrase %>% 
  left_join(all_data %>% select(student_id, student_level) %>% 
  filter(is.na(student_id) == F),
  by = "student_id", keep = F) %>% 
  unique() %>% 
  mutate(category = ifelse(category == "Constructive_Challenger",
                           "Reasoned_Creativity" , category))



library(rcartocolor)
# กำหนดว่าแต่ละ category เป็นบวกหรือลบ
positive_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(3:6) %>% 
  pull(category)


negative_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(1:2) %>% 
  pull(category)


thai_labels <- c(
"คิดวิเคราะห์และสังเคราะห์อย่างมีระบบ",
  "ให้เหตุผลร่วมกับผู้อื่น",
  "คิดสร้างสรรค์อย่างมีเหตุผล",
  "วางแผนอย่างเป็นขั้นเป็นตอน",
"ยอมตามโดยไม่ใช้วิจารณญาณ",
  "หลีกเลี่ยง"

  )

score_phrase %>% 
  count(category) %>% 
  mutate(prop = n / sum(n)) %>%
  mutate(category = factor(category, 
                      levels = c(positive_cats, negative_cats),
                      labels = thai_labels)) %>% 
  ggplot(aes(x = n, y = reorder(category, n), fill = category)) +
  geom_col()+
  geom_text(aes(x = n, label = scales::percent(prop, accuracy = 0.1)),
            hjust = -0.1, size = 5, family = "ChulaCharasNew") +
  scale_fill_manual(
    values = c(
      rep("#0f9d58",4),
      rep("#db4437",2)
    ))+
  theme_light()+
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.text = element_text(size = 16),
    text = element_text(family = "ChulaCharasNew", size = 18))+
  ylab("")+
  xlab("\n จำนวนข้อความ") +
  xlim(0,300)
```

:::

::::

## 1.5 มีสติปัญญาความรู้ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


คุณลักษณะย่อยของพฤติกรรมที่นักเรียนแสดงออกในด้านมีระเบียบ จำแนกตามระดับชั้นของนักเรียน

```{r fig.width = 10, fig.height = 6, echo = F}
plot_pyramid_chart(score_phrase %>% select(-student_level), 
                   all_data,
                   legend_row = 2,
                   color_direction = 1,
                   positive_cats = positive_cats,
                   negative_cats = negative_cats,
                   thai_labels = thai_labels)
```

## 1.5 คุณลักษณะย่อยด้านมีสติปัญญาความรู้ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r echo = F, eval = F, fig.width=8, fig.height=6}
positive_phrase <- score_phrase %>% 
  mutate(score = .pred_positive_behav_rf - .pred_negative_behav_rf) %>% 
  filter(score > 0.7) %>% 
  mutate(main_idea = purrr::map2_chr(phrase, category, summarize_main_idea_openai2)) 
write_excel_csv(positive_phrase, file = "01_data/score_data/intellegent_positive_phrase.csv")

negative_phrase <- score_phrase %>% 
  mutate(score = .pred_negative_behav_rf - .pred_positive_behav_rf) %>% 
  filter(score > 0.7) %>% 
  mutate(main_idea = purrr::map2_chr(phrase,category, summarize_main_idea_openai2))
write_excel_csv(negative_phrase, file = "01_data/score_data/intellegent_negative_phrase.csv")
```


```{r}
positive_phrase <- read_csv("01_data/score_data/intellegent_positive_phrase.csv")
negative_phrase <- read_csv("01_data/score_data/intellegent_negative_phrase.csv")
```


```{r}

positive_phrase <- positive_phrase %>% 
  filter(!category == "Avoidant_Compliance") %>% 
mutate(category = ifelse(category == "Constructive_Challenger",
                           "Reasoned_Creativity" , category)) %>% 
  filter(!str_detect(main_idea, "ขอย้ายกลุ่มใหม่")) %>% 
  mutate(main_idea = if_else(str_detect(main_idea, "ลองของใหม่"), "ลองของใหม่", main_idea))  %>% 
   mutate(main_idea = if_else(str_detect(main_idea, "ทำใหม่"), "ทำของใหม่", main_idea))  %>% 
    mutate(main_idea = if_else(str_detect(main_idea, "ไอเดียใหม่"), "ลองใช้ไอเดียใหม่", main_idea)) %>% 
   mutate(main_idea = if_else(str_detect(main_idea, "ไม่ซ้ำ"), "ไม่ซ้ำใคร", main_idea)) 


p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:4],
    selected_categories = thai_labels[3],
  max_words = 300,
  color_palette = "Set2",
  reverse_colors = TRUE
)
```


## 1.5 คุณลักษณะย่อยด้านมีสติปัญญาความรู้ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}

positive_phrase <- positive_phrase %>% 
  mutate(main_idea = if_else(str_detect(main_idea, "ปรึกษาเพื่อน"), "ปรึกษาเพื่อนในกลุ่ม", main_idea)) %>% 
  mutate(main_idea = if_else(str_detect(main_idea, "รับฟัง"), "รับฟังความคิดเห็น", main_idea)) %>% 
   mutate(main_idea = if_else(str_detect(main_idea, "เสนอความคิด"), "เสนอไอเดีย", main_idea))  %>% 
   mutate(main_idea = if_else(str_detect(main_idea, "เสนอไอเดีย"), "เสนอไอเดีย", main_idea))  %>% 
   mutate(main_idea = if_else(str_detect(main_idea, "แชร์"), "แชร์ไอเดีย", main_idea)) %>% 
   mutate(main_idea = if_else(str_detect(main_idea, "คิดตาม"), "ฟังเพื่อนแล้วคิดตาม", main_idea))  %>% 
mutate(main_idea = if_else(str_detect(main_idea, "ระดม"), "ระดมความคิดเห็นกับเพื่อน", main_idea))


p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:4],
    selected_categories = thai_labels[2],
  max_words = 300,
  color_palette = "Set2",
  reverse_colors = TRUE
)
```





## 1.5 คุณลักษณะย่อยด้านมีสติปัญญาความรู้ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r}

positive_phrase <- positive_phrase %>% 
  mutate(main_idea = if_else(str_detect(main_idea, "วางแผนงานให้ดี"), "วางแผนให้ดี", main_idea)) %>% 
   mutate(main_idea = if_else(str_detect(main_idea, "ออกแบบ"), "ออกแบบงาน", main_idea))  %>% 
   mutate(main_idea = if_else(str_detect(main_idea, "วางแผน"),"วางแผนงาน", main_idea)) %>% 
   mutate(main_idea = if_else(str_detect(main_idea, "แบ่งงาน"), "แบ่งงานตามหน้าที่" , main_idea))  %>% 
   mutate(main_idea = if_else(str_detect(main_idea, "แบ่งหน้าที่"), "แบ่งงานตามหน้าที่" , main_idea))  %>% 
   mutate(main_idea = if_else(str_detect(main_idea, "แบบ"), "ออกแบบงาน" , main_idea)) 
  

p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:4],
    selected_categories = thai_labels[4],
  max_words = 300,
  color_palette = "Set2",
  reverse_colors = TRUE
)

```



## 1.5 คุณลักษณะย่อยด้านมีสติปัญญาความรู้ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r}
positive_phrase <- positive_phrase %>% 
  filter(!category == "Avoidant_Compliance") %>% 
  mutate(category = ifelse(category == "Constructive_Challenger",
                           "Reasoned_Creativity" , category)) %>% 
  mutate(main_idea = str_replace(main_idea, "วิเคราะห์เจตนาข้อความ",
                                 "วิเคราะห์ปัญหา")) %>% 
  filter(!str_detect(main_idea, "คิดเองเถอะ")) %>% 
  mutate(main_idea = str_replace(main_idea, "คิดให้รอบคอบก่อนทำ" ,"คิดให้รอบคอบ")) %>% 
    mutate(main_idea = str_replace(main_idea, "คิดละเอียด" ,"คิดให้รอบคอบ")) %>% 
    mutate(main_idea = str_replace(main_idea, "คิดก่อนทำ" ,"คิดให้รอบคอบ")) %>% 
  mutate(main_idea = str_replace(main_idea, "คิดปัญหาหลักให้ชัดเจน","หาปัญหา")) %>% 
  mutate(main_idea = str_replace(main_idea, "หาปัญหาโรงเรียน","หาปัญหา")) %>% 
  mutate(main_idea = str_replace(main_idea, "หาหัวข้อใหม่","หาปัญหา")) %>% 
  mutate(main_idea = str_replace_all(main_idea, "ข้อมูล", "หาข้อมูล")) %>% 
  mutate(main_idea = str_replace(main_idea, "หาหาข้อมูล", "หาข้อมูล")) %>% 
mutate(main_idea = if_else(str_detect(main_idea, "หาข้อมูล"), "หาข้อมูล", main_idea)) %>% 
mutate(main_idea = if_else(str_detect(main_idea, "หาปัญหา"), "หาปัญหา", main_idea)) %>% 
mutate(main_idea = if_else(str_detect(main_idea, "พิจารณาเจตนา"), "วิเคราะห์ปัญหา", main_idea))  %>% 
mutate(main_idea = if_else(str_detect(main_idea, "ขาด"), "หาสิ่งที่โรงเรียนขาด", main_idea)) %>% 
mutate(main_idea = if_else(str_detect(main_idea, "ประโยชน์"), "ทำสิ่งที่มีประโยชน์", main_idea)) %>% 
mutate(main_idea = if_else(str_detect(main_idea, "ปัญหาโรงเรียน"), "วิเคราะห์ปัญหาโรงเรียน", main_idea))

p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:4],
    selected_categories = thai_labels[1],
  max_words = 300,
  color_palette = "Set2",
  reverse_colors = TRUE
)
```


## 1.5 คุณลักษณะย่อยด้านมีสติปัญญาความรู้ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
negative_phrase <- negative_phrase %>% 
mutate(main_idea = if_else(str_detect(main_idea, "ง่าย"), "ทำง่าย ๆ ", main_idea))  %>% 
mutate(main_idea = if_else(str_detect(main_idea, "เดิม"), "ทำเหมือนเดิม", main_idea)) %>% 
filter(!str_detect(main_idea, "สุดชีวิต")) %>% 
filter(!str_detect(main_idea, "สร้างสรรค์"))




p<-plot_category_wordclouds(
    phrase_data = negative_phrase,
    categories_filter = negative_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[5:6],
    selected_categories = thai_labels[5],
  max_words = 300,
  color_palette = "Set1",
  reverse_colors = T
)
```


## 1.5 คุณลักษณะย่อยด้านมีสติปัญญาความรู้ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
negative_phrase <- negative_phrase %>% 
filter(!str_detect(main_idea, "ตั้งใจ")) %>% 
filter(!str_detect(main_idea, "ทำเยอะ")) %>% 
filter(!str_detect(main_idea, "my"))  %>% 
filter(!str_detect(main_idea, "ดี")) %>% 
mutate(main_idea = if_else(str_detect(main_idea, "จ้าง"), "จ้างทำ", main_idea)) %>% 
mutate(main_idea = if_else(str_detect(main_idea, '"แล้วแต่"'), "จ้างทำ", main_idea))


p<-plot_category_wordclouds(
    phrase_data = negative_phrase,
    categories_filter = negative_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[5:6],
    selected_categories = thai_labels[6],
  max_words = 300,
  color_palette = "Set1",
  reverse_colors = T
)
```

## 1.6 รักเกียรติ และรักชื่อเสียงวงศ์ตระกูล : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


<div style = "font-size:75%;">

- ผู้วิจัยคัดกรองข้อความที่มีความสอดคล้อง/ไม่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านรู้จักตรากตรำ โดยใช้คะแนนจุดตัดเป็นเกณฑ์  จากนั้นใช้โมเดลภาษาขนาดใหญ่ช่วยระบุคุณลักษณะย่อยของพฤติกรรมที่แสดงออกในแต่ละข้อความ

</div>

:::: {.columns}

::: {.column width="40%"}

<div style = "font-size:75%;">

- จำแนกข้อความออกเป็นคุณลักษณะย่อย  7 ด้าน ประกอบด้วย ด้านที่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านไม่เป็นตนถือยศศักดิ์จำนวน 4 ด้าน และด้านที่ไม่สอดคล้อง 3 ด้าน

- **ด้านที่สอดคล้อง** ได้แก่
  
  - แสดงออก/พูดจาสุภาพ (ร้อยละ 65.8)

  - ให้เกียรติผู้อื่น (ร้อยละ 17.4)

  - รู้จักกาลเทศะ (ร้อยละ 6.7)


- **ด้านที่ไม่สอดคล้อง** ได้แก่ 

  - พูดจาหยาบคาย (ร้อยละ 7.2)

  - แสดงพฤติกรรมก้าวร้าว (ร้อยละ 2.9)
  
  - ใช้อำนาจข่มคนอื่น (ร้อยละ 0.1)

</div>

:::


::: {.column width="60%"}

<br>


```{r message = F, warning = F, echo = F}
score_phrase <- read_csv("01_data/score_data/score_item6.1_phrase.csv")
score_phrase <- score_phrase %>% 
  left_join(all_data %>% select(student_id, student_level) %>% 
  filter(is.na(student_id) == F),
  by = "student_id", keep = F) %>% 
  unique() %>% 
  mutate(category = ifelse(category == "Balanced_Response", "Cultural_Respect", category)) %>% 
  mutate(category = ifelse(category == "Ethical_Assertiveness",
                           "Cultural_Respect" , category)) %>% 
  filter(!category == "Avoidance_or_Sarcasm")



library(rcartocolor)
# กำหนดว่าแต่ละ category เป็นบวกหรือลบ
positive_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(2:3) %>% 
  pull(category)


negative_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(1) %>% 
  pull(category)


thai_labels <- c(
  "เคารพวัฒนธรรม",
  "ปกป้องชื่อเสียงของครอบครัว",
  "ทำตามรุ่นพี่โดยไม่ตั้งคำถาม"
  )

score_phrase %>% 
  count(category) %>% 
  mutate(prop = n / sum(n)) %>%
  mutate(category = factor(category, 
                      levels = c(positive_cats, negative_cats),
                      labels = thai_labels)) %>% 
  ggplot(aes(x = n, y = reorder(category, n), fill = category)) +
  geom_col()+
  geom_text(aes(x = n, label = scales::percent(prop, accuracy = 0.1)),
            hjust = -0.1, size = 5, family = "ChulaCharasNew") +
  scale_fill_manual(
    values = c(
      rep("#0f9d58",2),
      rep("#db4437",1)
    ))+
  theme_light()+
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.text = element_text(size = 16),
    text = element_text(family = "ChulaCharasNew", size = 18))+
  ylab("")+
  xlab("\n จำนวนข้อความ") +
  xlim(0,600)
```

:::

::::

## 1.6 รักเกียรติ และรักชื่อเสียงวงศ์ตระกูล : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

คุณลักษณะย่อยของพฤติกรรมที่นักเรียนแสดงออกในด้านมีระเบียบ จำแนกตามระดับชั้นของนักเรียน

```{r fig.width = 10, fig.height = 6, echo = F}
plot_pyramid_chart(score_phrase %>% select(-student_level), 
                   all_data,
                   legend_row = 2,
                   color_direction = 1,
                   positive_cats = positive_cats,
                   negative_cats = negative_cats,
                   thai_labels = thai_labels)
```


## 1.6 คุณลักษณะย่อยด้านรักเกียรติ และรักชื่อเสียงวงศ์ตระกูล : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}



```{r echo = F, eval = F, fig.width=8, fig.height=6}
positive_phrase <- score_phrase %>% 
  mutate(score = .pred_positive_behav_rf - .pred_negative_behav_rf) %>% 
  filter(score > 0.7) %>% 
  mutate(main_idea = purrr::map2_chr(phrase, category, summarize_main_idea_openai2)) 
write_excel_csv(positive_phrase, file = "01_data/score_data/family_positive_phrase.csv")

negative_phrase <- score_phrase %>% 
  mutate(score = .pred_negative_behav_rf - .pred_positive_behav_rf) %>% 
  filter(score > 0.7) %>% 
  mutate(main_idea = purrr::map2_chr(phrase,category, summarize_main_idea_openai2))
write_excel_csv(negative_phrase, file = "01_data/score_data/family_negative_phrase.csv")
```


```{r}
positive_phrase <- read_csv("01_data/score_data/family_positive_phrase.csv")
negative_phrase <- read_csv("01_data/score_data/family_negative_phrase.csv")
```


```{r}

positive_phrase <- positive_phrase %>% 
  filter(!category == "Follow_Superior_Unquestioned")%>% 
  mutate(category = ifelse(category == "Balanced_Response", "Cultural_Respect", category)) %>% 
  mutate(category = ifelse(category == "Ethical_Assertiveness",
                           "Cultural_Respect" , category))

positive_phrase <- positive_phrase %>% 
  mutate(main_idea = ifelse(str_detect(main_idea, "เหมาะสม"),
                            "เล่นให้เหมาะสม",
                            main_idea))

positive_phrase <- positive_phrase %>% 
  mutate(main_idea = ifelse(str_detect(main_idea, "เปลี่ยน"),
                            "ปรับบทให้ดีขึ้น",
                            main_idea)) %>% 
  mutate(main_idea = ifelse(str_detect(main_idea, "แสดง"),
                            "แสดงให้พอดี",
                            main_idea)) %>% 
  mutate(main_idea = ifelse(str_detect(main_idea, "ตลก"),
                            "ตลกพอประมาณ",
                            main_idea)) %>% 
  mutate(main_idea = ifelse(str_detect(main_idea, "พอเหมาะ"),
                            "เล่นให้พอเหมาะ",
                            main_idea)) %>% 
  mutate(main_idea = ifelse(str_detect(main_idea, "ลด" ),
                            "ลดการล้อเลียน",
                            main_idea)) 


p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:2],
    selected_categories = thai_labels[1],
  max_words = 300,
  color_palette = "Set2",
  reverse_colors = T
)
```


## 1.6 คุณลักษณะย่อยด้านรักเกียรติ และรักชื่อเสียงวงศ์ตระกูล : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r}

positive_phrase <- positive_phrase %>% 
  mutate(main_idea = ifelse(str_detect(main_idea, "ต่อว่าครอบครัว"),
                            "ครอบครัวจะถูกตำหนิ",
                            main_idea)) %>% 
  mutate(main_idea = ifelse(str_detect(main_idea, "อบอุ่นครอบครัว"),
                            "มีผลต่อครอบครัว",
                            main_idea)) %>% 
    mutate(main_idea = ifelse(str_detect(main_idea, "มั่นใจในครอบครัว"),
                            "มีผลต่อครอบครัว",
                            main_idea)) %>% 
  filter(!str_detect(main_idea,"โบ้ยงานน้อง"))



p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:2],
    selected_categories = thai_labels[2],
  max_words = 300,
  color_palette = "Set2",
  reverse_colors = TRUE
)
```

## 1.6 คุณลักษณะย่อยด้านรักเกียรติ และรักชื่อเสียงวงศ์ตระกูล : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
negative_phrase <- negative_phrase %>% 
  filter(!category == "Avoidance_or_Sarcasm")

p<-plot_category_wordclouds(
    phrase_data = negative_phrase,
    categories_filter = negative_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[3],
    selected_categories = thai_labels[3],
  max_words = 300,
  color_palette = "Set2",
  reverse_colors = TRUE
)
```
## 1.7 มีระเบียบ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


<div style = "font-size:75%;">

- ผู้วิจัยคัดกรองข้อความที่มีความสอดคล้อง/ไม่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านรู้จักตรากตรำ โดยใช้คะแนนจุดตัดเป็นเกณฑ์  จากนั้นใช้โมเดลภาษาขนาดใหญ่ช่วยระบุคุณลักษณะย่อยของพฤติกรรมที่แสดงออกในแต่ละข้อความ

</div>

:::: {.columns}

::: {.column width="40%"}

<div style = "font-size:75%;">

- จำแนกข้อความออกเป็นคุณลักษณะย่อย  7 ด้าน ประกอบด้วย ด้านที่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านไม่เป็นตนถือยศศักดิ์จำนวน 4 ด้าน และด้านที่ไม่สอดคล้อง 3 ด้าน

- **ด้านที่สอดคล้อง** ได้แก่
  
  - แสดงออก/พูดจาสุภาพ (ร้อยละ 65.8)

  - ให้เกียรติผู้อื่น (ร้อยละ 17.4)

  - รู้จักกาลเทศะ (ร้อยละ 6.7)


- **ด้านที่ไม่สอดคล้อง** ได้แก่ 

  - พูดจาหยาบคาย (ร้อยละ 7.2)

  - แสดงพฤติกรรมก้าวร้าว (ร้อยละ 2.9)
  
  - ใช้อำนาจข่มคนอื่น (ร้อยละ 0.1)

</div>

:::


::: {.column width="60%"}

<br>


```{r results = F}
source("05_report/generate_report.R")
```


```{r message = F, warning = F, echo = F}
score_phrase <- read_csv("01_data/score_data/score_item2.1_phrase.csv")
score_phrase <- score_phrase %>% 
  left_join(all_data %>% select(student_id, student_level) %>% 
  filter(is.na(student_id) == F),
  by = "student_id", keep = F) %>% 
  unique()  %>% 
  mutate(category = ifelse(category == "Planned_Responsibility", "Commitment_to_Rules", category)) 



library(rcartocolor)
# กำหนดว่าแต่ละ category เป็นบวกหรือลบ
positive_cats <- score_phrase %>% 
  filter(!category == "Reactive_or_Emotional_Response") %>% 
  count(category_use,category) %>% 
  slice(3:6) %>% 
  pull(category)


negative_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(1:3) %>% 
  pull(category)


thai_labels <- c(
  "ยึดมั่นในกฎระเบียบ/รับผิดชอบต่อหน้าที่",
  "กระตุ้นเพื่อนให้ตรงเวลา",
  "ควบคุมตนเองได้",
  "ละเลยหน้าที่",
  "ตามเพื่อนโดยไม่คิด",
  "ตอบสนองด้วยอารมณ์"
  )




score_phrase %>% 
  count(category) %>% 
  mutate(prop = n / sum(n)) %>%
  mutate(category = factor(category, 
                      levels = c(positive_cats, negative_cats),
                      labels = thai_labels)) %>% 
  ggplot(aes(x = n, y = reorder(category, n), fill = category)) +
  geom_col()+
  geom_text(aes(x = n, label = scales::percent(prop, accuracy = 0.1)),
            hjust = -0.1, size = 5, family = "ChulaCharasNew") +
  scale_fill_manual(
    values = c(
      rep("#0f9d58",3),
      rep("#db4437",3)
    ))+
  theme_light()+
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.text = element_text(size = 16),
    text = element_text(family = "ChulaCharasNew", size = 18))+
  ylab("")+
  xlab("\n จำนวนข้อความ") +
  xlim(0,300)
```

:::

::::


## 1.7 มีระเบียบ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


คุณลักษณะย่อยของพฤติกรรมที่นักเรียนแสดงออกในด้านมีระเบียบ จำแนกตามระดับชั้นของนักเรียน

```{r fig.width = 10, fig.height = 6, echo = F}
plot_pyramid_chart(score_phrase %>% select(-student_level), 
                   all_data,
                   legend_row = 2,
                   color_direction = 1,
                   positive_cats = positive_cats,
                   negative_cats = negative_cats,
                   thai_labels = thai_labels)
```


## 1.7 คุณลักษณะย่อยด้านมีระเบียบ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r echo = F, eval = F, fig.width=8, fig.height=6}
positive_phrase <- score_phrase %>% 
  mutate(score = .pred_positive_behav_rf - .pred_negative_behav_rf) %>% 
  filter(score > 0.7) %>% 
  mutate(main_idea = purrr::map2_chr(phrase, category, summarize_main_idea_openai2)) 
write_excel_csv(positive_phrase, file = "01_data/score_data/discipline_positive_phrase.csv")

negative_phrase <- score_phrase %>% 
  mutate(score = .pred_negative_behav_rf - .pred_positive_behav_rf) %>% 
  filter(score > 0.7) %>% 
  mutate(main_idea = purrr::map2_chr(phrase,category, summarize_main_idea_openai2))
write_excel_csv(negative_phrase, file = "01_data/score_data/discipline_negative_phrase.csv")
```


```{r}
positive_phrase <- read_csv("01_data/score_data/discipline_positive_phrase.csv")
negative_phrase <- read_csv("01_data/score_data/discipline_negative_phrase.csv")

positive_phrase <- positive_phrase %>% 
      filter(!category == "Peer_Pressure_Compliance") %>% 
      filter(!category == "Reactive_or_Emotional_Response") %>% 
  mutate(category = ifelse(category == "Planned_Responsibility", "Commitment_to_Rules", category))

negative_phrase <- negative_phrase %>% 
  filter(!category == "Self_Control")

p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:3],
    selected_categories = thai_labels[1],
  max_words = 350,
  color_palette = "Set2",
  reverse_colors = TRUE
)
```

## 1.7 คุณลักษณะย่อยด้านมีระเบียบ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r}
p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:3],
    selected_categories = thai_labels[2],
  max_words = 350,
  color_palette = "Set2",
  reverse_colors = TRUE
)
```
## 1.7 คุณลักษณะย่อยด้านมีระเบียบ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r}
p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:3],
    selected_categories = thai_labels[3],
  max_words = 350,
  color_palette = "Set2",
  reverse_colors = TRUE
)
```

## 1.7 คุณลักษณะย่อยด้านมีระเบียบ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r}
p<-plot_category_wordclouds(
    phrase_data = negative_phrase,
    categories_filter =negative_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[4:6],
    selected_categories = thai_labels[4],
  max_words = 350,
  color_palette = "Set1",
  reverse_colors = TRUE
)
```


## 1.7 คุณลักษณะย่อยด้านมีระเบียบ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
p<-plot_category_wordclouds(
    phrase_data = negative_phrase %>% 
      mutate(main_idea = ifelse(main_idea == "เห็นด้วยกับเพื่อน", "ไปช้ากับเพื่อน", main_idea)) %>% 
      mutate(main_idea = str_replace_all(main_idea, "ตามเพื่อนให้เร็วหน่อย" , "ไปตามเพื่อน")) %>% 
      filter(!main_idea == "ทิ้งเพื่อนไว้ตรงนั้น") %>% 
      filter(!main_idea == '"เห็นด้วย"') %>% 
      filter(!main_idea == "ปล่อยเขาไป") %>% 
      filter(!main_idea == '"ไปก่อนเลย"') %>% 
      filter(!main_idea == "ช่วยเพื่อนด่วน") %>% 
      filter(!main_idea == str_detect(main_idea,"คนเดียว")) %>% 
      filter(!main_idea == "ไปคนเดียวก็ได้") %>% 
      filter(!str_detect(main_idea, "ปล่อย")),

    categories_filter =negative_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[4:6],
    selected_categories = thai_labels[5],
  max_words = 350,
  color_palette = "Set1",
  reverse_colors = TRUE
)
```



## 1.7 คุณลักษณะย่อยด้านมีระเบียบ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
p<-plot_category_wordclouds(
    phrase_data = negative_phrase %>% 
      mutate(main_idea = ifelse(main_idea == "เห็นด้วยกับเพื่อน", "ไปช้ากับเพื่อน", main_idea)) %>% 
      mutate(main_idea = str_replace_all(main_idea, "ตามเพื่อนให้เร็วหน่อย" , "ไปตามเพื่อน")) %>% 
      filter(!main_idea == "ทิ้งเพื่อนไว้ตรงนั้น") %>% 
      filter(!main_idea == '"เห็นด้วย"') %>% 
      filter(!main_idea == "ปล่อยเขาไป") %>% 
      filter(!main_idea == '"ไปก่อนเลย"') %>% 
      filter(!main_idea == "ช่วยเพื่อนด่วน") %>% 
      filter(!main_idea == str_detect(main_idea,"คนเดียว")) %>% 
      filter(!main_idea == "ไปคนเดียวก็ได้") %>% 
      filter(!str_detect(main_idea, "ปล่อย")) %>% 
      mutate(main_idea = str_replace(main_idea, "สายไหมไหม" , "สายไหม")),

    categories_filter =negative_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[4:6],
    selected_categories = thai_labels[6],
  max_words = 350,
  color_palette = "Set1",
  reverse_colors = TRUE
)
```


## 1.8 รู้จักรักษาหมู่รักษาคณะ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


<div style = "font-size:75%;">

- ผู้วิจัยคัดกรองข้อความที่มีความสอดคล้อง/ไม่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านรู้จักตรากตรำ โดยใช้คะแนนจุดตัดเป็นเกณฑ์  จากนั้นใช้โมเดลภาษาขนาดใหญ่ช่วยระบุคุณลักษณะย่อยของพฤติกรรมที่แสดงออกในแต่ละข้อความ

</div>

:::: {.columns}

::: {.column width="40%"}

<div style = "font-size:75%;">

- จำแนกข้อความออกเป็นคุณลักษณะย่อย  7 ด้าน ประกอบด้วย ด้านที่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านไม่เป็นตนถือยศศักดิ์จำนวน 4 ด้าน และด้านที่ไม่สอดคล้อง 3 ด้าน

- **ด้านที่สอดคล้อง** ได้แก่
  
  - แสดงออก/พูดจาสุภาพ (ร้อยละ 65.8)

  - ให้เกียรติผู้อื่น (ร้อยละ 17.4)

  - รู้จักกาลเทศะ (ร้อยละ 6.7)


- **ด้านที่ไม่สอดคล้อง** ได้แก่ 

  - พูดจาหยาบคาย (ร้อยละ 7.2)

  - แสดงพฤติกรรมก้าวร้าว (ร้อยละ 2.9)
  
  - ใช้อำนาจข่มคนอื่น (ร้อยละ 0.1)

</div>

:::


::: {.column width="60%"}

<br>


```{r message = F, warning = F, echo = F}
score_phrase <- read_csv("01_data/score_data/score_item3.3_phrase.csv")
score_phrase <- score_phrase %>% 
  left_join(all_data %>% select(student_id, student_level) %>% 
  filter(is.na(student_id) == F),
  by = "student_id", keep = F) %>% 
  unique() %>% 
  mutate(category = ifelse(category == "Proactive_Action_for_Group",
                           "Peaceful_Conflict_Management", category)) %>% 
  mutate(category = ifelse(category == "Indifference_to_Group",
                           "Withdrawal_from_Group" , category))


library(rcartocolor)
# กำหนดว่าแต่ละ category เป็นบวกหรือลบ
positive_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(3:5) %>% 
  filter(!category == "Withdrawal_from_Group") %>% 
  pull(category) 


negative_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(1:2) %>% 
  pull(category)


thai_labels <- c(
  "รับผิดชอบร่วมกันในคณะ",
  "จัดการความขัดแย้งอย่างสงบ",
  "รักษาความสามัคคีของหมู่คณะ",
  "โทษกันหรือสร้างความขัดแย้ง",
  "ไม่ใส่ใจต่อความเดือดร้อนของกลุ่ม"
  )

score_phrase %>% 
  count(category) %>% 
  mutate(prop = n / sum(n)) %>%
  mutate(category = factor(category, 
                      levels = c(positive_cats, negative_cats),
                      labels = thai_labels)) %>% 
  ggplot(aes(x = n, y = reorder(category, n), fill = category)) +
  geom_col()+
  geom_text(aes(x = n, label = scales::percent(prop, accuracy = 0.1)),
            hjust = -0.1, size = 5, family = "ChulaCharasNew") +
  scale_fill_manual(
    values = c(
      rep("#0f9d58",3),
      rep("#db4437",2)
    ))+
  theme_light()+
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.text = element_text(size = 16),
    text = element_text(family = "ChulaCharasNew", size = 18))+
  ylab("")+
  xlab("\n จำนวนข้อความ") +
  xlim(0,400)
```

:::

::::



## 1.8 รู้จักรักษาหมู่รักษาคณะ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

คุณลักษณะย่อยของพฤติกรรมที่นักเรียนแสดงออกในด้านมีระเบียบ จำแนกตามระดับชั้นของนักเรียน

```{r fig.width = 10, fig.height = 6, echo = F}
plot_pyramid_chart(score_phrase %>% select(-student_level), 
                   all_data,
                   legend_row = 2,
                   color_direction = 1,
                   positive_cats = positive_cats,
                   negative_cats = negative_cats,
                   thai_labels = thai_labels)
```


## 1.8 คุณลักษณะย่อยด้านรู้จักรักษาหมู่รักษาคณะ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}



```{r echo = F, eval = F, fig.width=8, fig.height=6}
positive_phrase <- score_phrase %>% 
  mutate(score = .pred_positive_behav_rf - .pred_negative_behav_rf) %>% 
  filter(score > 0.7) %>% 
  mutate(main_idea = purrr::map2_chr(phrase, category, summarize_main_idea_openai2)) 
write_excel_csv(positive_phrase, file = "01_data/score_data/collective_positive_phrase.csv")

negative_phrase <- score_phrase %>% 
  mutate(score = .pred_negative_behav_rf - .pred_positive_behav_rf) %>% 
  filter(score > 0.7) %>% 
  mutate(main_idea = purrr::map2_chr(phrase,category, summarize_main_idea_openai2))
write_excel_csv(negative_phrase, file = "01_data/score_data/collective_negative_phrase.csv")
```


```{r}
positive_phrase <- read_csv("01_data/score_data/collective_positive_phrase.csv")
negative_phrase <- read_csv("01_data/score_data/collective_negative_phrase.csv")


positive_phrase <- positive_phrase %>% 
  filter(!str_detect(category, "Indifference_to_Group")) %>% 
  mutate(category = ifelse(category == "Proactive_Action_for_Group",
                           "Peaceful_Conflict_Management", category)) %>% 
mutate(main_idea = if_else(str_detect(main_idea, "ตักเตือน"), "ตักเตือน", main_idea)) %>% 
  filter(!str_detect(main_idea, "บอกครู")) %>% 
  mutate(main_idea = ifelse(str_detect(main_idea, "หยุด"), "หยุดพฤติกรรม", main_idea)) %>% 
  filter(!str_detect(main_idea, "ลงโทษ")) %>% 
mutate(main_idea = if_else(str_detect(main_idea, "เตือนน้อง"), "เตือนน้อง", main_idea))
  

p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:3],
    selected_categories = thai_labels[2],
  max_words = 350,
  color_palette = "Set2",
  reverse_colors = TRUE
)
```

## 1.8 คุณลักษณะย่อยด้านรู้จักรักษาหมู่รักษาคณะ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
positive_phrase <- positive_phrase %>% 
  filter(!str_detect(main_idea, "เตือน"))


p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:3],
    selected_categories = thai_labels[1],
  max_words = 350,
  color_palette = "Set2",
  reverse_colors = TRUE
)
```



## 1.8 คุณลักษณะย่อยด้านรู้จักรักษาหมู่รักษาคณะ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r}
positive_phrase <- positive_phrase %>% 
  filter(!str_detect(main_idea, "เหนื่อยฟรี"))

p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:3],
    selected_categories = thai_labels[3],
  max_words = 350,
  color_palette = "Set2",
  reverse_colors = TRUE
)
```



## 1.8 คุณลักษณะย่อยด้านรู้จักรักษาหมู่รักษาคณะ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r}
negative_phrase <- negative_phrase %>% 
  filter(!category == "Proactive_Action_for_Group") %>% 
  mutate(category = ifelse(category == "Indifference_to_Group",
                           "Withdrawal_from_Group" , category))

p<-plot_category_wordclouds(
    phrase_data = negative_phrase,
    categories_filter = negative_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[4:5],
    selected_categories = thai_labels[4],
  max_words = 350,
  color_palette = "Set1",
  reverse_colors = TRUE
)
```


## 1.8 คุณลักษณะย่อยด้านรู้จักรักษาหมู่รักษาคณะ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r}

p<-plot_category_wordclouds(
    phrase_data = negative_phrase,
    categories_filter = negative_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[4:5],
    selected_categories = thai_labels[5],
  max_words = 350,
  color_palette = "Set1",
  reverse_colors = TRUE
)
```

## 1.9 ไม่เหยียดหยาม : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


<div style = "font-size:75%;">

- ผู้วิจัยคัดกรองข้อความที่มีความสอดคล้อง/ไม่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านรู้จักตรากตรำ โดยใช้คะแนนจุดตัดเป็นเกณฑ์  จากนั้นใช้โมเดลภาษาขนาดใหญ่ช่วยระบุคุณลักษณะย่อยของพฤติกรรมที่แสดงออกในแต่ละข้อความ

</div>

:::: {.columns}

::: {.column width="40%"}

<div style = "font-size:75%;">

- จำแนกข้อความออกเป็นคุณลักษณะย่อย  7 ด้าน ประกอบด้วย ด้านที่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านไม่เป็นตนถือยศศักดิ์จำนวน 4 ด้าน และด้านที่ไม่สอดคล้อง 3 ด้าน

- **ด้านที่สอดคล้อง** ได้แก่
  
  - แสดงออก/พูดจาสุภาพ (ร้อยละ 65.8)

  - ให้เกียรติผู้อื่น (ร้อยละ 17.4)

  - รู้จักกาลเทศะ (ร้อยละ 6.7)


- **ด้านที่ไม่สอดคล้อง** ได้แก่ 

  - พูดจาหยาบคาย (ร้อยละ 7.2)

  - แสดงพฤติกรรมก้าวร้าว (ร้อยละ 2.9)
  
  - ใช้อำนาจข่มคนอื่น (ร้อยละ 0.1)

</div>

:::


::: {.column width="60%"}

<br>


```{r message = F, warning = F, echo = F}
score_phrase <- read_csv("01_data/score_data/score_item1.1_phrase.csv")
score_phrase <- score_phrase %>% 
  left_join(all_data %>% select(student_id, student_level) %>% 
  filter(is.na(student_id) == F),
  by = "student_id", keep = F) %>% 
  unique() %>% 
  mutate(category = ifelse(category == "Compassionate_Expression", "Empathy", category))


library(rcartocolor)
# กำหนดว่าแต่ละ category เป็นบวกหรือลบ
positive_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(4:6) %>% 
  pull(category) 


negative_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(1:3) %>% 
  pull(category)


thai_labels <- c(
  "เข้าใจและเห็นใจผู้อื่น",
  "ไม่ร่วมล้อเลียนหรือเผยแพร่ข้อมูลส่วนตัว",
  "ห้ามปรามด้วยความสุภาพ",
  "ล้อเลียนหรือดูหมิ่นอย่างเปิดเผย",
  "ตอบโต้ด้วยความก้าวร้าว",
  "เพิกเฉย/ไม่ใส่ใจ"
  )

score_phrase %>% 
  count(category) %>% 
  mutate(prop = n / sum(n)) %>%
  mutate(category = factor(category, 
                      levels = c(positive_cats, negative_cats),
                      labels = thai_labels)) %>% 
  ggplot(aes(x = n, y = reorder(category, n), fill = category)) +
  geom_col()+
  geom_text(aes(x = n, label = scales::percent(prop, accuracy = 0.1)),
            hjust = -0.1, size = 5, family = "ChulaCharasNew") +
  scale_fill_manual(
    values = c(
      rep("#0f9d58",3),
      rep("#db4437",3)
    ))+
  theme_light()+
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.text = element_text(size = 16),
    text = element_text(family = "ChulaCharasNew", size = 18))+
  ylab("")+
  xlab("\n จำนวนข้อความ") +
  xlim(0,550)
```

:::

::::

## 1.9 ไม่เหยียดหยาม : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


คุณลักษณะย่อยของพฤติกรรมที่นักเรียนแสดงออกในด้านมีระเบียบ จำแนกตามระดับชั้นของนักเรียน

```{r fig.width = 10, fig.height = 6, echo = F}
thai_labels <- c(
 
  "ล้อเลียนหรือดูหมิ่นอย่างเปิดเผย",
  "ตอบโต้ด้วยความก้าวร้าว",
  "เพิกเฉย/ไม่ใส่ใจ",
  "เข้าใจและเห็นใจผู้อื่น",
  "ไม่ร่วมล้อเลียนหรือเผยแพร่ข้อมูลส่วนตัว",
  "ห้ามปรามด้วยความสุภาพ"
  )

plot_pyramid_chart(score_phrase %>% select(-student_level),
                   all_data,
                   legend_row = 2,
                   color_direction = -1,
                   positive_cats = positive_cats,
                   negative_cats = negative_cats,
                   thai_labels = thai_labels)
```

## 1.9 คุณลักษณะย่อยด้านไม่เหยียดหยาม : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}



```{r echo = F, eval = F, fig.width=8, fig.height=6}
positive_phrase <- score_phrase %>% 
  mutate(score = .pred_positive_behav_rf - .pred_negative_behav_rf) %>% 
  filter(score > 0.7) %>% 
  mutate(main_idea = purrr::map2_chr(phrase, category, summarize_main_idea_openai2)) 
write_excel_csv(positive_phrase, file = "01_data/score_data/respect_positive_phrase.csv")

negative_phrase <- score_phrase %>% 
  mutate(score = .pred_negative_behav_rf - .pred_positive_behav_rf) %>% 
  filter(score > 0.7) %>% 
  mutate(main_idea = purrr::map2_chr(phrase,category, summarize_main_idea_openai2))
write_excel_csv(negative_phrase, file = "01_data/score_data/respect_negative_phrase.csv")
```


```{r}
positive_phrase <- read_csv("01_data/score_data/respect_positive_phrase.csv")
negative_phrase <- read_csv("01_data/score_data/respect_negative_phrase.csv")


positive_phrase <- positive_phrase %>% 
mutate(category = ifelse(category == "Compassionate_Expression", "Empathy", category)) %>% 
mutate(main_idea = if_else(str_detect(main_idea, "ละเมิด"), "ห้ามละเมิดสิทธิ", main_idea)) %>% 
mutate(main_idea = if_else(str_detect(main_idea, "สิทธิ"), "สิทธิส่วนบุคคล", main_idea))  %>% 
mutate(main_idea = if_else(str_detect(main_idea, "อย่าล้อ"), "อย่าล้อเพื่อน", main_idea))  




p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[4:6],
    selected_categories = thai_labels[6],
  max_words = 350,
  color_palette = "Set2",
  reverse_colors = T
)
```



## 1.9 คุณลักษณะย่อยด้านไม่เหยียดหยาม : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}

p <- plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[4:6],
    selected_categories = thai_labels[4],
  max_words = 350,
  color_palette = "Set2",
  reverse_colors = T
)
```



## 1.9 คุณลักษณะย่อยด้านไม่เหยียดหยาม : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}

p <- plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[4:6],
    selected_categories = thai_labels[5],
  max_words = 350,
  color_palette = "Set2",
  reverse_colors = T
)
```


## 1.9 คุณลักษณะย่อยด้านไม่เหยียดหยาม : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
p <- plot_category_wordclouds(
    phrase_data = negative_phrase,
    categories_filter = negative_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:3],
    selected_categories = thai_labels[3],
  max_words = 350,
  color_palette = "Set1",
  reverse_colors = T
)
```


## 1.9 คุณลักษณะย่อยด้านไม่เหยียดหยาม : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}

negative_phrase <- negative_phrase %>% 
  mutate(main_idea = ifelse(str_detect(main_idea, "หัวเราะ"), "หัวเราะ", main_idea)) %>% 
  mutate(main_idea = ifelse(str_detect(main_idea, "หัวเราะกลับ"), "หัวเราะ", main_idea)) %>% 
  mutate(main_idea = ifelse(str_detect(main_idea, "หัวเราะครับ"), "หัวเราะ", main_idea)) %>% 
  mutate(main_idea = ifelse(str_detect(main_idea, "หัวเราะร่วม"), "หัวเราะด้วย", main_idea)) %>% 
  mutate(main_idea = ifelse(str_detect(main_idea, "ขำขัน"), "ขำขัน", main_idea)) %>% 
  filter(!str_detect(main_idea,"ชอบเงียบ")) %>% 
  mutate(main_idea = ifelse(str_detect(main_idea, "หัวเราะได้"), "หัวเราะ", main_idea)) %>% 
  mutate(main_idea = ifelse(str_detect(main_idea, "ตลกตอนเด็ก"), "ตลก", main_idea)) 


p <- plot_category_wordclouds(
    phrase_data = negative_phrase,
    categories_filter = negative_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:3],
    selected_categories = thai_labels[1],
  max_words = 350,
  color_palette = "Set1",
  reverse_colors = T
)
```


## 1.10 กล้าเสียสละเพื่อประโยชน์ส่วนรวม : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


<div style = "font-size:75%;">

- ผู้วิจัยคัดกรองข้อความที่มีความสอดคล้อง/ไม่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านรู้จักตรากตรำ โดยใช้คะแนนจุดตัดเป็นเกณฑ์  จากนั้นใช้โมเดลภาษาขนาดใหญ่ช่วยระบุคุณลักษณะย่อยของพฤติกรรมที่แสดงออกในแต่ละข้อความ

</div>

:::: {.columns}

::: {.column width="40%"}

<div style = "font-size:75%;">

- จำแนกข้อความออกเป็นคุณลักษณะย่อย  7 ด้าน ประกอบด้วย ด้านที่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านไม่เป็นตนถือยศศักดิ์จำนวน 4 ด้าน และด้านที่ไม่สอดคล้อง 3 ด้าน

- **ด้านที่สอดคล้อง** ได้แก่
  
  - แสดงออก/พูดจาสุภาพ (ร้อยละ 65.8)

  - ให้เกียรติผู้อื่น (ร้อยละ 17.4)

  - รู้จักกาลเทศะ (ร้อยละ 6.7)


- **ด้านที่ไม่สอดคล้อง** ได้แก่ 

  - พูดจาหยาบคาย (ร้อยละ 7.2)

  - แสดงพฤติกรรมก้าวร้าว (ร้อยละ 2.9)
  
  - ใช้อำนาจข่มคนอื่น (ร้อยละ 0.1)

</div>

:::


::: {.column width="60%"}

<br>


```{r message = F, warning = F, echo = F}
score_phrase <- read_csv("01_data/score_data/score_item1.2_phrase.csv")
score_phrase <- score_phrase %>% 
  left_join(all_data %>% select(student_id, student_level) %>% 
  filter(is.na(student_id) == F),
  by = "student_id", keep = F) %>% 
  unique() %>% 
  mutate(category = ifelse(category == "Community_Orientation", "Active_Protection", category)) %>% 
  mutate(category = ifelse(category == "Voluntary_Sacrifice", "Active_Protection", category)) %>%
  mutate(category = ifelse(category == "Moral_Courage", "Active_Protection", category)) %>% 
  filter(!category == "Blaming_or_Deflection") %>%
  filter(!category == "Complicity")

library(rcartocolor)
# กำหนดว่าแต่ละ category เป็นบวกหรือลบ
positive_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(2) %>% 
  pull(category) 


negative_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(1) %>% 
  pull(category)


thai_labels <- c(
  "ปกป้องผู้อื่นอย่างเข้มแข็ง",           # Active_Protection
  "พฤติกรรมอื่นที่ไม่สอดคล้องกับการเสียสละ ฯ"            # Passive_Avoidance
)
  

score_phrase %>% 
  count(category) %>% 
  mutate(prop = n / sum(n)) %>%
  mutate(category = factor(category, 
                      levels = c(positive_cats, negative_cats),
                      labels = thai_labels)) %>% 
  ggplot(aes(x = n, y = reorder(category, n), fill = category)) +
  geom_col()+
  geom_text(aes(x = n, label = scales::percent(prop, accuracy = 0.1)),
            hjust = -0.1, size = 5, family = "ChulaCharasNew") +
  scale_fill_manual(
    values = c(
      rep("#0f9d58",1),
      rep("#db4437",1)
    ))+
  theme_light()+
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.text = element_text(size = 16),
    text = element_text(family = "ChulaCharasNew", size = 18))+
  ylab("")+
  xlab("\n จำนวนข้อความ") +
  xlim(0,700)
```

:::

::::


## 1.10 กล้าเสียสละเพื่อประโยชน์ส่วนรวม : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r fig.width = 10, fig.height = 6, echo = F}
plot_pyramid_chart(score_phrase %>% select(-student_level), 
                   all_data,
                   legend_row = 2,
                   color_direction = 1,
                   positive_cats = positive_cats,
                   negative_cats = negative_cats,
                   thai_labels = thai_labels)
```
## 1.10 คุณลักษณะย่อยด้านกล้าเสียสละเพื่อประโยชน์ส่วนรวม : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}



```{r echo = F, eval = F, fig.width=8, fig.height=6}
positive_phrase <- score_phrase %>% 
  mutate(score = .pred_positive_behav_rf - .pred_negative_behav_rf) %>% 
  filter(score > 0.70) %>% 
  mutate(main_idea = purrr::map2_chr(phrase, category, summarize_main_idea_openai2)) 
write_excel_csv(positive_phrase, file = "01_data/score_data/sacrifice_positive_phrase.csv")

negative_phrase <- score_phrase %>% 
  mutate(score = .pred_negative_behav_rf - .pred_positive_behav_rf) %>% 
  filter(score > 0.70) %>% 
  mutate(main_idea = purrr::map2_chr(phrase,category, summarize_main_idea_openai2))
write_excel_csv(negative_phrase, file = "01_data/score_data/sacrifice_negative_phrase.csv")
```


```{r}
positive_phrase <- read_csv("01_data/score_data/sacrifice_positive_phrase.csv")
negative_phrase <- read_csv("01_data/score_data/sacrifice_negative_phrase.csv")

positive_phrase <- positive_phrase %>% 
  mutate(category = ifelse(category == "Community_Orientation", "Active_Protection", category)) %>% 
  mutate(category = ifelse(category == "Voluntary_Sacrifice", "Active_Protection", category)) %>%
  mutate(category = ifelse(category == "Moral_Courage", "Active_Protection", category)) %>% 
  filter(!category == "Blaming_or_Deflection") %>%
  filter(!category == "Complicity") %>% 
  filter(!str_detect(main_idea, "ยิ้ม")) %>% 
  filter(!str_detect(main_idea, "ระเบิด")) %>% 
  filter(!str_detect(main_idea , "ขำ")) %>% 
  filter(!str_detect(main_idea , "นิ่ง")) %>% 
  filter(!str_detect(main_idea , "ทำเป็นไม่รู้")) %>%
  filter(!str_detect(main_idea , "ไม่สนใจ")) %>%
  filter(!str_detect(main_idea , "เรื่องของเพื่อน")) %>% 
  filter(!str_detect(main_idea , "ไม่แคร์แล้ว")) %>% 
  mutate(main_idea = ifelse(str_detect(main_idea, "ลบ"), "ลบภาพ", main_idea)) %>% 
  mutate(main_idea = ifelse(str_detect(main_idea, "ไอแพด"), "คืนไอแพดเพื่อน", main_idea)) %>% 
  mutate(main_idea = ifelse(str_detect(main_idea, "iPad"), "คืนไอแพดเพื่อน", main_idea)) %>% 
  mutate(main_idea = ifelse(str_detect(main_idea, "หยุด"), "หยุดเพื่อน", main_idea)) %>% 
  mutate(main_idea = ifelse(str_detect(main_idea, "ส่งต่อ"), "ไม่ส่งต่อ", main_idea))

p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1],
    selected_categories = thai_labels[1],
  max_words = 200,
  color_palette = "Set2",
  reverse_colors = T
)
```
## 1.10 คุณลักษณะย่อยด้านกล้าเสียสละเพื่อประโยชน์ส่วนรวม : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r}

negative_phrase <- negative_phrase %>% 
    filter(!category == "Blaming_or_Deflection") %>%
    filter(!category == "Complicity") %>% 
  filter(!str_detect(main_idea, "ห้าม")) %>% 
  filter(!str_detect(main_idea, "ลบ")) %>% 
  filter(!str_detect(main_idea, "บอกครู")) %>% 
  filter(!str_detect(main_idea, "เตือน")) %>% 
  filter(!str_detect(main_idea, "บอก")) %>% 
  filter(!str_detect(main_idea, "คืน")) %>%
  filter(!str_detect(main_idea, "หยุด")) %>%
  filter(!str_detect(main_idea, "ฟ้อง")) %>%
mutate(main_idea = ifelse(str_detect(main_idea, "ด่า"), "ด่า", main_idea))



p<-plot_category_wordclouds(
    phrase_data = negative_phrase,
    categories_filter = negative_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[2],
    selected_categories = thai_labels[2],
  max_words = 100,
  color_palette = "Set3",
  reverse_colors = T
)
```
## 1.11 เป็นผู้รับใช้และใช้คน : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


<div style = "font-size:75%;">

- ผู้วิจัยคัดกรองข้อความที่มีความสอดคล้อง/ไม่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านรู้จักตรากตรำ โดยใช้คะแนนจุดตัดเป็นเกณฑ์  จากนั้นใช้โมเดลภาษาขนาดใหญ่ช่วยระบุคุณลักษณะย่อยของพฤติกรรมที่แสดงออกในแต่ละข้อความ

</div>

:::: {.columns}

::: {.column width="40%"}

<div style = "font-size:75%;">

- จำแนกข้อความออกเป็นคุณลักษณะย่อย  7 ด้าน ประกอบด้วย ด้านที่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านไม่เป็นตนถือยศศักดิ์จำนวน 4 ด้าน และด้านที่ไม่สอดคล้อง 3 ด้าน

- **ด้านที่สอดคล้อง** ได้แก่
  
  - แสดงออก/พูดจาสุภาพ (ร้อยละ 65.8)

  - ให้เกียรติผู้อื่น (ร้อยละ 17.4)

  - รู้จักกาลเทศะ (ร้อยละ 6.7)


- **ด้านที่ไม่สอดคล้อง** ได้แก่ 

  - พูดจาหยาบคาย (ร้อยละ 7.2)

  - แสดงพฤติกรรมก้าวร้าว (ร้อยละ 2.9)
  
  - ใช้อำนาจข่มคนอื่น (ร้อยละ 0.1)

</div>

:::


::: {.column width="60%"}

<br>


```{r message = F, warning = F, echo = F}
score_phrase <- read_csv("01_data/score_data/score_item3.1_phrase.csv")
score_phrase <- score_phrase %>% 
  left_join(all_data %>% select(student_id, student_level) %>% 
  filter(is.na(student_id) == F),
  by = "student_id", keep = F) %>% 
  unique()  %>% 
  mutate(category = ifelse(category == "Servant_Mindset" , "Motivating_and_Encouraging", category)) %>% 
  filter(!category == "Neglect_or_Disengagement")

library(rcartocolor)
# กำหนดว่าแต่ละ category เป็นบวกหรือลบ
positive_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(2:5) %>% 
  pull(category) 


negative_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(1) %>% 
  pull(category)


thai_labels <- c(
  "ช่วยประสานให้งานสำเร็จ",
  "ชี้นำอย่างสุภาพ",
  "ส่งเสริมกำลังใจภายในทีม",
  "เป็นแบบอย่างที่ดี",
  "สั่งแบบเผด็จการ"
)
  

score_phrase %>% 
  count(category) %>% 
  mutate(prop = n / sum(n)) %>%
  mutate(category = factor(category, 
                      levels = c(positive_cats, negative_cats),
                      labels = thai_labels)) %>% 
  ggplot(aes(x = n, y = reorder(category, n), fill = category)) +
  geom_col()+
  geom_text(aes(x = n, label = scales::percent(prop, accuracy = 0.1)),
            hjust = -0.1, size = 5, family = "ChulaCharasNew") +
  scale_fill_manual(
    values = c(
      rep("#0f9d58",4),
      rep("#db4437",1)
    ))+
  theme_light()+
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.text = element_text(size = 16),
    text = element_text(family = "ChulaCharasNew", size = 18))+
  ylab("")+
  xlab("\n จำนวนข้อความ") +
  xlim(0,450)
```

:::

::::

## 1.11 เป็นผู้รับใช้และใช้คน : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r fig.width = 10, fig.height = 6, echo = F}
plot_pyramid_chart(score_phrase %>% select(-student_level), 
                   all_data,
                   legend_row = 2,
                   color_direction = 1,
                   positive_cats = positive_cats,
                   negative_cats = negative_cats,
                   thai_labels = thai_labels)
```


## 1.11 คุณลักษณะย่อยด้านเป็นผู้รับใช้และใช้คน : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r echo = F, eval = F, fig.width=8, fig.height=6}
positive_phrase <- score_phrase %>% 
  mutate(score = .pred_positive_behav_rf - .pred_negative_behav_rf) %>% 
  filter(score > 0.70) %>% 
  mutate(main_idea = purrr::map2_chr(phrase, category, summarize_main_idea_openai2)) 
write_excel_csv(positive_phrase, file = "01_data/score_data/serve_positive_phrase.csv")

negative_phrase <- score_phrase %>% 
  mutate(score = .pred_negative_behav_rf - .pred_positive_behav_rf) %>% 
  filter(score > 0.70) %>% 
  mutate(main_idea = purrr::map2_chr(phrase,category, summarize_main_idea_openai2))
write_excel_csv(negative_phrase, file = "01_data/score_data/serve_negative_phrase.csv")
```


```{r}
positive_phrase <- read_csv("01_data/score_data/serve_positive_phrase.csv")
negative_phrase <- read_csv("01_data/score_data/serve_negative_phrase.csv")

positive_phrase <- positive_phrase %>% 
  filter(!category == "Authoritarian_Force") %>% 
  mutate(category = ifelse(category == "Servant_Mindset" , "Motivating_and_Encouraging", category))

p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:4],
    selected_categories = thai_labels[3],
  max_words = 200,
  color_palette = "Set2",
  reverse_colors = T
)
```



## 1.11 คุณลักษณะย่อยด้านเป็นผู้รับใช้และใช้คน : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r}
p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:4],
    selected_categories = thai_labels[2],
  max_words = 200,
  color_palette = "Set2",
  reverse_colors = T
)
```




## 1.11 คุณลักษณะย่อยด้านเป็นผู้รับใช้และใช้คน : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r}
p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:4],
    selected_categories = thai_labels[1],
  max_words = 200,
  color_palette = "Set2",
  reverse_colors = T
)
```

## 1.11 คุณลักษณะย่อยด้านเป็นผู้รับใช้และใช้คน : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r}

positive_phrase <- positive_phrase %>% 
  mutate(main_idea = ifelse(str_detect(main_idea, "Role"), "Role Model" , main_idea)) %>% 
  filter(!str_detect(main_idea, "ฟังน้ำฐาน")) %>% 
  filter(!str_detect(main_idea, "ดู"))

p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:4],
    selected_categories = thai_labels[4],
  max_words = 200,
  color_palette = "Set2",
  reverse_colors = T
)
```


## 1.11 คุณลักษณะย่อยด้านเป็นผู้รับใช้และใช้คน : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r}

p<-plot_category_wordclouds(
    phrase_data = negative_phrase,
    categories_filter = negative_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[5:7],
    selected_categories = thai_labels[5],
  max_words = 200,
  color_palette = "Set1",
  reverse_colors = T
)
```

## 1.12 ศีลธรรม : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}



<div style = "font-size:75%;">

- ผู้วิจัยคัดกรองข้อความที่มีความสอดคล้อง/ไม่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านรู้จักตรากตรำ โดยใช้คะแนนจุดตัดเป็นเกณฑ์  จากนั้นใช้โมเดลภาษาขนาดใหญ่ช่วยระบุคุณลักษณะย่อยของพฤติกรรมที่แสดงออกในแต่ละข้อความ

</div>

:::: {.columns}

::: {.column width="40%"}

<div style = "font-size:75%;">

- จำแนกข้อความออกเป็นคุณลักษณะย่อย  7 ด้าน ประกอบด้วย ด้านที่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านไม่เป็นตนถือยศศักดิ์จำนวน 4 ด้าน และด้านที่ไม่สอดคล้อง 3 ด้าน

- **ด้านที่สอดคล้อง** ได้แก่
  
  - แสดงออก/พูดจาสุภาพ (ร้อยละ 65.8)

  - ให้เกียรติผู้อื่น (ร้อยละ 17.4)

  - รู้จักกาลเทศะ (ร้อยละ 6.7)


- **ด้านที่ไม่สอดคล้อง** ได้แก่ 

  - พูดจาหยาบคาย (ร้อยละ 7.2)

  - แสดงพฤติกรรมก้าวร้าว (ร้อยละ 2.9)
  
  - ใช้อำนาจข่มคนอื่น (ร้อยละ 0.1)

</div>

:::


::: {.column width="60%"}

<br>


```{r message = F, warning = F, echo = F}
score_phrase <- read_csv("01_data/score_data/score_item1.4_phrase.csv")
score_phrase <- score_phrase %>% 
  left_join(all_data %>% select(student_id, student_level) %>% 
  filter(is.na(student_id) == F),
  by = "student_id", keep = F) %>% 
  unique()  %>% 
  mutate(category = ifelse(category == "Integrity_Under_Pressure", "Truth_Telling", category))

library(rcartocolor)
# กำหนดว่าแต่ละ category เป็นบวกหรือลบ
positive_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(3:5) %>% 
  pull(category) 


negative_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(1:2) %>% 
  pull(category)


thai_labels <- c(
 "ยืนยันจุดยืนอย่างสุภาพ",
  "กล้าทำสิ่งที่ถูกต้อง", 
  "พูดความจริง",
"เลี่ยงตอบหรือเงียบไว้",
"ยอมปกปิดทั้งที่ไม่เห็นด้วย"
)
  

score_phrase %>% 
  count(category) %>% 
  mutate(prop = n / sum(n)) %>%
  mutate(category = factor(category, 
                      levels = c(positive_cats, negative_cats),
                      labels = thai_labels)) %>% 
  ggplot(aes(x = n, y = reorder(category, n), fill = category)) +
  geom_col()+
  geom_text(aes(x = n, label = scales::percent(prop, accuracy = 0.1)),
            hjust = -0.1, size = 5, family = "ChulaCharasNew") +
  scale_fill_manual(
    values = c(
      rep("#0f9d58",3),
      rep("#db4437",2)
    ))+
  theme_light()+
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.text = element_text(size = 16),
    text = element_text(family = "ChulaCharasNew", size = 18))+
  ylab("")+
  xlab("\n จำนวนข้อความ") +
  xlim(0,400)
```

:::

::::


## 1.12 ศีลธรรม : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r fig.width = 10, fig.height = 6, echo = F}
plot_pyramid_chart(score_phrase %>% select(-student_level), 
                   all_data,
                   legend_row = 2,
                   color_direction = 1,
                   positive_cats = positive_cats,
                   negative_cats = negative_cats,
                   thai_labels = thai_labels)
```


## 1.12 คุณลักษณะย่อยด้านศีลธรรม : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r echo = F, eval = F, fig.width=8, fig.height=6}
positive_phrase <- score_phrase %>% 
  mutate(score = .pred_positive_behav_rf - .pred_negative_behav_rf) %>% 
  filter(score > 0.70) %>% 
  mutate(main_idea = purrr::map2_chr(phrase, category, summarize_main_idea_openai2)) 
write_excel_csv(positive_phrase, file = "01_data/score_data/moral_positive_phrase.csv")

negative_phrase <- score_phrase %>% 
  mutate(score = .pred_negative_behav_rf - .pred_positive_behav_rf) %>% 
  filter(score > 0.70) %>% 
  mutate(main_idea = purrr::map2_chr(phrase,category, summarize_main_idea_openai2))
write_excel_csv(negative_phrase, file = "01_data/score_data/moral_negative_phrase.csv")
```


```{r}
positive_phrase <- read_csv("01_data/score_data/moral_positive_phrase.csv")
negative_phrase <- read_csv("01_data/score_data/moral_negative_phrase.csv")

positive_phrase <- positive_phrase %>% 
    mutate(category = ifelse(category == "Integrity_Under_Pressure", "Truth_Telling", category))


p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:3],
    selected_categories = thai_labels[3],
  max_words = 200,
  color_palette = "Set2",
  reverse_colors = T
)
```


## 1.12 คุณลักษณะย่อยด้านศีลธรรม : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:3],
    selected_categories = thai_labels[1],
  max_words = 200,
  color_palette = "Set2",
  reverse_colors = T
)
```

## 1.12 คุณลักษณะย่อยด้านศีลธรรม : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:3],
    selected_categories = thai_labels[2],
  max_words = 200,
  color_palette = "Set2",
  reverse_colors = T
)
```


## 1.12 คุณลักษณะย่อยด้านศีลธรรม : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r}
p<-plot_category_wordclouds(
    phrase_data = negative_phrase,
    categories_filter = negative_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[4:5],
    selected_categories = thai_labels[4],
  max_words = 200,
  color_palette = "Set2",
  reverse_colors = T
)
```


## 1.12 คุณลักษณะย่อยด้านศีลธรรม : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r}
p<-plot_category_wordclouds(
    phrase_data = negative_phrase,
    categories_filter = negative_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[4:5],
    selected_categories = thai_labels[5],
  max_words = 200,
  color_palette = "Set2",
  reverse_colors = T
)
```

# 2. ผลการวิเคราะห์คุณลักษณะอันพึงประสงค์ตามหลักสูตรแกนกลางที่รับผิดชอบโดยฝ่ายวิชาการ


## คะแนนคุณลักษณะอันพึงประสงค์ตามหลักสูตรแกนกลางที่รับผิดชอบโดยฝ่ายวิชาการ (1) {.smaller}


เมื่อพิจารณาคุณลักษณะอันพึงประสงค์ตามพระราโชบายของรัชกาลที่ 6 จำนวน 13 ด้าน พบว่าทุกด้านมีค่ามัธยฐานสูงกว่าคะแนนจุดตัดที่ 0.45 คะแนนทั้งหมด บ่งชี้ว่าพฤติกรรมการแสดงออกของนักเรียนส่วนใหญ่มีแนวโน้มสอดคล้องกับคุณลักษณะอันพึงประสงค์ตามพระราโชบายของรัชกาลที่ 6

เมื่อพิจารณาจากมัธยฐานพบว่า ด้านที่นักเรียนแสดงออกอย่างสอดคล้องมากที่สุดได้แก่

- รู้จักตรากตรำ (Med = 0.89, QD = 0.05)

- ไม่สำรวยหยิบโหย่ง (Med = 0.86, QD = 0.08) และไม่ทำตนเป็นคนถือยศศักดิ์ (Med = 0.86, QD = 0.06) 

ด้านที่มีมัธยฐานต่ำที่สุดคือด้านศีลธรรม (Med = 0.64, QD = 0.79) นอกจากนี้ยังมีข้อสังเกตว่าคะแนนด้านศีลธรรมเป็นด้่านที่มีการกระจายสูงมากที่สุด บ่งชี้ว่ามีนักเรียนบางกลุ่มที่มีแนวโน้มแสดงออกไม่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านศีลธรรม

## คะแนนคุณลักษณะอันพึงประสงค์ตามหลักสูตรแกนกลางที่รับผิดชอบโดยฝ่ายวิชาการ (2) {.smaller}



```{r}
score_longformat_academic %>% 
  mutate(attribute = as.character(attribute)) %>% 
  group_by(attribute) %>% 
  summarise(
    n = n(),
    median = median(score_value, na.rm = TRUE),
    qd = IQR(score_value, na.rm = TRUE)/2,
    avg = mean(score_value, na.rm = TRUE),
    sd = sd(score_value, na.rm = TRUE),
    min = min(score_value, na.rm = TRUE),
    q1 = quantile(score_value, 0.25, na.rm = TRUE),
    q3 = quantile(score_value, 0.75, na.rm = TRUE),
    max = max(score_value, na.rm = TRUE)
  ) %>% 
  arrange(desc(median)) %>%
  gt() %>% 
  cols_label(attribute = "คุณลักษณะอันพึงประสงค์",
             median = "Med",
             qd = "QD",
             avg = "M",
             sd = "SD",
             min = "Min",
             q1 = "Q1",
             q3 = "Q3",
             max = "Max") %>% 
  cols_align(align = "left", columns = attribute) %>%
  fmt_number(columns = everything(),
             decimals = 2) %>%
  tab_options(table.font.size = 12,
              table.width = pct(100),
              column_labels.font.weight = "bold",
              column_labels.font.size = 18,
              table.border.top.style = "solid",
              table.border.bottom.style = "solid",
              table.border.top.color = "black",
              table.border.bottom.color = "black") %>% 
  tab_style(
    style = cell_text(font = "ChulaCharasNew"),
    locations = cells_column_labels()
  )
```


 
## คะแนนคุณลักษณะอันพึงประสงค์ตามหลักสูตรแกนกลางที่รับผิดชอบโดยฝ่ายวิชาการ (3) {.smaller}


```{r fig.height = 5}
score_longformat_academic %>% 
  mutate(attribute = as.character(attribute)) %>% 
  mutate(attribute = fct_reorder(attribute, score_value, .fun = mean, .na_rm = TRUE)) %>% 
  ggplot(aes(x = score_value, y = attribute)) +
  geom_boxplot(fill = "#0f9d58", outlier.alpha = 0) +
  geom_jitter(height = 0.1, alpha = 0.1)+
  geom_vline(xintercept = c(-0.37, 0.45), linetype = 2, color = "grey50")+
  ylab("")+
  xlab("\n คะแนนคุณลักษณะอันพึงประสงค์") +
  theme_light()+
  theme(text = element_text(family = "ChulaCharasNew"),
        panel.grid = element_blank(),
        axis.text = element_text(size = 14),
        axis.title.x = element_text(size = 15))
```





## สัดส่วนของนักเรียนจำแนกตามความสอดคล้องกับคุณลักษณะอันพึงประสงค์ตามหลักสูตรแกนกลางที่รับผิดชอบโดยฝ่ายวิชาการ {.smaller}

```{r fig.height = 5}
library(rcartocolor)
score_longformat_academic %>% 
 mutate(attribute = as.character(attribute)) %>% 
  mutate(class = case_when(
    score_value > 0.45 ~ "สอดคล้อง",
    score_value < -0.37 ~ "ไม่สอดคล้อง",
    TRUE ~ "ไม่ขัดเจน/หลากหลาย"
  )) %>% 
  mutate(class = fct_relevel(class, "สอดคล้อง", "ไม่ขัดเจน/หลากหลาย", "ไม่สอดคล้อง")) %>%
  
  # 1. คำนวณสัดส่วนแต่ละ class
  count(attribute, class) %>%
  group_by(attribute) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup() %>%
  
  # 2. หาค่าที่เป็น prop ของ "สอดคล้อง" เพื่อนำไปจัดลำดับ
  group_by(attribute) %>%
  mutate(prop_green = prop[class == "สอดคล้อง"]) %>%
  ungroup() %>%
  
  # 3. จัดลำดับ attribute ใหม่
  mutate(attribute = fct_reorder(attribute, prop_green)) %>%
  
  # 4. ใส่ label เฉพาะ "สอดคล้อง"
  mutate(label = ifelse(class == "สอดคล้อง", scales::percent(prop, accuracy = 1), NA)) %>%
  
  ggplot(aes(y = attribute, x = prop, fill = class)) +
  geom_col(position = "fill") +
  geom_text(
    aes(label = label),
    position = position_fill(vjust = 0.5),
    family = "ChulaCharasNew",
    fontface = "bold",
    size = 5,
    na.rm = TRUE,
    col = "white"
  ) +
  scale_fill_manual(values = c(
    "สอดคล้อง" = "#0f9d58", 
    "ไม่ขัดเจน/หลากหลาย" = "#f4b400", 
    "ไม่สอดคล้อง" = "#db4437"
  )) +
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(x = "\nสัดส่วนของนักเรียน", y = "", fill = "") +
  theme_light() +
  theme(
    panel.grid = element_blank(),
    text = element_text(family = "ChulaCharasNew", size = 14),
    axis.text = element_text(size = 14),
    axis.title.x = element_text(size = 15),
    legend.position = "top"
  ) +
  guides(fill = guide_legend(reverse = TRUE))
```




## 2.1 อยู่อย่างพอเพียง : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}



<div style = "font-size:75%;">

- ผู้วิจัยคัดกรองข้อความที่มีความสอดคล้อง/ไม่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านรู้จักตรากตรำ โดยใช้คะแนนจุดตัดเป็นเกณฑ์  จากนั้นใช้โมเดลภาษาขนาดใหญ่ช่วยระบุคุณลักษณะย่อยของพฤติกรรมที่แสดงออกในแต่ละข้อความ

</div>

:::: {.columns}

::: {.column width="40%"}

<div style = "font-size:75%;">

- จำแนกข้อความออกเป็นคุณลักษณะย่อย  7 ด้าน ประกอบด้วย ด้านที่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านไม่เป็นตนถือยศศักดิ์จำนวน 4 ด้าน และด้านที่ไม่สอดคล้อง 3 ด้าน

- **ด้านที่สอดคล้อง** ได้แก่
  
  - แสดงออก/พูดจาสุภาพ (ร้อยละ 65.8)

  - ให้เกียรติผู้อื่น (ร้อยละ 17.4)

  - รู้จักกาลเทศะ (ร้อยละ 6.7)


- **ด้านที่ไม่สอดคล้อง** ได้แก่ 

  - พูดจาหยาบคาย (ร้อยละ 7.2)

  - แสดงพฤติกรรมก้าวร้าว (ร้อยละ 2.9)
  
  - ใช้อำนาจข่มคนอื่น (ร้อยละ 0.1)

</div>

:::


::: {.column width="60%"}

<br>



```{r message = F, warning = F, echo = F}
score_phrase <- read_csv("01_data/score_data/score_item7.1_phrase.csv")
score_phrase <- score_phrase %>% 
  left_join(all_data %>% select(student_id, student_level) %>% 
  filter(is.na(student_id) == F),
  by = "student_id", keep = F) %>% 
  unique() %>% 
  filter(!str_detect(category, "Peer_Pressured_Spending"))

library(rcartocolor)
# กำหนดว่าแต่ละ category เป็นบวกหรือลบ
positive_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(2:5) %>% 
  pull(category)
negative_cats <- c("Alternative_Solution")

thai_labels <- c(
  "ปรึกษาผู้ปกครองก่อนตัดสินใจ", 
  "ไม่ตามกระแส",
  "คิดก่อนใช้ตามความจำเป็น", 
  "แยกแยะความอยากกับความจำเป็น",
"ใช้เงินตามกระแส"
)

score_phrase %>% 
  count(category) %>% 
  mutate(prop = n / sum(n)) %>%
  mutate(category = factor(category, 
                      levels = c(positive_cats, negative_cats),
                      labels = thai_labels)) %>% 
  ggplot(aes(x = n, y = reorder(category, n), fill = category)) +
  geom_col()+
  geom_text(aes(x = n, label = scales::percent(prop, accuracy = 0.1)),
            hjust = -0.1, size = 5, family = "ChulaCharasNew") +
  scale_fill_manual(
    values = c(
      rep("#0f9d58",4),
      rep("#db4437",1)
    ))+
  theme_light()+
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.text = element_text(size = 16),
    text = element_text(family = "ChulaCharasNew", size = 18))+
  ylab("")+
  xlab("\n จำนวนข้อความ") +
  xlim(0,400)
```

:::

::::

## 2.1 อยู่อย่างพอเพียง : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r fig.width = 10, fig.height = 6, echo = F}
plot_pyramid_chart(score_phrase %>% select(-student_level), 
                   all_data,
                   legend_row = 2,
                   color_direction = 1,
                   positive_cats = positive_cats,
                   negative_cats = negative_cats,
                   thai_labels = thai_labels)
```


## 2.1 คุณลักษณะย่อยด้านอยู่อย่างพอเพียง : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}




```{r echo = F, eval = F, fig.width=8, fig.height=6}
positive_phrase <- score_phrase %>% 
  mutate(score = .pred_positive_behav_rf - .pred_negative_behav_rf) %>% 
  filter(score > 0.75) %>% 
  mutate(main_idea = purrr::map2_chr(phrase, category, summarize_main_idea_openai2)) 
write_excel_csv(positive_phrase, file = "01_data/score_data/sufficiency_positive_phrase.csv")

negative_phrase <- score_phrase %>% 
  mutate(score = .pred_negative_behav_rf - .pred_positive_behav_rf) %>% 
  filter(score > 0.70) %>% 
  mutate(main_idea = purrr::map2_chr(phrase,category, summarize_main_idea_openai2))
write_excel_csv(negative_phrase, file = "01_data/score_data/sufficiency_negative_phrase.csv")
```


```{r}
positive_phrase <- read_csv("01_data/score_data/sufficiency_positive_phrase.csv")
negative_phrase <- read_csv("01_data/score_data/sufficiency_negative_phrase.csv")

positive_phrase <- positive_phrase %>% 
  filter(!str_detect(category, "Peer_Pressured_Spending")) %>% 
  filter(!str_detect(category, "Alternative_Solution")) %>% 
  mutate(main_idea = ifelse(str_detect(main_idea, "ไม่ซื้อให้พ่อแม่"), "ไม่ซื้อเพราะพ่อแม่" , main_idea))  %>% 
  mutate(main_idea = ifelse(str_detect(main_idea, "ไม่ซื้อเพราะจำเป็น"), "ไม่ซื้อเพราะไม่จำเป็น" , main_idea)) 


p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:4],
    selected_categories = thai_labels[3],
  max_words = 200,
  color_palette = "Set2",
  reverse_colors = T
)
```

## 2.1 คุณลักษณะย่อยด้านอยู่อย่างพอเพียง : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:4],
    selected_categories = thai_labels[4],
  max_words = 200,
  color_palette = "Set2",
  reverse_colors = T
)
```


## 2.1 คุณลักษณะย่อยด้านอยู่อย่างพอเพียง : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:4],
    selected_categories = thai_labels[2],
  max_words = 200,
  color_palette = "Set2",
  reverse_colors = T
)
```



## 2.1 คุณลักษณะย่อยด้านอยู่อย่างพอเพียง : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:4],
    selected_categories = thai_labels[1],
  max_words = 200,
  color_palette = "Set2",
  reverse_colors = T
)
```

## 2.1 คุณลักษณะย่อยด้านอยู่อย่างพอเพียง : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
negative_phrase <- read_csv("01_data/score_data/sufficiency_positive_phrase.csv")
negative_phrase <- negative_phrase %>% 
  filter(str_detect(category, "Alternative_Solution")) %>% 
  filter(!str_detect(main_idea, "ไม่ซื้อ")) %>% 
  filter(!str_detect(main_idea, "ไม่ใช้")) %>% 
  filter(!str_detect(main_idea, "100")) %>% 
  filter(!str_detect(main_idea, "คืนช้า"))

p<-plot_category_wordclouds(
    phrase_data = negative_phrase,
    categories_filter = negative_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[5],
    selected_categories = thai_labels[5],
  max_words = 200,
  color_palette = "Set1",
  reverse_colors = T
)
```


## 2.2 ใฝ่เรียนรู้ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


<div style = "font-size:75%;">

- ผู้วิจัยคัดกรองข้อความที่มีความสอดคล้อง/ไม่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านรู้จักตรากตรำ โดยใช้คะแนนจุดตัดเป็นเกณฑ์  จากนั้นใช้โมเดลภาษาขนาดใหญ่ช่วยระบุคุณลักษณะย่อยของพฤติกรรมที่แสดงออกในแต่ละข้อความ

</div>

:::: {.columns}

::: {.column width="40%"}

<div style = "font-size:75%;">

- จำแนกข้อความออกเป็นคุณลักษณะย่อย  7 ด้าน ประกอบด้วย ด้านที่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านไม่เป็นตนถือยศศักดิ์จำนวน 4 ด้าน และด้านที่ไม่สอดคล้อง 3 ด้าน

- **ด้านที่สอดคล้อง** ได้แก่
  
  - แสดงออก/พูดจาสุภาพ (ร้อยละ 65.8)

  - ให้เกียรติผู้อื่น (ร้อยละ 17.4)

  - รู้จักกาลเทศะ (ร้อยละ 6.7)


- **ด้านที่ไม่สอดคล้อง** ได้แก่ 

  - พูดจาหยาบคาย (ร้อยละ 7.2)

  - แสดงพฤติกรรมก้าวร้าว (ร้อยละ 2.9)
  
  - ใช้อำนาจข่มคนอื่น (ร้อยละ 0.1)

</div>

:::


::: {.column width="60%"}

<br>



```{r message = F, warning = F, echo = F}
score_phrase <- read_csv("01_data/score_data/score_item4.2_phrase.csv")
score_phrase <- score_phrase %>% 
  left_join(all_data %>% select(student_id, student_level) %>% 
  filter(is.na(student_id) == F),
  by = "student_id", keep = F) %>% 
  unique() %>% 
  filter(!str_detect(category, "non_response_or_confusion"))

library(rcartocolor)
# กำหนดว่าแต่ละ category เป็นบวกหรือลบ
positive_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(2:6) %>% 
  pull(category)
negative_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(1) %>% 
  pull(category)

thai_labels <- c(
  "ลองด้วยความรอบคอบ",           # cautious_experimentation  
  "ริเริ่มอย่างใฝ่รู้",             # curious_initiative  
  "พยายามอย่างต่อเนื่อง",         # effortful_persistence  
  "เรียนรู้ด้วยคำแนะนำ",         # guided_learning  
  "หลีกเลี่ยงเพราะกลัว"          # fear_avoidance  
)

score_phrase %>% 
  count(category) %>% 
  mutate(prop = n / sum(n)) %>%
  mutate(category = factor(category, 
                      levels = c(positive_cats, negative_cats),
                      labels = thai_labels)) %>% 
  ggplot(aes(x = n, y = reorder(category, n), fill = category)) +
  geom_col()+
  geom_text(aes(x = n, label = scales::percent(prop, accuracy = 0.1)),
            hjust = -0.1, size = 5, family = "ChulaCharasNew") +
  scale_fill_manual(
    values = c(
      rep("#0f9d58",4),
      rep("#db4437",1)
    ))+
  theme_light()+
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.text = element_text(size = 16),
    text = element_text(family = "ChulaCharasNew", size = 18))+
  ylab("")+
  xlab("\n จำนวนข้อความ") +
  xlim(0,280)
```

:::

::::


## 2.2 ใฝ่เรียนรู้ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r fig.width = 10, fig.height = 6, echo = F}
plot_pyramid_chart(score_phrase %>% select(-student_level), 
                   all_data,
                   legend_row = 2,
                   color_direction = 1,
                   positive_cats = positive_cats,
                   negative_cats = negative_cats,
                   thai_labels = thai_labels)
```

## 2.2 คุณลักษณะย่อยด้านใฝ่เรียนรู้ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r echo = F, eval = F, fig.width=8, fig.height=6}
positive_phrase <- score_phrase %>% 
  mutate(score = .pred_positive_behav_rf - .pred_negative_behav_rf) %>% 
  filter(score > 0.75) %>% 
  mutate(main_idea = purrr::map2_chr(phrase, category, summarize_main_idea_openai2)) 
write_excel_csv(positive_phrase, file = "01_data/score_data/curiosity_positive_phrase.csv")

negative_phrase <- score_phrase %>% 
  mutate(score = .pred_negative_behav_rf - .pred_positive_behav_rf) %>% 
  filter(score > 0.70) %>% 
  mutate(main_idea = purrr::map2_chr(phrase,category, summarize_main_idea_openai2))
write_excel_csv(negative_phrase, file = "01_data/score_data/curiosity_negative_phrase.csv")
```


```{r}
positive_phrase <- read_csv("01_data/score_data/curiosity_positive_phrase.csv")
negative_phrase <- read_csv("01_data/score_data/curiosity_negative_phrase.csv")

set.seed(123)
p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:4],
    selected_categories = thai_labels[3],
  max_words = 300,
  color_palette = "Set2",
  reverse_colors = T
)
```


## 2.2 คุณลักษณะย่อยด้านใฝ่เรียนรู้ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:4],
    selected_categories = thai_labels[2],
  max_words = 300,
  color_palette = "Set2",
  reverse_colors = T
)
```

## 2.2 คุณลักษณะย่อยด้านใฝ่เรียนรู้ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:4],
    selected_categories = thai_labels[4],
  max_words = 300,
  color_palette = "Set2",
  reverse_colors = T
)
```



## 2.2 คุณลักษณะย่อยด้านใฝ่เรียนรู้ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}

positive_phrase <- positive_phrase %>% 
  mutate(main_idea = ifelse(str_detect(main_idea, "ทดลอง"), "ทดลองทำก่อน" , main_idea)) %>% 
  mutate(main_idea = ifelse(str_detect(main_idea, "ออกแบบ"), "วางแผนก่อนทำ" , main_idea)) %>% 
  mutate(main_idea = ifelse(str_detect(main_idea, "วางแผน"), "วางแผนก่อนทำ" , main_idea)) %>% 
  mutate(main_idea = ifelse(str_detect(main_idea, "ลองทำ"), "ลองทำก่อน" , main_idea)) %>% 
  filter(!str_detect(main_idea, "ห้องน้ำ")) %>% 
  filter(!str_detect(main_idea, "หยุด")) %>%
  filter(!str_detect(main_idea, "เปลี่ยน")) %>% 
  filter(!str_detect(main_idea, "ลด")) %>% 
  mutate(main_idea = ifelse(str_detect(main_idea, "สำรอง"), "มีแผนสำรองไว้เผื่อ" , main_idea))

  
set.seed(123)
p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:4],
    selected_categories = thai_labels[1],
  max_words = 300,
  color_palette = "Set2",
  reverse_colors = T
)
```
## 2.2 คุณลักษณะย่อยด้านใฝ่เรียนรู้ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
set.seed(123)
negative_phrase <- negative_phrase %>% 
  filter(!str_detect(main_idea, "ทำแล้วเกิด"))

p<-plot_category_wordclouds(
    phrase_data = negative_phrase,
    categories_filter = negative_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[5:6],
    selected_categories = thai_labels[5],
  max_words = 300,
  color_palette = "Set2",
  reverse_colors = T
)
```

## 2.3 รักชาติ ศาสน์ กษัตริย์ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}



<div style = "font-size:75%;">

- ผู้วิจัยคัดกรองข้อความที่มีความสอดคล้อง/ไม่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านรู้จักตรากตรำ โดยใช้คะแนนจุดตัดเป็นเกณฑ์  จากนั้นใช้โมเดลภาษาขนาดใหญ่ช่วยระบุคุณลักษณะย่อยของพฤติกรรมที่แสดงออกในแต่ละข้อความ

</div>

:::: {.columns}

::: {.column width="40%"}

<div style = "font-size:75%;">

- จำแนกข้อความออกเป็นคุณลักษณะย่อย  7 ด้าน ประกอบด้วย ด้านที่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านไม่เป็นตนถือยศศักดิ์จำนวน 4 ด้าน และด้านที่ไม่สอดคล้อง 3 ด้าน

- **ด้านที่สอดคล้อง** ได้แก่
  
  - แสดงออก/พูดจาสุภาพ (ร้อยละ 65.8)

  - ให้เกียรติผู้อื่น (ร้อยละ 17.4)

  - รู้จักกาลเทศะ (ร้อยละ 6.7)


- **ด้านที่ไม่สอดคล้อง** ได้แก่ 

  - พูดจาหยาบคาย (ร้อยละ 7.2)

  - แสดงพฤติกรรมก้าวร้าว (ร้อยละ 2.9)
  
  - ใช้อำนาจข่มคนอื่น (ร้อยละ 0.1)

</div>

:::


::: {.column width="60%"}

<br>



```{r message = F, warning = F, echo = F}
score_phrase <- read_csv("01_data/score_data/score_item6.2_phrase.csv")
score_phrase <- score_phrase %>% 
  left_join(all_data %>% select(student_id, student_level) %>% 
  filter(is.na(student_id) == F),
  by = "student_id", keep = F) %>% 
  unique() 

library(rcartocolor)
# กำหนดว่าแต่ละ category เป็นบวกหรือลบ
positive_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(2:5) %>% 
  pull(category)
negative_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(1) %>% 
  pull(category)

thai_labels <- c(
 "สื่อสารอย่างตรงไปตรงมาและสุภาพ",          # Active_Communication
  "เสนอทางเลือกที่เหมาะสมต่อสถานการณ์",       # Adjust_and_Suggest
  "ตั้งขอบเขตที่เหมาะสมต่อสิ่งที่ไม่เหมาะสม",  # Boundary_Setting
  "แสดงออกอย่างเหมาะสมกับบริบทและโอกาส",       # Respectful_Performance
 "เพิกเฉยต่อส่ิงไม่เหมาะสม"
)

score_phrase %>% 
  count(category) %>% 
  mutate(prop = n / sum(n)) %>%
  mutate(category = factor(category, 
                      levels = c(positive_cats, negative_cats),
                      labels = thai_labels)) %>% 
  ggplot(aes(x = n, y = reorder(category, n), fill = category)) +
  geom_col()+
  geom_text(aes(x = n, label = scales::percent(prop, accuracy = 0.1)),
            hjust = -0.1, size = 5, family = "ChulaCharasNew") +
  scale_fill_manual(
    values = c(
      rep("#0f9d58",4),
      rep("#db4437",1)
    ))+
  theme_light()+
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.text = element_text(size = 16),
    text = element_text(family = "ChulaCharasNew", size = 18))+
  ylab("")+
  xlab("\n จำนวนข้อความ") +
  xlim(0,280)
```

:::

::::

## 2.3 รักชาติ ศาสน์ กษัตริย์ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r fig.width = 10, fig.height = 6, echo = F}
plot_pyramid_chart(score_phrase %>% select(-student_level), 
                   all_data,
                   legend_row = 2,
                   color_direction = 1,
                   positive_cats = positive_cats,
                   negative_cats = negative_cats,
                   thai_labels = thai_labels)
```

## 2.3 คุณลักษณะย่อยด้านรักชาติ ศาสน์ กษัตริย์ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}



```{r echo = F, eval = F, fig.width=8, fig.height=6}
positive_phrase <- score_phrase %>% 
  mutate(score = .pred_positive_behav_rf - .pred_negative_behav_rf) %>% 
  filter(score > 0.7) %>% 
  mutate(main_idea = purrr::map2_chr(phrase, category, summarize_main_idea_openai2)) 
write_excel_csv(positive_phrase, file = "01_data/score_data/nation_positive_phrase.csv")

negative_phrase <- score_phrase %>% 
  mutate(score = .pred_negative_behav_rf - .pred_positive_behav_rf) %>% 
  filter(score > 0.70) %>% 
  mutate(main_idea = purrr::map2_chr(phrase,category, summarize_main_idea_openai2))
write_excel_csv(negative_phrase, file = "01_data/score_data/nation_negative_phrase.csv")
```


```{r}
positive_phrase <- read_csv("01_data/score_data/nation_positive_phrase.csv")
negative_phrase <- read_csv("01_data/score_data/nation_negative_phrase.csv")

positive_phrase <- positive_phrase %>% 
  filter(!str_detect(main_idea, "น่าเบื่อ")) %>% 
  mutate(main_idea = ifelse(str_detect(main_idea, "ไม่เหมาะสม"), "แสดงให้เหมาะสม", main_idea))
set.seed(123)
p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:4],
    selected_categories = thai_labels[4],
  max_words = 300,
  color_palette = "Set2",
  reverse_colors = T
)
```

## 2.3 คุณลักษณะย่อยด้านรักชาติ ศาสน์ กษัตริย์ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:4],
    selected_categories = thai_labels[2],
  max_words = 300,
  color_palette = "Set2",
  reverse_colors = T
)
```

## 2.3 คุณลักษณะย่อยด้านรักชาติ ศาสน์ กษัตริย์ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:4],
    selected_categories = thai_labels[1],
  max_words = 300,
  color_palette = "Set2",
  reverse_colors = T
)
```

## 2.3 คุณลักษณะย่อยด้านรักชาติ ศาสน์ กษัตริย์ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
positive_phrase <- positive_phrase %>%
  mutate(ain_idea = ifelse(str_detect(main_idea, "ไม่ควร"), "ไม่ควรทำในงานเฉลิมพระเกียรติ", main_idea)) 

p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:4],
    selected_categories = thai_labels[3],
  max_words = 300,
  color_palette = "Set2",
  reverse_colors = T
)
```

## 2.3 คุณลักษณะย่อยด้านรักชาติ ศาสน์ กษัตริย์ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}

negative_phrase <- negative_phrase %>% 
  filter(!str_detect(main_idea ,"ทำให้ดีที่สุด")) %>% 
  filter(!str_detect(main_idea ,"ทำเต็มที่")) %>% 
  filter(!str_detect(main_idea ,"ไม่"))

p<-plot_category_wordclouds(
    phrase_data = negative_phrase,
    categories_filter = negative_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[5],
    selected_categories = thai_labels[5],
  max_words = 300,
  color_palette = "Set1",
  reverse_colors = T
)
```

# 3. ผลการวิเคราะห์คุณลักษณะอันพึงประสงค์ตามหลักสูตรแกนกลางที่รับผิดชอบโดยฝ่ายกิจการนักเรียน


## คะแนนคุณลักษณะอันพึงประสงค์ตามหลักสูตรแกนกลางที่รับผิดชอบโดยฝ่ายกิจการนักเรียน (1) {.smaller}


เมื่อพิจารณาคุณลักษณะอันพึงประสงค์ตามพระราโชบายของรัชกาลที่ 6 จำนวน 13 ด้าน พบว่าทุกด้านมีค่ามัธยฐานสูงกว่าคะแนนจุดตัดที่ 0.45 คะแนนทั้งหมด บ่งชี้ว่าพฤติกรรมการแสดงออกของนักเรียนส่วนใหญ่มีแนวโน้มสอดคล้องกับคุณลักษณะอันพึงประสงค์ตามพระราโชบายของรัชกาลที่ 6

เมื่อพิจารณาจากมัธยฐานพบว่า ด้านที่นักเรียนแสดงออกอย่างสอดคล้องมากที่สุดได้แก่

- รู้จักตรากตรำ (Med = 0.89, QD = 0.05)

- ไม่สำรวยหยิบโหย่ง (Med = 0.86, QD = 0.08) และไม่ทำตนเป็นคนถือยศศักดิ์ (Med = 0.86, QD = 0.06) 

ด้านที่มีมัธยฐานต่ำที่สุดคือด้านศีลธรรม (Med = 0.64, QD = 0.79) นอกจากนี้ยังมีข้อสังเกตว่าคะแนนด้านศีลธรรมเป็นด้่านที่มีการกระจายสูงมากที่สุด บ่งชี้ว่ามีนักเรียนบางกลุ่มที่มีแนวโน้มแสดงออกไม่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านศีลธรรม

## คะแนนคุณลักษณะอันพึงประสงค์ตามหลักสูตรแกนกลางที่รับผิดชอบโดยฝ่ายกิจการนักเรียน (2) {.smaller}



```{r}
score_longformat_student %>% 
  mutate(attribute = as.character(attribute)) %>% 
  group_by(attribute) %>% 
  summarise(
    n = n(),
    median = median(score_value, na.rm = TRUE),
    qd = IQR(score_value, na.rm = TRUE)/2,
    avg = mean(score_value, na.rm = TRUE),
    sd = sd(score_value, na.rm = TRUE),
    min = min(score_value, na.rm = TRUE),
    q1 = quantile(score_value, 0.25, na.rm = TRUE),
    q3 = quantile(score_value, 0.75, na.rm = TRUE),
    max = max(score_value, na.rm = TRUE)
  ) %>% 
  arrange(desc(median)) %>%
  gt() %>% 
  cols_label(attribute = "คุณลักษณะอันพึงประสงค์",
             median = "Med",
             qd = "QD",
             avg = "M",
             sd = "SD",
             min = "Min",
             q1 = "Q1",
             q3 = "Q3",
             max = "Max") %>% 
  cols_align(align = "left", columns = attribute) %>%
  fmt_number(columns = everything(),
             decimals = 2) %>%
  tab_options(table.font.size = 12,
              table.width = pct(100),
              column_labels.font.weight = "bold",
              column_labels.font.size = 18,
              table.border.top.style = "solid",
              table.border.bottom.style = "solid",
              table.border.top.color = "black",
              table.border.bottom.color = "black") %>% 
  tab_style(
    style = cell_text(font = "ChulaCharasNew"),
    locations = cells_column_labels()
  )
```


 
## คะแนนคุณลักษณะอันพึงประสงค์ตามหลักสูตรแกนกลางที่รับผิดชอบโดยฝ่ายกิจการนักเรียน (3) {.smaller}


```{r fig.height = 5}
score_longformat_student %>% 
  mutate(attribute = as.character(attribute)) %>% 
  mutate(attribute = fct_reorder(attribute, score_value, .fun = mean, .na_rm = TRUE)) %>% 
  ggplot(aes(x = score_value, y = attribute)) +
  geom_boxplot(fill = "#f4b400", outlier.alpha = 0) +
  geom_jitter(height = 0.1, alpha = 0.1)+
  geom_vline(xintercept = c(-0.37, 0.45), linetype = 2, color = "grey50")+
  ylab("")+
  xlab("\n คะแนนคุณลักษณะอันพึงประสงค์") +
  theme_light()+
  theme(text = element_text(family = "ChulaCharasNew"),
        panel.grid = element_blank(),
        axis.text = element_text(size = 14),
        axis.title.x = element_text(size = 15))
```



## สัดส่วนของนักเรียนจำแนกตามความสอดคล้องกับคุณลักษณะอันพึงประสงค์ตามหลักสูตรแกนกลางที่รับผิดชอบโดยฝ่ายกิจการนักเรียน {.smaller}


```{r fig.height = 5}
library(rcartocolor)
score_longformat_student %>% 
 mutate(attribute = as.character(attribute)) %>% 
  mutate(class = case_when(
    score_value > 0.45 ~ "สอดคล้อง",
    score_value < -0.37 ~ "ไม่สอดคล้อง",
    TRUE ~ "ไม่ขัดเจน/หลากหลาย"
  )) %>% 
  mutate(class = fct_relevel(class, "สอดคล้อง", "ไม่ขัดเจน/หลากหลาย", "ไม่สอดคล้อง")) %>%
  
  # 1. คำนวณสัดส่วนแต่ละ class
  count(attribute, class) %>%
  group_by(attribute) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup() %>%
  
  # 2. หาค่าที่เป็น prop ของ "สอดคล้อง" เพื่อนำไปจัดลำดับ
  group_by(attribute) %>%
  mutate(prop_green = prop[class == "สอดคล้อง"]) %>%
  ungroup() %>%
  
  # 3. จัดลำดับ attribute ใหม่
  mutate(attribute = fct_reorder(attribute, prop_green)) %>%
  
  # 4. ใส่ label เฉพาะ "สอดคล้อง"
  mutate(label = ifelse(class == "สอดคล้อง", scales::percent(prop, accuracy = 1), NA)) %>%
  
  ggplot(aes(y = attribute, x = prop, fill = class)) +
  geom_col(position = "fill") +
  geom_text(
    aes(label = label),
    position = position_fill(vjust = 0.5),
    family = "ChulaCharasNew",
    fontface = "bold",
    size = 5,
    na.rm = TRUE,
    col = "white"
  ) +
  scale_fill_manual(values = c(
    "สอดคล้อง" = "#0f9d58", 
    "ไม่ขัดเจน/หลากหลาย" = "#f4b400", 
    "ไม่สอดคล้อง" = "#db4437"
  )) +
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(x = "\nสัดส่วนของนักเรียน", y = "", fill = "") +
  theme_light() +
  theme(
    panel.grid = element_blank(),
    text = element_text(family = "ChulaCharasNew", size = 14),
    axis.text = element_text(size = 14),
    axis.title.x = element_text(size = 15),
    legend.position = "top"
  ) +
  guides(fill = guide_legend(reverse = TRUE))
```




## 3.1 มีร่างกายและจิตใจเข้มแข็ง : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


<div style = "font-size:75%;">

- ผู้วิจัยคัดกรองข้อความที่มีความสอดคล้อง/ไม่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านรู้จักตรากตรำ โดยใช้คะแนนจุดตัดเป็นเกณฑ์  จากนั้นใช้โมเดลภาษาขนาดใหญ่ช่วยระบุคุณลักษณะย่อยของพฤติกรรมที่แสดงออกในแต่ละข้อความ

</div>

:::: {.columns}

::: {.column width="40%"}

<div style = "font-size:75%;">

- จำแนกข้อความออกเป็นคุณลักษณะย่อย  7 ด้าน ประกอบด้วย ด้านที่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านไม่เป็นตนถือยศศักดิ์จำนวน 4 ด้าน และด้านที่ไม่สอดคล้อง 3 ด้าน

- **ด้านที่สอดคล้อง** ได้แก่
  
  - แสดงออก/พูดจาสุภาพ (ร้อยละ 65.8)

  - ให้เกียรติผู้อื่น (ร้อยละ 17.4)

  - รู้จักกาลเทศะ (ร้อยละ 6.7)


- **ด้านที่ไม่สอดคล้อง** ได้แก่ 

  - พูดจาหยาบคาย (ร้อยละ 7.2)

  - แสดงพฤติกรรมก้าวร้าว (ร้อยละ 2.9)
  
  - ใช้อำนาจข่มคนอื่น (ร้อยละ 0.1)

</div>

:::


::: {.column width="60%"}

<br>



```{r message = F, warning = F, echo = F}
score_phrase <- read_csv("01_data/score_data/score_item5.3_phrase.csv")
score_phrase <- score_phrase %>% 
  left_join(all_data %>% select(student_id, student_level) %>% 
  filter(is.na(student_id) == F),
  by = "student_id", keep = F) %>% 
  unique() 

library(rcartocolor)
# กำหนดว่าแต่ละ category เป็นบวกหรือลบ
positive_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(2:4) %>% 
  pull(category)
negative_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(1) %>% 
  pull(category)

thai_labels <- c(
  "มีความยืดหยุ่นทางอารมณ์",   # Emotional_Resilience
  "ดูแลสุขภาพสม่ำเสมอ",                     # Healthy_Routine
  "รู้วิธีฟื้นฟูจิตใจ",         # Mental_Recovery
  "พฤติกรรมหลีกเลี่ยง"
)

score_phrase %>% 
  count(category) %>% 
  mutate(prop = n / sum(n)) %>%
  mutate(category = factor(category, 
                      levels = c(positive_cats, negative_cats),
                      labels = thai_labels)) %>% 
  ggplot(aes(x = n, y = reorder(category, n), fill = category)) +
  geom_col()+
  geom_text(aes(x = n, label = scales::percent(prop, accuracy = 0.1)),
            hjust = -0.1, size = 5, family = "ChulaCharasNew") +
  scale_fill_manual(
    values = c(
      rep("#0f9d58",3),
      rep("#db4437",1)
    ))+
  theme_light()+
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.text = element_text(size = 16),
    text = element_text(family = "ChulaCharasNew", size = 18))+
  ylab("")+
  xlab("\n จำนวนข้อความ") +
  xlim(0,400)
```

:::

::::


## 3.1 มีร่างกายและจิตใจเข้มแข็ง : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r fig.width = 10, fig.height = 6, echo = F}
plot_pyramid_chart(score_phrase %>% select(-student_level), 
                   all_data,
                   legend_row = 2,
                   color_direction = 1,
                   positive_cats = positive_cats,
                   negative_cats = negative_cats,
                   thai_labels = thai_labels)
```

## 3.1 คุณลักษณะย่อยด้านมีร่างกายและจิตใจเข้มแข็ง : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}



```{r echo = F, eval = F, fig.width=8, fig.height=6}
positive_phrase <- score_phrase %>% 
  mutate(score = .pred_positive_behav_rf - .pred_negative_behav_rf) %>% 
  filter(score > 0.85) %>% 
  mutate(main_idea = purrr::map2_chr(phrase, category, summarize_main_idea_openai2)) 
write_excel_csv(positive_phrase, file = "01_data/score_data/strong_positive_phrase.csv")

negative_phrase <- score_phrase %>% 
  mutate(score = .pred_negative_behav_rf - .pred_positive_behav_rf) %>% 
  filter(score > 0.70) %>% 
  mutate(main_idea = purrr::map2_chr(phrase,category, summarize_main_idea_openai2))
write_excel_csv(negative_phrase, file = "01_data/score_data/strong_negative_phrase.csv")
```


```{r}
positive_phrase <- read_csv("01_data/score_data/strong_positive_phrase.csv")
negative_phrase <- read_csv("01_data/score_data/strong_negative_phrase.csv")


set.seed(123)
p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:3],
    selected_categories = thai_labels[3],
  max_words = 300,
  color_palette = "Set2",
  reverse_colors = T
)
```
## 3.1 คุณลักษณะย่อยด้านมีร่างกายและจิตใจเข้มแข็ง : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
set.seed(123)
positive_phrase <- positive_phrase %>%
  mutate(main_idea = ifelse(str_detect(main_idea, "กีฬา"), "เล่นกีฬา", main_idea)) %>%
  mutate(main_idea = ifelse(str_detect(main_idea, "ออกกำลังกาย"), "ออกกำลังกาย", main_idea)) %>% 
  mutate(main_idea = ifelse(str_detect(main_idea, "กิน"), "กินอาหารที่มีประโยชน์", main_idea)) %>% 
  filter(!str_detect(main_idea, "เจตนา"))

p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:3],
    selected_categories = thai_labels[2],
  max_words = 300,
  color_palette = "Set2",
  reverse_colors = T
)
```
## 3.1 คุณลักษณะย่อยด้านมีร่างกายและจิตใจเข้มแข็ง : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
set.seed(123)
p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:3],
    selected_categories = thai_labels[1],
  max_words = 300,
  color_palette = "Set2",
  reverse_colors = T
)
```

## 3.1 คุณลักษณะย่อยด้านมีร่างกายและจิตใจเข้มแข็ง : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
negative_phrase <- negative_phrase %>% 
  filter(!str_detect(main_idea, "ช่วยเพื่อนทำ")) %>% 
  filter(!str_detect(main_idea, "จัดเวลา")) %>% 
  filter(!str_detect(main_idea, "ลดเล่นเกม")) %>% 
  filter(!str_detect(main_idea, "ไม่ส่งผลดี"))

set.seed(123)
p<-plot_category_wordclouds(
    phrase_data = negative_phrase,
    categories_filter = negative_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[4],
    selected_categories = thai_labels[4],
  max_words = 300,
  color_palette = "Set1",
  reverse_colors = T
)
```


## 3.2 มีความรับผิดชอบ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


<div style = "font-size:75%;">

- ผู้วิจัยคัดกรองข้อความที่มีความสอดคล้อง/ไม่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านรู้จักตรากตรำ โดยใช้คะแนนจุดตัดเป็นเกณฑ์  จากนั้นใช้โมเดลภาษาขนาดใหญ่ช่วยระบุคุณลักษณะย่อยของพฤติกรรมที่แสดงออกในแต่ละข้อความ

</div>

:::: {.columns}

::: {.column width="40%"}

<div style = "font-size:75%;">

- จำแนกข้อความออกเป็นคุณลักษณะย่อย  7 ด้าน ประกอบด้วย ด้านที่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านไม่เป็นตนถือยศศักดิ์จำนวน 4 ด้าน และด้านที่ไม่สอดคล้อง 3 ด้าน

- **ด้านที่สอดคล้อง** ได้แก่
  
  - แสดงออก/พูดจาสุภาพ (ร้อยละ 65.8)

  - ให้เกียรติผู้อื่น (ร้อยละ 17.4)

  - รู้จักกาลเทศะ (ร้อยละ 6.7)


- **ด้านที่ไม่สอดคล้อง** ได้แก่ 

  - พูดจาหยาบคาย (ร้อยละ 7.2)

  - แสดงพฤติกรรมก้าวร้าว (ร้อยละ 2.9)
  
  - ใช้อำนาจข่มคนอื่น (ร้อยละ 0.1)

</div>

:::


::: {.column width="60%"}

<br>



```{r message = F, warning = F, echo = F}
score_phrase <- read_csv("01_data/score_data/score_item5.2_phrase.csv")
score_phrase <- score_phrase %>% 
  left_join(all_data %>% select(student_id, student_level) %>% 
  filter(is.na(student_id) == F),
  by = "student_id", keep = F) %>% 
  unique() 

library(rcartocolor)
# กำหนดว่าแต่ละ category เป็นบวกหรือลบ
positive_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(2:4) %>% 
  pull(category)
negative_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(1) %>% 
  pull(category)

thai_labels <- c(
 "พยายามอย่างสม่ำเสมอ",
  "ตระหนักในหน้าที่",
  "แก้ปัญหาด้วยความรับผิดชอบ",
 "หลีกเลี่ยงหน้าที่"
)

score_phrase %>% 
  count(category) %>% 
  mutate(prop = n / sum(n)) %>%
  mutate(category = factor(category, 
                      levels = c(positive_cats, negative_cats),
                      labels = thai_labels)) %>% 
  ggplot(aes(x = n, y = reorder(category, n), fill = category)) +
  geom_col()+
  geom_text(aes(x = n, label = scales::percent(prop, accuracy = 0.1)),
            hjust = -0.1, size = 5, family = "ChulaCharasNew") +
  scale_fill_manual(
    values = c(
      rep("#0f9d58",3),
      rep("#db4437",1)
    ))+
  theme_light()+
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.text = element_text(size = 16),
    text = element_text(family = "ChulaCharasNew", size = 18))+
  ylab("")+
  xlab("\n จำนวนข้อความ") +
  xlim(0,450)
```


:::

::::


## 3.2 มีความรับผิดชอบ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r fig.width = 10, fig.height = 6, echo = F}
plot_pyramid_chart(score_phrase %>% select(-student_level), 
                   all_data,
                   legend_row = 2,
                   color_direction = 1,
                   positive_cats = positive_cats,
                   negative_cats = negative_cats,
                   thai_labels = thai_labels)
```



## 3.2 คุณลักษณะย่อยด้านมีความรับผิดชอบ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r echo = F, eval = F, fig.width=8, fig.height=6}
positive_phrase <- score_phrase %>% 
  mutate(score = .pred_positive_behav_rf - .pred_negative_behav_rf) %>% 
  filter(score > 0.85) %>% 
  mutate(main_idea = purrr::map2_chr(phrase, category, summarize_main_idea_openai2)) 
write_excel_csv(positive_phrase, file = "01_data/score_data/responsible_positive_phrase.csv")

negative_phrase <- score_phrase %>% 
  mutate(score = .pred_negative_behav_rf - .pred_positive_behav_rf) %>% 
  filter(score > 0.70) %>% 
  mutate(main_idea = purrr::map2_chr(phrase,category, summarize_main_idea_openai2))
write_excel_csv(negative_phrase, file = "01_data/score_data/responsible_negative_phrase.csv")
```


```{r}
positive_phrase <- read_csv("01_data/score_data/responsible_positive_phrase.csv")
negative_phrase <- read_csv("01_data/score_data/responsible_negative_phrase.csv")

positive_phrase <- positive_phrase  %>% 
  filter(!str_detect(category, "Avoidant_Delegation"))

set.seed(123)
p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:3],
    selected_categories = thai_labels[3],
  max_words = 300,
  color_palette = "Set2",
  reverse_colors = T
)
```


## 3.2 คุณลักษณะย่อยด้านมีความรับผิดชอบ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
set.seed(123)
p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:3],
    selected_categories = thai_labels[2],
  max_words = 300,
  color_palette = "Set2",
  reverse_colors = T
)
```


## 3.2 คุณลักษณะย่อยด้านมีความรับผิดชอบ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
set.seed(123)
p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:3],
    selected_categories = thai_labels[1],
  max_words = 300,
  color_palette = "Set2",
  reverse_colors = T
)
```



## 3.2 คุณลักษณะย่อยด้านมีความรับผิดชอบ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
set.seed(123)

negative_phrase <- negative_phrase %>% 
  filter(!str_detect(main_idea, "ช่วย")) %>% 
  filter(!str_detect(main_idea, "ไม่โทษตัวเอง"))

p<-plot_category_wordclouds(
    phrase_data = negative_phrase,
    categories_filter = negative_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[4],
    selected_categories = thai_labels[4],
  max_words = 300,
  color_palette = "Set1",
  reverse_colors = T
)
```


## 3.3 มีความคิดสร้างสรรค์ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


<div style = "font-size:75%;">

- ผู้วิจัยคัดกรองข้อความที่มีความสอดคล้อง/ไม่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านรู้จักตรากตรำ โดยใช้คะแนนจุดตัดเป็นเกณฑ์  จากนั้นใช้โมเดลภาษาขนาดใหญ่ช่วยระบุคุณลักษณะย่อยของพฤติกรรมที่แสดงออกในแต่ละข้อความ

</div>

:::: {.columns}

::: {.column width="40%"}

<div style = "font-size:75%;">

- จำแนกข้อความออกเป็นคุณลักษณะย่อย  7 ด้าน ประกอบด้วย ด้านที่สอดคล้องกับคุณลักษณะอันพึงประสงค์ด้านไม่เป็นตนถือยศศักดิ์จำนวน 4 ด้าน และด้านที่ไม่สอดคล้อง 3 ด้าน

- **ด้านที่สอดคล้อง** ได้แก่
  
  - แสดงออก/พูดจาสุภาพ (ร้อยละ 65.8)

  - ให้เกียรติผู้อื่น (ร้อยละ 17.4)

  - รู้จักกาลเทศะ (ร้อยละ 6.7)


- **ด้านที่ไม่สอดคล้อง** ได้แก่ 

  - พูดจาหยาบคาย (ร้อยละ 7.2)

  - แสดงพฤติกรรมก้าวร้าว (ร้อยละ 2.9)
  
  - ใช้อำนาจข่มคนอื่น (ร้อยละ 0.1)

</div>

:::


::: {.column width="60%"}

<br>



```{r message = F, warning = F, echo = F}
score_phrase <- read_csv("01_data/score_data/score_item4.3_phrase.csv")
score_phrase <- score_phrase %>% 
  left_join(all_data %>% select(student_id, student_level) %>% 
  filter(is.na(student_id) == F),
  by = "student_id", keep = F) %>% 
  unique() %>% 
  mutate(category = ifelse(category == "Strategic_Presentation", "Persuasive_Reasoning", category))

library(rcartocolor)
# กำหนดว่าแต่ละ category เป็นบวกหรือลบ
positive_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(3:5) %>% 
  pull(category)
negative_cats <- score_phrase %>% 
  count(category_use,category) %>% 
  slice(1:2) %>% 
  pull(category)

thai_labels <- c(
  "ร่วมกันสร้างสรรค์ผลงาน",
  "กล้าเสนอไอเดียอย่างสร้างสรรค์",
  "อธิบายเหตุผลชวนให้เพื่อนคล้อยตาม",
"ไม่เสนอแนวคิดใหม่",
  "ยอมตามโดยไม่แสดงความเห็น"  
)

score_phrase %>% 
  count(category) %>% 
  mutate(prop = n / sum(n)) %>%
  mutate(category = factor(category, 
                      levels = c(positive_cats, negative_cats),
                      labels = thai_labels)) %>% 
  ggplot(aes(x = n, y = reorder(category, n), fill = category)) +
  geom_col()+
  geom_text(aes(x = n, label = scales::percent(prop, accuracy = 0.1)),
            hjust = -0.1, size = 5, family = "ChulaCharasNew") +
  scale_fill_manual(
    values = c(
      rep("#0f9d58",3),
      rep("#db4437",2)
    ))+
  theme_light()+
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.text = element_text(size = 16),
    text = element_text(family = "ChulaCharasNew", size = 18))+
  ylab("")+
  xlab("\n จำนวนข้อความ") +
  xlim(0,450)
```

:::

::::

## 3.3 มีความคิดสร้างสรรค์ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r fig.width = 10, fig.height = 6, echo = F}
plot_pyramid_chart(score_phrase %>% select(-student_level), 
                   all_data,
                   legend_row = 2,
                   color_direction = 1,
                   positive_cats = positive_cats,
                   negative_cats = negative_cats,
                   thai_labels = thai_labels)
```


## 3.3 คุณลักษณะย่อยด้านมีความคิดสร้างสรรค์ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r echo = F, eval = F, fig.width=8, fig.height=6}
positive_phrase <- score_phrase %>% 
  mutate(score = .pred_positive_behav_rf - .pred_negative_behav_rf) %>% 
  filter(score > 0.85) %>% 
  mutate(main_idea = purrr::map2_chr(phrase, category, summarize_main_idea_openai2)) 
write_excel_csv(positive_phrase, file = "01_data/score_data/creative_positive_phrase.csv")

negative_phrase <- score_phrase %>% 
  mutate(score = .pred_negative_behav_rf - .pred_positive_behav_rf) %>% 
  filter(score > 0.70) %>% 
  mutate(main_idea = purrr::map2_chr(phrase,category, summarize_main_idea_openai2))
write_excel_csv(negative_phrase, file = "01_data/score_data/creative_negative_phrase.csv")
```


```{r}
positive_phrase <- read_csv("01_data/score_data/creative_positive_phrase.csv")
negative_phrase <- read_csv("01_data/score_data/creative_negative_phrase.csv")


positive_phrase <- positive_phrase %>% 
  mutate(category = ifelse(category == "Strategic_Presentation", "Persuasive_Reasoning", category))

set.seed(123)
p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:3],
    selected_categories = thai_labels[3],
  max_words = 300,
  color_palette = "Set2",
  reverse_colors = T
)
```

## 3.3 คุณลักษณะย่อยด้านมีความคิดสร้างสรรค์ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
set.seed(123)
p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:3],
    selected_categories = thai_labels[2],
  max_words = 300,
  color_palette = "Set2",
  reverse_colors = T
)
```

## 3.3 คุณลักษณะย่อยด้านมีความคิดสร้างสรรค์ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}

```{r}
set.seed(123)
p<-plot_category_wordclouds(
    phrase_data = positive_phrase,
    categories_filter = positive_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[1:3],
    selected_categories = thai_labels[1],
  max_words = 300,
  color_palette = "Set2",
  reverse_colors = T
)
```


## 3.3 คุณลักษณะย่อยด้านมีความคิดสร้างสรรค์ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r}
set.seed(123)

p<-plot_category_wordclouds(
    phrase_data = negative_phrase,
    categories_filter = negative_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[4:5],
    selected_categories = thai_labels[5],
  max_words = 300,
  color_palette = "Set1",
  reverse_colors = F
)
```


## 3.3 คุณลักษณะย่อยด้านมีความคิดสร้างสรรค์ : ผลการวิเคราะห์ลักษณะของพฤติกรรมจากข้อความของนักเรียน {.smaller}


```{r}
set.seed(123)

negative_phrase <- negative_phrase %>% 
  filter(!str_detect(main_idea, "ทำอย่างอื่นบ้าง")) %>% 
  filter(!str_detect(main_idea, "คิดซ้ำซาก")) %>% 
  filter(!str_detect(main_idea, "บอล"))
 
p<-plot_category_wordclouds(
    phrase_data = negative_phrase,
    categories_filter = negative_phrase %>% 
      count(category) %>% pull(category),
    category_labels = thai_labels[4:5],
    selected_categories = thai_labels[4],
  max_words = 300,
  color_palette = "Set1",
  reverse_colors = F
)
```

