{
  "hash": "614cc926cfada7deba10e7aae737c62b",
  "result": {
    "engine": "knitr",
    "markdown": "---\ndate: \"2024-10-09\"\ntitle: \"Missing Value Analysis\"\ncategories:\n  - Machine Learning\n  - Missing Values\n  - R Programming\nimage: img/missing_value.png\nmessage: false\nwarning: false\nhighlight: atom\nbibliography: reference.bib \n---\n\n\n\n\n## ค่าสูญหาย\n\nค่าสูญหาย (missing values) เป็นปัญหาทั่วไปที่มักพบได้เสมอในการวิเคราะห์ข้อมูล โดยเป็นสถานการณ์ที่ค่าสังเกตของตัวแปรบางตัว หรือหน่วยข้อมูลบางหน่วยมีการขาดหายไปจากชุดข้อมูล ซึ่งทำให้ชุดข้อมูลดังกล่าวไม่ได้มีข้อมูลที่ครบถ้วนสมบูรณ์\n\nอัลกอริทึมและโมเดลการวิเคราะห์ข้อมูลส่วนใหญ่มักมีข้อสมมุตินึงที่ผู้สอนส่วนใหญ่ก็มักไม่ได้กล่าวถึงคือ ข้อมูลที่นำมาวิเคราะห์จะต้องเป็นข้อมูลที่ไม่มีค่าสูญหาย (เรียกว่า complete data) อย่างไรก็ตามหากมองย้อนตอนที่เราวิเคราะห์ข้อมูลจริง ๆ มีโอกาสน้อยมากที่เราจะพบกับ complete data ดังกล่าว\n\nกระบวนการปกติที่เรามักใช้ในการจัดการข้อมูลสูญหายคือ\n\n1. ลบหน่วยข้อมูลที่มีค่าสูญหายออกไปจากการวิเคราะห์ (listwise deletion)\n\n2. แทนค่าสูญหายด้วยค่าที่เหมาะสม\n\nทั้งสองวิธีการผลลัพธ์สุดท้ายที่ได้คือข้อมูลสมบูรณ์เหมือนกัน แต่ในหลายกรณีให้ผลลัพธ์ที่แตกต่างกัน และมีประสิทธิภาพที่แตกต่างกันด้วย\n\n\nถึงแม้ค่าสูญหายจะเหมือนเป็นปัญหาทั่วไปแต่ในหลายกรณีเมื่อมีค่าสูญหายเกิดขึ้นการตัดสินใจและดำเนินการที่ไม่เหมาะสมของผู้วิเคราะห์ล้วนมีแนวโน้มส่งผลกระทบเชิงลบต่อโมเดลการวิเคราะห์ไม่มากก็น้อย ผลกระทบดังกล่าวทำให้ความแม่นยำและความน่าเชื่อถือของผลการวิเคราะห์ลดน้อยลง  การสำรวจ วิเคราะห์ และแก้ไขปัญหาค่าสูญหายจึงเป็นขั้นตอนจำเป็นที่ผู้วิเคราะห์จะต้องดำเนินการอย่างระมัดระวัง\n\n## สาเหตุของการสูญหายของข้อมูล\n\nการสูญหายของข้อมูลเป็นไปได้จากสาเหตุที่หลากหลาย ขึ้นอยู่กับบริบทหรือวิธีการเก็บรวบรวมข้อมูลที่ผู้วิจัยใช้ด้วย โดยอาจแจกแจงสาเหตุการสูญหายของข้อมูลได้ดังนี้\n\n### 1. ผู้ให้ข้อมูลหรือการวัดค่าสังเกต\n\nเป็นไปได้หลากหลายลักษณะ เช่น ในการวิจัยเชิงสำรวจที่มีการเก็บรวบรวมข้อมูลด้วยแบบสอบถามหรือแบบวัด มีความเป็นไปได้ที่ผู้ตอบอาจลืมตอบคำถามในบางข้อ หรือเลือกที่จะไม่ตอบเพราะไม่มีความรู้ หรือไม่สนใจที่จะให้ข้อมูล หรืออาจมีความสะดวกในการตอบคำถาม ปัจจัยดังกล่าวล้วนเป็นสาเหตุที่ทำให้เกิดค่าสูญหายทั้งสิ้น\n\nความผิดพลาดของอุปกรณ์วัดก็เป็นปัจจัยในด้านนี้ด้วย เช่น ผู้วิจัยอาจเลือกใช้ smart watch เป็นเครื่องมือในการวัดชีพจร และตัวชี้วัดทางกายภาพของผู้เรียนระหว่างการจัดการเรียนรู้ อาจมีความเป็นไปได้ที่ผู้เรียนบางคนไม่ได้ใส่อุปกรณ์อย่างถูกต้อง หรืออุปกรณ์ทำงานผิดพลาดจากสาเหตุอื่น ๆ ทำให้ไม่สามารถเก็บรวบรวมข้อมูลได้อย่างครบถ้วน\n\nอีกลักษณะหนึ่งคือการขาดหายไปจากการที่หน่วยข้อมูลบางหน่วยไม่ได้เข้าร่วมกิจกรรมที่กำหนดไว้สำหรับการเก็บรวบรวมข้อมูล เช่น การออกแบบการเก็บรวบรวมข้อมูลในชั้นเรียน หรือเป็นการบ้านให้กับนักเรียน แต่อาจมีนักเรียนบางคนที่ไม่ได้เข้าเรียนในวันดังกล่าว หรือไม่ส่งการบ้าน สถานการณ์ดังกล่าวทำให้เกิดค่าสูญหายได้เช่นเดียวกัน\n\n### 2. การยุบรวมข้อมูลจากแหล่งข้อมูลที่หลากหลาย \n\nการเก็บข้อมูลจากฐานข้อมูลของหน่วยงานต่าง ๆ เช่น สพฐ. สทศ. สมศ. รวมทั้งหน่วยงานภาครัฐอื่น ๆ แล้วนำมารวมกันเพื่อดำเนินการวิเคราะห์ ก็มีโอกาสที่บางหน่วยข้อมูลขาดหายไปเนื่องจากความแตกต่างของการเก็บข้อมูลในแต่ละฐาน\n\n### 3. การเก็บรวบรวมข้อมูลระยะยาว\n\nการเก็บรวบรวมข้อมูลระยะยาวที่จะต้องเก็บข้อมูลจากหน่วยข้อมูลเดียวกันหลาย ๆ ครั้ง หากระหว่างทางมีหน่วยข้อมูลออกจากระบบก็เกิดข้อมูลขาดหายได้เช่นกัน\n\n\n## ประเภทของค่าสูญหาย\n\nการจำแนกประเภทของค่าสูญหายสามารถจำแนกได้หลายลักษณะ ขึ้นกับบริบทที่ทำการวิเคราะห์ค่าสูญหาย หรือเกณฑ์ที่ใช้ในการพิจารณา โดยทั่วไปอาจจำแนกค่าสูญหายออกเป็น 3 ประเภท ได้แก่ ข้อมูลสูญหายที่เกิดจาก\n\n1. การออกแบบการเก็บข้อมูลที่ไม่เหมาะสม\n\n2. ปรากฏการณ์สุ่ม\n\n3. สาเหตุเฉพาะ\n\n### การสูญหายจากการออกแบบการเก็บข้อมูลที่ไม่เหมาะสม\n\nลักษณะการสูญหายประเภทแรกสามารถเกิดได้ กล่าวคือผู้วิเคราะห์อาจมีการออกแบบการเก็บรวบรวมข้อมูลที่ไม่สอดคล้องกับสถานการณ์จริง ทำให้บางหน่วยข้อมูลถูกบันทึกเป็นค่าสูญหายแต่ในความเป็นจริงหน่วยข้อมูลดังกล่าวควรสามารถบันทึกข้อมูลได้ ยกตัวอย่างเช่น การวิเคราะห์การเรียนรู้ของนักเรียนาอาจมีการออกแบบการเก็บรวบรวมข้อมูลการมาเรียนของนักเรียน โดยมีการบันทึกข้อมูลไว้ 2 ลักษณะ ได้แก่ มาเรียนตรงเวลา (`ontime`) และมาเรียนสาย (`late`) แต่เมื่อเก็บรวบรวมข้อมูลเสร็จพบว่ามีนักเรียนบางคนไม่มีข้อมูลในตัวแปรนี้\n\nเมื่อพิจารณาเพิ่มเติมพบว่า นักเรียนกลุ่มที่ไม่มีข้อมูลในตัวแปรดังกล่าว คือกลุ่มนักเรียนที่ไม่ได้มาเรียนในวันนั้นทำให้ไม่สามารถระบุได้ว่ามาตรงเวลาหรือมาสาย สถานการณ์ดังกล่าวผู้วิเคราะห์สามารถแก้ปัญหาโดยปรับโครงสร้างการเก็บค่าของตัวแปรนี้ใหม่ โดยอาจเพิ่มกลุ่มนักเรียนที่ไม่ได้มาเรียน (`absent`) เป็นค่าที่เป็นไปได้ของตัวแปรนี้อีกหนึ่งค่า ซึ่งจะทำให้ผู้วิเคราะห์มีข้อมูลที่สมบูรณ์ของตัวแปรนี้\n\n### การสูญหายจากปรากฏการณ์สุ่ม\n\nการสูญหายในลักษณะที่สองคือการสูญหายจากปรากฏการณ์สุ่ม เรียกได้ว่าเป็นการสูญหายในเชิงสถิติ [@little2014statistical] โดยสามารถจำแนกได้เป็น 2 ประเภทได้แก่\n\n**การสูญหายแบบสุ่มสมบูรณ์ (missing completely at random: MCAR)**\n\n\nกล่าวคือ ถ้าการมีอยู่ของข้อมูลที่ขาดหายไปในตัวแปรหนึ่ง ๆ ไม่มีความสัมพันธ์กับตัวแปรอื่น ๆ ที่สังเกตเห็นหรือไม่ได้สังเกตเห็น ข้อมูลนั้นจะถือว่าขาดหายไปแบบสุ่มโดยสมบูรณ์ กลไกการสูญหายแบบ MCAR สามารถอธิบายในเชิงคณิตศาสตร์ได้ดังนี้\n\nกำหนดให้ $m_{ij}$ เป็นตัวแปร dummy แสดงการสูญหายของหน่วยข้อมูลที่ i ในตัวแปรที่ j ถ้ามีค่าเท่ากับ 1 คือเป็นค่าสูญหาย และ $X_{obs}$ คือข้อมูลที่ผู้วิเคราะห์สามารถสังเกตได้ในชุดข้อมูล ส่วน $X_{mis}$ คือข้อมูลที่สูญหาย กลไกลการสูญหายแบบ MCAR คือความน่าจะเป็นในการสูญหายของหน่วยข้อมูลที่ $i$ ในตัวแปรที่ $j$ เป็นค่าคงที่ ที่ไม่สัมพันธ์หรือขึ้นกับข้อมูลที่สังเกตได้และข้อมูลสูญหาย ดังนี้\n\n$$\np(m_{ij} = 1 | X_{obs}, X_{mis}) = p\n$$\n\nการ simulation ด้านล่างแสดงกลไกการเกิดค่าสูญหายแบบ MCAR ได้อย่างชัดเจน\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n## ชุดข้อมูลสมบูรณ์\ndata <- read_csv(\"/Users/choat/Downloads/exam.csv\")\nglimpse(data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 387\nColumns: 5\n$ ach                  <dbl> 52.159780, 30.784999, 39.607737, 55.985351, 31.80…\n$ learning_performance <dbl> 32.666667, 10.666667, 28.000000, 52.666667, 15.55…\n$ ontime_class         <chr> \"used to late\", \"used to late\", \"never late\", \"us…\n$ engage               <chr> \"no engage\", \"much engage\", \"much engage\", \"much …\n$ practice             <chr> \"do practice\", \"do not praction\", \"do not practio…\n```\n\n\n:::\n:::\n\n\n\nสมมุติว่ามีการสูญหายแบบ MCAR ขึ้นบนตัวแปร `learning_performance` ร้อยละ 20 สถานการณ์นี้เทียบเท่ากับการสุ่มตัวอย่างแบบ SRS ออกจาก vector ของ `ach` ในสัดส่วน 0.2 ดังนี้\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(patchwork)\nset.seed(123)\ndata <- data %>% \n  mutate(learning_performance_mcar = ifelse(runif(387,0,1)<0.2,NA, learning_performance)) \np1<-data %>% \n  pivot_longer(cols=starts_with(\"learning\")) %>% \n  ggplot(aes(x=value))+\n  geom_histogram(aes(fill = name))+\n  theme(legend.position = \"none\")\n\np2<-data %>% \n  pivot_longer(cols=starts_with(\"learning\")) %>% \n  ggplot(aes(x = value, y=name))+\n  geom_boxplot(aes(fill = name))\n\np1+p2\n```\n\n::: {.cell-output-display}\n![](missing_value2024_files/figure-html/unnamed-chunk-2-1.png){width=768}\n:::\n:::\n\n\n\nการสูญหายแบบ MCAR ไม่ได้ทำให้เกิด bias ในการวิเคราะห์ แต่อาจมีผลกับ precision ของการวิเคราะห์ ลองพิจารณาผลการวิเคราะห์ด้านล่าง\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata %>% \n  ggplot(aes(x=learning_performance))+\n  geom_point(aes(y=ach),alpha=0.1)+\n  geom_point(data = data %>% filter(is.na(learning_performance_mcar)==T), \n             aes(y=ach), col=\"maroon\", shape = 2)+\n  theme_light()+\n  theme(panel.grid = element_blank())\n```\n\n::: {.cell-output-display}\n![](missing_value2024_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndata %>% \n  select(learning_performance, ach, learning_performance_mcar) %>% \n  pivot_longer(cols = c(learning_performance, \n                        learning_performance_mcar)) %>% \n  group_by(name) %>% \n  summarise(mean = mean(value, na.rm = T),\n            sd = sd(value,na.rm = T),\n            median = median(value,na.rm = T),\n            cor = cor(ach, value, use = \"complete.obs\"),\n            r2 = cor^2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 6\n  name                       mean    sd median   cor    r2\n  <chr>                     <dbl> <dbl>  <dbl> <dbl> <dbl>\n1 learning_performance       45.8  26.0   47.6 0.846 0.715\n2 learning_performance_mcar  45.4  26.0   47.4 0.842 0.708\n```\n\n\n:::\n:::\n\n\n\n\n**การสูญหายแบบสุ่ม (missing at random: MAR)**\n\nกล่าวคือ ถ้าการมีอยู่ของข้อมูลที่ขาดหายไปในตัวแปรหนึ่ง ๆ มีความสัมพันธ์กับตัวแปรอื่น ๆ ที่ผู้วิเคราะห์มีข้อมูลสามารถสังเกตค่าได้ โดยไม่เกี่ยวข้องกับข้อมูลที่สูญหายไปของตัวแปรนั้น ข้อมูลนั้นจะถือว่าขาดหายไปแบบ MAR กลไกการสูญหายแบบ MAR สามารถอธิบายในเชิงคณิตศาสตร์ได้ดังนี้\n\n$$\n\np(m_{ij} = 1 | X_{obs}, X_{mis}) = f(X_{obs})\n\n$$\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(123)\ndata <- data %>% \n  mutate(learning_performance_mar = case_when(\n    ach > 70 | ach < 30 ~ ifelse(runif(387,0,1)<0.5,NA, ach) ,\n    .default = ach\n  )\n  )\np1<-data %>% \n  pivot_longer(cols=starts_with(\"learning\")) %>% \n  ggplot(aes(x=value))+\n  geom_histogram(aes(fill = name))+\n  theme(legend.position = \"none\")\n\n\np2<-data %>% \n  pivot_longer(cols=starts_with(\"learning\")) %>% \n  ggplot(aes(x = value, y=name))+\n  geom_boxplot(aes(fill = name))\n\np1+p2\n```\n\n::: {.cell-output-display}\n![](missing_value2024_files/figure-html/unnamed-chunk-5-1.png){width=768}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndata %>% \n  ggplot(aes(x=learning_performance))+\n  geom_point(aes(y=ach),alpha=0.1)+\n  geom_point(data = data %>% filter(is.na(learning_performance_mar)==T), \n             aes(y=ach), col=\"maroon\", shape = 2)+\n  theme_light()+\n  theme(panel.grid = element_blank())\n```\n\n::: {.cell-output-display}\n![](missing_value2024_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n\n```{.r .cell-code}\ndata %>% \n  select(learning_performance,learning_performance_mcar, \n         learning_performance_mar, ach) %>% \n  pivot_longer(cols = c(learning_performance,\n                        learning_performance_mcar, \n                        learning_performance_mar)) %>%\n  group_by(name) %>% \n  summarise(mean = mean(value, na.rm = T),\n            sd = sd(value,na.rm = T),\n            median = median(value,na.rm = T),\n            cor = cor(ach, value, use = \"complete.obs\"),\n            r2 = cor^2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 3 × 6\n  name                       mean    sd median   cor    r2\n  <chr>                     <dbl> <dbl>  <dbl> <dbl> <dbl>\n1 learning_performance       45.8  26.0   47.6 0.846 0.715\n2 learning_performance_mar   45.8  15.2   46.1 1     1    \n3 learning_performance_mcar  45.4  26.0   47.4 0.842 0.708\n```\n\n\n:::\n:::\n\n\n\nจากผลการวิเคราะห์ข้างต้นจะเห็นว่าการสูญหายแบบ MAR มีแนวโน้มทำให้เกิดความลำเอียงในการวิเคราะห์ความสัมพันธ์ระหว่างตัวแปร\n\nการตรวจสอบว่าการสูญหายในชุดข้อมูลเป็น MCAR หรือ MAR สามารถทำได้หลายวิธีการ แนวคิดหลัก ๆ คือการวิเคราะห์ความสัมพันธ์ระหว่างการสูญหายของข้อมูลกับตัวแปรอื่น ๆ ในชุดข้อมูล หากพบหลักฐานว่ามีความสัมพันธ์ดังกล่าวแสดงว่าการสูญหายที่เกิดขึ้นเป็นแบบ MAR รูปด้านล่างแสดงตัวอย่างการวิเคราะห์ข้อมูลจำลองข้างต้น\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(naniar)\np1<-data |> \n  bind_shadow() |>  ## สร้าง shadow matrix\n  ggplot(aes(x = learning_performance_mcar_NA, y=ach))+\n  geom_boxplot()+\n  ggtitle(\"MCAR Mechanism\")\n\np2<-data |> \n  bind_shadow() |>  ## สร้าง shadow matrix\n  ggplot(aes(x = learning_performance_mar_NA, y=ach))+\n  geom_boxplot()+\n  ggtitle(\"MAR Mechanism\")\n\np1+p2\n```\n\n::: {.cell-output-display}\n![](missing_value2024_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\nจากรูปจะเห็นว่าข้อมูลที่สูญหาย `NA` ใน learning performance มีความสัมพันธ์กับ `ach` โดยการสูญหายพบมากในนักเรียนที่มี `ach` อยู่ในระดับต่ำและสูง อย่างชัดเจน ลักษณะนี้แสดงการสูญหายที่มีกลไกแบบ MAR \n\nเมื่อเปรียบเทียบกับการสูญหายใน learning performance ที่มีการสูญหายแบบ MCAR จะเห็นว่าไม่มีแนวโน้มความสัมพันธ์ระหว่างการสูญหายของข้อมูลกับ `ach` \n\nหากมีตัวแปรหลายตัวในชุดข้อมูล เราสามารถใช้การวิเคราะหการถดถอย logistic หรือโมเดลทำนายอื่น ๆ ช่วยในการวิเคราะห์ความสัมพันธ์ระหว่างการสูญหายกับข้อมูลตัวแปรอื่น ๆ เพื่อวินิจฉัยลักษณะของกลไกการสูญหายแบบสุ่มได้ เช่นตัวอย่างต่อไปนี้\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n  data |> \n  bind_shadow() |> \n  select(learning_performance_mar_NA, ach, engage, ontime_class, practice) |>\n  ## ปรับให้ตัวแปรตามเป็น binary 0,1\n  mutate(learning_performance_mar_NA = as.numeric(learning_performance_mar_NA)-1) %>% \n  with(glm(learning_performance_mar_NA ~ ach + engage + ontime_class + practice, family = binomial)) |> \n  summary()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = learning_performance_mar_NA ~ ach + engage + ontime_class + \n    practice, family = binomial)\n\nCoefficients:\n                         Estimate Std. Error z value Pr(>|z|)    \n(Intercept)               0.24149    0.43274   0.558    0.577    \nach                      -0.05429    0.01087  -4.993 5.94e-07 ***\nengagemoderate engage    -0.28707    0.46266  -0.620    0.535    \nengagemuch engage        -0.50548    0.42143  -1.199    0.230    \nengageno engage           0.74495    0.56177   1.326    0.185    \nontime_classused to late  0.36631    0.32893   1.114    0.265    \npracticedo practice       0.26216    0.41625   0.630    0.529    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 309.13  on 386  degrees of freedom\nResidual deviance: 262.52  on 380  degrees of freedom\nAIC: 276.52\n\nNumber of Fisher Scoring iterations: 5\n```\n\n\n:::\n:::\n\n\n\nผลการวิเคราะห์ข้างต้นเห็นชัดเจนว่า `ach` เป็นตัวแปรที่มีความสัมพันธ์กับการสูญหายใน learning performance ดังนั้นการสูญหายดังกล่าวมีแนวโน้มเป็นการสูญหายแบบ MAR\n\n\n### การสูญหายจากสาเหตุเฉพาะ\n\nสาเหตุเฉพาะหรือ Missing Not at Random (MNAR) คือ การสูญหายที่มีความสัมพันธ์กับค่าของตัวแปรที่สูญหายไป หรือค่าของตัวแปรอื่น ๆ ที่ไม่สามารถสังเกตได้ หรือไม่ได้สังเกต \n\n$$\np(m_{ij} = 1 | X_{obs}, X_{mis}) = f(X_{obs}, X_{mis})\n$$\n\nกล่าวง่าย ๆ เป็นการสูญหายที่เกิดขึ้นโดยสัมพันธ์กับค่าที่สูญหาย การสูญหายแบบนี้ไม่สามารถอธิบายได้ด้วยข้อมูลที่มี  เช่น\n\n- ผู้ตอบไม่ตอบคำถามเกี่ยวกับรายได้เพราะรายได้ของตนเองสูงเกินไป\n  \n- นักเรียนที่มีคะแนนต่ำมากไม่ตอบคำถาม ไม่เข้าเรียน หรือไม่ส่งงานทำให้ครูไม่สามารถประเมินคะแนนให้นักเรียนได้\n\n- ผู้เรียนที่เรียนไม่เก่ง drop out ออกไปจากชั้นเรียนระหว่างการเรียนรู้ทำให้ไม่สามารถประเมินผลการเรียนรู้หรือตัวแปรที่เกี่ยวข้องได้\n\nผลลัพธ์ด้านล่างแสดงผลการเปรียบเทียบการวิเคราะห์ในสถานการณ์ที่ข้อมูลสูญหายแบบ MNAR เปรียบเทียบกับการสูญหายแบบอื่น โดยใช้ข้อมูลจำลอง\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(123)\ndata <- data %>% \n  mutate(learning_performance_mnar = case_when(\n    learning_performance < 30  ~ ifelse(runif(387,0,1)<0.4,NA, ach) ,\n    .default = learning_performance\n  )\n  )\np1<-data %>% \n  pivot_longer(cols=starts_with(\"learning\")) %>% \n  ggplot(aes(x=value))+\n  geom_histogram(aes(fill = name))+\n  theme(legend.position = \"none\")\n\np2<-data %>% \n  pivot_longer(cols=starts_with(\"learning\")) %>% \n  ggplot(aes(x = value, y=name))+\n  geom_boxplot(aes(fill = name))\n\np1+p2\n```\n\n::: {.cell-output-display}\n![](missing_value2024_files/figure-html/unnamed-chunk-9-1.png){width=768}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndata %>% \n  ggplot(aes(x=learning_performance))+\n  geom_point(aes(y=ach),alpha=0.1)+\n  geom_point(data = data %>% filter(is.na(learning_performance_mnar)==T), \n             aes(y=ach), col=\"maroon\", shape = 2)+\n  theme_light()+\n  theme(panel.grid = element_blank())\n```\n\n::: {.cell-output-display}\n![](missing_value2024_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n\n```{.r .cell-code}\ndata %>% \n  select(learning_performance, learning_performance_mcar, \n         learning_performance_mar, learning_performance_mnar, ach) %>% \n  pivot_longer(cols = starts_with(\"learning\")) %>% \n  group_by(name) %>% \n  summarise(mean = mean(value, na.rm = T),\n            sd = sd(value,na.rm = T),\n            median = median(value,na.rm = T),\n            cor = cor(ach, value, use = \"complete.obs\"),\n            r2 = cor^2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 4 × 6\n  name                       mean    sd median   cor    r2\n  <chr>                     <dbl> <dbl>  <dbl> <dbl> <dbl>\n1 learning_performance       45.8  26.0   47.6 0.846 0.715\n2 learning_performance_mar   45.8  15.2   46.1 1     1    \n3 learning_performance_mcar  45.4  26.0   47.4 0.842 0.708\n4 learning_performance_mnar  52.3  21.9   52   0.890 0.793\n```\n\n\n:::\n:::\n\n\n\n\nการตรวจสอบ MNAR ค่อนข้างลำบากเมื่อเปรียบเทียบกับการวิเคราะห์กลไกการสูญหายแบบอื่น  ตัวอย่างด้านล่างแสดงให้เห็นว่าเมื่อมีการสูญหายแบบ MAR ผลการวิเคราะห์ความสัมพันธ์ระหว่างการสูญหายกับตัวแปรในชุดข้อมูลมีลักษณะที่เหมือนกับผลการวิเคราะห์ที่ได้จาก MAR กล่าวคือการแยกกลไกการสูญหายแบบ MAR และ MNAR ออกจากกันด้วยข้อมูลเชิงปริมาณแต่เพียงอย่างเดียวทำได้ยากหรืออาจทำไม่ได้เลย\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1<-data |> \n  bind_shadow() |>  ## สร้าง shadow matrix\n  ggplot(aes(x = learning_performance_mcar_NA, y=ach))+\n  geom_boxplot()+\n  ggtitle(\"MCAR Mechanism\")\n\np2<-data |> \n  bind_shadow() |>  ## สร้าง shadow matrix\n  ggplot(aes(x = learning_performance_mar_NA, y=ach))+\n  geom_boxplot()+\n  ggtitle(\"MAR Mechanism\")\n\np3<-data |> \n  bind_shadow() |>  ## สร้าง shadow matrix\n  ggplot(aes(x = learning_performance_mnar_NA, y=ach))+\n  geom_boxplot()+\n  ggtitle(\"MNAR Mechanism\")\n\np1+p2+p3\n```\n\n::: {.cell-output-display}\n![](missing_value2024_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n\nจากลักษณะการสูญหายแบบ MNAR ที่มีกลไกที่แฝงอยู่เบื้องหลังค่าที่สูญหายอีกทีหนึ่งนี้ การตรวจสอบจึงค่อนข้างยากลำบาก แต่ก็สามารถดำเนินการได้ โดยวิธีการตรวจสอบที่เป็นไปได้ เช่น\n\nการเปรียบเทียบกับทฤษฎีหรือความรู้หรือข้อมูลอื่นที่มีอยู่เกี่ยวกับบริบทที่ทำการวิเคราะห์ ยกตัวอย่างเช่น การเก็บรวบรวมข้อมูลรายได้ผู้ปกครองของนักเรียนซึ่งพบว่ามีค่าสูญหาย เมื่อทำการวิเคราะห์ข้อมูลรายได้ที่เก็บรวบรวมได้ดังกล่าวอาจพบว่าค่าเฉลี่ย และขอบเขตของรายได้ผู้ปกครองนักเรียนในโรงเรียนนี้มีแนวโน้มที่ต่ำกว่าปกติ โดยอาจสังเกตว่าต่ำกว่าผลการสำรวจในอดีต หรือต่ำกว่าที่ควรจะเป็นจากการพิจารณาบริบทแวดล้อมของโรงเรียน กรณีเช่นนี้อาจตั้งสมมุติฐานได้ว่าการสูญหายดังกล่าวเป็นการสูญหายในกลุ่มของนักเรียนที่ครอบครัวมีฐานะร่ำรวย จากตัวอย่างนี้จะเห็นว่าการตรวจสอบการสูญหายแบบ MNAR ต้องอาศัยความรู้ในส่วนอื่นนอกเหนือจากข้อมูลเชิงปริมาณที่เก็บรวบรวมมาแต่เพียงอย่างเดียว\n\nอีกวิธีการหนึ่งคือการใช้โมเดลการวิเคราะห์ความลำเอียงในการเลือกตัวอย่าง (sample selection bias) หรือ Heckman Selection Model หรือ Heckman Correction [@Galimard2018] โมเดลดังกล่าวเป็นทั้งโมเดลการวิเคราะห์และแก้ปัญหาการสูญหายแบบ MNAR อย่างไรก็ตามรายละเอียดส่วนนี้ค่อนข้างมีมากและอยู่นอกเหนือขอบเขตเนื้อหาในหัวข้่อนี้ อ่านเพิ่มเติมได้ที่ --- > **\n\n\n## ขั้นตอนการวิเคราะห์ข้อมูลที่มีค่าสูญหาย\n\nการวิเคราะห์ข้อมูลเมื่อมีค่าสูญหายนั้นมีแนวทางหรือวิธีดำเนินงานที่หลากหลายขึ้นอยู่กับว่าเราอ้างอิงสำนักไหน นักสถิติหรือนักวิทยาการข้อมูลคนไหน กลุ่มไหน อย่างไรก็ตามแนวทางโดยทั่วไปที่เหมือนกันประกอบด้วย\n\n1. การสำรวจและระบุค่าสูญหาย\n\n2. การวิเคราะห์รูปแบบหรือกลไกของค่าสูญหาย\n\n3. การจัดการค่าสูญหาย\n\nรายละเอียดในแต่ละขั้นตอนมีดังนี้\n\n## การสำรวจและระบุค่าสูญหาย\n\nทัศนภาพข้อมูลเป็นเครื่องมือสำคัญที่จะช่วยให้ผู้วิเคราะห์ทำความเข้าใจสภาพการสูญหายของข้อมูลในชุดข้อมูลที่ทำงานด้วย โดยปกตินักวิเคราะห์จะใช้ทั้งทัศนภาพข้อมูลควบคู่กับการวิเคราะห์ผลทางสถิติเพื่อทำความเข้าใจและระบุค่าสูญหายในชุดข้อมูล\n\nอย่างไรก็ตามจากประสบการณ์ของผู้สอน เทคนิคการวิเคราะห์เพื่อสำรวจค่าสูญหายที่ใช้อาจมีความแตกต่างกันขึ้นอยู่กับขนาดของชุดข้อมูลด้วย\n\n- การใช้ทัศนภาพข้อมูลและสถิติพื้นฐานเพื่อสำรวจค่าสูญหายเหมาะกับการทำงานบนชุดข้อมูลขนาดเล็ก\n\n- ข้อมูลขนาดปานหลางหรือขนาดใหญ่อาจจะต้องใช้เทคนิคโดยเฉพาะ ML เข้ามาช่วยเพื่อให้แสดงสภาพการสูญหายของข้อมูลของตัวแปรทั้งหมดได้\n\n\n### Tabulating Missing data\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(naniar)\nmiss_var_summary(data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 8 × 3\n  variable                  n_miss pct_miss\n  <chr>                      <int>    <num>\n1 learning_performance_mcar     69     17.8\n2 learning_performance_mar      53     13.7\n3 learning_performance_mnar     44     11.4\n4 ach                            0      0  \n5 learning_performance           0      0  \n6 ontime_class                   0      0  \n7 engage                         0      0  \n8 practice                       0      0  \n```\n\n\n:::\n:::\n\n\n\n\n### Visualization for Missing data\n\nเทคนิคทั้งหมดในหัวข้อนี้เหมาะสำหรับใช้กับชุดข้อมูลที่มีขนาดไม่ใหญ่มาก\n\n\n- heatmap\n\n- missing data pattern plot\n\n- co-occurence plot\n\n\n- scatter plot\n\nตัวอย่างมีดังนี้\n\n\n\nการสร้าง heatmap สามารถทำได้หลายวิธีการ ตั้งแต่การสร้างแบบ manual (ซึ่งทำบ่อย ๆ ก็เหนื่อย) ไปจนถึงมีฟังก์ชันสำเร็จรูปจากหลาย library\n\n\n#### heatmap\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## install.packages(\"visdat\")\nlibrary(visdat)\n## create shadow matrix\nvis_dat(data)\n```\n\n::: {.cell-output-display}\n![](missing_value2024_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\np1<-vis_miss(data, cluster = TRUE)\np1\n```\n\n::: {.cell-output-display}\n![](missing_value2024_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\np2<-vis_miss(data, cluster = TRUE, facet = ontime_class)\np2\n```\n\n::: {.cell-output-display}\n![](missing_value2024_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\n\n\n\n#### md plot\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## install.packages(\"mice)\nlibrary(mice)\nmd.pattern(data, rotate.names = TRUE)\n```\n\n::: {.cell-output-display}\n![](missing_value2024_files/figure-html/unnamed-chunk-16-1.png){width=768}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n    ach learning_performance ontime_class engage practice\n268   1                    1            1      1        1\n44    1                    1            1      1        1\n25    1                    1            1      1        1\n6     1                    1            1      1        1\n13    1                    1            1      1        1\n9     1                    1            1      1        1\n12    1                    1            1      1        1\n10    1                    1            1      1        1\n      0                    0            0      0        0\n    learning_performance_mnar learning_performance_mar\n268                         1                        1\n44                          1                        1\n25                          1                        0\n6                           1                        0\n13                          0                        1\n9                           0                        1\n12                          0                        0\n10                          0                        0\n                           44                       53\n    learning_performance_mcar    \n268                         1   0\n44                          0   1\n25                          1   1\n6                           0   2\n13                          1   1\n9                           0   2\n12                          1   2\n10                          0   3\n                           69 166\n```\n\n\n:::\n:::\n\n\n\n\n\n#### co-occurence plot\n\nco-occurence plot ช่วยแสดงสภาพการสูญหายที่ลึกกว่า heatmap เพราะมีทั้งมิติความถี่ของการสูญหายเป็นรายตัวแปรซึ่งจำแนกเป็นการสูญหายในตัวแปรเดียว และการสูญหายร่วมกัน\n\nการสูญหายร่วมกันที่มากมีผลทำให้การแก้ปัญหาแบบตัดข้อมูลที่ missing ออกจากไปการวิเคราะห์เริ่มไม่ work (ทำไม?)\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(naniar)\ngg_miss_upset(data)\n```\n\n::: {.cell-output-display}\n![](missing_value2024_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n:::\n\n\n\n#### Scatter plot\n\nแผนภาพการกระจายมีประโยชน์มากสำหรับวิเคราะห์กลไกการสูญหายของข้อมูล\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata %>% \n  bind_shadow() %>% \n  ggplot(aes(x = learning_performance_mar))+\n  geom_point(aes(y=ach))+\n  geom_rug(aes(y=ach))+\n  geom_rug(aes(y=ach ,\n               col = learning_performance_mar_NA))+\n  scale_color_manual(values = c(\"!NA\" = NULL, \"NA\" = \"maroon\"),\n                     labels=c(NULL, \"missing in ach\"))+\n  theme_light()\n```\n\n::: {.cell-output-display}\n![](missing_value2024_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\n\nจากรูปจะเห็นได้อย่างชัดเจนว่าการสูญหายที่เกิดขึ้นใน ach มีความสัมพันธ์กับ learning performance ของนักเรียน ซึ่งสะท้อน MAR mechanism\n\n\n\n### การสำรวจค่าสูญหายสำหรับข้อมูลขนาดใหญ่\n\n\nในกรณีที่ชุดข้อมูลมีขนาดใหญ่  โดยเฉพาะเมื่อมีตัวแปรจำนวนมาก การใช้ heatmap หรือ co-occurence plot อาจมีประสิทธิภาพน้อยลง ลองใช้วิธีการข้างต้นวิเคราะห์สภาพการสูญหายในชุดข้อมูลต่อไปนี้\n\n[ดาวน์โหลด](https://bit.ly/2JoKcqX)\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlarge_data <- read_csv(\"/Users/choat/Downloads/onlinelearning_miss.csv\")\nlarge_data <- large_data %>% select(-1) %>% \n  rename(student_id = X)\n\nmiss_var_summary(large_data) %>% \n  arrange(desc(pct_miss))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 49 × 3\n   variable            n_miss pct_miss\n   <chr>                <int>    <num>\n 1 climate.online1         97      9.7\n 2 climate.onsite2         88      8.8\n 3 climate.online3         87      8.7\n 4 climate.onsite3         80      8  \n 5 climate.onsite1         72      7.2\n 6 climate.online2         70      7  \n 7 computer                29      2.9\n 8 interaction.online1     27      2.7\n 9 interaction.onsite1     27      2.7\n10 outcome.onsite3         26      2.6\n# ℹ 39 more rows\n```\n\n\n:::\n:::\n\n\n\nidea คือเราอาจใช้เทคนิค dimensionality reduction เพื่อย่อขนาดข้อมูลก่อนที่จะสร้างทัศนภาพข้อมูล ผลลัพธ์ที่ได้จะช่วยให้ผู้วิเคราะห์สามารถทำความเข้าใจสภาพการสูญหายของข้อมูลได้ง่ายขึ้น\n\nการใช้ PCA ในบริบทนี้สามารถดำเนินการได้ดังนี้\n\n1. แปลงข้อมูลของตัวแปรที่มีค่าสูญหายเป็น dummy variable โดยใช้ 1 แทนค่าสูญหาย และ 0 แทนค่าที่ไม่สูญหาย\n\n2. ใช้ PCA เพื่อสกัดองค์ประกอบหลักจาก matrix ของ dummy ดังกล่าว\n\n3. ลักษณะการทำงานของ PCA คือจะสร้างองค์ประกอบหลักที่สามารถอธิบายความแปรปรวนของตัวแปรต้นฉบับเดิมให้ได้มากที่สุด ดังนั้นเมื่อตัวแปรนำเข้าเป็นแบบ binary 0,1 องค์ประกอบหลักที่ได้จึงจะสะท้อนความแปรปรวนหรือรูปแบบการสูญหายของข้อมูล\n\n\nทดลองดำเนินการดังนี้\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndummy_mat <- large_data %>% \n  bind_shadow() %>% \n  dplyr::select(ends_with(\"NA\")) %>% \n  select(-1) |> \n  mutate_all(as.numeric) %>% \n  mutate_all(~ .-1)\n\nlibrary(tidymodels)\ndummy_mat  %>% \n  recipe(~.) %>% \n  step_pca(all_predictors()) %>% \n  prep() %>%\n  juice() %>% \n  ggplot(aes(PC1, PC2))+\n  geom_point()\n```\n\n::: {.cell-output-display}\n![](missing_value2024_files/figure-html/unnamed-chunk-20-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndummy_mat  %>% \n#  rownames_to_column(var = \"student_id\") %>%  # เก็บ rownames เป็นคอลัมน์ (ถ้าต้องการ)\n#  mutate(student_id = paste0(\"student\", student_id)) %>% \n#  pivot_longer(cols = -student_id, names_to = \"variable\", values_to = \"value\") %>%\n#  pivot_wider(names_from = student_id, values_from = value) %>% \n#  column_to_rownames(\"variable\") %>%\n  recipe(~.) %>% \n  step_pca(all_predictors(), num_comp = 3) %>% \n  prep() -> pca_prep\n\n## Variance Extraction\npca_prep %>% \n  tidy(1, type = \"variance\") |> \n  filter(terms == \"percent variance\") |> \n  ggplot(aes(x=component, y=value))+\n  geom_col()+\n  ggtitle(\"Percent Variance Explained\")\n```\n\n::: {.cell-output-display}\n![](missing_value2024_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n\n```{.r .cell-code}\n## Component Loadings\npca_prep %>% \n  tidy(1) %>% \n  filter(component %in% c(\"PC1\",\"PC2\",\"PC3\")) %>% \n  ggplot(aes(x=value, y=terms))+\n  geom_col()+\n  facet_wrap(~component)+\n  theme(text = element_text(family = \"ChulaCharasNew\"))+\n  ggtitle(\"Factor Loadings\")\n```\n\n::: {.cell-output-display}\n![](missing_value2024_files/figure-html/unnamed-chunk-21-2.png){width=672}\n:::\n:::\n\n\n\n\n#### ตัวอย่างการใช้ correlation วิเคราะห์กลไกการสูญหาย\n\nเราสามารถใช้คะแนนองค์ประกอบหลักของค่าสูญหายในการวิเคราะห์กลไกการสูญหายของข้อมูลได้ ยกตัวอย่างเช่น การนำคะแนนองค์ประกอบหลักของค่าสูญหายไปวิเคราะห์ความสัมพันธ์กับตัวแปรอื่น ๆ ในโมเดล\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1 <- pca_prep |> juice() |> \n  mutate(PC1 = -PC1) |> \n  dplyr::select(PC1) |> \n  bind_cols(large_data) |> \n  select_if(is.numeric) |> \n  select(-student_id, -climate.online1) |> \n  pivot_longer(cols = -PC1) |> \n  group_by(name) |> \n  summarise(cor = cor(PC1, value, use = \"complete.obs\")) |> \n  ggplot(aes(x = abs(cor), y=reorder(name, abs(cor))))+\n  geom_col()+\n  theme(text = element_text(family = \"ChulaCharasNew\"))+\n  scale_x_continuous(limits=c(0,0.2))+\n  ylab(\"\")\n\np2 <- pca_prep |> juice() |> \n  dplyr::select(PC2) |> \n  bind_cols(large_data) |> \n  select_if(is.numeric) |> \n  select(-student_id, -climate.onsite3, -climate.onsite2) |> \n  pivot_longer(cols = -PC2) |> \n  group_by(name) |> \n  summarise(cor = cor(PC2, value, use = \"complete.obs\")) |> \n  ggplot(aes(x = abs(cor), y=reorder(name, abs(cor))))+\n  geom_col()+\n  theme(text = element_text(family = \"ChulaCharasNew\"))+\n  scale_x_continuous(limits=c(0,0.2))+\n  ylab(\"\")\n\np3 <- pca_prep |> juice() |> \n  dplyr::select(PC3) |> \n  bind_cols(large_data) |> \n  select_if(is.numeric) |> \n  select(-student_id, -climate.onsite2, -climate.online3) |> \n  pivot_longer(cols = -PC3) |> \n  group_by(name) |> \n  summarise(cor = cor(PC3, value, use = \"complete.obs\")) |> \n  ggplot(aes(x = abs(cor), y=reorder(name, abs(cor))))+\n  geom_col()+\n  theme(text = element_text(family = \"ChulaCharasNew\"))+\n  scale_x_continuous(limits=c(0,0.2))+\n  ylab(\"\")\n\np1/p2/p3\n```\n\n::: {.cell-output-display}\n![](missing_value2024_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n:::\n\n\n\n#### ตัวอย่างการใช้ decision tree วิเคราะห์กลไกการสูญหาย\n\nการวิเคราะห์ด้านล่างแสดงให้เห็นว่าองค์ประกอบหลักที่ 1 ของค่าสูญหายไม่มีแนวโน้มความสัมพันธ์กับตัวแปรอิสระในโมเดลอย่างชัดเจน แสดงให้เห็นว่าการสูญหายที่เกิดขึ้นใน `climate.online1` มีแนวโน้มเป็นแบบ MCAR \n\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 4\n  .metric .estimator .estimate .config             \n  <chr>   <chr>          <dbl> <chr>               \n1 f_meas  binary        0.05   Preprocessor1_Model1\n2 sens    binary        0.0286 Preprocessor1_Model1\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](missing_value2024_files/figure-html/unnamed-chunk-23-1.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](missing_value2024_files/figure-html/unnamed-chunk-23-2.png){width=672}\n:::\n:::\n\n\n\n## การแก้ปัญหาค่าสูญหาย\n\n\nการแก้ปัญหาค่าสูญหายอาจทำให้หลายวิธีการ ทั้งนี้ขึ้นอยู่กับความเหมาะสมว่าในแต่ละกรณีควรเลือกใช้วิธีการใด โดยปกติอาจจำแนกวิธีการแก้ปัญหาได้เป็นดังนี้\n\n-   เลือกใช้โมเดลการวิเคราะห์ที่แกร่งต่อการสูญหายของข้อมูล เช่น tree-based models\n\n-   การลบข้อมูลที่มีค่าสูญหายทิ้ง ซึ่งสามารถทำได้หลายลักษณะ เช่น การลบตัวแปรที่มีค่าสูญหายอย่างรุนแรงออกไปจากการวิเคราะห์ หรือการลบหน่วยข้อมูลที่มีค่าสูญหายออกไปจากการวิเคราะห์ วิธีการนี้อาจเหมาะสมถ้าในการวิเคราะห์มีตัวแปรหรือหน่วยข้อมูลบางตัวที่มีค่าสูญหายมากอย่างผิดปกติหรือรุนแรงมากเมื่อเปรียบเทียบกับตัวแปรหรือหน่วยข้อมูลอื่น ๆ อย่างไรก็ตามหากพบว่าการสูญหายมีการกระจายตัวไปหลายตัวแปรพและหลายหน่วยข้อมูลพร้อมกันวิธีการนี้จะไม่ work เพราะอาจสร้าง bias ให้กับการวิเคราะห์\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- read_csv(\"/Users/choat/Downloads/exam.csv\")\nglimpse(data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 387\nColumns: 5\n$ ach                  <dbl> 52.159780, 30.784999, 39.607737, 55.985351, 31.80…\n$ learning_performance <dbl> 32.666667, 10.666667, 28.000000, 52.666667, 15.55…\n$ ontime_class         <chr> \"used to late\", \"used to late\", \"never late\", \"us…\n$ engage               <chr> \"no engage\", \"much engage\", \"much engage\", \"much …\n$ practice             <chr> \"do practice\", \"do not praction\", \"do not practio…\n```\n\n\n:::\n\n```{.r .cell-code}\n### ลองสร้าง missign value ใน learning performance\nset.seed(123)\ndata_miss <- data %>% \n  mutate(learning_performance = \n           case_when(\n             ach < 30 ~ ifelse(runif(387,0,1)<2, NA, learning_performance),\n             ach >=30 ~ learning_performance\n           )\n  )\n #dplyr::select(-learning_performance)\ndata_miss %>% vis_miss(cluster = T)\n```\n\n::: {.cell-output-display}\n![](missing_value2024_files/figure-html/unnamed-chunk-24-1.png){width=672}\n:::\n\n```{.r .cell-code}\ndata_miss %>% miss_var_summary()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 5 × 3\n  variable             n_miss pct_miss\n  <chr>                 <int>    <num>\n1 learning_performance     89     23.0\n2 ach                       0      0  \n3 ontime_class              0      0  \n4 engage                    0      0  \n5 practice                  0      0  \n```\n\n\n:::\n\n```{.r .cell-code}\ndata_miss %>% \n  bind_shadow() %>% \n  ggplot(aes(x=learning_performance, y=ach))+\n  geom_point(data = data, col = \"maroon\")+\n  geom_smooth(method=\"lm\", se = F)+\n  geom_point(col = \"steelblue\")+\n  geom_smooth(data = data, col = \"maroon\", method = \"lm\")\n```\n\n::: {.cell-output-display}\n![](missing_value2024_files/figure-html/unnamed-chunk-24-2.png){width=672}\n:::\n:::\n\n\n\nอีกปัจจัยหนึ่งที่ควรนำมาพิจารณาร่วมในการลบข้อมูลคือกลไกการสูญหายของข้อมูล กล่าวคือหากการสูญหายที่เกิดขึ้นเป็นแบบ MCAR การลบข้อมูลสามารถทำได้โดยไม่ได้ทำให้เกิดความลำเอียงในผลการวิเคราะห์ อย่างไรก็ตามหากการสูญหายเป็น MAR หรือ MNAR การลบข้อมูลอาจทำให้เกิดความลำเอียงดังที่ได้กล่าวไว้\n\n-   การลงรหัสข้อมูลสูญหาย กล่าวคือในบางกรณีการสูญหายของข้อมูลสอดคล้องกับธรรมชาติของตัวแปรที่สูญหายทำให้ผู้วิเคราะห์สามารถลงรหัสของข้อมูลได้แทนที่จะกำหนดเป็นค่าสูญหาย ยกตัวอย่างจากชุดข้อมูล `exam.csv` หากผู้วิเคราะห์ทราบว่ามีหน่วยข้อมูลหลายหน่วยที่มีค่าสูญหายในตัวแปร `engage` และ `ontime_class` โดยที่หน่วยข้อมูลดังกล่าวเป็นนักเรียนที่ขาดเรียนบ่อยหรือแทบจะไม่มาเรียนในคลาสเลย กรณีเช่นนี้ผู้วิเคราะห์สามารถลงรหัสข้อมูลของนักเรียนดังกล่าวเป็น `no engage` และ `missed class` ตามลำดับ แทนที่จะกำหนดเป็นค่าสูญหาย และหากมีการสูญหายใน learning_performance ผู้วิเคราะห์อาจใช้ค่าเฉลี่ย learning_performance ของกลุ่มนักเรียนที่ไม่มาเรียนหรือมาเรียนน้อยเป็นตัวแทนค่าสูญหายดังกล่าวได้\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata %>% count(ontime_class)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 2\n  ontime_class     n\n  <chr>        <int>\n1 never late     249\n2 used to late   138\n```\n\n\n:::\n:::\n\n\n\n-   การทดแทนค่าสูญหาย (imputation methods) วิธีการนี้มักทดแทนค่าสูญหายโดยใช้ความสัมพันธ์ระหว่างตัวแปรที่มีค่าสูญหายกับตัวแปรอื่น ๆ เพื่อหาค่าทดแทนที่มีความสมเหตุสมผลมากที่สุด\n\nการวิจัยในอดีตมักเน้นการวิเคราะห์เพื่ออนุมานเชิงสถิติ ดังนั้นที่ผ่านมาวิธีการทดแทนค่าสูญหายหลายวิธีการจึงมีการออกแบบให้คำนึงถึงผลกระทบที่จะมีต่อการอนุมานเชิงสถิติในโมเดลต่าง ๆ กล่าวคือวัตถุประสงค์หลักในการหาค่าทดแทนคือการรับประกันว่าค่าทดแทนที่กำหนดให้กับข้อมูลสูญหายจะมีคุณภาพเพียงพอที่จะทำให้การทดสอบสมมุติฐานหรือการประมาณค่าแบบช่วงมีความน่าเชื่อถือ วิธีการที่มักใช้แก้ปัญหาเป็นหลักในกลุ่มนี้คือ การทดแทนค่าสูญหายแบบหลายค่า (multiple imputation)\n\n![](mi.png)\n\nอย่างไรก็ตามวิธีการดังกล่าวอาจไม่ work ในการพัฒนาโมเดลทำนายทั้งนี้เป็นเพราะ\n\n1.  โมเดลทำนายหลายตัวไม่ได้เป็น parametric model กล่าวคือไม่ได้มีข้อตกลงเบื้องต้นเกี่ยวกับการแจกแจงของข้อมูล เช่น decision tree, K-NN ทำให้โมเดลดังกล่าวไม่สามารถสร้างสารสนเทศในการอนุมานเชิงสถิติได้ multiple imputation จะไม่เหมาะกับการทำงานร่วมกับโมเดลแบบนี้\n\n2.  การพัฒนาโมเดลทำนายมีกระบวนการที่ค่อนข้างซับซ้อนหลายขั้น มีการใช้การสุ่มตัวอย่างซ้ำ เช่น cross-validation หรือ bootstraping เพื่อคำนวณความคลาดเคลื่อนแบบ out-sample นอกจากนี้หลายโมเดลยังมีการประมวลผลที่ซับซ้อนใช้เวลาต่อหนึ่งรอบในการประมาณที่ค่อนข้างมาก การทำ multiple imputation จะยิ่งเพิ่มเวลาในการประมวลผลและการใช้ทรัพยากรไปอีก\n\nอย่างไรก็ตามการประเมินความผันแปรในการทดแทนค่าสูญหายเป็นประเด็นที่ควรวิเคราะห์/ศึกษาในงานวิจัย ซึ่งเราสามารถทำได้ผ่านการสุ่มซ้ำในขั้นตอนการ train model แทนการใช้ multiple imputation (กล่าวคือกำหนดการทดแทนค่าสูญหายเป็นขั้นตอนหนึ่งในแต่ละ cross-validation เลย) ผลลัพธ์ที่ได้จะช่วยลดภาระในการคำนวณ และสะท้อน variation ที่เกิดจากการทดแทนข้อมูลสูญหายได้\n\n3.  การพัฒนาโมเดลทำนายมีวัตถุประสงค์เพื่อทำนายข้อมูลที่ยังไม่เคยเห็นหรือไม่ทราบคำตอบมาก่อน แทนที่จะอธิบายความสัมพันธ์หรือสร้างองค์ความรู้จากความสัมพันธ์ระหว่างตัวแปร ดังนั้นค่าที่ทดแทนค่าสูญหายที่สร้างขึ้นจึงควรมีความใกล้เคียงกับค่าจริงให้มากที่สุดเท่าที่จะเป็นไปได้\n\n4.  การทำ multiple imputation เป็นการสร้างผลลัพธ์การอนุมานเชิงสถิติซึ่งจะไม่สามารถโมเดลหรืออัลกอริทึมสำหรับการทดแทนค่าสูญหายเอาไว้ใช้ต่อได้ ทำให้เป็นอุปสรรคในการนำโมเดลนี้ไปใช้กับกลุ่มเป้าหมายในกรณีทั่วไป\n\n5.  การทดแทนค่าสูญหายในการพัฒนาโมเดลทำนายควรมีลักษณะเฉพาะคือ มีความแกร่งต่อการสูญหายในหลายตัวแปรพร้อมกัน สามารถเก็บอัลกอริทึมหรือโมเดลการทดแทนค่าสูญหายเอาไว้ได้เพื่อเอาไปผนวกหรือใช้ร่วมกับโมเดลการทำนายในกรณีทั่วไป ควรรองรับการสูญหายของตัวแปรได้หลายประเภทในโมเดลเดียว และควรมีความทนทานต่อค่าผิดปกติมีความเสถียรในการสร้างค่าทดแทนค่าสูญหาย\n\n\n### Imputing Missing Values in Recipe\n\n> การทดแทนค่าสูญหายควรเป็นกระบวนการแรกในการเตรียมข้อมูล\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Impute via bagged trees\nstep_impute_bag() \n\n# Impute via k-nearest neighbours\nstep_impute_knn()\n\n# Impute numeric variables via a linear model\nstep_impute_linear()\n\n# Impute numeric data using the mean\nstep_impute_mean() \n\n# Impute numeric data using the median\nstep_impute_median() \n\n# Impute nominal data using the most common value\nstep_impute_mode() \n\n# Impute numeric data using minimum value\nstep_impute_lower()\n\n# Assign missing categories to \"unknown\" \nstep_unknown()\n```\n:::\n",
    "supporting": [
      "missing_value2024_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}